function showOtherMap_self(){var e=gSelf.coordsFlag;"GEOGRAPHIC"==e?addOther_geo():addOther_proj()}function addOther_geo(){var e=gSelf.getCenter(),t=gSelf.getZoom(),i=t.z;switch(gSelf.activeLayer.mapSource){case"google":var n=.001373291015625,r=n*gSelf.w,a=Math.ceil(10-Math.log(i/r)/Math.log(2));a>18&&(a=18),1>a&&(a=1);var s=r*Math.pow(2,10-a);gSelf.zoom=s;var o={center:new google.maps.LatLng(e.y,e.x),zoom:a,mapTypeControl:!1,panControl:!1,zoomControl:!1,scaleControl:!1,rotateControl:!1,streetViewControl:!1},l=document.getElementById(gSelf.activeLayer.id);gSelf.activeLayer.oMap=new google.maps.Map(l,o),gSelf.activeLayer.oMap.Minlevel=1,gSelf.activeLayer.oMap.MaxLevel=18,gSelf.activeLayer.oMap.targetLevel=10;break;case"tianditu":var n=.0013767249999999897,r=n*gSelf.w,a=Math.ceil(10-Math.log(i/r)/Math.log(2));a>18&&(a=18),1>a&&(a=1);var s=r*Math.pow(2,10-a);gSelf.zoom=s,gSelf.activeLayer.oMap=new TMap(gSelf.activeLayer.id),gSelf.activeLayer.oMap.centerAndZoom(new TLngLat(e.x,e.y),a),gSelf.activeLayer.oMap.Minlevel=1,gSelf.activeLayer.oMap.MaxLevel=18,gSelf.activeLayer.oMap.targetLevel=10;break;case"baidu":var n=.0011498312500000019,r=n*gSelf.w,a=Math.ceil(11-Math.log(i/r)/Math.log(2));a>19&&(a=19),1>a&&(a=1);var s=r*Math.pow(2,11-a);gSelf.zoom=s;var c=new BMap.Point(e.x,e.y);gSelf.activeLayer.oMap=new BMap.Map(gSelf.activeLayer.id),gSelf.activeLayer.oMap.centerAndZoom(c,a),gSelf.activeLayer.oMap.Minlevel=1,gSelf.activeLayer.oMap.MaxLevel=19,gSelf.activeLayer.oMap.targetLevel=11;break;case"bingmap":var n=.001373291015625,r=n*gSelf.w,a=Math.ceil(10-Math.log(i/r)/Math.log(2));a>20&&(a=20),1>a&&(a=1);var s=r*Math.pow(2,10-a);gSelf.zoom=s;var c=new Microsoft.Maps.Location(e.x,e.y),o={credentials:"Aim92CS40Hzcidl63lqWEM_Jxhsgg9sfE7YlKwtHAhN9-4TmR5Hn6CneOfZx2RcZ",center:c,mapTypeId:Microsoft.Maps.MapTypeId.aerial,zoom:a};gSelf.activeLayer.oMap=new Microsoft.Maps.Map(document.getElementById(gSelf.activeLayer.id),o),gSelf.activeLayer.oMap.setView({center:c,zoom:a}),gSelf.activeLayer.oMap.Minlevel=1,gSelf.activeLayer.oMap.MaxLevel=20,gSelf.activeLayer.oMap.targetLevel=10}for(var g=gSelf.getAllLayers(),h=0;h<g.length;h++)"otherLayer"!=g[h].oClass&&g[h].renew()}function addOther_proj(){var e=gSelf.getCenter(),t=gSelf.getZoom(),i=gEcnu.Util.shToLngLat(e.x,e.y),n=gSelf.getSize().w,r=t.z/n,a=parseInt(Math.log(r)/Math.log(2))+1,r=Math.pow(2,a-1);switch(gSelf.zoom=r*n,gSelf.activeLayer.mapSource){case"google":var s={center:new google.maps.LatLng(i.lat,i.lng),zoom:18-a,mapTypeControl:!1,panControl:!1,zoomControl:!1,scaleControl:!1,rotateControl:!1,streetViewControl:!1},o=document.getElementById(gSelf.activeLayer.id);gSelf.activeLayer.oMap=new google.maps.Map(o,s),gSelf.activeLayer.oMap.Minlevel=1,gSelf.activeLayer.oMap.MaxLevel=18,gSelf.activeLayer.oMap.targetLevel=10;break;case"baidu":var l=new BMap.Point(i.lng,i.lat);gSelf.activeLayer.oMap=new BMap.Map(gSelf.activeLayer.id),gSelf.activeLayer.oMap.centerAndZoom(l,19-a),gSelf.activeLayer.oMap.Minlevel=1,gSelf.activeLayer.oMap.MaxLevel=19,gSelf.activeLayer.oMap.targetLevel=11;break;case"tianditu":var i=gEcnu.Util.shToLngLat(e.x-370,e.y+230);gSelf.activeLayer.oMap=new TMap(gSelf.activeLayer.id),gSelf.activeLayer.oMap.centerAndZoom(new TLngLat(i.lng,i.lat),18-a),gSelf.activeLayer.oMap.Minlevel=1,gSelf.activeLayer.oMap.MaxLevel=18,gSelf.activeLayer.oMap.targetLevel=10;break;case"bingmap":var i=gEcnu.Util.shToLngLat(e.x-370,e.y+230),c=new Microsoft.Maps.Location(i.lat,i.lng),s={credentials:"Aim92CS40Hzcidl63lqWEM_Jxhsgg9sfE7YlKwtHAhN9-4TmR5Hn6CneOfZx2RcZ",center:c,mapTypeId:Microsoft.Maps.MapTypeId.aerial,zoom:18-a};gSelf.activeLayer.oMap=new Microsoft.Maps.Map(document.getElementById(gSelf.activeLayer.id),s),gSelf.activeLayer.oMap.Minlevel=1,gSelf.activeLayer.oMap.MaxLevel=20,gSelf.activeLayer.oMap.targetLevel=10}for(var g=gSelf.getAllLayers(),h=0;h<g.length;h++)"otherLayer"!=g[h].oClass&&g[h].renew()}function getLocation_bingmap(e){var t=new Microsoft.Maps.GeoLocationProvider(e);t.getCurrentPosition()}function showOtherMap_eagle(){var e=eagleEye_self,t=e._tianContainer,i=e._eagleWidth,n=(e._eagleHeight,e.eCenterX),r=e.eCenterY,a=e.eagleZoom,s=a/i,o=parseInt(Math.log(s)/Math.log(2))+1;console.log("other zl",18-o);var l=gEcnu.Util.shToLngLat(n,r);switch(e.mapSource){case"GOOGLE":var c={center:new google.maps.LatLng(l.lat,l.lng),zoom:18-o,mapTypeControl:!1,panControl:!1,zoomControl:!1,scaleControl:!1,rotateControl:!1,streetViewControl:!1},g=new google.maps.Map(t,c);eagleEye_self.eagleBasemap=g;break;case"BAIDU":var h=new BMap.Point(l.lng,l.lat),g=new BMap.Map(t.id);g.centerAndZoom(h,19-o),eagleEye_self.eagleBasemap=g;break;case"TMAP":var l=gEcnu.Util.shToLngLat(n-400,r+230),g=new TMap(t.id);g.centerAndZoom(new TLngLat(l.lng,l.lat),18-o),eagleEye_self.eagleBasemap=g}}!function(){var e=!1;gClass=function(){},gClass.extend=function(t){function i(){e||(n&&(this._superprototype=n.prototype),this.init.apply(this,arguments))}var n=null;this!==gClass&&(n=this),n&&(e=!0,i.prototype=new n,i.prototype.constructor=i,e=!1),i.extend=arguments.callee;for(var r in t)t.hasOwnProperty(r)&&(n&&"function"==typeof t[r]&&"function"==typeof i.prototype[r]&&/\b_super\b/.test(t[r])?i.prototype[r]=function(e,t){return function(){return this._super=n.prototype[e],t.apply(this,arguments)}}(r,t[r]):i.prototype[r]=t[r]);return i}}();var gEcnu={};gEcnu.config={version:"1.0.0",maxLevel:10,minLevel:1,tileWidth:250,tileHeight:200,tileMapUrl:"http://58.198.182.28:81/",geoserver:"http://ccgis.cn/geosvr173/",imgPath:"http://webgis.ecnu.edu.cn/shalugis/shaldapsys/jslib/images/"},gEcnu.Util={},gEcnu.Util.createDiv=function(e,t,i,n){var r=document.createElement("div");return r.id=e,r.style.width=t+"px",r.style.height=i+"px",n&&(r.style.position="absolute"),r.style.zIndex=1,r},gEcnu.Util.createTextArea=function(e,t,i,n){var r=document.createElement("textarea");return r.id=e,r.style.width=t+"px",r.style.height=i+"px",n&&(r.style.position="absolute"),r.style.zIndex=1,r},gEcnu.Util.createCanvas=function(e,t,i,n){var r=document.createElement("canvas");return 0!=gEcnu.Util.getIEVersion()&&(r=window.G_vmlCanvasManager.initElement(r)),r.id=e,r.width=t,r.height=i,r.style.width=t+"px",r.style.height=i+"px",n&&(r.style.position="absolute"),r},gEcnu.Util.isInArray=function(e,t){for(var i in e)if(e[i]==t)return!0;return!1},gEcnu.Util.isObjInArray=function(e,t){for(var i in e)if(e[i].id==t.id)return alert("已被添加，请更换图层id"+t.id),!0;return!1},gEcnu.Util.transformProj2Geo=function(e){for(var t=e.length,i=0;t>i;i++){var n=e[i],r=n.shape.Points,a=n.shape.shpBox,s=n._lineRings;n.shape.Points=gEcnu.Util.trans2Geo(r),n.shape.shpBox=gEcnu.Util.transShpbox2Geo(a);for(var o=0,l=s.length;l>o;o++){var c=s[o].points;n._lineRings[o].points=gEcnu.Util.trans2Geo(c)}}return e},gEcnu.Util.trans2Geo=function(e){for(var t=e.length,i=[],n=0;t>n;n++){var r=e[n],a=gEcnu.Util.shToLngLat(r.x,r.y),s={x:a.lng,y:a.lat};i.push(s)}return i},gEcnu.Util.transShpbox2Geo=function(e){var t=e[0],i=e[1],n=e[2],r=e[3],a=gEcnu.Util.shToLngLat(t,i),s=gEcnu.Util.shToLngLat(n,r),o=a.lat,l=s.lat,c=a.lng,g=s.lng,h=[c,o,g,l];return h},gEcnu.Util.transformGeo2Proj=function(e){for(var t=e.length,i=0;t>i;i++){var n=e[i],r=n.shape.Points,a=n.shape.shpBox,s=n._lineRings;n.shape.Points=gEcnu.Util.trans2Proj(r),n.shape.shpBox=gEcnu.Util.transShpbox2Proj(a);for(var o=0,l=s.length;l>o;o++){var c=s[o].points;n._lineRings[o].points=gEcnu.Util.trans2Proj(c)}}return e},gEcnu.Util.trans2Proj=function(e){for(var t=e.length,i=[],n=0;t>n;n++){var r=e[n],a=gEcnu.Util.lnglatToSh(r.x,r.y),s={x:a.x,y:a.y};i.push(s)}return i},gEcnu.Util.transShpbox2Proj=function(e){var t=e[0],i=e[1],n=e[2],r=e[3],a=gEcnu.Util.lnglatToSh(t,i),s=gEcnu.Util.lnglatToSh(n,r),t=a.x,n=s.x,i=a.y,r=s.y,o=[t,i,n,r];return o},gEcnu.Util.worldToScreen=function(e,t){var i=gSelf.getCenter(),n=i.x,r=i.y,a=parseInt(gSelf.w)/2,s=parseInt(gSelf.h)/2,o=gSelf.zoom/parseInt(gSelf.w),l=parseFloat(a)+parseFloat((e-n)/o)+.5,c=parseFloat(s)-parseFloat((t-r)/o)+.5;return{x:l,y:c}},gEcnu.Util.screenToWorld=function(e,t){var i=gSelf.getCenter(),n=i.x,r=i.y,a=parseInt(gSelf.w)/2,s=parseInt(gSelf.h)/2,o=gSelf.zoom/parseInt(gSelf.w),l=parseFloat(n)+parseFloat((e-a)*o),c=parseFloat(r)-parseFloat((t-s)*o);return{x:l,y:c}},gEcnu.Util.worldToScreen_geo=function(e,t){var i=gSelf.getCenter(),n=i.x,r=i.y,a=parseInt(gSelf.w)/2,s=parseInt(gSelf.h)/2,o=gSelf.zoom/parseInt(gSelf.w);if("GEOGRAPHIC"==gSelf.coordsFlag){var l=i.x,c=i.y;n=111e3*l*Math.cos(c),r=111e3*c;var g=111.31955*gSelf.zoom*1e3;o=g/parseInt(gSelf.w)}var h=a+parseFloat(e-n)/o+.5,u=s-parseFloat(t-r)/o+.5;return{x:h,y:u}},gEcnu.Util.screenToWorld_geo=function(e,t){var i=gSelf.getCenter(),n=i.x,r=i.y,a=parseInt(gSelf.w)/2,s=parseInt(gSelf.h)/2,o=gSelf.zoom/parseInt(gSelf.w);if("GEOGRAPHIC"==gSelf.coordsFlag){var l=i.x,c=i.y;n=111e3*l*Math.cos(c),r=111e3*c;var g=111.31955*gSelf.zoom*1e3;o=g/parseInt(gSelf.w)}var h=n+parseFloat(e-a)*o,u=r-parseFloat(t-s)*o;return{x:h,y:u}},gEcnu.Util.getMouseXY=function(e,t){var i=0,n=0,r=t.srcElement?t.srcElement:t.target;if(1!=r.nodeType)return{x:i,y:n};if(document.attachEvent){var a="medium"==gEcnu.Util.getEleStyle(r,"border-top-width")?0:gEcnu.Util.delpx(gEcnu.Util.getEleStyle(r,"border-top-width")),s="medium"==gEcnu.Util.getEleStyle(r,"border-left-width")?0:gEcnu.Util.delpx(gEcnu.Util.getEleStyle(r,"border-left-width"));i=t.layerX-s,n=t.layerY-a}else{for(;r&&r!=e;){var a="medium"==gEcnu.Util.getEleStyle(r,"border-top-width")?0:gEcnu.Util.delpx(gEcnu.Util.getEleStyle(r,"border-top-width")),s="medium"==gEcnu.Util.getEleStyle(r,"border-left-width")?0:gEcnu.Util.delpx(gEcnu.Util.getEleStyle(r,"border-left-width"));i+=r.offsetLeft+s,n+=r.offsetTop+a,r=r.offsetParent}i=t.offsetX+i+document.body.scrollLeft,n=t.offsetY+n+document.body.scrollTop}return{x:i,y:n}},gEcnu.Util.getTouchXY=function(e){for(var t=0;t<e.targetTouches.length;t++){var i=e.targetTouches[t];ox=i.pageX,oy=i.pageY}return x=ox-gSelf.mapLeft,y=oy-gSelf.mapTop,{x:x,y:y}},gEcnu.Util.getTouchPos=function(e){var t={x:0,y:0};try{t.x=e.touches[0].screenX,t.y=e.touches[0].screenY}catch(i){console.log(i.toString())}return t},gEcnu.Util.getShpBox=function(e){var t=e.length;if(t>=1){var i=[],n=e[0].x,r=e[0].y,a=e[0].x,s=e[0].y;if(t>=2)for(var o=1;t>o;o++){var l=e[o];n>=l.x&&(n=l.x),a<=l.x&&(a=l.x),r>=l.y&&(r=l.y),s<=l.y&&(s=l.y)}return i=[n,r,a,s]}return void alert("获取最小外接矩形失败！")},gEcnu.Util.getType=function(e){var t;return("object"==(t=typeof e)?null==e&&"null"||Object.prototype.toString.call(e).slice(8,-1):t).toLowerCase()},gEcnu.Util.extend=function(e,t){for(var i in t)"array"==gEcnu.Util.getType(t[i])||"object"==gEcnu.Util.getType(t[i])?(e[i]="array"==gEcnu.Util.getType(t[i])?[]:{},arguments.callee(e[i],t[i])):e[i]=t[i]},gEcnu.Util.getTouchPt=function(e){var t=e.pageX-gSelf.mapLeft,i=e.pageY-gSelf.mapTop;return{x:t,y:i}},gEcnu.Util.getMousePos=function(e){var t=e||window.event;return{x:t.screenX,y:t.screenY}},gEcnu.Util.p1top2Dis=function(e,t){var i=parseInt(e.x-t.x),n=parseInt(e.y-t.y),r=parseInt(Math.sqrt(i*i+n*n));return r},gEcnu.Util.getEleStyle=function(e,t){var i=t.split("-"),n=i[0];if(n.length>1)for(var r=1;r<i.length;r++)n+=i[r].substring(0,1).toUpperCase()+i[r].substring(1);else n=t;return e.currentStyle?e.currentStyle[n]:document.defaultView.getComputedStyle(e,!1)[n]},gEcnu.Util.setOptions=function(e,t){var i=gEcnu.Util.cloneObj(e.options);for(var n in t)(null!=t[n]||void 0!=t[n]||""!=t[n])&&(i[n]=t[n]);return i},gEcnu.Util.shToLngLat=function(e,t){var i=95418.0172735741,n=48.3052839794785,r=-11592069.1853624,a=63.9932503167748,s=110821.847990882,o=-3469087.15690168,l=(a*e-i*t-(r*a-i*o))/(n*a-i*s),c=(s*e-n*t-(r*s-n*o))/(i*s-n*a);return{lat:l,lng:c}},gEcnu.Util.lnglatToSh=function(e,t){var i=95418.0172735741,n=48.3052839794785,r=-11592069.1853624,a=63.9932503167748,s=110821.847990882,o=-3469087.15690168,l=i*e+n*t+r-50+470,c=a*e+s*t+o-50-235;return{x:l,y:c}},gEcnu.Util.delpx=function(e){return""==e?0:parseInt(e.substring(0,e.length-2))},gEcnu.Util.ajax=function(e,t,i,n,r,a,s,o){function l(e){}var c,g=arguments.length;(7==arguments.length||8==arguments.length)&&(c=setTimeout(function(){u?u.abort():h&&(alert(h),h.abort()),a()},s));var h=null,u=null;if(i instanceof Object){var p="";for(k in i)p+=k+"="+encodeURIComponent(i[k])+"&";i=p}window.XDomainRequest?(u=new XDomainRequest,u&&(u.onerror=l,u.onload=function(){c&&clearTimeout(c),8==arguments.length?r(u.responseText,o):r(u.responseText)},"get"==e.toLowerCase()?(null==i||""==i?u.open("get",t):u.open("get",t+"?"+i),u.send()):"post"==e.toLowerCase()&&(u.open("post",t),u.setRequestHeader("content-Type","application/x-www-form-urlencoded"),u.send(i)))):(window.XMLHttpRequest?h=new XMLHttpRequest:window.ActiveXObject&&(h=new ActiveXObject("Microsoft.XMLHTTP")),h.onreadystatechange=function(e){4==h.readyState&&(200==h.status?r&&(c&&clearTimeout(c),8==g?r(h.responseText,o):r(h.responseText)):404==h.status?hander404&&hander404():500==h.status&&hander500&&hander500())},"get"==e.toLowerCase()?(null==i||""==i?h.open("get",t,n):h.open("get",t+"?"+i,n),h.send(null)):"post"==e.toLowerCase()&&(h.open("post",t,n),h.setRequestHeader("content-Type","application/x-www-form-urlencoded"),h.send(i)))},gEcnu.Util.cloneObj=function(e){var t,i;if("object"==typeof e){if(t=e.constructor===Object?{}:[],window.JSON)i=JSON.stringify(e),t=JSON.parse(i);else if(t.constructor===Array)t.concat(e);else for(var n in e)t[n]=e[n];return t}},gEcnu.Util.drawLine=function(e,t,i,n,r){e.beginPath(),e.moveTo(t,i),e.lineTo(n,r),e.closePath(),e.stroke()},gEcnu.Util.getPolylineLength=function(e){for(var t=e.length,i=0,n=0;t-1>n;n++){var r=Math.sqrt((e[n].x-e[n+1].x)*(e[n].x-e[n+1].x)+(e[n].y-e[n+1].y)*(e[n].y-e[n+1].y));i+=r}return i},gEcnu.Util.calcAreaMap=function(e){for(var t=0,i=e,n=0;n<i.length;n++)t+=i[n].x*i[(n+1)%i.length].y-i[(n+1)%i.length].x*i[n].y;var r=parseInt(Math.abs(.5*t));return r},gEcnu.Util.drawCalPolyline=function(e,t){gEcnu.Util.setStyle(e);t.length;e.beginPath();var i=gEcnu.Util.worldToScreen(t[0].x,t[0].y);"GEOGRAPHIC"==gSelf.coordsFlag&&(i=gEcnu.Util.worldToScreen_geo(t[0].x,t[0].y)),e.moveTo(i.x,i.y);for(var n=1;n<t.length;n++)i=gEcnu.Util.worldToScreen(t[n].x,t[n].y),"GEOGRAPHIC"==gSelf.coordsFlag&&(i=gEcnu.Util.worldToScreen_geo(t[n].x,t[n].y)),e.lineTo(i.x,i.y);e.stroke()},gEcnu.Util.setStyle=function(e,t){var i={fillColor:"blue",strokeColor:"blue",lineWeight:2,borderStatus:!0,fillStatus:!0,vtxStatus:!1,vtxRadius:3,tlr:5,opacity:1};return arguments.length>1&&(i=t),e.fillStyle=i.fillColor,e.strokeStyle=i.strokeColor,e.lineWidth=i.lineWeight,e.globalAlpha=i.opacity,i},gEcnu.Util.debounce=function(e,t,i,n){var r;return function(){function a(){i||e.apply(s,o),r=null}var s=this,o=arguments;r?clearTimeout(r):i&&e.apply(s,o),r=setTimeout(a,t||100),n()}},gEcnu.Util.addEvtHandler=function(e,t,i){e.addEventListener?e.addEventListener(t,i,!1):e.attachEvent?e.attachEvent("on"+t,i):e["on"+t]=i,"mousewheel"==t&&0==gEcnu.Util.getIEVersion()&&e.addEventListener("DOMMouseScroll",i,!1)},gEcnu.Util.removeEvtHandler=function(e,t,i){e.removeEventListener?e.removeEventListener(t,i,!1):e.detachEvent?e.detachEvent("on"+t,i):e["on"+t]=i,"mousewheel"==t&&e.removeEventListener("DOMMouseScroll",i,!1)},gEcnu.Util.preventDefault=function(e){e.preventDefault?e.preventDefault():window.event.returnValue=!1},gEcnu.Util.stopPropagation=function(e){e.stopPropagation?e.stopPropagation():window.event.cancelBubble=!0},gEcnu.Util.bindCusEvt=function(e,t,i){var n=document.createEvent("Event");n.initEvent(t,!1,!1),gSelf.cusEvtArr[t]=n,e.addEventListener(t,i,!1)},gEcnu.Util.triggerCusEvt=function(e,t){e.dispatchEvent(gSelf.cusEvtArr[t])},gEcnu.Util.ifctrl=function(e){var t=window.Event?!0:!1;return t?("undefined"!=typeof e.ctrlKey?e.ctrlKey:e.modifiers&Event.CONTROL_MASK>0)?!0:!1:window.event.ctrlKey?!0:!1},gEcnu.Util.ifshift=function(e){var t=window.Event?!0:!1;return t?("undefined"!=typeof e.shiftKey?e.shiftKey:e.modifiers&Event.SHIFT_MASK>0)?!0:!1:window.event.shiftKey?!0:!1},gEcnu.Util.getIEVersion=function(){var e=window.navigator.userAgent.toLowerCase();return/msie 8\.0/i.test(e)?8:/msie 7\.0/i.test(e)?7:/msie 6\.0/i.test(e)?6:0},Array.indexOf||(Array.prototype.indexOf=function(e){for(var t=0;t<this.length;t++)if(this[t]==e)return t;return-1}),gEcnu.Util.getButton=function(e){if(e=e||window.event,+[1])return e.button;switch(e.button){case 0:case 1:case 3:case 5:case 7:return 0;case 2:case 6:return 2;case 4:return 1}},gEcnu.Util.bindFunction=function(e,t){return function(){t.apply(e,arguments),console.log("util",arguments)}};var gEcnu_reg=/^#([0-9a-fA-f]{3}|[0-9a-fA-f]{6})$/;gEcnu.Util.colorRgb=function(e,t){var i=e.toLowerCase();if(i&&gEcnu_reg.test(i)){if(4===i.length){for(var n="#",r=1;4>r;r+=1)n+=i.slice(r,r+1).concat(i.slice(r,r+1));i=n}for(var a=[],r=1;7>r;r+=2)a.push(parseInt("0x"+i.slice(r,r+2)));return"RGBA("+a.join(",")+","+t+")"}return i},gEcnu.Util.colorHex=function(e){console.log(e,e.length);var t=e.replace(/\s/g,"");if(console.log("that",t),/^(rgb|RGB)/.test(t)){var i=t.replace(/(?:\(|\)|rgba|rgb|RGB)*/gi,"").split(",");console.log("aColor",i);for(var n="#",r=i.length>3?3:i.length,a=0;r>a;a++){var s=parseInt(i[a]).toString(16);console.log("hex",s),0==s&&(console.log(0),s+=s),n+=s}return console.log("strHex",n),7!==n.length&&(n=t),n}if(!gEcnu_reg.test(t))return t;var o=t.replace(/#/,"").split("");if(6===o.length)return t;if(3===o.length){for(var l="#",a=0;a<o.length;a+=1)l+=o[a]+o[a];return l}},gEcnu.Util.resizeDivByContent=function(e,t,i){var n=parseInt(i/e),r=t.length,a=parseInt(r/n)+1,s=e*a+3*a;if(1==a)var o=r*e;else var o=i;return{w:o,h:s}},gEcnu.Util.decode=function(e){var t=e.scale;if(!e.UTF8Encoding)for(var i=e.features,n=0;n<i.length;n++){var r=i[n],a=r.geometry.coordinates,s=r.geometry.encodeOffsets[0],o=(r.properties.cp,r.geometry.Parts||[0]);r.geometry.coordinates=gEcnu.Util.decodePolygon(o,a,s,t)}return e},gEcnu.Util.decodePolygon=function(e,t,i,n){for(var r=[],a=parseFloat(i[0]),s=parseFloat(i[1]),o=e.length,l=[],c=0;o>c;c++){var g=[],h=e[c];if(c==o-1)var u=t.length/2;else var u=e[c+1];for(var p=2*h;2*u>p;p+=2){var d=parseFloat(t[p]),f=parseFloat(t[p+1]);if(0==p){var y=parseFloat(a/n),v=parseFloat(s/n),m=[Number(y.toFixed(4)),Number(v.toFixed(4))];g.push(m),l=m}else{var E=l,y=parseFloat(E[0])+parseFloat(d/n),v=parseFloat(E[1])+parseFloat(f/n),m=[Number(y.toFixed(4)),Number(v.toFixed(4))];l=m,g.push(m)}}r.push(g)}return r},gEcnu.Util.getMapParamByScale=function(e,t,i){var n=e.getSize(),r=e.getCenter(),a=r.x,s=r.y,o=n.w,l=n.h,c=e.getZoom().z,g=c/o*l;g>14e4&&(g=14e4),c=g*i;var h=t/100,u=c/h,p=parseInt(u/2.54*96),d=parseInt(p*i);return{w:d,h:p,zoom:c,cx:a,cy:s}},gEcnu.Util.getTimeInfo=function(){var e=new Date,t=e.getFullYear(),i=e.getMonth()+1,n=e.getDate();return{year:t,month:i,day:n}},gEcnu.Util.webColor2dbColor=function(e){var t=e.substring(1),i=t.substr(0,2),n=t.substr(2,2),r=t.substr(4,2);return newColor="$00"+r+n+i,newColor},gEcnu.Util.dbColor2webColor=function(e){var t="";if(0==e.indexOf("$")){var i=e.substring(3),n=i.substr(0,2),r=i.substr(2,2),a=i.substr(4,2);t="#"+a+r+n}else 0==e.indexOf("cl")&&(t=e.substring(2).toLowerCase(),t=gEcnu.Util.corlorName2Hex(t));return t},gEcnu.Util.corlorName2Hex=function(e){for(var t="",i=[["aliceblue","#f0f8ff","rgb(240,248,255)","rgb(94.1%,96.9%,100%)"],["antiquewhite","#faebd7","rgb(250,235,215)","rgb(98%,92.2%,84.3%)"],["aqua","#00ffff","rgb(0,255,255)","rgb(0%,100%,100%)"],["aquamarine","#7fffd4","rgb(127,255,212)","rgb(49.8%,100%,83.1%)"],["azure","#f0ffff","rgb(240,255,255)","rgb(94.1%,100%,100%)"],["beige","#f5f5dc","rgb(245,245,220)","rgb(96.1%,96.1%,86.3%)"],["bisque","#ffe4c4","rgb(255,228,196)","rgb(100%,89.4%,76.9%)"],["black","#000000","rgb(0,0,0)","rgb(0%,0%,0%)"],["blanchedalmond","#ffebcd","rgb(255,235,205)","rgb(100%,92.2%,80.4%)"],["blue","#0000ff","rgb(0,0,255)","rgb(0%,0%,100%)"],["blueviolet","#8a2be2","rgb(138,43,226)","rgb(54.1%,16.9%,88.6%)"],["brown","#a52a2a","rgb(165,42,42)","rgb(64.7%,16.5%,16.5%)"],["burlywood","#deb887","rgb(222,184,135)","rgb(87.1%,72.2%,52.9%)"],["cadetblue","#5f9ea0","rgb(95,158,160)","rgb(37.3%,62%,62.7%)"],["chartreuse","#7fff00","rgb(127,255,0)","rgb(49.8%,100%,0%)"],["chocolate","#d2691e","rgb(210,105,30)","rgb(82.4%,41.1%,11.8%)"],["coral","#ff7f50","rgb(255,127,80)","rgb(100%,49.8%,31.4%)"],["cornflowerblue","#6495ed","rgb(100,149,237)","rgb(39.2%,58.4%,92.9%)"],["cornsilk","#fff8dc","rgb(255,248,220)","rgb(100%,97.3%,86.3%)"],["crimson","#dc143c","rgb(220,20,60)","rgb(86.3%,7.8%,23.5%)"],["cyan","#00ffff","rgb(0,255,255)","rgb(0%,100%,100%)"],["darkblue","#00008b","rgb(0,0,139)","rgb(0%,0%,54.5%)"],["darkcyan","#008b8b","rgb(0,139,139)","rgb(0%,54.5%,54.5%)"],["darkgoldenrod","#b8860b","rgb(184,134,11)","rgb(72.2%,52.5%,4.3%)"],["darkgray","#a9a9a9","rgb(169,169,169)","rgb(66.3%,66.3%,66.3%)"],["darkgreen","#006400","rgb(0,100,0)","rgb(0%,39.2%,0%)"],["darkgrey","#a9a9a9","rgb(169,169,169)","rgb(66.3%,66.3%,66.3%)"],["darkkhaki","#bdb76b","rgb(189,183,107)","rgb(74.1%,71.8%,42%)"],["darkmagenta","#8b008b","rgb(139,0,139)","rgb(54.5%,0%,54.5%)"],["darkolivegreen","#556b2f","rgb(85,107,47)","rgb(33.3%,42%,18.4%)"],["darkorange","#ff8c00","rgb(255,140,0)","rgb(100%,54.9%,0%)"],["darkorchid","#9932cc","rgb(153,50,204)","rgb(60%,19.6%,80%)"],["darkred","#8b0000","rgb(139,0,0)","rgb(54.5%,0%,0%)"],["darksalmon","#e9967a","rgb(233,150,122)","rgb(91.4%,58.8%,47.8%)"],["darkseagreen","#8fbc8f","rgb(143,188,143)","rgb(56.1%,73.7%,56.1%)"],["darkslateblue","#483d8b","rgb(72,61,139)","rgb(28.2%,23.9%,54.5%)"],["darkslategray","#2f4f4f","rgb(47,79,79)","rgb(18.4%,31%,31%)"],["darkslategrey","#2f4f4f","rgb(47,79,79)","rgb(18.4%,31%,31%)"],["darkturquoise","#00ced1","rgb(0,206,209)","rgb(0%,80.8%,82%)"],["darkviolet","#9400d3","rgb(148,0,211)","rgb(58%,0%,82.7%)"],["deeppink","#ff1493","rgb(255,20,147)","rgb(100%,7.8%,57.6%)"],["deepskyblue","#00bfff","rgb(0,191,255)","rgb(0%,74.9%,100%)"],["dimgray","#696969","rgb(105,105,105)","rgb(41.1%,41.1%,41.1%)"],["dimgrey","#696969","rgb(105,105,105)","rgb(41.1%,41.1%,41.1%)"],["dodgerblue","#1e90ff","rgb(30,144,255)","rgb(11.8%,56.5%,100%)"],["firebrick","#b22222","rgb(178,34,34)","rgb(69.8%,13.3%,13.3%)"],["floralwhite","#fffaf0","rgb(255,250,240)","rgb(100%,98%,94.1%)"],["forestgreen","#228b22","rgb(34,139,34)","rgb(13.3%,54.5%,13.3%)"],["fuchsia","#ff00ff","rgb(255,0,255)","rgb(100%,0%,100%)"],["gainsboro","#dcdcdc","rgb(220,220,220)","rgb(86.3%,86.3%,86.3%)"],["ghostwhite","#f8f8ff","rgb(248,248,255)","rgb(97.3%,97.3%,100%)"],["gold","#ffd700","rgb(255,215,0)","rgb(100%,84.3%,0%)"],["goldenrod","#daa520","rgb(218,165,32)","rgb(85.5%,64.7%,12.5%)"],["gray","#808080","rgb(128,128,128)","rgb(50.2%,50.2%,50.2%)"],["green","#008000","rgb(0,128,0)","rgb(0%,50.2%,0%)"],["greenyellow","#adff2f","rgb(173,255,47)","rgb(67.8%,100%,18.4%)"],["grey","#808080","rgb(128,128,128)","rgb(50.2%,50.2%,50.2%)"],["honeydew","#f0fff0","rgb(240,255,240)","rgb(94.1%,100%,94.1%)"],["hotpink","#ff69b4","rgb(255,105,180)","rgb(100%,41.1%,70.6%)"],["indianred","#cd5c5c","rgb(205,92,92)","rgb(80.4%,36%,36%)"],["indigo","#4b0082","rgb(75,0,130)","rgb(29.4%,0%,51%)"],["ivory","#fffff0","rgb(255,255,240)","rgb(100%,100%,94.1%)"],["khaki","#f0e68c","rgb(240,230,140)","rgb(94.1%,90.2%,54.9%)"],["lavender","#e6e6fa","rgb(230,230,250)","rgb(90.2%,90.2%,98%)"],["lavenderblush","#fff0f5","rgb(255,240,245)","rgb(100%,94.1%,96.1%)"],["lawngreen","#7cfc00","rgb(124,252,0)","rgb(48.6%,98.8%,0%)"],["lemonchiffon","#fffacd","rgb(255,250,205)","rgb(100%,98%,80.4%)"],["lightblue","#add8e6","rgb(173,216,230)","rgb(67.8%,84.7%,90.2%)"],["lightcoral","#f08080","rgb(240,128,128)","rgb(94.1%,50.2%,50.2%)"],["lightcyan","#e0ffff","rgb(224,255,255)","rgb(87.8%,100%,100%)"],["lightgoldenrodyellow","#fafad2","rgb(250,250,210)","rgb(98%,98%,82.4%)"],["lightgray","#d3d3d3","rgb(211,211,211)","rgb(82.7%,82.7%,82.7%)"],["lightgreen","#90ee90","rgb(144,238,144)","rgb(56.5%,93.3%,56.5%)"],["lightgrey","#d3d3d3","rgb(211,211,211)","rgb(82.7%,82.7%,82.7%)"],["lightpink","#ffb6c1","rgb(255,182,193)","rgb(100%,71.4%,75.7%)"],["lightsalmon","#ffa07a","rgb(255,160,122)","rgb(100%,62.7%,47.8%)"],["lightseagreen","#20b2aa","rgb(32,178,170)","rgb(12.5%,69.8%,66.7%)"],["lightskyblue","#87cefa","rgb(135,206,250)","rgb(52.9%,80.8%,98%)"],["lightslategray","#778899","rgb(119,136,153)","rgb(46.7%,53.3%,60%)"],["lightslategrey","#778899","rgb(119,136,153)","rgb(46.7%,53.3%,60%)"],["lightsteelblue","#b0c4de","rgb(176,196,222)","rgb(69%,76.9%,87.1%)"],["lightyellow","#ffffe0","rgb(255,255,224)","rgb(100%,100%,87.8%)"],["lime","#00ff00","rgb(0,255,0)","rgb(0%,100%,0%)"],["limegreen","#32cd32","rgb(50,205,50)","rgb(19.6%,80.4%,19.6%)"],["linen","#faf0e6","rgb(250,240,230)","rgb(98%,94.1%,90.2%)"],["magenta","#ff00ff","rgb(255,0,255)","rgb(100%,0%,100%)"],["maroon","#800000","rgb(128,0,0)","rgb(50.2%,0%,0%)"],["mediumaquamarine","#66cdaa","rgb(102,205,170)","rgb(40%,80.4%,66.7%)"],["mediumblue","#0000cd","rgb(0,0,205)","rgb(0%,0%,80.4%)"],["mediumorchid","#ba55d3","rgb(186,85,211)","rgb(72.9%,33.3%,82.7%)"],["mediumpurple","#9370db","rgb(147,112,219)","rgb(57.6%,43.9%,85.9%)"],["mediumseagreen","#3cb371","rgb(60,179,113)","rgb(23.5%,70.2%,44.3%)"],["mediumslateblue","#7b68ee","rgb(123,104,238)","rgb(48.2%,40.8%,93.3%)"],["mediumspringgreen","#00fa9a","rgb(0,250,154)","rgb(0%,98%,60.4%)"],["mediumturquoise","#48d1cc","rgb(72,209,204)","rgb(28.2%,82%,80%)"],["mediumvioletred","#c71585","rgb(199,21,133)","rgb(78%,8.2%,52.2%)"],["midnightblue","#191970","rgb(25,25,112)","rgb(9.8%,9.8%,43.9%)"],["mintcream","#f5fffa","rgb(245,255,250)","rgb(96.1%,100%,98%)"],["mistyrose","#ffe4e1","rgb(255,228,225)","rgb(100%,89.4%,88.2%)"],["moccasin","#ffe4b5","rgb(255,228,181)","rgb(100%,89.4%,71%)"],["navajowhite","#ffdead","rgb(255,222,173)","rgb(100%,87.1%,67.8%)"],["navy","#000080","rgb(0,0,128)","rgb(0%,0%,50.2%)"],["oldlace","#fdf5e6","rgb(253,245,230)","rgb(99.2%,96.1%,90.2%)"],["Olive","#808000","rgb(128,128,0)","rgb(50.2%,50.2%,0%)"],["olivedrab","#6b8e23","rgb(107,142,35)","rgb(42%,55.7%,13.7%)"],["orange","#ffa500","rgb(255,165,0)","rgb(100%,64.7%,0%)"],["orangered","#ff4500","rgb(255,69,0)","rgb(100%,27.1%,0%)"],["orchid","#da70d6","rgb(218,112,214)","rgb(85.5%,43.9%,83.9%)"],["palegoldenrod","#eee8aa","rgb(238,232,170)","rgb(93.3%,91%,66.7%)"],["palegreen","#98fb98","rgb(152,251,152)","rgb(59.6%,98.4%,59.6%)"],["paleturquoise","#afeeee","rgb(175,238,238)","rgb(68.6%,93.3%,93.3%)"],["palevioletred","#db7093","rgb(219,112,147)","rgb(85.9%,43.9%,57.6%)"],["papayawhip","#ffefd5","rgb(255,239,213)","rgb(100%,93.7%,83.5%)"],["peachpuff","#ffdab9","rgb(255,218,185)","rgb(100%,85.5%,72.5%)"],["peru","#cd853f","rgb(205,133,63)","rgb(80.4%,52.2%,24.7%)"],["pink","#ffc0cb","rgb(255,192,203)","rgb(100%,75.3%,79.6%)"],["plum","#dda0dd","rgb(221,160,221)","rgb(86.7%,62.7%,86.7%)"],["powderblue","#b0e0e6","rgb(176,224,230)","rgb(69%,87.8%,90.2%)"],["purple","#800080","rgb(128,0,128)","rgb(50.2%,0%,50.2%)"],["red","#ff0000","rgb(255,0,0)","rgb(100%,0%,0%)"],["rosybrown","#bc8f8f","rgb(188,143,143)","rgb(73.7%,56.1%,56.1%)"],["royalblue","#4169e1","rgb(65,105,225)","rgb(25.5%,41.1%,100%)"],["saddlebrown","#8b4513","rgb(139,69,19)","rgb(54.5%,27.1%,7.5%)"],["salmon","#fa8072","rgb(250,128,114)","rgb(98%,50.2%,44.7%)"],["sandybrown","#f4a460","rgb(244,164,96)","rgb(95.7%,64.3%,37.6%)"],["seagreen","#2e8b57","rgb(46,139,87)","rgb(18%,54.5%,34.1%)"],["seashell","#fff5ee","rgb(255,245,238)","rgb(100%,96.1%,93.3%)"],["sienna","#a0522d","rgb(160,82,45)","rgb(62.7%,32.2%,17.6%)"],["silver","#c0c0c0","rgb(192,192,192)","rgb(75.3%,75.3%,75.3%)"],["skyblue","#87ceeb","rgb(135,206,235)","rgb(52.9%,80.8%,92.2%)"],["slateblue","#6a5acd","rgb(106,90,205)","rgb(41.6%,35.3%,80.4%)"],["slategray","#708090","rgb(112,128,144)","rgb(43.9%,50.2%,56.5%)"],["slategrey","#708090","rgb(112,128,144)","rgb(43.9%,50.2%,56.5%)"],["snow","#fffafa","rgb(255,250,250)","rgb(100%,98%,98%)"],["springgreen","#00ff7f","rgb(0,255,127)","rgb(0%,100%,49.8%)"],["steelblue","#4682b4","rgb(70,130,180)","rgb(27.5%,51%,70.6%)"],["tan","#d2b48c","rgb(210,180,140)","rgb(82.4%,70.6%,54.9%)"],["teal","#008080","rgb(0,128,128)","rgb(0%,50.2%,50.2%)"],["thistle","#d8bfd8","rgb(216,191,216)","rgb(84.7%,74.9%,84.7%)"],["tomato","#ff6347","rgb(255,99,71)","rgb(100%,38.8%%,27.8%)"],["turquoise","#40e0d0","rgb(64,224,208)","rgb(25.1%,87.7%,81.6%)"],["violet","#ee82ee","rgb(238,130,238)","rgb(93.3%,51%,93.3%)"],["wheat","#f5deb3","rgb(245,222,179)","rgb(96.1%,87.1%,70.2%)"],["white","#ffffff","rgb(255,255,255)","rgb(100%,100%,100%)"],["whitesmoke","#f5f5f5","rgb(245,245,245)","rgb(96.1%,96.1%,96.1%)"],["yellow","#ffff00","rgb(255,255,0)","rgb(100%,100%,0%)"],["yellowgreen","#9acd32","rgb(154,205,50)","rgb(60.4%,80.4%,19.6%)"]],n=0,r=i.length;r>n;n++)for(var a=i[n],s=0,o=a.length;o>s;s++)if(e==a[0])return t=a[1];return t},gEcnu.Util.insertAfter_cust=function(e,t){var i=t.parentNode;i.lastChild==t?i.appendChild(e):i.insertBefore(e,t.nextSibling)},gEcnu.Util.dragDiv=function(e,t){var i=document.getElementById(e),n=document.getElementById(t);n.style.cursor="move";var r=i.currentStyle?i.currentStyle.width:document.defaultView.getComputedStyle(i,null).width,a=i.currentStyle?i.currentStyle.height:document.defaultView.getComputedStyle(i,null).height,s=r.substring(0,r.length-2),o=a.substring(0,a.length-2);n.onmousedown=function(e){var t=e.clientX-i.offsetLeft,n=e.clientY-i.offsetTop;document.onmousemove=function(e){var r=e.clientX-t,a=e.clientY-n;0>r?r=0:r>document.body.clientWidth-s&&(r=document.body.clientWidth-s),0>a?a=0:a>document.body.clientHeight-o&&(a=document.body.clientHeight-o),i.style.left=r+"px",i.style.top=a+"px"},document.onmouseup=function(e){document.onmousemove=null,document.onmouseup=null}}},gEcnu.Util.Trim=function(e,t){var i;return i=e.replace(/(^\s+)|(\s+$)/g,""),t&&"g"==t.toLowerCase()&&(i=i.replace(/\s/g,"")),i},gEcnu.Util.isClockWise=function(e){for(var t=0,i=0,n=e.length;n-1>i;i++){var r=e[i],a=e[i+1],s=(r.y+a.y)*(a.x-r.x)/2;t+=s}return t>0?!0:!1},gEcnu.Util.getOuterPolyIndex=function(e){for(var t=0,i=0,n={},r=0,a=e.length;a>r;r++){var s=e[r].points,o=gEcnu.Util.getArea(s);n[r]=o,o>i&&(i=o)}for(var l in n)if(i==n[l])return t=l;return 0},gEcnu.Util.getArea=function(e){for(var t=0,i=e,n=0;n<i.length;n++)t+=i[n].x*i[(n+1)%i.length].y-i[(n+1)%i.length].x*i[n].y;var r=parseInt(Math.abs(.5*t));return r},gEcnu.Util.isPolyInPoly=function(e,t){for(var i=e.length,n=(t.length,0);i-1>n;n++){var r=e[n],a=e[n+1],s=[r,a],o=gEcnu.Util.pointInPoly(r,t),l=gEcnu.Util.pointInPoly(a,t);if(!o||!l)return!1;var c=gEcnu.Util.isLineInPoly(s,t);if(!c)return!1}return!0},gEcnu.Util.isLineInPoly=function(e,t){for(var i=[],n=e[0],r=e[1],a=0,s=t.length;s-1>a;a++){var o=t[a],l=t[a+1],c=[o,l],g=gEcnu.Util.isPtEqualLinept(n,c),h=gEcnu.Util.isPtEqualLinept(r,c),u=gEcnu.Util.isPtEqualLinept(o,e),p=gEcnu.Util.isPtEqualLinept(l,e);if(g||h)g&&i.push(g),h&&i.push(h);else if(u||p)u&&i.push(u),p&&i.push(p);else if(gEcnu.Util.isLineIntersect(e,c))return!1}if(i.length>0)for(var d=gEcnu.Util.sortObj(i),a=0,f=d.length;f-1>a;a++){var y=d[a],v=d[a+1],m=(y.x+v.x)/2,E=(y.y+v.y)/2,_={x:m,y:E};if(!gEcnu.Util.pointInPoly(_,t))return!1}return!0},gEcnu.Util.sortObj=function(e){return e.sort(gEcnu.Util.compareFun),e},gEcnu.Util.compareFun=function(e,t){return e.x-t.x},gEcnu.Util.isPtEqualLinept=function(e,t){var i=t[0],n=t[1];return e.x==i.x&&e.y==i.y?i:e.x==n.x&&e.y==n.y?n:null},gEcnu.Util.isLineIntersect=function(e,t){var i=e[0],n=e[1],r=t[0],a=t[1],s=(n.x-i.x)*(a.y-r.y)-(n.y-i.y)*(a.x-r.x);(i.y-r.y)*(a.x-r.x)-(i.x-r.x)*(a.y-r.x);if(0==s)return!1;var o=((i.y-r.y)*(a.x-r.x)-(i.x-r.x)*(a.y-r.y))/s,l=((i.y-r.y)*(n.x-i.x)-(i.x-r.x)*(n.y-i.y))/s;return o>0&&1>o&&l>0&&1>l?!0:!1},gEcnu.Util.isPtOnLine=function(e,t){var i=t[0],n=t[1],r=Math.min(i.x,n.x),a=Math.max(i.x,n.x),s=Math.min(i.y,n.y),o=Math.max(i.y,n.y);if(i.x==n.x){if(e.x==i.x&&e.y>=s&&e.y<=o)return!0}else{if(i.y!=n.y){var l=(n.y-i.y)/(n.x-i.x),c=l*(e.x-i.x)+i.y;return c==e.y&&c>=s&&o>=c?!0:!1;
}if(e.y==i.y&&e.x>=r&&e.x<=a)return!0}},gEcnu.Util.pointInPoly=function(e,t){for(var i=!1,n=-1,r=t.length,a=r-1;++n<r;a=n)(t[n].y<=e.y&&e.y<t[a].y||t[a].y<=e.y&&e.y<t[n].y)&&e.x<(t[a].x-t[n].x)*(e.y-t[n].y)/(t[a].y-t[n].y)+t[n].x&&(i=!i);return i};var gSelf;gEcnu.Map=gClass.extend({init:function(e){gSelf=this,this._initContainer(e),this._initProp(),this.overLayer=new gEcnu.Layer.Overlay("overlay"),this.mLayer=new gEcnu.Layer.Marker("markerLayer"),this.addLayer(this.mLayer),this.addLayer(this.overLayer),this._initEvent(),this.activeLayer=null,document.ondragstart=function(){return!1}},_initContainer:function(e){this._container=document.getElementById(e),this.w=this._container.clientWidth,this.h=this._container.clientHeight,this._container.style.overflow="hidden"},_initProp:function(){this.oLayers=[],this.mode="map",this.mapTool="pan",this.dragging=!1,this.isTouch=!1,this.coordsFlag="PROJECTED",this.oLayers=[],this.cx=0,this.cy=0,this.zl=1,this.zl_pre=1,this.zoom=parseInt(1*this.w),this.ownDyn=!1,this.ownTile=!1,this.ownOther=!1,this.maxLevel=gEcnu.config.maxLevel,this.minLevel=gEcnu.config.minLevel,this.tileWidth=gEcnu.config.tileWidth,this.tileHeight=gEcnu.config.tileHeight,this.cusEvtArr=[],this.tileCount=0,this.disUnit="米",this.areaUnit="平方米",this.cursorStyle={pan:"default",dis:"default",area:"default",select:"default",addpoint:"default",delpoint:"default",mark:"default",draw:"default"},this.mapLeft=this._container.offsetLeft,this.mapTop=this._container.offsetTop,this.disMinus=0,this.pinchPt1,this.pinchPt2,this.startDis,this.endDis,this.startX=0,this.startY=0,this.startScrX=0,this.startSrcY=0,this.lengthPtArr=[],this.areaPtArr=[],this.oControls=[],this.resizeTimer=null,this.forbidPan_ex=!1,this.curScrPolys=[],this.tlr=5,this.serverURL=gEcnu.config.geoserver,this.webMapURL=this.serverURL+"WebMap",this.webFeatureUrl=this.serverURL+"WebFeature",this.tileMapURL=gEcnu.config.tileMapUrl+"TileMap",this.fileServer=gEcnu.config.tileMapUrl+"FileServer?fn=",this.dynFileServer=this.serverURL+"FileServer?fn="},_initEvent:function(){function e(e){"map"==gSelf.mode?h(e):gSelf.mousedblclickCustom(e)}function t(e){var e=e?e:window.event;if(window.event||e.preventDefault(),gSelf.tmpMapmode=gSelf.mode,gSelf.tmpMaptool=gSelf.mapTool,gEcnu.Util.ifctrl(e)&&(gSelf.mode="map",gSelf.mapTool="pan"),"map"==gSelf.mode&&"rulerLength"!=gSelf.mapTool&&"rulerArea"!=gSelf.mapTool){if(gSelf.forbidPan_ex)return gSelf.mode=gSelf.tmpMapmode,void(gSelf.mapTool=gSelf.tmpMaptool);i(e),document.onmousemove=function(e){return gSelf.forbidPan_ex?(gSelf.mode=gSelf.tmpMapmode,void(gSelf.mapTool=gSelf.tmpMaptool)):void r(e)},document.onmouseup=function(e){return gSelf.forbidPan_ex?(gSelf.mode=gSelf.tmpMapmode,void(gSelf.mapTool=gSelf.tmpMaptool)):(document.onmousemove=null,document.onmouseup=null,void s(e))}}else i(e),n(e);var t=gEcnu.Util.getMouseXY(gSelf._container,e),a=gEcnu.Util.screenToWorld(t.x,t.y),o={screenX:t.x,screenY:t.y,geoX:a.x,geoY:a.y};gSelf._mousedown_EX(e,o)}function i(e){if("map"==gSelf.mode)if("touchstart"==e.type&&2==e.touches.length){var t=gEcnu.Util.getTouchPt(e.touches[0]),i=gEcnu.Util.getTouchPt(e.touches[1]);gSelf.pinchPt1=t,gSelf.pinchPt2=i,gSelf.startDis=gEcnu.Util.p1top2Dis(t,i)}else{"pan"==gSelf.mapTool&&(gSelf.dragging=!0);var n,r;"touchstart"==e.type?(n=gEcnu.Util.getTouchXY(e),r=gEcnu.Util.getTouchPos(e)):(n=gEcnu.Util.getMouseXY(gSelf._container,e),r=gEcnu.Util.getMousePos(e)),gSelf.startX=n.x,gSelf.startY=n.y,gSelf.startScrX=r.x,gSelf.startScrY=r.y;for(var a=gSelf.getAllLayers(),s=0;s<a.length;s++)"tileLayer"==a[s].oClass?(a[s].startLeft=gEcnu.Util.delpx(a[s].baseMap.style.left),a[s].startTop=gEcnu.Util.delpx(a[s].baseMap.style.top)):(a[s].startLeft=gEcnu.Util.delpx(a[s]._layerContainer.style.left),a[s].startTop=gEcnu.Util.delpx(a[s]._layerContainer.style.top))}}function n(e){gEcnu.Util.preventDefault(e),gEcnu.Util.stopPropagation(e),"map"==gSelf.mode?c(e):gSelf.mousedownCustom(e)}function r(e){if(gEcnu.Util.preventDefault(e),"map"==gSelf.mode&&"pan"==gSelf.mapTool){var t,i;if("touchmove"==e.type&&2==e.touches.length){var n=gEcnu.Util.getTouchPt(e.touches[0]),r=gEcnu.Util.getTouchPt(e.touches[1]);gSelf.pinchPt1=n,gSelf.pinchPt2=r,gSelf.endDis=gEcnu.Util.p1top2Dis(n,r),gSelf.disMinus=gSelf.endDis-gSelf.startDis}else if("touchmove"==e.type?(t=gEcnu.Util.getTouchXY(e),i=gEcnu.Util.getTouchPos(e),gSelf.endScrX=i.x,gSelf.endScrY=i.y):(t=gEcnu.Util.getMouseXY(gSelf._container,e),i=gEcnu.Util.getMousePos(e)),gSelf.currentX=t.x,gSelf.currentY=t.y,gSelf.dragging&&"pan"==gSelf.mapTool){var a=i.x-gSelf.startScrX,s=i.y-gSelf.startScrY,o=gSelf.getAllLayers();if(Math.abs(a)>0||Math.abs(s)>0)for(var l=0;l<o.length;l++)o[l].visible&&(o[l].onDrag(a,s),"dynLayer"==o[l].oClass&&gEcnu.Layer.Dyn._removeDynLoad(o[l]))}}}function a(e){if(gEcnu.Util.preventDefault(e),"map"==gSelf.mode){var t;t="touchmove"==e.type?gEcnu.Util.getTouchXY(e):gEcnu.Util.getMouseXY(gSelf._container,e);var i=gSelf.mapTool;switch(i){case"pan":gSelf.mLayer.getLayerContainer().style.cursor=gSelf.cursorStyle.pan;break;case"rulerLength":gSelf.mLayer.getLayerContainer().style.cursor=gSelf.cursorStyle.dis;break;case"rulerArea":gSelf.mLayer.getLayerContainer().style.cursor=gSelf.cursorStyle.area}gSelf.currentX=t.x,gSelf.currentY=t.y,g(e)}else gSelf.mousemoveCustom(e);var n=gEcnu.Util.getMouseXY(gSelf._container,e),r=gEcnu.Util.screenToWorld(n.x,n.y),a={screenX:n.x,screenY:n.y,geoX:r.x,geoY:r.y};gSelf._mousemove_EX(e,a)}function s(e){if("map"==gSelf.mode&&"pan"==gSelf.mapTool){var t,i;if(Math.abs(gSelf.disMinus)>0)gSelf.disMinus>0?gSelf.zoomIn():gSelf.zoomOut(),gSelf.disMinus=0;else if("touchend"==e.type?i={x:gSelf.endScrX,y:gSelf.endScrY}:(t=gEcnu.Util.getMouseXY(gSelf._container,e),i=gEcnu.Util.getMousePos(e)),"pan"==gSelf.mapTool){var n=i.x-gSelf.startScrX,r=i.y-gSelf.startScrY;if(Math.abs(n)>0||Math.abs(r)>0){var a=gSelf.getScreenCenter(),s=a.x-n,o=a.y-r,l=gEcnu.Util.screenToWorld(s,o);gSelf.setCenter(l.x,l.y);for(var c=gSelf.getAllLayers(),g=c.length,h=0;g>h;h++)"tileLayer"==c[h].oClass&&c[h].visible&&(c[h].xOffset=c[h].xOffset+n,c[h].yOffset=c[h].yOffset+r,c[h].baseMap.style.left=c[h].startLeft+n+"px",c[h].baseMap.style.top=c[h].startTop+r+"px"),c[h].visible&&c[h].renew();gSelf.dragging=!1,gSelf.zl_pre=gSelf.zl,gSelf._boundsChanged()}}}gSelf.mode=gSelf.tmpMapmode,gSelf.mapTool=gSelf.tmpMaptool}function o(e){"map"==gSelf.mode||gSelf.mouseupCustom(e);var t=gEcnu.Util.getMouseXY(gSelf._container,e),i=gEcnu.Util.screenToWorld(t.x,t.y),n={screenX:t.x,screenY:t.y,geoX:i.x,geoY:i.y};gSelf._mouseup_EX(e,n)}function l(e){gEcnu.Util.preventDefault(e),gSelf.forbidPan_ex||(clearTimeout(f),f=setTimeout(function(){if("map"==gSelf.mode&&"pan"==gSelf.mapTool){var t=e.wheelDelta||-e.detail;if(t>0){if(gSelf.tileCount>0&&gSelf.zl<=gSelf.minLevel)return void gSelf._boundsChanged({error:"zoomin"});gSelf.zl_pre=gSelf.zl;var i=gEcnu.Util.getMouseXY(gSelf._container,e),n=gEcnu.Util.screenToWorld(i.x,i.y),r=(n.x-gSelf.cx)/2,a=(n.y-gSelf.cy)/2,s=n.x-r,o=n.y-a;gSelf.setCenter(s,o),gSelf.zoomIn(i)}else{if(gSelf.tileCount>0&&gSelf.zl>=gSelf.maxLevel)return void gSelf._boundsChanged({error:"zoomout"});var i=gEcnu.Util.getMouseXY(gSelf._container,e),n=gEcnu.Util.screenToWorld(i.x,i.y),r=2*(n.x-gSelf.cx),a=2*(n.y-gSelf.cy),s=n.x-r,o=n.y-a;gSelf.setCenter(s,o),gSelf.zoomOut(i)}}else gSelf.mousewheelCustom(e)},280))}function c(e){var t=gSelf.overLayer.getCtx();if("rulerLength"==gSelf.mapTool){var i=gEcnu.Util.screenToWorld(gSelf.startX,gSelf.startY);"GEOGRAPHIC"==gSelf.coordsFlag&&(i=gEcnu.Util.screenToWorld_geo(gSelf.startX,gSelf.startY));var n={x:i.x,y:i.y};gSelf.lengthPtArr.push(n),gSelf.lengthPtArr.length>1&&gEcnu.Util.drawCalPolyline(t,gSelf.lengthPtArr)}else if("rulerArea"==gSelf.mapTool){var i=gEcnu.Util.screenToWorld(gSelf.startX,gSelf.startY);"GEOGRAPHIC"==gSelf.coordsFlag&&(i=gEcnu.Util.screenToWorld_geo(gSelf.startX,gSelf.startY));var n={x:i.x,y:i.y};gSelf.areaPtArr.push(n),gSelf.areaPtArr.length>1&&gEcnu.Util.drawCalPolyline(t,gSelf.areaPtArr)}else gSelf.overLayer.clear()}function g(e){var t=gSelf.overLayer.getCtx();if("rulerLength"==gSelf.mapTool){if(gSelf.lengthPtArr.length>0){gSelf.overLayer.clear();var i={x:gSelf.lengthPtArr[gSelf.lengthPtArr.length-1].x,y:gSelf.lengthPtArr[gSelf.lengthPtArr.length-1].y},n=gEcnu.Util.worldToScreen(i.x,i.y);if("GEOGRAPHIC"==gSelf.coordsFlag&&(n=gEcnu.Util.worldToScreen_geo(i.x,i.y)),gEcnu.Util.drawLine(t,n.x,n.y,gSelf.currentX,gSelf.currentY),gEcnu.Util.drawCalPolyline(t,gSelf.lengthPtArr),1==gSelf.lengthPtArr.length){var r=0,a=gEcnu.Util.screenToWorld(gSelf.currentX,gSelf.currentY);"GEOGRAPHIC"==gSelf.coordsFlag&&(a=gEcnu.Util.screenToWorld_geo(gSelf.currentX,gSelf.currentY)),r=Math.sqrt((a.x-gSelf.lengthPtArr[0].x)*(a.x-gSelf.lengthPtArr[0].x)+(a.y-gSelf.lengthPtArr[0].y)*(a.y-gSelf.lengthPtArr[0].y));var s="当前距离："+gSelf.convertUnit("dis",Math.round(r)),o="总距离:"+gSelf.convertUnit("dis",Math.round(r));t.font=" 13px 幼圆",t.fillStyle="#fff",t.fillRect(gSelf.currentX,gSelf.currentY-40,180,50),t.strokeStyle="#eaeaea",t.lineWidth=1,t.strokeRect(gSelf.currentX,gSelf.currentY-40,180,50),t.fillStyle="blue",t.fillText(s,gSelf.currentX,gSelf.currentY-20),t.fillText(o,gSelf.currentX,gSelf.currentY)}else{var r=0,l=0,c=gSelf.lengthPtArr.length-1,r="",a=gEcnu.Util.screenToWorld(gSelf.currentX,gSelf.currentY);"GEOGRAPHIC"==gSelf.coordsFlag&&(a=gEcnu.Util.screenToWorld_geo(gSelf.currentX,gSelf.currentY)),r=Math.sqrt((a.x-gSelf.lengthPtArr[c].x)*(a.x-gSelf.lengthPtArr[c].x)+(a.y-gSelf.lengthPtArr[c].y)*(a.y-gSelf.lengthPtArr[c].y)),l=gEcnu.Util.getPolylineLength(gSelf.lengthPtArr),l+=r;var s="当前距离："+gSelf.convertUnit("dis",Math.round(r)),o="总距离:"+gSelf.convertUnit("dis",Math.round(l));t.font=" 13px 幼圆",t.fillStyle="#fff",t.fillRect(gSelf.currentX,gSelf.currentY-40,180,50),t.strokeStyle="#333",t.lineWidth=1,t.strokeRect(gSelf.currentX,gSelf.currentY-40,180,50),t.fillStyle="blue",t.fillText(s,gSelf.currentX+5,gSelf.currentY-20),t.fillText(o,gSelf.currentX+5,gSelf.currentY)}}}else if("rulerArea"==gSelf.mapTool&&gSelf.areaPtArr.length>0){gSelf.overLayer.clear();var g=gSelf.areaPtArr.length-1,n=gEcnu.Util.worldToScreen(gSelf.areaPtArr[g].x,gSelf.areaPtArr[g].y);if("GEOGRAPHIC"==gSelf.coordsFlag&&(n=gEcnu.Util.worldToScreen_geo(gSelf.areaPtArr[g].x,gSelf.areaPtArr[g].y)),gEcnu.Util.drawLine(t,n.x,n.y,gSelf.currentX,gSelf.currentY),gSelf.areaPtArr.length>1){gEcnu.Util.drawCalPolyline(t,gSelf.areaPtArr);var n=gEcnu.Util.worldToScreen(gSelf.areaPtArr[0].x,gSelf.areaPtArr[0].y);"GEOGRAPHIC"==gSelf.coordsFlag&&(n=gEcnu.Util.worldToScreen_geo(gSelf.areaPtArr[0].x,gSelf.areaPtArr[0].y)),gEcnu.Util.drawLine(t,n.x,n.y,gSelf.currentX,gSelf.currentY);var h=0,l=gEcnu.Util.getPolylineLength(gSelf.areaPtArr),u=gEcnu.Util.screenToWorld(gSelf.currentX,gSelf.currentY);"GEOGRAPHIC"==gSelf.coordsFlag&&(u=gEcnu.Util.screenToWorld_geo(gSelf.currentX,gSelf.currentY));var p=Math.sqrt((u.x-gSelf.areaPtArr[g].x)*(u.x-gSelf.areaPtArr[g].x)+(u.y-gSelf.areaPtArr[g].y)*(u.y-gSelf.areaPtArr[g].y)),d=Math.sqrt((u.x-gSelf.areaPtArr[0].x)*(u.x-gSelf.areaPtArr[0].x)+(u.y-gSelf.areaPtArr[0].y)*(u.y-gSelf.areaPtArr[0].y));h=l+p+d;var f;f=gSelf.areaPtArr.concat();var y={x:u.x,y:u.y};f.push(y);var v=gEcnu.Util.calcAreaMap(f),s="周长："+gSelf.convertUnit("dis",Math.round(h)),o="面积："+gSelf.convertUnit("area",v);t.font=" 13px 幼圆",t.fillStyle="#fff",t.fillRect(gSelf.currentX,gSelf.currentY-40,200,50),t.strokeStyle="#333",t.lineWidth=1,t.strokeRect(gSelf.currentX,gSelf.currentY-40,200,50),t.fillStyle="blue",t.fillText(s,gSelf.currentX+5,gSelf.currentY-20),t.fillText(o,gSelf.currentX+5,gSelf.currentY)}}}function h(e){var t=gSelf.overLayer.getCtx(),i="";if("rulerLength"==gSelf.mapTool){gSelf.lengthPtArr.pop();var n=gEcnu.Util.getPolylineLength(gSelf.lengthPtArr);gSelf.overLayer.clear(),gEcnu.Util.drawCalPolyline(t,gSelf.lengthPtArr);var r=gSelf.lengthPtArr.length,a=gEcnu.Util.worldToScreen(gSelf.lengthPtArr[r-1].x,gSelf.lengthPtArr[r-1].y);"GEOGRAPHIC"==gSelf.coordsFlag&&(a=gEcnu.Util.worldToScreen_geo(gSelf.lengthPtArr[r-1].x,gSelf.lengthPtArr[r-1].y));var s=a.x,o=a.y;gSelf.lengthPtArr=[],i="总距离："+gSelf.convertUnit("dis",Math.round(n)),t.font=" 13px 幼圆",t.fillStyle="#fff",t.strokeStyle="#333",t.lineWidth=1,t.fillRect(s,o-15,180,25),t.strokeRect(s,o-15,180,25),t.fillStyle="blue",t.fillText(i,s+5,o)}else if("rulerArea"==gSelf.mapTool){if(gSelf.areaPtArr.pop(),gSelf.areaPtArr.length<3)return alert("绘制节点至少三个！"),i;var n=gEcnu.Util.getPolylineLength(gSelf.areaPtArr),l=0,c=gSelf.areaPtArr.length-1,g=Math.sqrt((gSelf.areaPtArr[c].x-gSelf.areaPtArr[0].x)*(gSelf.areaPtArr[c].x-gSelf.areaPtArr[0].x)+(gSelf.areaPtArr[c].y-gSelf.areaPtArr[0].y)*(gSelf.areaPtArr[c].y-gSelf.areaPtArr[0].y));l=n+g;var h=gEcnu.Util.calcAreaMap(gSelf.areaPtArr);gSelf.overLayer.clear(),gEcnu.Util.drawCalPolyline(t,gSelf.areaPtArr);var u=gEcnu.Util.worldToScreen(gSelf.areaPtArr[0].x,gSelf.areaPtArr[0].y),p=gEcnu.Util.worldToScreen(gSelf.areaPtArr[c].x,gSelf.areaPtArr[c].y);"GEOGRAPHIC"==gSelf.coordsFlag&&(u=gEcnu.Util.worldToScreen_geo(gSelf.areaPtArr[0].x,gSelf.areaPtArr[0].y),p=gEcnu.Util.worldToScreen_geo(gSelf.areaPtArr[c].x,gSelf.areaPtArr[c].y)),gEcnu.Util.drawLine(t,u.x,u.y,p.x,p.y);var a=gEcnu.Util.worldToScreen(gSelf.areaPtArr[gSelf.areaPtArr.length-1].x,gSelf.areaPtArr[gSelf.areaPtArr.length-1].y);"GEOGRAPHIC"==gSelf.coordsFlag&&(a=gEcnu.Util.worldToScreen_geo(gSelf.areaPtArr[gSelf.areaPtArr.length-1].x,gSelf.areaPtArr[gSelf.areaPtArr.length-1].y)),gSelf.areaPtArr=[],i="周长："+Math.round(l)+"米；面积："+Math.round(h)+"平方米",returnLenArea1="周长："+gSelf.convertUnit("dis",Math.round(l)),returnLenArea2="面积："+gSelf.convertUnit("area",Math.round(h)),t.font=" 13px 幼圆",t.fillStyle="#fff",t.fillRect(a.x,a.y-40,200,50),t.strokeStyle="#333",t.lineWidth=1,t.strokeRect(a.x,a.y-40,200,50),t.fillStyle="blue",t.fillText(returnLenArea1,a.x+5,a.y-20),t.fillText(returnLenArea2,a.x+5,a.y)}return i}var u,p="ontouchstart",d=document.documentElement;u=0==gEcnu.Util.getIEVersion()?this.mLayer.getLayerContainer():this._container,p in d&&(u.ontouchstart=t,u.ontouchmove=a,u.ontouchend=o),gEcnu.Util.addEvtHandler(u,"mousedown",t),gEcnu.Util.addEvtHandler(u,"mousemove",a),gEcnu.Util.addEvtHandler(u,"mouseup",o),gEcnu.Util.addEvtHandler(u,"mousewheel",l),gEcnu.Util.addEvtHandler(u,"dblclick",e);var f},addLayer:function(e){var t=this.oLayers;gEcnu.Util.isObjInArray(t,e)||(e.onAdd(this),t.push(e))},removeLayer:function(e){var t=[],i=this.oLayers;this.ownTile=!1,this.ownOther=!1;for(var n=0,r=0;n<i.length;n++)i[n]!=e?(t[r]=i[n],"tileLayer"==t[r].oClass&&(this.ownTile=!0),"otherLayer"==t[r].oClass&&(this.ownOther=!0),r++):e.onRemove(this);this.oLayers=t},removeLayerById:function(e){var t=[],i=this.oLayers;this.ownTile=!1;for(var n=0,r=0;n<i.length;n++)i[n].id!=e?(t[r]=i[n],"tileLayer"==t[r].oClass&&(this.ownTile=!0),r++):i[n].onRemove(this);this.oLayers=t},getLayerById:function(e){var t=this.oLayers;console.log(e);for(var i=0;i<t.length;i++)if(t[i].id==e)return t[i]},addLayers:function(e){var t=this.oLayers;for(var i in e)gEcnu.Util.isObjInArray(t,e[i])||(e[i].onAdd(this),t.push(e[i]))},removeLayers:function(e){var t=[],i=this.oLayers;this.ownTile=!1;for(var n in e)for(var r=0,a=0;r<i.length;r++)i[r]!=e[n]?(t[a]=i[r],"tileLayer"==t[a].oClass&&(this.ownTile=!0),a++):e[n].onRemove(this);i=t},showLayer:function(e){e.show()},hideLayer:function(e){e.hide()},addControl:function(e){var t=this.getAllControls();gEcnu.Util.isObjInArray(t,e)||(e.onAdd(this),t.push(e))},getAllLayers:function(){return this.oLayers},getAllControls:function(){return this.oControls},zoomIn:function(e){if(!(this.tileCount>0&&this.zl<=this.minLevel)){var t=gSelf.coordsFlag,i=this.getAllLayers();if(this.ownOther)if("PROJECTED"==t){var n=gSelf.activeLayer.oMap.MaxLevel-this.zl;if(n>=gSelf.activeLayer.oMap.MaxLevel)return void alert("已经放大至最大级别")}else{var r=Math.floor(gSelf.activeLayer.oMap.targetLevel-Math.log(gSelf.zoom/(gSelf.activeLayer.otherPxScale*gSelf.w))/Math.log(2));if(r>=gSelf.activeLayer.oMap.MaxLevel)return void alert("已经放大至最大级别")}this.zoom=this.zoom/2;var a=this.zl;this.zl_pre=a,this.zl--;for(var s=0;s<i.length;s++)i[s].visible&&i[s].zoomIn(e);for(var o=this.getAllControls(),l=0;l<o.length;l++)o[l].renew();gSelf._boundsChanged()}},zoomOut:function(e){if(!(this.tileCount>0&&this.zl>=this.maxLevel)){var t=gSelf.coordsFlag,i=this.getAllLayers();if(this.ownOther)if("PROJECTED"==t){var n=gSelf.activeLayer.oMap.MaxLevel-this.zl;if(n<=gSelf.activeLayer.oMap.Minlevel+1)return void alert("已经缩小至最小级别")}else{var r=Math.floor(gSelf.activeLayer.oMap.targetLevel-Math.log(gSelf.zoom/(gSelf.activeLayer.otherPxScale*gSelf.w))/Math.log(2));if(r<=gSelf.activeLayer.oMap.Minlevel)return void alert("已经缩小至最小级别")}this.zoom=2*this.zoom;var a=this.zl;this.zl_pre=a,this.zl++;for(var s=0;s<i.length;s++)i[s].visible&&i[s].zoomOut(e);for(var o=this.getAllControls(),l=0;l<o.length;l++)o[l].renew();gSelf._boundsChanged()}},zoomTo:function(e,t,i){this.setCenter(e,t);var n=this.getAllLayers();if("undefined"==typeof i)for(var r=0;r<n.length;r++)n[r].zoomTo();else if(i.hasOwnProperty("zl")){var a=i.zl;this.tileCount>0&&(a<gEcnu.config.minLevel?a=gEcnu.config.minLevel:a>gEcnu.config.maxLevel&&(a=gEcnu.config.maxLevel)),this.zl=a;var s=Math.pow(2,this.zl-1),o=this._container.clientWidth;this.zoom=s*o;for(var r=0;r<n.length;r++)n[r].zoomTo()}else if(i.hasOwnProperty("zoom")){this.zoom=i.zoom,_zoom=i.zoom;var o=this._container.clientWidth,s=_zoom/o,a=parseInt(Math.log(s)/Math.log(2))+1;this.tileCount>0&&(a<gEcnu.config.minLevel?a=gEcnu.config.minLevel:a>gEcnu.config.maxLevel&&(a=gEcnu.config.maxLevel));var s=Math.pow(2,a-1),l=s*o;this.zl=a,this.zoom=l;for(var r=0;r<n.length;r++)n[r].zoomTo()}for(var c=this.getAllControls(),g=0;g<c.length;g++)c[g].renew();gSelf._boundsChanged()},resize:function(){var e=this.w,t=this.zoom,i=t/e,n=(this.h,this._container.clientWidth),r=this._container.clientHeight;this.zoom=i*n;var a=gEcnu.Util.screenToWorld(n/2,r/2);this.cx=a.x,this.cy=a.y,this.w=n,this.h=r;for(var s=this.getAllLayers(),o=0;o<s.length;o++)s[o].resize();for(var l=this.getAllControls(),c=0;c<l.length;c++)l[c].renew();gSelf._boundsChanged()},getContainer:function(){return this._container},getSize:function(){return{w:this.w,h:this.h}},getZoom:function(){return{z:this.zoom,zl:this.zl}},getPreZl:function(){return this.zl_pre},setZoom:function(e){this.zoom=e},setZoomLevel:function(e){},getCenter:function(){return{x:this.cx,y:this.cy}},clearOverlay:function(){this.overLayer.clear()},forbidPan:function(){this.forbidPan_ex=!0},activePan:function(){this.forbidPan_ex=!1},setCenter:function(e,t){this.cx=e,this.cy=t},getScreenCenter:function(){return{x:this.w/2,y:this.h/2}},getBounds:function(){var e=this.getCenter(),t=this.getSize(),i=this.getZoom(),n=e.x-i.z/2,r=e.x+i.z/2,a=i.z/t.w,s=e.y-t.h*a/2,o=e.y+t.h*a/2;return{nw:{x:n,y:o},ne:{x:r,y:o},sw:{x:n,y:s},se:{x:r,y:s}}},getMode:function(){return this.mode},setMode:function(e){this.mode=e},getMapTool:function(){return this.mapTool},setMapTool:function(e){this.mapTool=e},setCursorStyle:function(e,t){this.cursorStyle[e]="url('"+t+"'),default"},events:{on:function(e,t){switch(e){case"boundsChanged":gEcnu.Map.prototype._boundsChanged_EX=function(e){t(e)};break;case"mousedown":gEcnu.Map.prototype._mousedown_EX=function(e,i){t(e,i)};break;case"mousemove":gEcnu.Map.prototype._mousemove_EX=function(e,i){t(e,i)};break;case"mouseup":gEcnu.Map.prototype._mouseup_EX=function(e,i){t(e,i)};break;case"dynError":gEcnu.Map.prototype._dynError_EX=function(e){t(e)}}}},_boundsChanged:function(){for(var e=this.getAllControls(),t=0;t<e.length;t++)"eagleMapControl"==e[t].oClass&&e[t].renew();if(arguments.length>0){var i=arguments[0];this._boundsChanged_EX(i)}else this._boundsChanged_EX()},_boundsChanged_EX:function(){},_mousedown_EX:function(e,t){},_mousemove_EX:function(e,t){},_mouseup_EX:function(e,t){},_dynError_EX:function(){},mousedownCustom:function(e){gEcnu.Edit.graphMouseDownEvt(e,gSelf)},mousemoveCustom:function(e){gEcnu.Edit.graphMouseMoveEvt(e,gSelf)},mouseupCustom:function(e){gEcnu.Edit.graphMouseUpEvt(e,gSelf)},mousewheelCustom:function(e){},mousedblclickCustom:function(e){gEcnu.Edit.graphMouseDblClickEvt(e,gSelf)},setProjCoordsFlag:function(){gSelf.coordsFlag="PROJECTED"},setGeoCoordsFlag:function(){gSelf.coordsFlag="GEOGRAPHIC"},setRulerUnit:function(e){this.disUnit=e.disUnit||"米",this.areaUnit=e.areaUnit||"平方米"},convertUnit:function(e,t){var i=this.disUnit,n=this.areaUnit;if("dis"==e)switch(i){case"千米":return t/1e3+"千米";case"公里":return t/1e3+"公里";default:return t+"米"}else switch(n){case"平方千米":return(t/1e6).toFixed(2)+"平方千米";case"平方公里":return(t/1e6).toFixed(2)+"平方公里";case"亩":return(.0015*t).toFixed(2)+"亩";case"公顷":return(t/1e4).toFixed(2)+"公顷";default:return t.toFixed(2)+"平方米"}},saveImageToScale:function(e,t,i,n){var r=gSelf,a=this;this.printScale=t,this.MAXWIDTH=2e3,this.MAXHEIGHT=2e3,this.MINWIDTH=100,this.MINHEIGHT=100;var s=(this.webMapURL,n?n:"上海市1："+t+"用地数据");this._printTitle=s;var o=document.getElementById(e);o.innerHTML="",o.style.display="block";var l=gEcnu.Util.getMapParamByScale(r,t,i),c=l.w,g=l.h,h=l.cx,u=l.cy,p=l.zoom,d="",f="",y=this.getAllLayers();this.outerDiv=o;for(var v=0,m=y.length;m>v;v++)"dynLayer"==y[v].oClass&&(d=y[v].getAllVisibleLyrs().join(","),f=y[v].ws);this._createPrintDiv(o,c,g);var E,_,S=this.imgDiv,x=h-p/2,b=u+p/c*g/2,w=1,L=1;if(c>this.MAXWIDTH){var M=parseInt(c%this.MAXWIDTH);M<this.MINWIDTH?(w=parseInt(c/this.MAXWIDTH),E=this.MAXWIDTH+M):(w=Math.ceil(c/this.MAXWIDTH),E=M)}else E=c;if(g>this.MAXHEIGHT){var C=g%this.MAXHEIGHT;C<this.MINHEIGHT?(L=parseInt(g/this.MAXHEIGHT),_=this.MAXHEIGHT+C):(L=Math.ceil(g/this.MAXHEIGHT),_=C)}else _=g;var P=p/c*this.MAXWIDTH,T=p/c*this.MAXHEIGHT,F=L*w;this.dynImgCount=0,this.totalDynImgNum=F;var v=0,U=document.createElement("img"),I=function(){if(!(v>=F)){var e=Math.floor(v/w),t=Math.floor(v%w),i=(e*a.MAXHEIGHT,t*a.MAXWIDTH,U.cloneNode());if(i.style.position="absolute",i.setAttribute("crossOrigin","anonymous"),i.style.left=t*a.MAXWIDTH+"px",i.style.top=e*a.MAXHEIGHT+"px",S.appendChild(i),t!=w-1)var n=P,r=a.MAXWIDTH;else var r=E,n=p/c*r;if(e!=L-1)var s=a.MAXHEIGHT,o=T;else var s=_,o=p/c*s;var l=x+P*t+n/2,g=b-(T*e+o/2);i.setAttribute("cx",parseInt(l)),i.setAttribute("cy",parseInt(g));var h={map:f,w:r,h:s,mt:"zoomto",cx:l,cy:g,zoom:n,"return":"json",lyrs:d};a._reqImageByScale(h,i,S),v++,v>=F||I()}};I()},_createPrintDiv:function(e,t,i){var n=this,r=gEcnu.Util.createDiv("printBtnDiv",300,40,!1),a=document.createElement("input");a.type="button",a.style.width="60px",a.style.height="28px",a.style.marginLeft="30px";var s=a.cloneNode(),o=a.cloneNode(),l=a.cloneNode();s.value="打印",l.value="导出",o.value="关闭",r.style.lineHeight="40px",r.appendChild(o),r.appendChild(l),r.appendChild(s),e.appendChild(r);var c=parseInt(t+104),g=parseInt(i+40+4+20+20+30+10),h=gEcnu.Util.createDiv("_printDiv",c,g,!1);h.style.position="relative",h.style.left="30px",h.style.textAlign="center",h.style.border="2px solid #000",h.style.margin="0 auto",h.style.backgroundColor="#fff";var u=gEcnu.Util.createDiv("_printTitleDiv",t,50,!1);u.style.position="relative",u.innerHTML=this._printTitle,u.style.lineHeight="100px",u.style.margin="0 auto",u.style.textAlign="center",u.style.fontSize="1.3em",u.style.color="#333",u.style.fontWeight="bold";var p=gEcnu.Util.createDiv("_printMapDiv",t,i,!1);p.style.position="relative",p.style.top="25px",p.style.margin="0 auto",p.style.border="1px solid #555";var d=document.createElement("img"),f=gEcnu.Util.createCanvas("canvas2Drawing",t,i,!0),y=gEcnu.Util.createDiv("tmpImgContainer",t,i,!0),v=d.cloneNode(),m=f.getContext("2d");this._dynctx=m,this.cavasImg_export=v,this.cavas=f,this.imgDiv=y,this.printDiv=h;var E=gEcnu.Util.createDiv("_legendDiv",114,460,!0);E.style.backgroundColor="rgba(255,255,255,0.6)",E.style.left="2px",E.style.top="2px";var _=d.cloneNode();_.src="imgs/legend_print.png",E.style.zIndex="11111",E.appendChild(_),p.appendChild(E),y.style.display="block",y.style.left="0px",y.style.top="0px",f.style.left="0px",f.style.top="0px",v.style.position="absolute",v.style.left="0px",v.style.top="0px",v.id="export_img",v.style.width=t+"px",v.style.height=i+"px",v.style.zIndex=100,p.appendChild(y),p.appendChild(f),p.appendChild(v);var S=gEcnu.Util.createDiv("_scaleDiv",200,30,!1);S.innerHTML="比例尺  1:"+this.printScale,S.style.marginLeft="50px",S.style.marginTop="35px",S.style.fontSize="1em",S.style.fontWeight="bold",S.style.color="#333";var x=gEcnu.Util.createDiv("_infoDiv",500,30,!0),b=gEcnu.Util.getTimeInfo(),w=b.year,L=b.month,M=b.day;x.innerHTML="上海市农用地综合管理平台\n\n  "+w+"年"+L+"月"+M+"日",x.style.bottom="5px",x.style.right="50px",x.style.fontSize="1em",x.style.fontWeight="bold",x.style.color="#333",h.appendChild(u),h.appendChild(p),h.appendChild(S),h.appendChild(x),e.appendChild(h),o.onclick=function(){e.style.display="none"},s.onclick=function(){$("#_printDiv").jqprint(),l.onclick=null,s.onclick=null,o.onclick=null,n.outerDiv.style.display="none"},t*i>4e6&&(l.disabled="disabled"),l.onclick=function(){var e=n.cavas.toDataURL("image/png");n._downloadScaleImg(e),n.outerDiv.style="none"}},_reqImageByScale:function(e,t,i){var n=this,r=this.webMapURL;try{gEcnu.Util.ajax("get",r,e,!0,function(t){if(t=JSON.parse(t),!t.mapURL)return void alert("地图请求失败！");var r=(e.lyrs.toLowerCase(),t.visibleLayers.toLowerCase(),parseInt(e.zoom,10),parseInt(t.mapZoom,10),Math.round(e.cx),Math.round(e.cy),Math.round(t.centerX)),a=Math.round(t.centerY),s=n.getFitedImg(i,r,a);s.src=n.dynFileServer+t.mapURL,s.onload=function(){if(n.dynImgCount++,n.dynImgCount>=n.totalDynImgNum){n.drawImageOnCavs(n._dynctx,i);var e=n.cavas.toDataURL("image/png");e.replace("image/png","image/octet-stream");n.cavasImg_export.setAttribute("crossOrigin","anonymous"),n.cavasImg_export.src=e}}})}catch(a){}},_downloadScaleImg:function(e){var t=document.createElement("a");t.href=e,t.download=this._printTitle+".png",t.click()},getFitedImg:function(e,t,i){for(var n=e.getElementsByTagName("img"),r=0,a=n.length;a>r;r++){var s=n[r],o=s.getAttribute("cx"),l=s.getAttribute("cy");if(Math.abs(o-t)<5&&Math.abs(l-i)<5)return s}},drawImageOnCavs:function(e,t){for(var i=t.getElementsByTagName("img"),n=0,r=i.length;r>n;n++){var a=i[n],s=gEcnu.Util.delpx(gEcnu.Util.getEleStyle(a,"left")),o=gEcnu.Util.delpx(gEcnu.Util.getEleStyle(a,"top"));e.drawImage(a,s,o)}}}),gEcnu.Layer=gClass.extend({init:function(e,t){this.id=e,this.visible=!0,this.options={opacity:1,zIndex:0}},onAdd:function(e){this._map=e,this._container=e.getContainer();var t=e.getSize();this._initLayerContainer(this.id,t.w,t.h),this._initProp(e),this._initParams(e),this._container.appendChild(this._layerContainer),this.setzIndex(),this.setOpacity(this.options.opacity)},onRemove:function(e){var t=e.getContainer();t.removeChild(this._layerContainer)},_initProp:function(e){},_initParams:function(e){},onDrag:function(e,t){this._layerContainer.style.left=this.startLeft+e+"px",this._layerContainer.style.top=this.startTop+t+"px"},zoomIn:function(){this.renew()},zoomOut:function(){this.renew()},zoomTo:function(){this.renew()},renew:function(){this._layerContainer.style.left="0px",this._layerContainer.style.top="0px"},show:function(){this.zoomTo(),this._layerContainer.style.display="block",this.visible=!0},hide:function(){this._layerContainer.style.display="none",this.visible=!1},getSize:function(){return{w:this._layerContainer.clientWidth,h:this._layerContainer.clientHeight}},getScreenCenter:function(){return{x:parseInt(this._layerContainer.clientWidth/2),y:parseInt(this._layerContainer.clientHeight/2)}},getMap:function(){return this._map},getLayerContainer:function(){return this._layerContainer},setzIndex:function(){isNaN(this.options.zIndex)||(this._layerContainer.style.zIndex=this.options.zIndex)},setOpacity:function(e){this.getLayerContainer().style.opacity=e},resize:function(){this._layerContainer.style.width=this._map.w+"px",this._layerContainer.style.height=this._map.h+"px"}}),gEcnu.Layer.Dyn=gEcnu.Layer.extend({init:function(e,t,i,n){this._super(t,n),this.options={zIndex:4},this.lyrStr=i,this.ws=e,this.oClass="dynLayer"},_initParams:function(e){var t=e.getCenter(),i=e.getZoom(),n=e.getSize();this.webMapURL=e.webMapURL,this.fileServer=e.dynFileServer,this._params={map:this.ws,w:n.w,h:n.h,mt:"zoomto",cx:t.x,cy:t.y,zoom:i.z,"return":"json",lyrs:""}},_initProp:function(e){var t=e.getSize();this._mapImg=new Image,this.img_copy=new Image,this._layerContainer.appendChild(this._mapImg),this._mapImg.width=t.w,this._mapImg.height=t.h,this.ctrlLyrs=[],this.mapUrl=null,this.startLeft=0,this.startTop=0,this.requestTimer=null,this.ifInit=!0,this.refreshFlag=!1},_initLayerContainer:function(e,t,i){var n=gEcnu.Util.createDiv(e,t,i,!0);n.style.zIndex=2,this._layerContainer=n},onAdd:function(e){e.ownDyn=!0,this._super(e),this.addLyr(this.lyrStr);var t=function(e){var t=e._map.mapTool;"pan"==t&&(e.img_copy.onload=null)};gEcnu.Layer.Dyn._removeDynLoad=t},addLyr:function(e,t){t&&(this.ctrlLyrs=["empty"]);for(var i=e.split(","),n=0;n<i.length;n++){var r=this.ctrlLyrs.indexOf(i[n]);0>r&&this.ctrlLyrs.push(i[n])}this._params.lyrs=this.ctrlLyrs.join(","),this._params.mt="zoomto",t&&(this._params.lyrs="empty,"+e),this._request(this._params)},removeLyr:function(e){for(var t=e.split(","),i=0;i<t.length;i++){var n=this.ctrlLyrs.indexOf(t[i]);if(n>=0){for(var r=n;r<this.ctrlLyrs.length-1;r++)this.ctrlLyrs[r]=this.ctrlLyrs[r+1];this.ctrlLyrs.length--}}this._params.lyrs=this.ctrlLyrs.join(","),this._params.mt="zoomto",this._request(this._params)},zoomIn:function(e){var t=this._params;t.zoom=t.zoom/2,this.scaleMap("zoomin",e),this.renew()},zoomOut:function(e){var t=this._params;t.zoom=2*t.zoom,this.scaleMap("zoomout",e),this.renew()},zoomTo:function(){this._params.zoom=this._map.zoom,this._params.cx=this._map.cx,this._params.cy=this._map.cy,this.renew()},scaleMap:function(e,t){var i=this._layerContainer;"undefined"==typeof t&&(t=this.getScreenCenter());var n=t.x,r=t.y,a=n+"px "+r+"px";i.style.webkitTransformOrigin=a,i.style.transformOrigin=a,i.style.transition="transform 100ms ease-in-out",i.style.transition="-webkit-transform 100ms ease-in-out","zoomin"==e&&(i.style.transform="scale(2,2)",i.style.webkitTransform="scale(2,2)"),"zoomout"==e&&(i.style.transform="scale(0.5,0.5)",i.style.webkitTransform="scale(0.5,0.5)")},renew:function(){this._params.cx=this._map.cx,this._params.cy=this._map.cy,this._params.zoom=this._map.zoom;var e=this;e.requestTimer&&clearTimeout(e.requestTimer),e.requestTimer=setTimeout(function(){e._request(e._params)},250)},resize:function(){this._super();var e=(this.getMap(),this.getSize());this._mapImg.width=e.w,this._mapImg.height=e.h,this._params.w=e.w,this._params.h=e.h,this._params.zoom="",this.renew()},getAllVisibleLyrs:function(){return this.ctrlLyrs},refresh:function(){this.refreshFlag=!0,this._params.clearmap=this.ws,this._request(this._params)},_request:function(e){var t=this,i=this.webMapURL,n=this._layerContainer;try{gEcnu.Util.ajax("get",i,e,!0,function(i){if(t.refreshFlag=!1,t._params.clearmap&&(t._params.clearmap="",delete t._params.clearmap),i=JSON.parse(i),!i.mapURL)return void gSelf._dynError_EX(i);var r=e.lyrs.toLowerCase().replace(/(^\s+)|(\s+$)/g,""),a=i.visibleLayers.toLowerCase().replace(/(^\s+)|(\s+$)/g,""),s=parseInt(e.zoom,10),o=parseInt(i.mapZoom,10),l=Math.round(e.cx),c=Math.round(e.cy),g=Math.round(i.centerX),h=Math.round(i.centerY);if(s==o&&l==g&&c==h&&r==a){if(gSelf.dragging)return;t.img_copy&&(t.img_copy.onload=null);var u=new Image,p=t.getSize();u.style.width=p.w+"px",u.style.height=p.h+"px",u.width=p.w,u.height=p.h,u.style.position="absolute",u.style.left="0px",u.style.top="0px",u.style.zIndex="10",t.img_copy=u,t.img_copy.onload=function(){n.removeChild(t._mapImg),n.style.left="0px",n.style.top="0px",n.appendChild(u),t._mapImg=u,n.style.transform="scale(1,1)",n.style.webkitTransform="scale(1,1)",n.style.transition="transform 0ms ease-in-out",n.style.transition="-webkit-transform 0ms ease-in-out"},u.src=t.fileServer+i.mapURL}})}catch(r){
alert("出现异常在："+r)}}}),gEcnu.Layer.Tile=gEcnu.Layer.extend({init:function(e,t,i){this._super(e,i),this.options={opacity:1,zIndex:3},this.tileName=t?t:"shImg2012a",this.oClass="tileLayer"},_initLayerContainer:function(e,t,i){var n=gEcnu.Util.createDiv(e,t,i,!0);this._layerContainer=n},_initMapView:function(e,t){var i=new Date-0;this.mapView=document.createElement("div"),this.mapView.id="mapView_"+i,this.mapView.width=this.w,this.mapView.height=this.h,this.mapView.style.position="absolute",this.mapView.style.top="0px",this.mapView.style.left="0px",this.mapView.style.width=e+"px",this.mapView.style.height=t+"px",this.mapView.style.overflow="hidden",this.mapView.style.zIndex=1,this.baseMap=document.createElement("div"),this.baseMap.id="baseMap"+i,this.baseMap.style.position="absolute",this.baseMap.style.left=this.xOffset+"px",this.baseMap.style.top=this.yOffset+"px",this.baseMap.style.width=this.nWidth*this.tileWidth+"px",this.baseMap.style.height=this.nHeight*this.tileHeight+"px",this.baseMap.style.zIndex=2,this.baseBgMap=this.baseMap.cloneNode(),this.baseBgMap.id="baseBgMap"+i,this.mapView.appendChild(this.baseMap),this.mapView.appendChild(this.baseBgMap),this._layerContainer.appendChild(this.mapView),this.baseBgMap.style.zIndex=1},_initParams:function(e){var t=e.getSize(),i=e.getCenter(),n=e.getZoom(),r=this.tileName;this._params={req:"getmap",w:t.w,h:t.h,zl:n.zl,cx:i.x,cy:i.y,"return":"json",map:r}},_initProp:function(e){this.mapLeft=this._container.offsetLeft,this.mapTop=this._container.offsetTop,this.startLeft=0,this.startTop=0,this.xOffset=-100,this.yOffset=-100,this.xMinus=0,this.yMinus=0,this.imgURL=gEcnu.config.imgPath+"blank.png",this.hasImgURL=[],this.tileWidth=e.tileWidth,this.tileHeight=e.tileHeight;var t=e.getSize();this.nWidth=Math.ceil(parseInt(t.w)/e.tileWidth)+1,this.nHeight=Math.ceil(parseInt(t.h)/e.tileHeight)+1,this.tileMapURL=e.tileMapURL,this.fileServer=e.fileServer,this.mapTool="pan",this.ifInit=!1,this.ifZoomTo=!1,this.requestTimer=null;var t=this.getMap().getSize();this._initMapView(t.w,t.h)},onAdd:function(e){e.ownTile=!0,e.tileCount++,this._super(e),this._createTiles(),this.ifInit=!0,this._request(this._params)},onRemove:function(e){this._super(e),e.tileCount--},onDrag:function(e,t){this.visible&&(this.baseMap.style.left=this.startLeft+e+"px",this.baseMap.style.top=this.startTop+t+"px")},_panMap:function(){for(this.hideLayer("baseMap");this.xOffset>0;)this.wrapR2L();for(;this.yOffset>0;)this.wrapB2T();for(;this.xOffset<-this.tileWidth;)this.wrapL2R();for(;this.yOffset<-this.tileHeight;)this.wrapT2B();this.showLayer("baseMap")},zoomIn:function(e){this.mapTool="zoomin",this.ifzoominOrout=!0,this.scaleMap(e),this.renew()},zoomOut:function(e){this.mapTool="zoomout",this.ifzoominOrout=!0,this.scaleMap(e),this.renew()},zoomTo:function(){this.ifZoomTo=!0,this._params.zl=this._map.zl,this._params.cx=this._map.cx,this._params.cy=this._map.cy,this._resetTile(),this.renew(),this.mapTool="pan"},scaleMap:function(e){this.hideLayer("baseMap");var t,i,n=this.getScreenCenter(),r=this.baseBgMap,a=this.baseMap.childNodes.length;"undefined"==typeof e?(t=n.x-this.xMinus,i=n.y-this.yMinus):(t=e.x-this.xMinus,i=e.y-this.yMinus);var s=(this.tileWidth*this.nWidth/2,this.tileHeight*this.nHeight/2,t+"px "+i+"px");r.style.webkitTransformOrigin=s,r.style.transformOrigin=s;var a=this.baseMap.childNodes.length,o=0,l=0;r.style.left=this.xMinus+"px",r.style.top=this.yMinus+"px";for(var c=0;a>c;c++){var g=this.baseMap.childNodes[0];if(0==c)o=gEcnu.Util.delpx(g.style.left),l=gEcnu.Util.delpx(g.style.top),g.style.left="0px",g.style.top="0px";else{var h=gEcnu.Util.delpx(g.style.left)-o+"px",u=gEcnu.Util.delpx(g.style.top)-l+"px";g.style.left=h,g.style.top=u}r.appendChild(g)}"zoomin"==this.mapTool&&(r.style.transform="scale(2,2)",r.style.webkitTransform="scale(2,2)"),"zoomout"==this.mapTool&&(r.style.transform="scale(0.5,0.5)",r.style.webkitTransform="scale(0.5,0.5)"),r.style.transition="transform 100ms ease-in-out",r.style.transition="-webkit-transform 100ms ease-in-out"},renew:function(){this._params.cx=this._map.cx,this._params.cy=this._map.cy,this._params.zl=this._map.zl,"pan"==this.mapTool&&(this.ifzoominOrout=!1,this._panMap());var e=this;e.requestTimer&&clearTimeout(e.requestTimer),e.requestTimer=setTimeout(function(){e._request(e._params)},250)},resize:function(){this._super();var e=this.getMap(),t=e.getSize();this.nWidth=Math.ceil(parseInt(t.w)/e.tileWidth)+1,this.nHeight=Math.ceil(parseInt(t.h)/e.tileHeight)+1,this.mapView.style.width=t.w+"px",this.mapView.style.height=t.h+"px",this.baseMap.style.width=this.baseBgMap.style.width=this.nWidth*this.tileWidth+"px",this.baseMap.style.height=this.baseBgMap.style.height=this.nHeight*this.tileHeight+"px",this._params.w=t.w,this._params.h=t.h;for(var i=this.baseMap.childNodes.length-1;i>=0;i--){var n=this.baseMap.childNodes[i];this.baseMap.removeChild(n),n=null}this.ifZoomTo=!0,this._createTiles(),this.renew()},_request:function(e){var t=this,i=this.tileMapURL;try{var n=!1;n=this.ifInit?!1:!0,gEcnu.Util.ajax("get",i,e,n,function(e){e=JSON.parse(e),t._showMap(e)})}catch(r){alert("出现异常在："+r)}},_showMap:function(e){function t(){var d=r*a;if(h>=s||h>=d)return void(i.mapTool="pan");var f=e.tiles[h].row,y=e.tiles[h].col;if(a>=f&&r>=y){var v=(f-1)*r+(y-1),m=n.childNodes[v],E=e.tiles[h].url,_=E.split("/")[2],S=_.substr(1,_.length-1),x=this.tileWidth*this.nWidth/2,b=this.tileHeight*this.nHeight/2;if("undefined"!=typeof m&&S==i._params.zl&&o==c&&g==l){var w=i.fileServer+E;void 0!=p[f+"_"+y]?"pan"!=i.mapTool&&u++:p[f+"_"+y]=!0,m.src=w,m.onerror=function(){m.src=gEcnu.config.imgPath+"blank.png"},m.onload=function(){u++;var e=r*a;if(u==s||u==e){var t=i.baseBgMap;t.style.left=i.baseMap.style.left,t.style.top=i.baseMap.style.top,i.showLayer("baseMap");for(var n=t.childNodes.length;n>0;n--){var o=t.childNodes[n-1];t.removeChild(o),o=null}t.style.webkitTransform="scale(1,1)",t.style.transform="scale(1,1)";var l=x+"px "+b+"px";t.style.webkitTransformOrigin=l,t.style.transformOrigin=l,t.style.transition="transform 10ms ease-in-out",t.style.transition="-webkit-transform 10ms ease-in-out"}},i.hasImgURL[m.id]=!0}}h++,t()}var i=this,n=this.baseMap,r=this.nWidth,a=this.nHeight;this.xMinus=e.tileInfo.xoff,this.yMinus=e.tileInfo.yoff,(this.ifInit||this.ifZoomTo||this.ifzoominOrout)&&(this.xOffset=e.tileInfo.xoff,this.yOffset=e.tileInfo.yoff,n.style.left=this.xOffset+"px",n.style.top=this.yOffset+"px",(this.ifInit||this.ifZoomTo)&&(this.ifZoomTo=!1,this._map.setZoom(e.tileInfo.zoom))),this.ifInit&&(this.baseBgMap.style.left=n.style.left,this.baseBgMap.style.top=n.style.top,this.ifInit=!1),this.ifzoominOrout&&this._resetTile();var s=e.tiles.length,o=parseInt(e.tileInfo.cx,10),l=parseInt(e.tileInfo.cy,10),c=parseInt(this._params.cx,10),g=parseInt(this._params.cy,10),h=0,u=0,p=(e.tiles,i.baseBgMap,this.tileWidth*this.nWidth/2,this.tileHeight*this.nHeight/2,{});t()},_resetTile:function(){for(var e=this.baseMap,t=e.childNodes.length;t>0;t--){var i=e.childNodes[t-1];e.removeChild(i),i=null}this._createTiles()},_createTiles:function(){for(var e,t,i=this.nWidth*this.nHeight,n=0;i>n;n++){var r=document.createElement("img");r.id="mt_"+n,r.src=this.imgURL,this.hasImgURL[r.id]=!1,r.style.position="absolute",t=Math.floor(n/this.nWidth)*this.tileHeight,e=Math.floor(n%this.nWidth)*this.tileWidth,r.style.left=e+"px",r.style.top=t+"px",r.style.width=this.tileWidth+"px",r.style.height=this.tileHeight+"px",this.baseMap.appendChild(r)}},wrapR2L:function(){this.xOffset=this.xOffset-this.tileWidth;var e=this.baseMap;if(void 0!=e.childNodes[0])for(var t=gEcnu.Util.delpx(e.childNodes[0].style.left),i=0;i<this.nHeight;i++){var n=e.childNodes[(i+1)*this.nWidth-1],r=e.childNodes[i*this.nWidth];n.style.left=t-this.tileWidth+"px",n.src=this.imgURL,e.removeChild(n),e.insertBefore(n,r),this.hasImgURL[n.id]=!1}},wrapL2R:function(){this.xOffset=this.xOffset+this.tileWidth;var e=this.baseMap;if(void 0!=e.childNodes[this.nWidth-1])for(var t=gEcnu.Util.delpx(e.childNodes[this.nWidth-1].style.left),i=0;i<this.nHeight;i++){var n,r=e.childNodes[i*this.nWidth];n=i<this.nHeight-1?e.childNodes[(i+1)*this.nWidth]:null,r.style.left=t+this.tileWidth+"px",r.src=this.imgURL,e.removeChild(r),n?e.insertBefore(r,n):e.appendChild(r),this.hasImgURL[r.id]=!1}},wrapT2B:function(){this.yOffset=this.yOffset+this.tileHeight;var e=this.baseMap;if(void 0!=e.childNodes[this.nHeight*this.nWidth-1])for(var t=gEcnu.Util.delpx(e.childNodes[this.nHeight*this.nWidth-1].style.top),i=0;i<this.nWidth;i++){var n=e.childNodes[0];n.style.top=t+this.tileHeight+"px",n.src=this.imgURL,e.removeChild(n),e.appendChild(n),this.hasImgURL[n.id]=!1}},wrapB2T:function(){this.yOffset=this.yOffset-this.tileHeight;var e=this.baseMap;if(void 0!=e.childNodes[0])for(var t=gEcnu.Util.delpx(e.childNodes[0].style.top),i=0;i<this.nWidth;i++){var n=e.childNodes[this.nHeight*this.nWidth-1];n.style.top=t-this.tileHeight+"px",n.src=this.imgURL,e.removeChild(n),e.insertBefore(n,e.childNodes[0]),this.hasImgURL[n.id]=!1}},showLayer:function(e){switch(e){case"baseMap":this.baseMap.style.display="block";break;case"bgMap":this.baseBgMap.style.display="block"}},hideLayer:function(e){switch(e){case"baseMap":this.baseMap.style.display="none";break;case"bgMap":this.baseBgMap.style.display="none"}}}),gEcnu.Layer.Tile_Ex=gEcnu.Layer.extend({init:function(e,t,i){this._super(e,i),this.options={opacity:1,zIndex:3},this.tileName=t,this.oClass="tileLayer",this.minLevel=14,this.maxLevel=21,i&&(this.minLevel=i.minLevel||14,this.maxLevel=i.maxLevel||21)},_initLayerContainer:function(e,t,i){var n=gEcnu.Util.createDiv(e,t,i,!0);this._layerContainer=n},_initMapView:function(e,t){var i=new Date-0;this.mapView=document.createElement("div"),this.mapView.id="mapView_"+i,this.mapView.width=this.w,this.mapView.height=this.h,this.mapView.style.position="absolute",this.mapView.style.top="0px",this.mapView.style.left="0px",this.mapView.style.width=e+"px",this.mapView.style.height=t+"px",this.mapView.style.overflow="hidden",this.mapView.style.zIndex=1,this.baseMap=document.createElement("div"),this.baseMap.id="baseMap"+i,this.baseMap.style.position="absolute",this.baseMap.style.left=this.xOffset+"px",this.baseMap.style.top=this.yOffset+"px",this.baseMap.style.width=this.nWidth*this.tileWidth+"px",this.baseMap.style.height=this.nHeight*this.tileHeight+"px",this.baseMap.style.zIndex=2,this.baseBgMap=this.baseMap.cloneNode(),this.baseBgMap.id="baseBgMap"+i,this.mapView.appendChild(this.baseMap),this.mapView.appendChild(this.baseBgMap),this._layerContainer.appendChild(this.mapView),this.baseBgMap.style.zIndex=1},_initParams:function(e){var t=e.getSize(),i=e.getCenter(),n=e.getZoom(),r=this.tileName;this._params={req:"getmap",w:t.w,h:t.h,zl:n.zl+17,cx:i.x,cy:i.y,"return":"json",map:r},this.zl=this._params.zl},_initProp:function(e){this.mapLeft=this._container.offsetLeft,this.mapTop=this._container.offsetTop,this.startLeft=0,this.startTop=0,this.xOffset=-100,this.yOffset=-100,this.xMinus=0,this.yMinus=0,this.imgURL=gEcnu.config.imgPath+"blank.png",this.hasImgURL=[],this.tileWidth=e.tileWidth,this.tileHeight=e.tileHeight;var t=e.getSize();this.mapSize=t,this.nWidth=Math.ceil(parseInt(t.w)/e.tileWidth)+1,this.nHeight=Math.ceil(parseInt(t.h)/e.tileHeight)+1,this.tileMapURL="https://ccgis.cn/mapb/webtilemap",this.fileServer="https://ccgis.cn/mapb/fileServer?fn=map/",this.mapTool="pan",this.ifInit=!1,this.ifZoomTo=!1,this.requestTimer=null;var t=this.getMap().getSize();this._initMapView(t.w,t.h)},onAdd:function(e){e.ownTile=!0,e.tileCount++,this._super(e),this.createTileFlag=!0,this.ifInit=!0,this._request(this._params)},onRemove:function(e){this._super(e),e.tileCount--},onDrag:function(e,t){this.visible&&(this.baseMap.style.left=this.startLeft+e+"px",this.baseMap.style.top=this.startTop+t+"px")},_panMap:function(){for(this.hideLayer("baseMap");this.xOffset>0;)this.wrapR2L();for(;this.yOffset>0;)this.wrapB2T();for(;this.xOffset<-this.tileWidth;)this.wrapL2R();for(;this.yOffset<-this.tileHeight;)this.wrapT2B();this.showLayer("baseMap")},zoomIn:function(e){this.mapTool="zoomin",this.ifzoominOrout=!0,this.scaleMap(e),this.renew()},zoomOut:function(e){this.mapTool="zoomout",this.ifzoominOrout=!0,this.scaleMap(e),this.renew()},zoomTo:function(){this.ifZoomTo=!0,this._params.zl=this._map.zl+17,this._params.cx=this._map.cx,this._params.cy=this._map.cy,this._resetTile(),this.renew(),this.mapTool="pan"},scaleMap:function(e){this.hideLayer("baseMap");var t,i,n=this.getScreenCenter(),r=this.baseBgMap,a=this.baseMap.childNodes.length;"undefined"==typeof e?(t=n.x-this.xMinus,i=n.y-this.yMinus):(t=e.x-this.xMinus,i=e.y-this.yMinus);var s=(this.tileWidth*this.nWidth/2,this.tileHeight*this.nHeight/2,t+"px "+i+"px");r.style.webkitTransformOrigin=s,r.style.transformOrigin=s;var a=this.baseMap.childNodes.length,o=0,l=0;r.style.left=this.xMinus+"px",r.style.top=this.yMinus+"px";for(var c=0;a>c;c++){var g=this.baseMap.childNodes[0];if(0==c)o=gEcnu.Util.delpx(g.style.left),l=gEcnu.Util.delpx(g.style.top),g.style.left="0px",g.style.top="0px";else{var h=gEcnu.Util.delpx(g.style.left)-o+"px",u=gEcnu.Util.delpx(g.style.top)-l+"px";g.style.left=h,g.style.top=u}r.appendChild(g)}"zoomin"==this.mapTool&&(r.style.transform="scale(2,2)",r.style.webkitTransform="scale(2,2)"),"zoomout"==this.mapTool&&(r.style.transform="scale(0.5,0.5)",r.style.webkitTransform="scale(0.5,0.5)"),r.style.transition="transform 100ms ease-in-out",r.style.transition="-webkit-transform 100ms ease-in-out"},renew:function(){this._params.cx=this._map.cx,this._params.cy=this._map.cy,this._params.zl=this._map.zl+17,"pan"==this.mapTool&&(this.ifzoominOrout=!1,this._panMap());var e=this;e.requestTimer&&clearTimeout(e.requestTimer),e.requestTimer=setTimeout(function(){e._request(e._params)},250)},resize:function(){this._super();var e=this.getMap(),t=e.getSize();this.nWidth=Math.ceil(parseInt(t.w)/this.tileWidth)+1,this.nHeight=Math.ceil(parseInt(t.h)/this.tileHeight)+1,this.mapView.style.width=t.w+"px",this.mapView.style.height=t.h+"px",this.baseMap.style.width=this.baseBgMap.style.width=this.nWidth*this.tileWidth+"px",this.baseMap.style.height=this.baseBgMap.style.height=this.nHeight*this.tileHeight+"px",this._params.w=t.w,this._params.h=t.h;for(var i=this.baseMap.childNodes.length-1;i>=0;i--){var n=this.baseMap.childNodes[i];this.baseMap.removeChild(n),n=null}this.ifZoomTo=!0,this._createTiles(),this.renew()},_request:function(e){var t=this,i=this.tileMapURL;try{var n=!1;n=this.ifInit?!1:!0,e.zl<=this.maxLevel&&e.zl>=this.minLevel&&gEcnu.Util.ajax("get",i,e,n,function(e){e=JSON.parse(e),t.resetTileInfo(e),t._showMap(e)})}catch(r){alert("出现异常在："+r)}},resetTileInfo:function(e){this.tileWidth="undefined"==typeof e.tileInfo.tileWidth?this.tileWidth:e.tileInfo.tileWidth,this.tileHeight="undefined"==typeof e.tileInfo.tileHeight?this.tileHeight:e.tileInfo.tileHeight;var t=this.mapSize;this.nWidth=Math.ceil(parseInt(t.w)/this.tileWidth)+1,this.nHeight=Math.ceil(parseInt(t.h)/this.tileHeight)+1,this.baseMap.style.width=this.nWidth*this.tileWidth+"px",this.baseMap.style.height=this.nHeight*this.tileHeight+"px",this.baseBgMap.style.width=this.nWidth*this.tileWidth+"px",this.baseBgMap.style.height=this.nHeight*this.tileHeight+"px",this.createTileFlag&&(this._createTiles(),this.createTileFlag=!1)},_showMap:function(e){function t(){var g=r*a;if(o>=s||o>=g)return void(i.mapTool="pan");var h=e.tiles[o].row,u=e.tiles[o].col;if(a>=h&&r>=u){var p=(h-1)*r+(u-1),d=n.childNodes[p],f=e.tiles[o].url,y=(f.split("/")[2],this.tileWidth*this.nWidth/2),v=this.tileHeight*this.nHeight/2;if("undefined"!=typeof d){var m=i.fileServer+f;void 0!=c[h+"_"+u]?"pan"!=i.mapTool&&l++:c[h+"_"+u]=!0,d.src=m,d.onerror=function(){d.src=gEcnu.config.imgPath+"blank.png"},d.onload=function(){l++;var e=r*a;if(l==s||l==e){var t=i.baseBgMap;t.style.left=i.baseMap.style.left,t.style.top=i.baseMap.style.top,i.showLayer("baseMap");for(var n=t.childNodes.length;n>0;n--){var o=t.childNodes[n-1];t.removeChild(o),o=null}t.style.webkitTransform="scale(1,1)",t.style.transform="scale(1,1)";var c=y+"px "+v+"px";t.style.webkitTransformOrigin=c,t.style.transformOrigin=c,t.style.transition="transform 10ms ease-in-out",t.style.transition="-webkit-transform 10ms ease-in-out"}},i.hasImgURL[d.id]=!0}}o++,t()}var i=this,n=this.baseMap,r=this.nWidth,a=this.nHeight;this.xMinus=e.tileInfo.xoff,this.yMinus=e.tileInfo.yoff,(this.ifInit||this.ifZoomTo||this.ifzoominOrout)&&(this.xOffset=e.tileInfo.xoff,this.yOffset=e.tileInfo.yoff,n.style.left=this.xOffset+"px",n.style.top=this.yOffset+"px",(this.ifInit||this.ifZoomTo)&&(this.ifZoomTo=!1,this._map.setZoom(e.tileInfo.zoom))),this.ifInit&&(this.baseBgMap.style.left=n.style.left,this.baseBgMap.style.top=n.style.top,this.ifInit=!1),this.ifzoominOrout&&this._resetTile();var s=e.tiles.length,o=(parseInt(e.tileInfo.cx,10),parseInt(e.tileInfo.cy,10),parseInt(this._params.cx,10),parseInt(this._params.cy,10),0),l=0,c=(e.tiles,i.baseBgMap,this.tileWidth*this.nWidth/2,this.tileHeight*this.nHeight/2,{});t()},_resetTile:function(){for(var e=this.baseMap,t=e.childNodes.length;t>0;t--){var i=e.childNodes[t-1];e.removeChild(i),i=null}this._createTiles()},_createTiles:function(){for(var e,t,i=this.nWidth*this.nHeight,n=0;i>n;n++){var r=document.createElement("img");r.id="mt_"+n,r.src=this.imgURL,this.hasImgURL[r.id]=!1,r.style.position="absolute",t=Math.floor(n/this.nWidth)*this.tileHeight,e=Math.floor(n%this.nWidth)*this.tileWidth,r.style.left=e+"px",r.style.top=t+"px",r.style.width=this.tileWidth+"px",r.style.height=this.tileHeight+"px",this.baseMap.appendChild(r)}},wrapR2L:function(){this.xOffset=this.xOffset-this.tileWidth;var e=this.baseMap;if(void 0!=e.childNodes[0])for(var t=gEcnu.Util.delpx(e.childNodes[0].style.left),i=0;i<this.nHeight;i++){var n=e.childNodes[(i+1)*this.nWidth-1],r=e.childNodes[i*this.nWidth];n.style.left=t-this.tileWidth+"px",n.src=this.imgURL,e.removeChild(n),e.insertBefore(n,r),this.hasImgURL[n.id]=!1}},wrapL2R:function(){this.xOffset=this.xOffset+this.tileWidth;var e=this.baseMap;if(void 0!=e.childNodes[this.nWidth-1])for(var t=gEcnu.Util.delpx(e.childNodes[this.nWidth-1].style.left),i=0;i<this.nHeight;i++){var n,r=e.childNodes[i*this.nWidth];n=i<this.nHeight-1?e.childNodes[(i+1)*this.nWidth]:null,r.style.left=t+this.tileWidth+"px",r.src=this.imgURL,e.removeChild(r),n?e.insertBefore(r,n):e.appendChild(r),this.hasImgURL[r.id]=!1}},wrapT2B:function(){this.yOffset=this.yOffset+this.tileHeight;var e=this.baseMap;if(void 0!=e.childNodes[this.nHeight*this.nWidth-1])for(var t=gEcnu.Util.delpx(e.childNodes[this.nHeight*this.nWidth-1].style.top),i=0;i<this.nWidth;i++){var n=e.childNodes[0];n.style.top=t+this.tileHeight+"px",n.src=this.imgURL,e.removeChild(n),e.appendChild(n),this.hasImgURL[n.id]=!1}},wrapB2T:function(){this.yOffset=this.yOffset-this.tileHeight;var e=this.baseMap;if(void 0!=e.childNodes[0])for(var t=gEcnu.Util.delpx(e.childNodes[0].style.top),i=0;i<this.nWidth;i++){var n=e.childNodes[this.nHeight*this.nWidth-1];n.style.top=t-this.tileHeight+"px",n.src=this.imgURL,e.removeChild(n),e.insertBefore(n,e.childNodes[0]),this.hasImgURL[n.id]=!1}},showLayer:function(e){switch(e){case"baseMap":this.baseMap.style.display="block";break;case"bgMap":this.baseBgMap.style.display="block"}},hideLayer:function(e){switch(e){case"baseMap":this.baseMap.style.display="none";break;case"bgMap":this.baseBgMap.style.display="none"}}}),gEcnu.Layer.Other=gEcnu.Layer.extend({init:function(e,t,i){this._super(e,i),this.options={opacity:1,zIndex:2},this.options=gEcnu.Util.setOptions(this,i),this.mapSource=t,this.oClass="otherLayer";this.oMap=null},_initLayerContainer:function(e,t,i){var n=gEcnu.Util.createDiv(e,t,i,!0);this._layerContainer=n,gSelf.activeLayer=this},onAdd:function(e){e.ownOther=!0,this._map=e,this._super(e),this.oMapMinlevel=1,this.oMapMaxLevel=18;var t=document.createElement("script");this.initPxScale(this.mapSource);var i=this._isExistScript();if(i)return void showOtherMap_self();switch(this.mapSource){case"google":t.src="http://maps.googleapis.com/maps/api/js?sensor=false&callback=showOtherMap_self";break;case"baidu":t.src="http://api.map.baidu.com/api?v=1.4&callback=showOtherMap_self",this.oMapMaxLevel=19;break;case"tianditu":t.src="http://api.tianditu.com/js/maps.js",t.onload=showOtherMap_self;break;case"bingmap":t.src="http://ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=7.0&mkt=en-us",t.onload=setTimeout(function(){showOtherMap_self()},3e3)}document.getElementsByTagName("head")[0].appendChild(t)},initPxScale:function(e){switch(e){case"google":this.otherPxScale=.001373291015625;break;case"baidu":this.otherPxScale=.0011498312500000019,this.oMapMaxLevel=19;break;case"tianditu":this.otherPxScale=.0013767249999999897;break;case"bingmap":this.otherPxScale=.001373291015625,this.oMapMaxLevel=20}},_isExistScript:function(){var e=document.getElementsByTagName("head")[0].getElementsByTagName("script"),t="";switch(this.mapSource){case"google":t="http://maps.googleapis.com/maps/api/js?sensor=false&callback=showOtherMap_self";break;case"tianditu":t="http://api.tianditu.com/js/maps.js";break;case"baidu":t="http://api.map.baidu.com/api?v=1.4&callback=showOtherMap_self";break;case"bingmap":t="http://ecn.dev.virtualearth.net/mapcontrol/v7.0/7.0.20150610192009.20/js/en-us/veapicore.js"}for(var i=0,n=e.length;n>i;i++){var r=e[i].src;if(t==r)return!0}return!1},zoomIn:function(){this.renew()},zoomOut:function(){this.renew()},zoomTo:function(){this.renew()},setMapType:function(e){switch(this.mapSource){case"google":switch(e){case"ROAD":this.oMap.setMapTypeId(google.maps.MapTypeId.ROADMAP);break;case"SATELLITE":this.oMap.setMapTypeId(google.maps.MapTypeId.SATELLITE);break;case"HYBRID":this.oMap.setMapTypeId(google.maps.MapTypeId.HYBRID)}break;case"baidu":switch(e){case"ROAD":this.oMap.setMapType(BMAP_NORMAL_MAP);break;case"SATELLITE":this.oMap.setMapType(BMAP_SATELLITE_MAP);break;case"HYBRID":this.oMap.setMapType(BMAP_HYBRID_MAP)}break;case"tianditu":switch(e){case"ROAD":this.oMap.setMapType(TMAP_NORMAL_MAP);break;case"SATELLITE":this.oMap.setMapType(TMAP_SATELLITE_MAP);break;case"HYBRID":this.oMap.setMapType(TMAP_HYBRID_MAP)}break;case"bingmap":switch(e){case"road":this.oMap.setMapType(Microsoft.Maps.MapTypeId.road);break;case"arial":this.oMap.setMapType(Microsoft.Maps.MapTypeId.aerial);break;case"birdseye":this.oMap.setMapType(Microsoft.Maps.MapTypeId.birdseye);break;case"collinsBart":this.oMap.setMapType(Microsoft.Maps.MapTypeId.collinsBart)}}},resize:function(){var e=this._map.getSize(),t=document.getElementById(this._layerContainer.id);t.style.width=e.w+"px",t.style.height=e.h+"px",this._layerContainer=t;var i=gSelf.coordsFlag;"GEOGRAPHIC"==i?this._resize_geo():this._resize_proj()},_resize_geo:function(){var e=gSelf.getCenter();switch(this.mapSource){case"google":this.oMap.setCenter(new google.maps.LatLng(e.y,e.x));break;case"baidu":this.oMap.setCenter(new BMap.Point(e.x,e.y));break;case"tianditu":this.oMap.setCenterAtLngLat(new TLngLat(e.x,e.y));break;case"bingmap":this.oMap.setView({center:new Microsoft.Maps.Location(e.x,e.y)})}},_resize_proj:function(){var e=gSelf.getCenter(),t=gEcnu.Util.shToLngLat(e.x,e.y);switch(this.mapSource){case"google":this.oMap.setCenter(new google.maps.LatLng(t.lat,t.lng));break;case"baidu":this.oMap.setCenter(new BMap.Point(t.lng,t.lat));break;case"tianditu":var t=gEcnu.Util.shToLngLat(e.x-370,e.y+230);this.oMap.setCenterAtLngLat(new TLngLat(t.lng,t.lat));break;case"bingmap":var t=gEcnu.Util.shToLngLat(e.x-370,e.y+230);this.oMap.setView({center:new Microsoft.Maps.Location(t.lat,t.lng)})}},renew:function(){this._super();var e=gSelf.coordsFlag;"GEOGRAPHIC"==e?this._renew_geo():this._renew_proj()},_renew_geo:function(){var e=this._map.getCenter(),t=this._map.getZoom(),i=this.mapSource,n=this.otherPxScale;console.log("gPxScale",n);var r=t.z;console.log("own level",t.zl);var a=n*gSelf.w;switch(i){case"google":this.oMap.setCenter(new google.maps.LatLng(e.y,e.x));var s=10-Math.log(r/a)/Math.log(2);this.oMap.setZoom(s);break;case"tianditu":var s=10-Math.log(r/a)/Math.log(2);this.oMap.centerAndZoom(new TLngLat(e.x,e.y),s);break;case"baidu":var s=11-Math.log(r/a)/Math.log(2);this.oMap.centerAndZoom(new BMap.Point(e.x,e.y),s);break;case"bingmap":var s=10-Math.log(r/a)/Math.log(2);this.oMap.setView({center:new Microsoft.Maps.Location(e.x,e.y),zoom:s})}},_renew_proj:function(){this._super();var e=this._map.getCenter(),t=this._map.getZoom(),i=gEcnu.Util.shToLngLat(e.x,e.y),n=this.mapSource;switch(n){case"google":this.oMap.setCenter(new google.maps.LatLng(i.lat,i.lng)),this.oMap.setZoom(18-t.zl);break;case"tianditu":var i=gEcnu.Util.shToLngLat(e.x-370,e.y+230);this.oMap.centerAndZoom(new TLngLat(i.lng,i.lat),18-t.zl);break;case"baidu":this.oMap.centerAndZoom(new BMap.Point(i.lng,i.lat),19-t.zl);break;case"bingmap":var i=gEcnu.Util.shToLngLat(e.x-370,e.y+230),r=new Microsoft.Maps.Location(i.lat,i.lng);this.oMap.setView({center:r,zoom:18-t.zl})}}}),gEcnu.Layer.Feature=gEcnu.Layer.extend({init:function(e,t,i,n){if(this._super(e),this.options={zIndex:5},this._land_label=!1,"undefined"!=typeof n&&(this._autoLabel=n.autoLabel,this._labelField=n.lableField,"undefined"!=typeof n.Mapping&&(this._labelFieldMapping=n.Mapping)),this.options=gEcnu.Util.setOptions(this,i),arguments.length>1)this.style=t;else{var r=new gEcnu.Style({});this.style=r}this.oClass="featureLayer",this.featureID=0,this.ctrlLyrs=[],this._opacity=!1,this.resetStyle=!1},_initLayerContainer:function(e,t,i){var n=gEcnu.Util.createCanvas(e,t,i,!0);this._layerContainer=n,this._ctx=n.getContext("2d"),this._layerContainer.style.left="0px",this._layerContainer.style.top="0px"},onAdd:function(e){this._map=e;var t=e.getSize(),i=this._map.getContainer();this._initLayerContainer(this.id,t.w,t.h),i.appendChild(this._layerContainer),this.setzIndex(),this.oFeatures=[]},setStyle:function(e){this.style=e,this.resetStyle=!0,this.renew()},setLabelOptions:function(e){"undefined"!=typeof e&&(this._autoLabel=e.autoLabel,this._labelField=e.lableField,"undefined"!=typeof e.Mapping&&(this._labelFieldMapping=e.Mapping))},activeLabel:function(){return"undefined"==typeof this._labelField?void alert("未定义标注字段！"):void(this._autoLabel||(this._autoLabel=!0,this.renew()))},deactiveLabel:function(){this._autoLabel&&(this._autoLabel=!1,this.renew())},activeOpacity:function(){this._opacity=!0,this.renew()},deactiveOpacity:function(){this._opacity=!1,this.renew()},addFeature:function(e){var t=this.getAllFeatures();gEcnu.Util.isInArray(t,e)||(t.push(e),e.onAdd(this))},removeFeature:function(e){for(var t=[],i=0,n=0;i<this.oFeatures.length;i++)this.oFeatures[i]!=e?(t[n]=this.oFeatures[i],n++):e.onRemove(this);this.oFeatures=t;this.getMap();this.renew()},addFeatures:function(e){for(var t=0;t<e.length;t++)this.addFeature(e[t])},removeFeatures:function(e){for(var t=0;t<e.length;t++)this.removeFeature(e[t])},removeFeaturesByFiled:function(e,t){for(var i=this.getAllFeatures(),n=i.length,r=0;n>r;r++){var a=i[r];a.fields[e]==t&&this.removeFeature(a)}},removeAllFeatures:function(){this.oFeatures=[],this.renew()},draw:function(){for(var e=this.getAllFeatures(),t=0;t<e.length;t++)this.setFeatureStyle(this,e[t].info),e[t].onDraw(this)},setFeatureStyle:function(){},renew:function(){this._super(),this._map.overLayer.clear(),this.clear(),this.draw()},refresh:function(){for(var e=this.getAllFeatures(),t=0;t<e.length;t++)e[t].onAdd(this)},resize:function(){this._super(),this._layerContainer.width=this._map.w,this._layerContainer.height=this._map.h,this.renew()},clear:function(){var e=this.getLayerContainer();this._ctx.clearRect(0,0,e.width,e.height)},getAllFeatures:function(){return this.oFeatures},updateFea:function(e,t){for(var i=this.oFeatures,n=i.length,r=n-1;r>=0;r--)if(i[r]==e){i.splice(r,1,t);break}},getScrFeatures:function(){var e=[],t=this.oFeatures,i=this._map,n=t.length;if(0>=n)return e;for(var r=0;n>r;r++){var a=t[r],s=a.shape.shpBox,o=s[0],l=s[1],c=s[2],g=s[3],h=i.getBounds(),u=h.nw.x,p=h.se.y,d=h.se.x,f=h.nw.y,y=o>=u&&d>o&&l>=p&&f>=l,v=o>=u&&d>o&&g>=p&&f>=g,m=c>=u&&d>c&&l>=p&&f>=l,E=c>=u&&d>c&&g>=p&&f>=g;(y||v||m||E)&&e.push(a)}return e},getCtx:function(){return this._ctx}}),gEcnu.Layer.Overlay=gEcnu.Layer.Feature.extend({init:function(e,t){this._super(e,t),this.options={opacity:1,zIndex:10},this.options=gEcnu.Util.setOptions(this,t),this.oClass="overlayLayer"},setStyle:function(e){this.style=e},initStyle:function(){var e=this.getCtx();e.strokeStyle="green",e.fillStyle="green",this._layerContainer.style.left="0px",this._layerContainer.style.top="0px",e.gloablAlpha=.7},onAdd:function(e){this._super(e),this.initStyle()},resize:function(){this._super(),this._layerContainer.width=this._map.w,this._layerContainer.height=this._map.h,this.renew()}}),gEcnu.Layer.Text=gEcnu.Layer.extend({init:function(e,t,i){this._super(e,i),this.options={opacity:1,zIndex:19},this.options=gEcnu.Util.setOptions(this,i),this.id=e,this.oClass="textLayer",this.oTexts=[],this.style=t,this.resetStyle=!1},_initLayerContainer:function(e,t,i){var n=gEcnu.Util.createDiv(e,t,i,!0);this._layerContainer=n},addText:function(e){gEcnu.Util.isInArray(this.oTexts,e)||(this.oTexts.push(e),e.onAdd(this))},removeText:function(e){for(var t=[],i=0,n=0;i<this.oTexts.length;i++)this.oTexts[i]!=e?(t[n]=this.oTexts[i],n++):this.oTexts[i].onRemove(this);this.oTexts=t,this.renew()},addTexts:function(e){for(var t=(this.oTexts,0);t<e.length;t++)this.addText(e[t])},removeTexts:function(e){for(var t=e,i=t.length,n=0;i>n;n++){var r=t[n];this.removeText(r)}},removeTextsByField:function(e,t){for(var i=this.oTexts,n=i.length,r=0;n>r;r++){var a=i[r];a.fields[e]==t&&this.removeText(a)}},getAllTexts:function(){return this.oTexts},removeAllTexts:function(){this._layerContainer.innerHTML="",this.oTexts=[],this.renew()},setStyle:function(e){this.style=e,this.resetStyle=!0,this.renew()},renew:function(){this._super();for(var e=0;e<this.oTexts.length;e++)this.oTexts[e].renew()},resize:function(){this._super(),this.renew()},getTextsInWindow:function(){var e=this.oTexts,t=[],i=e.length,n=this._map.getBounds(),r=n.sw.x,a=n.ne.x,s=n.sw.y,o=n.ne.y,l=gEcnu.Util.worldToScreen(r,o),c=gEcnu.Util.worldToScreen(a,s);r=l.x,a=c.x,s=l.y,o=c.y;for(var g=0;i>g;g++){var h=e[g],l=h.boxScrSize.xmin>r&&h.boxScrSize.xmin<a&&h.boxScrSize.ymax>s&&h.boxScrSize.ymax<o,u=h.boxScrSize.xmax>r&&h.boxScrSize.xmax<a&&h.boxScrSize.ymax>s&&h.boxScrSize.ymax<o,p=h.boxScrSize.xmin>r&&h.boxScrSize.xmin<a&&h.boxScrSize.ymin>s&&h.boxScrSize.ymin<o,l=h.boxScrSize.xmax>r&&h.boxScrSize.xmax<a&&h.boxScrSize.ymin>s&&h.boxScrSize.ymin<o;(l||u||p||l)&&t.push(h)}return t}}),gEcnu.Layer.Marker=gEcnu.Layer.extend({init:function(e,t){this._super(e,t),this.options={opacity:1,zIndex:20},this.options=gEcnu.Util.setOptions(this,t),this.id=e,this.oClass="markerLayer",this.oMarkers=[]},_initLayerContainer:function(e,t,i){var n=gEcnu.Util.createDiv(e,t,i,!0);this._layerContainer=n},addMarker:function(e){gEcnu.Util.isInArray(this.oMarkers,e)||(this.oMarkers.push(e),e.onAdd(this))},removeMarker:function(e){for(var t=[],i=0,n=0;i<this.oMarkers.length;i++)this.oMarkers[i]!=e?(t[n]=this.oMarkers[i],n++):this.oMarkers[i].onRemove(this);this.oMarkers=t,this.renew()},getAllMarkers:function(){return this.oMarkers},addMarkers:function(e){for(var t=(this.oMarkers,0);t<e.length;t++)this.addMarker(e[t])},removeMarkers:function(e){for(var t=e,i=t.length,n=0;i>n;n++){var r=t[n];this.removeMarker(r)}},removeAllMarkers:function(){var e=this.oMarkers;this.removeMarkers(e)},renew:function(){this._super();for(var e=0;e<this.oMarkers.length;e++)this.oMarkers[e].renew()},resize:function(){this._super(),this.renew()},getMarkersInWindow:function(){for(var e=this.oMarkers,t=[],i=e.length,n=this._map.getBounds(),r=0;i>r;r++){var a=e[r],s=n.sw.x,o=n.ne.x,l=n.sw.y,c=n.ne.y;a.x>s&&a.x<o&&a.y>l&&a.y<c&&t.push(a)}return t}}),gEcnu.Layer.Heatmap=gEcnu.Layer.Feature.extend({init:function(e,t){this._super(e,t),this.options={opacity:1,zIndex:19},this.options=gEcnu.Util.setOptions(this,t),this.oClass="heatmapLayer",this.heatmap={},
this.multi=1},onAdd:function(e){this._super(e),this._map=e;var t=this._map.getContainer();this.heatmap=gHeatmap.create({container:t,canvas:this._layerContainer,radius:20})},setFtsData:function(e){this.data=e;var t=e.field,i=e.points,n=this.getScrFeatures(i),r={};void 0!=e.max&&(r.max=e.max),void 0!=e.min&&(r.min=e.min);for(var a=[],s=0,o=n.length;o>s;s++){var l=n[s].shape.Points[0].X,c=n[s].shape.Points[0].Y,g=gEcnu.Util.worldToScreen(l,c),h=n[s].fields[t],u={x:g.x,y:g.y,value:h};a.push(u)}r.data=a,this.heatmap.setData(r)},setData:function(e){this.data=e;var t=e.data,i={};void 0!=e.max&&(i.max=e.max),void 0!=e.min&&(i.min=e.min);for(var n=[],r=t.length;r--;){var a={},s=gEcnu.Util.worldToScreen(t[r].x,t[r].y);a.x=s.x,a.y=s.y,void 0!=t[r].value&&(a.value=t[r].value),void 0!=t[r].radius&&(a.radius=t[r].radius*this.multi),n.push(a)}i.data=n,this.heatmap.setData(i)},clearHeatmap:function(){this.heatmap.clear(),this.data=null},resize:function(){this._super(),this._layerContainer.width=this._map.w,this._layerContainer.height=this._map.h,this.renew()},zoomIn:function(){this.multi*=2,this.renew()},zoomOut:function(){this.multi*=.5,this.renew()},zoomAll:function(){this.multi=1,this.renew()},renew:function(){this._super(),console.log(this.data),this.data&&null!=this.data&&this.setData(this.data,this.multi)},getScrFeatures:function(e){var t=[],i=this._map,n=e.length;if(0>=n)return t;for(var r=0;n>r;r++){var a=e[r],s=a.shape.shpBox,o=s[0],l=s[1],c=s[2],g=s[3],h=i.getBounds(),u=h.nw.x,p=h.se.y,d=h.se.x,f=h.nw.y,y=o>=u&&d>o&&l>=p&&f>=l,v=o>=u&&d>o&&g>=p&&f>=g,m=c>=u&&d>c&&l>=p&&f>=l,E=c>=u&&d>c&&g>=p&&f>=g;(y||v||m||E)&&t.push(a)}return t}}),gEcnu.Feature=gClass.extend({init:function(e){this.name=e},getVertices:function(){},getBounds:function(){},calcBounds:function(){}}),gEcnu.Feature.Point=gEcnu.Feature.extend({init:function(e,t){this._gpoints=e,this.shape={},this.shape.shpType=8,this.shape.shpBox=gEcnu.Util.getShpBox(e);var i=e.length;this.shape.NumPoints=i,this.shape.Points=[];for(var n=0;i>n;n++){var r=e[n],a={X:r.x,Y:r.y};this.shape.Points.push(a)}this.fields={},"object"==typeof t&&(this.fields=t)},onAdd:function(e){this._layer=e,this.onDraw(e)},onRemove:function(e){},addFields:function(e){for(var t in e)this.fields[t]=e[t]},delFields:function(e){for(var t=e.length,i=0;t>i;i++){var n=e[i];delete this.fields[n]}},delAllFields:function(){this.fields={}},onDraw:function(e){var t=e.getCtx(),i=e.style;e.resetStyle;if(i instanceof gEcnu.Style_Ex){var n=i.mappingField,r=this.fields,a="default";for(var s in r)if(s==n){a=r[s];break}for(var o=i.styles,l=o.length,c=0;l>c;c++){var g=o[c];g.mappingValue!=a||(this.style=g)}}else{if(!(i instanceof gEcnu.Style))return void alert("style样式有问题！");this.style=i}"undefined"==typeof this.style&&(this.style=new gEcnu.Style({}));for(var h=(gEcnu.Util.setStyle(t,this.style),e.getMap(),this.shape.NumPoints),u=0;h>u;u++){var p=this._gpoints[u],d=gEcnu.Util.worldToScreen(p.x,p.y);t.beginPath(),t.arc(d.x,d.y,this.style.cirRadius,0,2*Math.PI),t.stroke()}var f=this.style.fillColor;f=f.replace(/(^\s*)|(\s*$)/g,""),""!=f&&t.fill()},onSelect:function(){var e=this._gpoints,t=gSelf;null!=gEcnu.Edit.selectedPoint&&(gEcnu.Edit.selectedPoint=null,t.overLayer.clear());var i=new gEcnu.Style({cirRadius:6,opacity:1,fillColor:"#00FFFF",strokeColor:"#00FFFF",lineWeight:1});t.overLayer.setStyle(i);var n=t.overLayer._ctx;gEcnu.Util.setStyle(n,i),gEcnu.Graph.drawPoints_geo(n,e)},highLight:function(e,t,i){var n=this,r=this,t=(n.shape.shpType,arguments.length>1?arguments[1]:{isTwinkle:!1}),a=arguments.length>2?arguments[2]:{radius:6,isFill:!0,fillColor:"red",strokeColor:"red"},s=a.radius||6,o=void 0!=a.isFill?a.isFill:!0;if(o)var l=a.fillColor||"red";else var l="";var c=a.strokeColor||"red",g=t.isTwinkle,h=parseInt(t.twinkleCount)||3,u=parseInt(t.twinkleInterval)||1e3;if(g)var p=0,d=setInterval(function(){return p>=2*h-1?void window.clearInterval(d):(p%2==0?r._drawHighlightFea(e,s,l,c):e.removeAllFeatures(),void p++)},u);else r._drawHighlightFea(e,s,l,c)},_drawHighlightFea:function(e,t,i,n){var r=this,a=new gEcnu.Style({cirRadius:t,opacity:.5,fillColor:i,strokeColor:n});e.setStyle(a),e.addFeature(r)},getLayer:function(){return this._layer},getGeometrys:function(){return this._gpoints}}),gEcnu.Feature.Polyline=gEcnu.Feature.extend({init:function(e,t){this.shape={},this.shape.shpType=3,this._lineStrings=e;var i=e.length,n=[];this.shape.Parts=[];for(var r=0;i>r;r++){var a=e[r].points,s=n.length;this.shape.Parts.push(s),n=n.concat(a)}this.shape.shpBox=gEcnu.Util.getShpBox(n);var o=n.length;this.shape.NumPoints=o,this.shape.NumParts=i,this.shape.Points=[];for(var l=0;o>l;l++){var c=n[l],g={x:c.x,y:c.y};this.shape.Points.push(g)}if(this.fields={},"object"==typeof t)for(k in t)this.fields[k]=t[k];this._data=this.fields},onAdd:function(e){this._layerID=e.id,this.onDraw(e)},onRemove:function(e){},addFields:function(e){for(var t in e)this.fields[t]=e[t]},delFields:function(e){for(var t=e.length,i=0;t>i;i++){var n=e[i];delete this.fields[n]}},delAllFields:function(){this.fields={}},onDraw:function(e){var t=e.getCtx(),i=e.style;e.resetStyle;if(i instanceof gEcnu.Style_Ex){var n=i.mappingField,r=this.fields,a="default";for(var s in r)if(s==n){a=r[s];break}for(var o=i.styles,l=o.length,c=!1,g=0;l>g;g++){var h=o[g];h.mappingValue!=a||(this.style=h,c=!0)}if(!c){var u=new gEcnu.Style({});this.style=u}}else{if(!(i instanceof gEcnu.Style))return void alert("style样式有问题！");this.style=i}"undefined"==typeof this.style&&(this.style=new gEcnu.Style({}));for(var p=(gEcnu.Util.setStyle(t,this.style),e.getMap(),this.shape.NumParts),d=0;p>d;d++){var f=this._lineStrings[d],y=f.points.length;if(y>=2){t.beginPath();var v=gEcnu.Util.worldToScreen(f.points[0].x,f.points[0].y);t.moveTo(v.x,v.y);for(var m=1;y>m;m++)v=gEcnu.Util.worldToScreen(f.points[m].x,f.points[m].y),t.lineTo(v.x,v.y)}t.stroke()}},onSelect:function(){var e=this._lineStrings.length,t=gSelf;t.overLayer.clear();for(var i=0;e>i;i++){var n=this._lineStrings[i].points,r=new gEcnu.Style({cirRadius:3,opacity:1,fillColor:"#118811",strokeColor:"#118811",lineWeight:1});t.overLayer.setStyle(r);var a=t.overLayer._ctx;gEcnu.Util.setStyle(a,r),gEcnu.Graph.drawPoints_geo(a,n);var s=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});t.overLayer.setStyle(s);var a=t.overLayer._ctx;gEcnu.Util.setStyle(a,s),gEcnu.Graph.drawLines_geo(a,n)}},onSelect_ex:function(){var e=this._lineStrings.length,t=gSelf;null!=gEcnu.Edit.selectedLine&&(gEcnu.Edit.selectedLine=null,t.overLayer.clear());for(var i=0;e>i;i++){var n=this._lineStrings[i].points,r=t.overLayer._ctx,a=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});t.overLayer.setStyle(a);var r=t.overLayer._ctx;gEcnu.Util.setStyle(r,a),gEcnu.Graph.drawLines_geo(r,n)}},highLight:function(e,t,i){var n=this,r=this,t=(n.shape.shpType,arguments.length>1?arguments[1]:{isTwinkle:!1}),a=arguments.length>2?arguments[2]:{strokeColor:"red",lineWeight:2},s=a.strokeColor||"red",o=a.lineWeight||2,l=t.isTwinkle,c=t.twinkleCount||3,g=parseInt(t.twinkleInterval)||1e3;if(l)var h=0,u=setInterval(function(){return h>=2*c-1?void window.clearInterval(u):(h%2==0?r._drawHighlightFea(e,s,o):e.removeAllFeatures(),void h++)},g);else r._drawHighlightFea(e,s,o)},_drawHighlightFea:function(e,t,i){var n=this,r=new gEcnu.Style({opacity:.5,strokeColor:t,lineWeight:i});e.setStyle(r),e.addFeature(n)},getLayer:function(){return this._layerID},getGeometrys:function(){return this._lineStrings}}),gEcnu.Feature.Polygon=gEcnu.Feature.extend({init:function(e,t){this.shape={},this.shape.shpType=5,this._lineRings=e;var i=e.length,n=[];this.shape.Parts=[];for(var r=0;i>r;r++){var a=e[r].points,s=n.length;this.shape.Parts.push(s),n=n.concat(a)}this.shape.shpBox=gEcnu.Util.getShpBox(n);var o=n.length;this.shape.NumPoints=o,this.shape.NumParts=i,this.shape.Points=[];for(var l=0;o>l;l++){var c=n[l],g={x:c.x,y:c.y};this.shape.Points.push(g)}if(this.fields={},"object"==typeof t)for(k in t)this.fields[k]=t[k];this._data=this.fields},onAdd:function(e){this._layerID=e.id,this.onDraw(e)},onRemove:function(e){},addFields:function(e){for(var t in e)this.fields[t]=e[t]},delFields:function(e){for(var t=e.length,i=0;t>i;i++){var n=e[i];delete this.fields[n]}},delAllFields:function(){this.fields={}},onDraw:function(e){var t=e.getCtx(),i=e.style;e.resetStyle;if(i instanceof gEcnu.Style_Ex){var n=i.mappingField,r=this.fields,a="default";for(var s in r)if(s==n){a=r[s];break}for(var o=i.styles,l=o.length,c=0;l>c;c++){var g=o[c];g.mappingValue!=a||(this.style=g)}}else{if(!(i instanceof gEcnu.Style))return void alert("style样式有问题！");this.style=i}"undefined"==typeof this.style&&(this.style=new gEcnu.Style({}));var h=gEcnu.Util.setStyle(t,this.style);e.getMap();t.globalAlpha=1;var u=this.shape.NumParts,p=parseInt(gEcnu.Util.getOuterPolyIndex(this._lineRings)),d=this._lineRings[p],f=this._lineRings[p].points,y=gEcnu.Util.isClockWise(this._lineRings[p].points);this._lineRings.splice(p,1),this._lineRings.unshift(d);for(var v=0;u>v;v++){var m=this._lineRings[v],E=m.points.length,_="normal";if(v!=p){var S=gEcnu.Util.isPolyInPoly(m.points,f);if(S){var x=gEcnu.Util.isClockWise(m.points);_=y&&!x||!y&&x?"hole":"island"}}if(E>=2){t.beginPath();var b=gEcnu.Util.worldToScreen(m.points[0].x,m.points[0].y);t.moveTo(b.x,b.y);for(var w=1;E>w;w++)b=gEcnu.Util.worldToScreen(m.points[w].x,m.points[w].y),t.lineTo(b.x,b.y);t.closePath()}t.stroke(),e._opacity?t.globalAlpha=.1:t.globalAlpha=h.opacity;var L=this.style.fillColor;if(L=L.replace(/(^\s*)|(\s*$)/g,""),""!=L)switch(_){case"island":break;case"hole":t.globalAlpha=1,t.fillStyle="#fff",t.fill();break;default:t.fill()}if(e._autoLabel){t.globalAlpha=1;var M="null",C=this.fields;if("undefined"==typeof e._labelFieldMapping)"undefined"!=typeof C[e._labelField]&&(M=C[e._labelField]);else if("undefined"!=typeof C[e._labelField]){var P=C[e._labelField];"undefined"!=typeof e._labelFieldMapping[P]&&(M=e._labelFieldMapping[P])}var T=(this.shape.shpBox[0]+this.shape.shpBox[2])/2,F=(this.shape.shpBox[1]+this.shape.shpBox[3])/2,U=gEcnu.Util.worldToScreen(T,F);t.font="11px serif",t.fillStyle="#ffffff",t.fillText(M,U.x-20,U.y)}}},onDraw_bak20160113:function(e){var t=e.getCtx(),i=e.style;e.resetStyle;if(i instanceof gEcnu.Style_Ex){var n=i.mappingField,r=this.fields,a="default";for(var s in r)if(s==n){a=r[s];break}for(var o=i.styles,l=o.length,c=0;l>c;c++){var g=o[c];g.mappingValue!=a||(this.style=g)}}else{if(!(i instanceof gEcnu.Style))return void alert("style样式有问题！");this.style=i}"undefined"==typeof this.style&&(this.style=new gEcnu.Style({}));var h=gEcnu.Util.setStyle(t,this.style);e.getMap();t.globalAlpha=1;for(var u=this.shape.NumParts,p=0;u>p;p++){var d=this._lineRings[p],f=d.points.length;if(f>=2){t.beginPath();var y=gEcnu.Util.worldToScreen(d.points[0].x,d.points[0].y);t.moveTo(y.x,y.y);for(var v=1;f>v;v++)y=gEcnu.Util.worldToScreen(d.points[v].x,d.points[v].y),t.lineTo(y.x,y.y);t.closePath()}t.stroke(),e._opacity?t.globalAlpha=.1:t.globalAlpha=h.opacity;var m=this.style.fillColor;if(m=m.replace(/(^\s*)|(\s*$)/g,""),""!=m&&t.fill(),e._autoLabel){t.globalAlpha=1;var E="null",_=this.fields;if("undefined"==typeof e._labelFieldMapping)"undefined"!=typeof _[e._labelField]&&(E=_[e._labelField]);else if("undefined"!=typeof _[e._labelField]){var S=_[e._labelField];"undefined"!=typeof e._labelFieldMapping[S]&&(E=e._labelFieldMapping[S])}var x=(this.shape.shpBox[0]+this.shape.shpBox[2])/2,b=(this.shape.shpBox[1]+this.shape.shpBox[3])/2,w=gEcnu.Util.worldToScreen(x,b);t.font="11px serif",t.fillStyle="#ffffff",t.fillText(E,w.x-20,w.y)}}},onSelect:function(){var e=this._lineRings.length,t=gSelf;t.overLayer.clear();for(var i=0;e>i;i++){var n=this._lineRings[i].points,r=new gEcnu.Style({cirRadius:3,opacity:1,fillColor:"#82D900",strokeColor:"#82D900",lineWeight:1});t.overLayer.setStyle(r);var a=t.overLayer._ctx;gEcnu.Util.setStyle(a,r),gEcnu.Graph.drawPoints_geo(a,n);var s=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});t.overLayer.setStyle(s);var a=t.overLayer._ctx;gEcnu.Util.setStyle(a,s),gEcnu.Graph.drawLines_geo(a,n)}},onSelect_ex:function(){var e=this._lineRings.length,t=gSelf;null!=gEcnu.Edit.selectedPolygon&&(gEcnu.Edit.selectedPolygon=null,t.overLayer.clear());for(var i=0;e>i;i++){var n=this._lineRings[i].points,r=t.overLayer._ctx,a=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});t.overLayer.setStyle(a);var r=t.overLayer._ctx;gEcnu.Util.setStyle(r,a),gEcnu.Graph.drawLines_geo(r,n)}},highLight:function(e,t,i){var n=this,r=this,t=(n.shape.shpType,arguments.length>1?arguments[1]:{isTwinkle:!1}),a=arguments.length>2?arguments[2]:{isFill:!0,fillColor:"#00FFFF",strokeColor:"red",lineWeight:2},s=void 0!=a.isFill?a.isFill:!0;if(s)var o=a.fillColor||"#00FFFF";else var o="";var l=a.strokeColor||"red",c=a.lineWeight||2,g=t.isTwinkle,h=t.twinkleCount||3,u=parseInt(t.twinkleInterval)||1e3;if(g)var p=0,d=setInterval(function(){return p>=2*h-1?void window.clearInterval(d):(p%2==0?r._drawHighlightFea(e,o,l,c):e.removeAllFeatures(),void p++)},u);else r._drawHighlightFea(e,o,l,c)},_drawHighlightFea:function(e,t,i,n){var r=this,a=new gEcnu.Style({opacity:.5,fillColor:t,strokeColor:i,lineWeight:n});e.setStyle(a),e.addFeature(r)},getLayer:function(){return this._layerID},getGeometrys:function(){return this._lineRings},pointInFeature:function(e){for(var t=this._lineRings.length,i=0;t>i;i++){var n=this._lineRings[i].points;if(gEcnu.Graph.pointInPoly(e,n))return!0}return!1}}),gEcnu.Edit={},gEcnu.Edit.moving=!1,gEcnu.Edit.draw_line_points=[],gEcnu.Edit.draw_polygon_points=[],gEcnu.Edit.selectedPolygon=null,gEcnu.Edit.selectedPolygon_pre=null,gEcnu.Edit.selectedLine=null,gEcnu.Edit.selectedLine_pre=null,gEcnu.Edit.Poly_sellineRing_index=-1,gEcnu.Edit.Poly_selPoint_index=-1,gEcnu.Edit.Line_sellineString_index=-1,gEcnu.Edit.Line_selPoint_index=-1,gEcnu.Edit.NowPoint=null,gEcnu.Edit.selectedPoint=null,gEcnu.Edit.multiSelectedFeatures=[],gEcnu.Edit.draw_rect_points=[],gEcnu.Edit.draw_circle_points=[],gEcnu.Edit.drawCircleEnd=!1,gEcnu.Edit.graphMouseDownEvt=function(e,t){var i=t.getMode(),n=gEcnu.Util.getMouseXY(gSelf._container,e);gSelf.startX=n.x,gSelf.startY=n.y;var r=gEcnu.Util.screenToWorld(n.x,n.y),a=t.overLayer.getCtx();switch(gEcnu.Edit.moving=!0,i){case"drawMarker":var s=new gEcnu.Geometry.Point(r.x,r.y);t.mLayer.getLayerContainer().style.cursor=t.cursorStyle.mark;var o=gEcnu.DrawFeature.setting.events._events.added;"undefined"!=typeof o&&o(e,s);break;case"drawPoint":var s=new gEcnu.Geometry.Point(r.x,r.y),o=gEcnu.DrawFeature.setting.events._events.added;"undefined"!=typeof o&&o(e,s);break;case"drawLine":var l=gEcnu.DrawFeature.setting,c=l._catchable,g=l._layer;if(c){var h="",u="",p=g.getAllFeatures();if(h=gEcnu.Graph.catchPoint(n,p),h.indexOf("true")>=0){var d=parseFloat(h.split("|")[1].split(",")[0]),f=parseFloat(h.split("|")[1].split(",")[1]),y=parseFloat(h.split("|")[1].split(",")[2]),v=parseFloat(h.split("|")[1].split(",")[3]);n={x:d,y:f},r={x:y,y:v}}else if(t.mLayer.getLayerContainer().style.cursor=t.cursorStyle.draw,u=gEcnu.Graph.catchLine(n,p),u.indexOf("true")>=0){var m=parseFloat(u.split("|")[1].split(",")[0]),E=parseFloat(u.split("|")[1].split(",")[1]),_=parseFloat(u.split("|")[1].split(",")[2]),S=parseFloat(u.split("|")[1].split(",")[3]);n={x:m,y:E},r={x:_,y:S}}}var s=new gEcnu.Geometry.Point(r.x,r.y);gEcnu.Edit.draw_line_points.push(s);var x=new gEcnu.Style({cirRadius:3,opacity:1,fillColor:"#82D900",strokeColor:"#82D900",lineWeight:1});t.overLayer.setStyle(x);var a=t.overLayer._ctx;gEcnu.Util.setStyle(a,x),gEcnu.Graph.drawPoint(a,n);var b=gEcnu.Edit.draw_line_points.length;if(b>1){var w=new gEcnu.Style({opacity:1,fillColor:"#82D900",strokeColor:"#118811",lineWeight:1});t.overLayer.setStyle(w);var a=t.overLayer._ctx;gEcnu.Util.setStyle(a,w),gEcnu.Graph.drawLines_geo(a,gEcnu.Edit.draw_line_points)}break;case"drawPolygon":var l=gEcnu.DrawFeature.setting,c=l._catchable,g=l._layer;if(c){var h="",u="",p=g.getAllFeatures();if(h=gEcnu.Graph.catchPoint(n,p),h.indexOf("true")>=0){var d=parseFloat(h.split("|")[1].split(",")[0]),f=parseFloat(h.split("|")[1].split(",")[1]),y=parseFloat(h.split("|")[1].split(",")[2]),v=parseFloat(h.split("|")[1].split(",")[3]);n={x:d,y:f},r={x:y,y:v}}else if(t.mLayer.getLayerContainer().style.cursor=t.cursorStyle.draw,u=gEcnu.Graph.catchLine(n,p),u.indexOf("true")>=0){var m=parseFloat(u.split("|")[1].split(",")[0]),E=parseFloat(u.split("|")[1].split(",")[1]),_=parseFloat(u.split("|")[1].split(",")[2]),S=parseFloat(u.split("|")[1].split(",")[3]);n={x:m,y:E},r={x:_,y:S}}}var s=new gEcnu.Geometry.Point(r.x,r.y);gEcnu.Edit.draw_polygon_points.push(s);var L=new gEcnu.Style({cirRadius:3,opacity:1,fillColor:"#82D900",strokeColor:"#82D900",lineWeight:1});t.overLayer.setStyle(L);var a=t.overLayer._ctx;gEcnu.Util.setStyle(a,L),gEcnu.Graph.drawPoint(a,n);var b=gEcnu.Edit.draw_polygon_points.length;if(b>1){var w=new gEcnu.Style({opacity:1,fillColor:"#82D900",strokeColor:"#82D900",lineWeight:1});t.overLayer.setStyle(w);var a=t.overLayer._ctx;gEcnu.Util.setStyle(a,w),gEcnu.Graph.drawLines_geo(a,gEcnu.Edit.draw_polygon_points)}break;case"selectPolygon":if(gEcnu.Util.ifshift(e)){for(var l=gEcnu.EditFeature.setting,g=l._layer,p=g.getAllFeatures(),b=p.length,M=null,C=0;b>C;C++){for(var P=!1,T=p[C]._lineRings.length,F=0;T>F;F++){var U=p[C]._lineRings[F].points;if(gEcnu.Graph.pointInPoly(r,U)){for(var I=!1,A=gEcnu.Edit.multiSelectedFeatures,k=A.length,D=0;k>D;D++){var z=A[D];if(z==p[C]){I=!0,t.overLayer.clear(),gEcnu.Edit.multiSelectedFeatures.splice(D,1);break}}if(I)for(var R=gEcnu.Edit.multiSelectedFeatures,O=R.length,W=0;O>W;W++)R[W].onSelect_ex();else gEcnu.Edit.multiSelectedFeatures.push(p[C]),p[C].onSelect_ex();M=p[C],P=!0;break}}if(P)break}var o=gEcnu.EditFeature.setting.events._events.multiSelected,G=[];null!=M&&G.push(M),"undefined"!=typeof o&&o(e,G)}else{for(var l=gEcnu.EditFeature.setting,g=l._layer,p=g.getAllFeatures(),b=p.length,M=null,C=0;b>C;C++){for(var P=!1,T=p[C]._lineRings.length,F=0;T>F;F++){var U=p[C]._lineRings[F].points;if(gEcnu.Graph.pointInPoly(r,U)){M=p[C],gEcnu.Edit.selectedPolygon=M,gEcnu.Edit.selectedPolygon_pre=M,P=!0;break}}if(P)break}var o=gEcnu.EditFeature.setting.events._events.selected,G=[];null!=M&&G.push(M),"undefined"!=typeof o&&o(e,G)}break;case"addPoint":var u="false";if(null==gEcnu.Edit.selectedPolygon)return;if(u=gEcnu.Graph.catchLine(n,[gEcnu.Edit.selectedPolygon]),u.indexOf("true")>=0){var y=parseFloat(u.split("|")[1].split(",")[2]),v=parseFloat(u.split("|")[1].split(",")[3]),B=parseFloat(u.split("|")[4].split(",")[0]),H=parseFloat(u.split("|")[4].split(",")[1]),N=gEcnu.Edit.selectedPolygon._lineRings[B],X=new gEcnu.Geometry.Point(y,v),Y=parseInt(H)+1;N.addPoint(X,Y);for(var l=gEcnu.EditFeature.setting,g=l._layer,q=g.getAllFeatures(),Q=[],V=0;V<q.length;V++)q[V]!=gEcnu.Edit.selectedPolygon_pre&&Q.push(q[V]);var j=new gEcnu.Feature.Polygon(gEcnu.Edit.selectedPolygon._lineRings,gEcnu.Edit.selectedPolygon._data);Q.push(j),gEcnu.Edit.selectedPolygon.shape=j.shape,gEcnu.Edit.selectedPolygon_pre=j,gEcnu.Edit.selectedPolygon=j,g.removeAllFeatures(),g.addFeatures(Q),j.onSelect(),t.setMode("moveNode_mouseDwon");var o=gEcnu.EditFeature.setting.events._events.updateCompleted;"undefined"!=typeof o&&o(e,j)}break;case"delPoint":var h="false";if(null==gEcnu.Edit.selectedPolygon)return;if(h=gEcnu.Graph.catchPoint(n,[gEcnu.Edit.selectedPolygon]),h.indexOf("true")>=0){var Z=parseFloat(h.split("|")[2].split(",")[0]),J=parseFloat(h.split("|")[2].split(",")[1]),N=gEcnu.Edit.selectedPolygon._lineRings[Z],Y=parseInt(J);N.delPoint(Y);for(var l=gEcnu.EditFeature.setting,g=l._layer,q=g.getAllFeatures(),Q=[],V=0;V<q.length;V++)q[V]!=gEcnu.Edit.selectedPolygon_pre&&Q.push(q[V]);var j=new gEcnu.Feature.Polygon(gEcnu.Edit.selectedPolygon._lineRings,gEcnu.Edit.selectedPolygon._data);Q.push(j),gEcnu.Edit.selectedPolygon.shape=j.shape,gEcnu.Edit.selectedPolygon_pre=j,gEcnu.Edit.selectedPolygon=j,g.removeAllFeatures(),g.addFeatures(Q),j.onSelect(),t.setMode("moveNode_mouseDwon");var o=gEcnu.EditFeature.setting.events._events.updateCompleted;"undefined"!=typeof o&&o(e,j)}break;case"moveNode_mouseDwon":t.setMode("moveNode");break;case"selectLine":if(gEcnu.Util.ifshift(e)){console.log("shift");var l=gEcnu.EditFeature.setting,g=l._layer,p=g.getAllFeatures(),b=p.length,M=null,K=gEcnu.Graph.catchLine(n,p);if(K.indexOf("true")>=0){var $=parseFloat(K.split("|")[4].split(",")[2]);$=parseInt($);for(var ee=p[$],I=!1,A=gEcnu.Edit.multiSelectedFeatures,k=A.length,D=0;k>D;D++){var z=A[D];if(z==ee){I=!0,t.overLayer.clear(),gEcnu.Edit.multiSelectedFeatures.splice(D,1);break}}I||gEcnu.Edit.multiSelectedFeatures.push(ee);for(var R=gEcnu.Edit.multiSelectedFeatures,O=R.length,W=0;O>W;W++)R[W].onSelect_ex();M=ee}var o=gEcnu.EditFeature.setting.events._events.multiSelected,G=[];null!=M&&G.push(M),"undefined"!=typeof o&&o(e,G)}else{var l=gEcnu.EditFeature.setting,g=l._layer,p=g.getAllFeatures(),b=p.length,M=null,K=gEcnu.Graph.catchLine(n,p);if(K.indexOf("true")>=0){var $=parseFloat(K.split("|")[4].split(",")[2]);$=parseInt($);var ee=p[$];gEcnu.EditFeature.setting._reshape?ee.onSelect():ee.onSelect_ex(),M=ee,gEcnu.Edit.selectedLine=M,gEcnu.Edit.selectedLine_pre=M}var o=gEcnu.EditFeature.setting.events._events.selected,G=[];null!=M&&G.push(M),"undefined"!=typeof o&&o(e,G)}break;case"moveNodeLine_mouseDwon":t.setMode("moveNode_Line");break;case"addPoint_line":var u="false";if(null==gEcnu.Edit.selectedLine)return;if(u=gEcnu.Graph.catchLine(n,[gEcnu.Edit.selectedLine]),u.indexOf("true")>=0){var y=parseFloat(u.split("|")[1].split(",")[2]),v=parseFloat(u.split("|")[1].split(",")[3]),B=parseFloat(u.split("|")[4].split(",")[0]),H=parseFloat(u.split("|")[4].split(",")[1]),N=gEcnu.Edit.selectedLine._lineStrings[B],X=new gEcnu.Geometry.Point(y,v),Y=parseInt(H)+1;N.addPoint(X,Y);for(var l=gEcnu.EditFeature.setting,g=l._layer,q=g.getAllFeatures(),Q=[],V=0;V<q.length;V++)q[V]!=gEcnu.Edit.selectedLine_pre&&Q.push(q[V]);var j=new gEcnu.Feature.Polyline(gEcnu.Edit.selectedLine._lineStrings,gEcnu.Edit.selectedLine._data);Q.push(j),gEcnu.Edit.selectedLine.shape=j.shape,gEcnu.Edit.selectedLine_pre=j,gEcnu.Edit.selectedLine=j,g.removeAllFeatures(),g.addFeatures(Q),j.onSelect(),t.setMode("moveNodeLine_mouseDwon");var o=gEcnu.EditFeature.setting.events._events.updateCompleted;"undefined"!=typeof o&&o(e,j)}break;case"delPoint_line":var h="false";if(null==gEcnu.Edit.selectedLine)return;if(h=gEcnu.Graph.catchPoint(n,[gEcnu.Edit.selectedLine]),h.indexOf("true")>=0){var Z=parseFloat(h.split("|")[2].split(",")[0]),J=parseFloat(h.split("|")[2].split(",")[1]),N=gEcnu.Edit.selectedLine._lineStrings[Z],Y=parseInt(J);N.delPoint(Y);for(var l=gEcnu.EditFeature.setting,g=l._layer,q=g.getAllFeatures(),Q=[],V=0;V<q.length;V++)q[V]!=gEcnu.Edit.selectedLine_pre&&Q.push(q[V]);var j=new gEcnu.Feature.Polyline(gEcnu.Edit.selectedLine._lineStrings,gEcnu.Edit.selectedLine._data);Q.push(j),gEcnu.Edit.selectedLine.shape=j.shape,gEcnu.Edit.selectedLine_pre=j,gEcnu.Edit.selectedLine=j,g.removeAllFeatures(),g.addFeatures(Q),j.onSelect(),t.setMode("moveNodeLine_mouseDwon");var o=gEcnu.EditFeature.setting.events._events.updateCompleted;"undefined"!=typeof o&&o(e,j)}break;case"selectPoint":for(var l=gEcnu.EditFeature.setting,g=l._layer,p=g.getAllFeatures(),b=p.length,M=null,C=0;b>C;C++)for(var te=p[C],ie=te.shape.NumPoints,F=0;ie>F;F++){var ne=gEcnu.Util.worldToScreen(te.shape.Points[F].X,te.shape.Points[F].Y),re=Math.sqrt((ne.x-n.x)*(ne.x-n.x)+(ne.y-n.y)*(ne.y-n.y));if(5>re){M=te;break}}if(!M)return;if(gEcnu.Util.ifshift(e)){for(var I=!1,A=gEcnu.Edit.multiSelectedFeatures,k=A.length,D=0;k>D;D++){var z=A[D];if(z==M){I=!0,t.overLayer.clear(),gEcnu.Edit.multiSelectedFeatures.splice(D,1);break}}I||gEcnu.Edit.multiSelectedFeatures.push(M);for(var R=gEcnu.Edit.multiSelectedFeatures,O=R.length,W=0;O>W;W++)R[W].onSelect();var ae=gEcnu.EditFeature.setting.events._events.multiSelected,G=[];null!=M&&G.push(M),"undefined"!=typeof ae&&ae(e,G)}else{M&&(gEcnu.Edit.selectedPoint=M,M.onSelect());var o=gEcnu.EditFeature.setting.events._events.selected,G=[];null!=M&&G.push(M),"undefined"!=typeof o&&o(e,G)}break;case"selectText":for(var l=gEcnu.EditFeature.setting,g=l._layer,se=g.getTextsInWindow(),b=se.length,oe=null,C=0;b>C;C++){var le=se[C];if(n.x>=le.boxScrSize.xmin&&n.x<=le.boxScrSize.xmax&&n.y>=le.boxScrSize.ymin&&n.y<=le.boxScrSize.ymax){oe=le;break}}var o=gEcnu.EditFeature.setting.events._events.selected,ce=[];null!=oe&&ce.push(oe),"undefined"!=typeof o&&o(e,ce);break;case"drawRect":var ge=new gEcnu.Geometry.Point(r.x,r.y);gEcnu.Edit.draw_rect_points.push(ge);break;case"drawCircle":gEcnu.Edit.draw_circle_points=[];var ge=new gEcnu.Geometry.Point(r.x,r.y);gEcnu.Edit.draw_circle_points.push(ge);break;case"drawText":var o=gEcnu.DrawFeature.setting.events._events.added;"undefined"!=typeof o&&o(e)}},gEcnu.Edit.graphMouseMoveEvt=function(e,t){var i=t.getMode(),n=gEcnu.Util.getMouseXY(gSelf._container,e);gEcnu.Edit.NowPoint=n;var r=t.overLayer.getCtx();switch(i){case"drawLine":var a=gEcnu.Edit.draw_line_points,s=a.length,o=gEcnu.DrawFeature.setting,l=o._catchable,c=o._layer;if(t.overLayer.clear(),t.mLayer.getLayerContainer().style.cursor=t.cursorStyle.draw,l){var g="",h="",u=c.getAllFeatures();if(g=gEcnu.Graph.catchPoint(n,u),g.indexOf("true")>=0){t.overLayer.clear(),t.mLayer.getLayerContainer().style.cursor="crosshair";var p=parseFloat(g.split("|")[1].split(",")[0]),d=parseFloat(g.split("|")[1].split(",")[1]);n={x:p,y:d};var f=new gEcnu.Style({cirRadius:3,opacity:1,fillColor:"red",strokeColor:"red",lineWeight:2});t.overLayer.setStyle(f);var r=t.overLayer._ctx;gEcnu.Util.setStyle(r,f),gEcnu.Graph.drawPoint(r,n)}else if(h=gEcnu.Graph.catchLine(n,u),h.indexOf("true")>=0){var y=parseFloat(h.split("|")[2].split(",")[0]),v=parseFloat(h.split("|")[2].split(",")[1]),m=parseFloat(h.split("|")[3].split(",")[0]),E=parseFloat(h.split("|")[3].split(",")[1]),_={x:y,y:v},S={x:m,y:E},f=new gEcnu.Style({cirRadius:3,opacity:1,fillColor:"red",strokeColor:"red",lineWeight:2});t.overLayer.setStyle(f);var r=t.overLayer._ctx;gEcnu.Util.setStyle(r,f),gEcnu.Graph.drawLine(r,_,S)}}if(s>=1){var f=new gEcnu.Style({opacity:1,fillColor:"#82D900",strokeColor:"#82D900",lineWeight:1});t.overLayer.setStyle(f);var r=t.overLayer._ctx;gEcnu.Util.setStyle(r,f);var x=gEcnu.Util.worldToScreen(a[s-1].x,a[s-1].y);gEcnu.Graph.drawLine(r,x,n),gEcnu.Graph.drawLines_geo(r,a)}gEcnu.Graph.drawPoints_geo(r,a);break;case"drawPolygon":var a=gEcnu.Edit.draw_polygon_points,s=a.length,o=gEcnu.DrawFeature.setting,l=o._catchable,c=o._layer;if(t.overLayer.clear(),t.mLayer.getLayerContainer().style.cursor=t.cursorStyle.draw,l){var g="",h="",u=c.getAllFeatures();if(g=gEcnu.Graph.catchPoint(n,u),g.indexOf("true")>=0){t.overLayer.clear(),t.mLayer.getLayerContainer().style.cursor="crosshair";var p=parseFloat(g.split("|")[1].split(",")[0]),d=parseFloat(g.split("|")[1].split(",")[1]);n={x:p,y:d};var f=new gEcnu.Style({cirRadius:3,opacity:1,fillColor:"red",strokeColor:"red",lineWeight:2});t.overLayer.setStyle(f);var r=t.overLayer._ctx;gEcnu.Util.setStyle(r,f),gEcnu.Graph.drawPoint(r,n)}else if(h=gEcnu.Graph.catchLine(n,u),h.indexOf("true")>=0){var y=parseFloat(h.split("|")[2].split(",")[0]),v=parseFloat(h.split("|")[2].split(",")[1]),m=parseFloat(h.split("|")[3].split(",")[0]),E=parseFloat(h.split("|")[3].split(",")[1]),_={x:y,y:v},S={x:m,y:E},f=new gEcnu.Style({cirRadius:3,opacity:1,fillColor:"red",strokeColor:"red",lineWeight:2});t.overLayer.setStyle(f);var r=t.overLayer._ctx;gEcnu.Util.setStyle(r,f),gEcnu.Graph.drawLine(r,_,S)}}if(s>=1){var f=new gEcnu.Style({opacity:1,fillColor:"#82D900",strokeColor:"#82D900",lineWeight:1});t.overLayer.setStyle(f);var r=t.overLayer._ctx;gEcnu.Util.setStyle(r,f);var x=gEcnu.Util.worldToScreen(a[s-1].x,a[s-1].y);if(gEcnu.Graph.drawLine(r,x,n),s>=2){var b=gEcnu.Util.worldToScreen(a[0].x,a[0].y);gEcnu.Graph.drawLine(r,b,n)}gEcnu.Graph.drawLines_geo(r,a),g.indexOf("true")>=0&&gEcnu.Graph.drawPoint(r,n)}gEcnu.Graph.drawPoints_geo(r,a);break;case"moveNode_mouseDwon":case"selectPolygon":if(t.mLayer.getLayerContainer().style.cursor=t.cursorStyle.select,null!=gEcnu.Edit.selectedPolygon&&gEcnu.EditFeature.setting._reshape){t.mLayer.getLayerContainer().style.cursor=t.cursorStyle.select;for(var w=gEcnu.Edit.selectedPolygon._lineRings.length,L=0;w>L;L++)for(var M=gEcnu.Edit.selectedPolygon._lineRings[L].points,C=M.length,P=0;C>P;P++){var T=gEcnu.Util.worldToScreen(M[P].x,M[P].y),F=Math.sqrt((n.x-T.x)*(n.x-T.x)+(n.y-T.y)*(n.y-T.y));if(5>F)return gEcnu.Edit.Poly_selPoint_index=P,gEcnu.Edit.Poly_sellineRing_index=L,t.mLayer.getLayerContainer().style.cursor="move",void t.setMode("moveNode_mouseDwon")}}t.setMode("selectPolygon");break;case"moveNode":if(-1!=gEcnu.Edit.Poly_selPoint_index){var U=gEcnu.Edit.selectedPolygon,I=U._lineRings[gEcnu.Edit.Poly_sellineRing_index].points[gEcnu.Edit.Poly_selPoint_index],A=U._lineRings[gEcnu.Edit.Poly_sellineRing_index].points.length,k=U._lineRings[gEcnu.Edit.Poly_sellineRing_index].points[A-1],o=gEcnu.EditFeature.setting,l=o._catchable,c=o._layer;if(t.overLayer.clear(),l){for(var D=c.getAllFeatures(),z=new Array,L=0;L<D.length;L++)D[L]!=U&&z.push(D[L]);var g=gEcnu.Graph.catchPoint(n,z);if(g.indexOf("true")>=0){t.mLayer.getLayerContainer().style.cursor="crosshair";var p=parseFloat(g.split("|")[1].split(",")[0]),d=parseFloat(g.split("|")[1].split(",")[1]);n={x:p,y:d},I.x=parseFloat(g.split("|")[1].split(",")[2]),I.y=parseFloat(g.split("|")[1].split(",")[3]),0==gEcnu.Edit.Poly_selPoint_index&&(k.x=I.x,k.y=I.y);var r=t.overLayer._ctx;gEcnu.Graph.drawPoint(r,n)}else{t.mLayer.getLayerContainer().style.cursor=t.cursorStyle.select;var h=gEcnu.Graph.catchLine(n,z);if(h.indexOf("true")>=0){t.mLayer.getLayerContainer().style.cursor=t.cursorStyle.select;var y=parseFloat(h.split("|")[2].split(",")[0]),v=parseFloat(h.split("|")[2].split(",")[1]),m=parseFloat(h.split("|")[3].split(",")[0]),E=parseFloat(h.split("|")[3].split(",")[1]),_={x:y,y:v},S={x:m,y:E};I.x=parseFloat(h.split("|")[1].split(",")[2]),I.y=parseFloat(h.split("|")[1].split(",")[3]),0==gEcnu.Edit.Poly_selPoint_index&&(k.x=I.x,k.y=I.y);var r=t.overLayer._ctx;gEcnu.Graph.drawLine(r,_,S)}else{t.mLayer.getLayerContainer().style.cursor=t.cursorStyle.select;var S=gEcnu.Util.screenToWorld(n.x,n.y);I.x=S.x,I.y=S.y,0==gEcnu.Edit.Poly_selPoint_index&&(k.x=I.x,k.y=I.y)}}var r=t.overLayer._ctx,R=new gEcnu.Style({opacity:1,fillColor:"#82D900",strokeColor:"#82D900",lineWeight:1});t.overLayer.setStyle(R),gEcnu.Util.setStyle(r,R),gEcnu.Graph.drawPoints_geo(r,U._lineRings[gEcnu.Edit.Poly_sellineRing_index].points);var O=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});t.overLayer.setStyle(O),gEcnu.Util.setStyle(r,O),gEcnu.Graph.drawLines_geo(r,U._lineRings[gEcnu.Edit.Poly_sellineRing_index].points)}else{t.mLayer.getLayerContainer().style.cursor="pointer";var S=gEcnu.Util.screenToWorld(n.x,n.y);I.x=S.x,I.y=S.y,0==gEcnu.Edit.Poly_selPoint_index&&(k.x=I.x,k.y=I.y);var r=t.overLayer._ctx,R=new gEcnu.Style({opacity:1,fillColor:"#82D900",strokeColor:"#82D900",lineWeight:1});t.overLayer.setStyle(R),gEcnu.Util.setStyle(r,R),gEcnu.Graph.drawPoints_geo(r,U._lineRings[gEcnu.Edit.Poly_sellineRing_index].points);var O=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});t.overLayer.setStyle(O),gEcnu.Util.setStyle(r,O),gEcnu.Graph.drawLines_geo(r,U._lineRings[gEcnu.Edit.Poly_sellineRing_index].points)}}break;case"addPoint":var h="false";if(null==gEcnu.Edit.selectedPolygon)return;if(h=gEcnu.Graph.catchLine(n,[gEcnu.Edit.selectedPolygon]),h.indexOf("true")>=0){t.mLayer.getLayerContainer().style.cursor="crosshair";var W=parseFloat(h.split("|")[1].split(",")[0]),G=parseFloat(h.split("|")[1].split(",")[1]),r=t.overLayer._ctx;gEcnu.Edit.selectedPolygon.onSelect();var f=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});return t.overLayer.setStyle(f),gEcnu.Util.setStyle(r,f),void gEcnu.Graph.drawPoint(r,{
x:W,y:G})}t.mLayer.getLayerContainer().style.cursor=t.cursorStyle.select,gEcnu.Edit.selectedPolygon.onSelect();break;case"delPoint":var g="false";if(null==gEcnu.Edit.selectedPolygon)return;if(g=gEcnu.Graph.catchPoint(n,[gEcnu.Edit.selectedPolygon]),g.indexOf("true")>=0){t.mLayer.getLayerContainer().style.cursor="pointer";var p=parseFloat(g.split("|")[1].split(",")[0]),d=parseFloat(g.split("|")[1].split(",")[1]),r=t.overLayer._ctx;gEcnu.Edit.selectedPolygon.onSelect();var f=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});return t.overLayer.setStyle(f),gEcnu.Util.setStyle(r,f),void gEcnu.Graph.drawPoint(r,{x:p,y:d})}t.mLayer.getLayerContainer().style.cursor=t.cursorStyle.select,gEcnu.Edit.selectedPolygon.onSelect();break;case"moveNodeLine_mouseDwon":case"selectLine":if(t.mLayer.getLayerContainer().style.cursor=t.cursorStyle.select,null!=gEcnu.Edit.selectedLine&&gEcnu.EditFeature.setting._reshape){t.mLayer.getLayerContainer().style.cursor=t.cursorStyle.select;for(var w=gEcnu.Edit.selectedLine._lineStrings.length,L=0;w>L;L++)for(var M=gEcnu.Edit.selectedLine._lineStrings[L].points,C=M.length,P=0;C>P;P++){var T=gEcnu.Util.worldToScreen(M[P].x,M[P].y),F=Math.sqrt((n.x-T.x)*(n.x-T.x)+(n.y-T.y)*(n.y-T.y));if(5>F)return gEcnu.Edit.Line_sellineString_index=L,gEcnu.Edit.Line_selPoint_index=P,t.mLayer.getLayerContainer().style.cursor="move",void t.setMode("moveNodeLine_mouseDwon")}}t.setMode("selectLine");break;case"selectPoint":case"selectText":t.mLayer.getLayerContainer().style.cursor=t.cursorStyle.select;break;case"moveNode_Line":if(-1!=gEcnu.Edit.Line_selPoint_index){var B=gEcnu.Edit.selectedLine,I=B._lineStrings[gEcnu.Edit.Line_sellineString_index].points[gEcnu.Edit.Line_selPoint_index],o=gEcnu.EditFeature.setting,l=o._catchable,c=o._layer;if(t.overLayer.clear(),l){for(var D=c.getAllFeatures(),z=new Array,L=0;L<D.length;L++)D[L]!=B&&z.push(D[L]);var g=gEcnu.Graph.catchPoint(n,z);if(g.indexOf("true")>=0){t.mLayer.getLayerContainer().style.cursor="crosshair";var p=parseFloat(g.split("|")[1].split(",")[0]),d=parseFloat(g.split("|")[1].split(",")[1]);n={x:p,y:d},I.x=parseFloat(g.split("|")[1].split(",")[2]),I.y=parseFloat(g.split("|")[1].split(",")[3]);var r=t.overLayer._ctx;gEcnu.Graph.drawPoint(r,n)}else{t.mLayer.getLayerContainer().style.cursor="move";var h=gEcnu.Graph.catchLine(n,z);if(h.indexOf("true")>=0){t.mLayer.getLayerContainer().style.cursor="default";var y=parseFloat(h.split("|")[2].split(",")[0]),v=parseFloat(h.split("|")[2].split(",")[1]),m=parseFloat(h.split("|")[3].split(",")[0]),E=parseFloat(h.split("|")[3].split(",")[1]),_={x:y,y:v},S={x:m,y:E};I.x=parseFloat(h.split("|")[1].split(",")[2]),I.y=parseFloat(h.split("|")[1].split(",")[3]);var r=t.overLayer._ctx;gEcnu.Graph.drawLine(r,_,S)}else{t.mLayer.getLayerContainer().style.cursor="move";var S=gEcnu.Util.screenToWorld(n.x,n.y);I.x=S.x,I.y=S.y}}var r=t.overLayer._ctx;gEcnu.Graph.drawPoints_geo(r,B._lineStrings[gEcnu.Edit.Line_sellineString_index].points),gEcnu.Graph.drawLines_geo(r,B._lineStrings[gEcnu.Edit.Line_sellineString_index].points)}else{t.mLayer.getLayerContainer().style.cursor="pointer";var S=gEcnu.Util.screenToWorld(n.x,n.y);I.x=S.x,I.y=S.y;var r=t.overLayer._ctx;gEcnu.Graph.drawPoints_geo(r,B._lineStrings[gEcnu.Edit.Line_sellineString_index].points),gEcnu.Graph.drawLines_geo(r,B._lineStrings[gEcnu.Edit.Line_sellineString_index].points)}}break;case"addPoint_line":var h="false";if(null==gEcnu.Edit.selectedLine)return;if(h=gEcnu.Graph.catchLine(n,[gEcnu.Edit.selectedLine]),h.indexOf("true")>=0){t.mLayer.getLayerContainer().style.cursor="crosshair";var W=parseFloat(h.split("|")[1].split(",")[0]),G=parseFloat(h.split("|")[1].split(",")[1]),r=t.overLayer._ctx;gEcnu.Edit.selectedLine.onSelect();var f=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});return t.overLayer.setStyle(f),gEcnu.Util.setStyle(r,f),void gEcnu.Graph.drawPoint(r,{x:W,y:G})}t.mLayer.getLayerContainer().style.cursor="default",gEcnu.Edit.selectedLine.onSelect();break;case"delPoint_line":var g="false";if(null==gEcnu.Edit.selectedLine)return;if(g=gEcnu.Graph.catchPoint(n,[gEcnu.Edit.selectedLine]),g.indexOf("true")>=0){t.mLayer.getLayerContainer().style.cursor="pointer";var p=parseFloat(g.split("|")[1].split(",")[0]),d=parseFloat(g.split("|")[1].split(",")[1]),r=t.overLayer._ctx;gEcnu.Edit.selectedLine.onSelect();var f=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});return t.overLayer.setStyle(f),gEcnu.Util.setStyle(r,f),void gEcnu.Graph.drawPoint(r,{x:p,y:d})}t.mLayer.getLayerContainer().style.cursor="default",gEcnu.Edit.selectedLine.onSelect();break;case"drawRect":t.mLayer.getLayerContainer().style.cursor=t.cursorStyle.draw;var H=gEcnu.Util.screenToWorld(n.x,n.y);new gEcnu.Geometry.Point(H.x,H.y);if(gEcnu.Edit.draw_rect_points.length>0){gSelf.overLayer.clear();var r=gSelf.overLayer.getCtx();r.strokeStyle="red";var N=n.x-gSelf.startX,X=n.y-gSelf.startY;r.strokeRect(gSelf.startX,gSelf.startY,N,X)}break;case"drawCircle":t.mLayer.getLayerContainer().style.cursor=t.cursorStyle.draw;var H=gEcnu.Util.screenToWorld(n.x,n.y);new gEcnu.Geometry.Point(H.x,H.y);if(gEcnu.Edit.draw_circle_points.length>0){gSelf.overLayer.clear();var r=gSelf.overLayer.getCtx();r.strokeStyle="red",r.beginPath();var Y=Math.sqrt((n.x-gSelf.startX)*(n.x-gSelf.startX)+(n.y-gSelf.startY)*(n.y-gSelf.startY));r.arc(gSelf.startX,gSelf.startY,Y,0,2*Math.PI,!0),r.stroke(),r.closePath();var q=gEcnu.DrawFeature.setting.isDisplayRadius;if(q){r.beginPath(),r.moveTo(gSelf.startX,gSelf.startY),r.lineTo(n.x,n.y),r.stroke();var Q=gEcnu.Util.screenToWorld_geo(n.x,n.y),V=gEcnu.Util.screenToWorld_geo(gSelf.startX,gSelf.startY),F=Math.sqrt((V.x-Q.x)*(V.x-Q.x)+(V.y-Q.y)*(V.y-Q.y)),j=(n.x+gSelf.startX)/2,Z=(n.y+gSelf.startY)/2;r.fillStyle="red",r.font="14px Arial";var J=Number(F).toFixed(0)+"米";parseInt(F/1e3)>0&&(J=(F/1e3).toFixed(0)+"千米"),r.fillText(J,j-50,Z-10)}}break;case"drawMarker":t.mLayer.getLayerContainer().style.cursor=t.cursorStyle.mark;break;case"drawPoint":t.mLayer.getLayerContainer().style.cursor=t.cursorStyle.draw;break;case"drawText":t.mLayer.getLayerContainer().style.cursor=t.cursorStyle.draw}},gEcnu.Edit.graphMouseUpEvt=function(e,t){var i=t.getMode(),n=gEcnu.Util.getMouseXY(gSelf._container,e),r=gEcnu.Util.screenToWorld(n.x,n.y);switch(gEcnu.Edit.moving=!1,i){case"moveNode":for(var a=gEcnu.EditFeature.setting,s=a._layer,o=s.getAllFeatures(),l=[],c=0;c<o.length;c++)o[c]!=gEcnu.Edit.selectedPolygon_pre&&l.push(o[c]);var g=gEcnu.Edit.selectedPolygon._data,h={};for(var u in g)h[u]=g[u];var p=new gEcnu.Feature.Polygon(gEcnu.Edit.selectedPolygon._lineRings,h);l.push(p),gEcnu.Edit.selectedPolygon.shape=p.shape,gEcnu.Edit.selectedPolygon_pre=p,gEcnu.Edit.selectedPolygon=p,s.removeAllFeatures(),s.addFeatures(l),p.onSelect(),t.setMode("moveNode_mouseDwon");var d=gEcnu.EditFeature.setting.events._events.updateCompleted;"undefined"!=typeof d&&d(e,p);break;case"moveNode_Line":for(var a=gEcnu.EditFeature.setting,s=a._layer,o=s.getAllFeatures(),l=[],c=0;c<o.length;c++)o[c]!=gEcnu.Edit.selectedLine_pre&&l.push(o[c]);var g=gEcnu.Edit.selectedLine._data,h={};for(var u in g)h[u]=g[u];var p=new gEcnu.Feature.Polyline(gEcnu.Edit.selectedLine._lineStrings,h);l.push(p),gEcnu.Edit.selectedLine.shape=p.shape,gEcnu.Edit.selectedLine_pre=p,gEcnu.Edit.selectedLine=p,s.removeAllFeatures(),s.addFeatures(l),p.onSelect(),t.setMode("moveNodeLine_mouseDwon");var d=gEcnu.EditFeature.setting.events._events.updateCompleted;"undefined"!=typeof d&&d(e,p);break;case"drawRect":console.log("up");var f=new gEcnu.Geometry.Point(r.x,r.y);gEcnu.Edit.draw_rect_points.push(f);var y=gEcnu.Edit.draw_rect_points[1].x,v=gEcnu.Edit.draw_rect_points[0].y,m=gEcnu.Edit.draw_rect_points[1].x,E=gEcnu.Edit.draw_rect_points[1].y,_=gEcnu.Edit.draw_rect_points[0].x,S=gEcnu.Edit.draw_rect_points[1].y,x=new gEcnu.Geometry.Point(y,v),b=new gEcnu.Geometry.Point(m,E),w=new gEcnu.Geometry.Point(_,S);gEcnu.Edit.draw_rect_points[1]=x,gEcnu.Edit.draw_rect_points.push(b),gEcnu.Edit.draw_rect_points.push(w);var L=new gEcnu.Geometry.RectRing(gEcnu.Edit.draw_rect_points),M=gEcnu.DrawFeature.setting.events._events.added;"undefined"!=typeof M&&(M(e,L),gEcnu.Edit.draw_rect_points=[]),gSelf.overLayer.clear();break;case"drawCircle":var f=new gEcnu.Geometry.Point(r.x,r.y);gEcnu.Edit.draw_circle_points.push(f);var C=gEcnu.Edit.draw_circle_points[0];if(gEcnu.Edit.draw_circle_points.length>=2){var P=gEcnu.Edit.draw_circle_points[0],T=gEcnu.Edit.draw_circle_points[1],F=Math.sqrt((T.x-P.x)*(T.x-P.x)+(T.y-P.y)*(T.y-P.y)),U=new gEcnu.Geometry.RadiusRing(C,F),M=gEcnu.DrawFeature.setting.events._events.added;"undefined"!=typeof M&&(M(e,U),gEcnu.Edit.draw_circle_points=[])}}},gEcnu.Edit.graphMouseDblClickEvt=function(e,t){var i=t.getMode();switch(i){case"drawLine":gEcnu.Edit.draw_line_points.pop();var n=new gEcnu.Geometry.LineString(gEcnu.Edit.draw_line_points),r=gEcnu.DrawFeature.setting.events._events.added;"undefined"!=typeof r&&(r(e,n),gEcnu.Edit.draw_line_points=[]),t.overLayer.clear();break;case"drawPolygon":gEcnu.Edit.draw_polygon_points.pop();var a=new gEcnu.Geometry.LinearRing(gEcnu.Edit.draw_polygon_points),r=gEcnu.DrawFeature.setting.events._events.added;"undefined"!=typeof r&&(r(e,a),gEcnu.Edit.draw_polygon_points=[]),t.overLayer.clear()}};var eagleEye_self=null;gEcnu.Control=gClass.extend({init:function(e,t){this.id=e,this.options={top:15,left:15,zIndex:500}},setPos:function(){this._container.style.left=this.options.left+"px",this._container.style.top=this.options.top+"px",this._container.style.zIndex=this.options.zIndex},renew:function(){}}),gEcnu.Control.Zoom=gEcnu.Control.extend({init:function(e,t){this._super(e,t),this.options=gEcnu.Util.setOptions(this,t)},_initContainer:function(){var e=30,t=60,i=gEcnu.Util.createDiv("zoomCtrl",e,t,!0),n=gEcnu.Util.createDiv("zoomInDiv",e,t/2,!1),r=new Image;r.src=gEcnu.config.imgPath+"zoomin.png",n.appendChild(r);var a=gEcnu.Util.createDiv("zoomOutDiv",e,t/2,!1),s=new Image;s.src=gEcnu.config.imgPath+"zoomout.png",r.onmouseup=function(e){gEcnu.Util.stopPropagation(e),gSelf.zoomIn()},s.onmouseup=function(e){gEcnu.Util.stopPropagation(e),gSelf.zoomOut()},a.appendChild(s),i.appendChild(n),i.appendChild(a),this._container=i},onAdd:function(e){var t=e.getContainer();this._initContainer(),this.setPos(),t.appendChild(this._container)},setPos:function(){this._container.style.right="15px",this._container.style.top="40px",this._container.style.zIndex=this.options.zIndex}}),gEcnu.Control.Scale=gEcnu.Control.extend({init:function(e,t){this._super(e,t),this.options={zIndex:15,fontColor:"#000"},this.oClass="scaleControl",this.options=gEcnu.Util.setOptions(this,t)},setScalePos:function(e){this.posOption=e},onAdd:function(e){this.scaleLeft=20,this.scaleTop=7,this._initContainer(e),this.setPos(),e.getContainer().appendChild(this._container)},setPos:function(){var e=this.posOption;e?(void 0!=e.right&&(this._container.style.right=e.right+"px"),void 0!=e.bottom&&(this._container.style.bottom=e.bottom+"px"),void 0!=e.left&&(this._container.style.left=e.left+"px"),void 0!=e.top&&(this._container.style.top=e.top+"px")):(this._container.style.right="15px",this._container.style.bottom="10px"),this._container.style.zIndex=this.options.zIndex},_initContainer:function(e){this._map=e;var t=e.getSize(),i=180,n=30,r=gEcnu.Util.createCanvas("scaleCtrl",i,n,!0);r.style.backgroundColor="rgba(224,224,224,0.75)";var a=r.getContext("2d");this._container=r,this._ctx=a,this._showScale(t)},_showScale:function(e){var t=e.h,i=this._ctx,n=this._showScaleText(i,t),r=n.allpx,a=n.halfpx,s=this.scaleLeft,o=this.scaleTop;i.beginPath(),i.strokeStyle=this.options.fontColor,i.fillStyle=this.options.fontColor,i.linewidth=1,i.moveTo(s,o),i.lineTo(s,o+3),i.lineTo(r+s,o+3),i.lineTo(r+s,o),i.closePath(),i.fill(),i.beginPath(),i.moveTo(s+1,o+3),i.lineTo(s+1,o+6),i.closePath(),i.stroke(),i.beginPath(),i.moveTo(r+s-1,o+3),i.lineTo(r+s-1,o+6),i.closePath(),i.stroke(),i.beginPath(),i.moveTo(a+s-1,o+3),i.lineTo(a+s-1,o+6),i.closePath(),i.stroke()},_showScaleText:function(e,t){var i;if("GEOGRAPHIC"==gSelf.coordsFlag){var n=111.31955*gSelf.zoom*1e3;i=n/parseInt(gSelf.w)}else i=gSelf.zoom/parseInt(gSelf.w);var r=this._getScaleWidth(i),a=r.halfmeter,s=r.allmeter,o=r.allpx,l=r.halfpx,c=this.scaleLeft,g=this.scaleTop;return e.clearRect(0,0,200,t),e.font="14px serif",e.fillStyle=this.options.fontColor,e.fillText("0",c,g+20),e.fillText(a,c+l-5,g+20),e.fillText(s,c+o,g+20),r},_getScaleWidth:function(e){var t={};return 16>=e?(t.halfpx=50,t.allpx=100,t.halfmeter=Math.round(50*e)+"m",t.allmeter=2*Math.round(50*e)+"m"):(t.halfpx=50,t.allpx=100,t.halfmeter=Math.round(50*e/1e3)+"km",t.allmeter=2*Math.round(50*e/1e3)+"km"),t},clear:function(){var e=this._container;this._ctx.clearRect(0,0,e.width,e.height)},renew:function(){this.clear(),this._showScale(this._map)}}),gEcnu.Control.Scale_bak=gEcnu.Control.extend({init:function(e,t){this._super(e,t),this.options={top:0,left:0,zIndex:15,fontColor:"#000"},this.oClass="scaleControl",this.options=gEcnu.Util.setOptions(this,t)},onAdd:function(e){this.scaleLeft=this.scaleLeft||26,this.scaleTop=this.scaleTop||e.getSize().h-33,this._initContainer(e),this.setPos(),e.getContainer().appendChild(this._container)},_initContainer:function(e){this._map=e;var t=e.getSize(),i=gEcnu.Util.createCanvas("scaleCtrl",t.w,t.h,!0),n=i.getContext("2d");this._container=i,this._ctx=n,this._showScale(t)},setScalePos:function(e,t){var t=t||{},i=e.getSize(),n=t.left?t.left:t.right?i.w-t.right:26,r=t.top?t.top:t.bottom?i.h-t.bottom:i.h-33;this.scaleLeft=n,this.scaleTop=r},_showScale:function(e){var t=e.h,i=this._ctx,n=this._showScaleText(i,t),r=n.allpx,a=n.halfpx,s=this.scaleLeft,o=this.scaleTop;i.beginPath(),i.strokeStyle=this.options.fontColor,i.fillStyle=this.options.fontColor,i.linewidth=1,i.moveTo(s,o),i.lineTo(s,o+3),i.lineTo(r+s,o+3),i.lineTo(r+s,o),i.closePath(),i.fill(),i.beginPath(),i.moveTo(s+1,o+3),i.lineTo(s+1,o+6),i.closePath(),i.stroke(),i.beginPath(),i.moveTo(r+s-1,o+3),i.lineTo(r+s-1,o+6),i.closePath(),i.stroke(),i.beginPath(),i.moveTo(a+s-1,o+3),i.lineTo(a+s-1,o+6),i.closePath(),i.stroke()},_showScaleText:function(e,t){var i;if("GEOGRAPHIC"==gSelf.coordsFlag){var n=111.31955*gSelf.zoom*1e3;i=n/parseInt(gSelf.w)}else i=gSelf.zoom/parseInt(gSelf.w);var r=this._getScaleWidth(i),a=r.halfmeter,s=r.allmeter,o=r.allpx,l=r.halfpx,c=this.scaleLeft,g=this.scaleTop;return e.clearRect(0,0,200,t),e.font="14px serif",e.fillStyle=this.options.fontColor,e.fillText("0",c,g+20),e.fillText(a,c+l-5,g+20),e.fillText(s,c+o,g+20),r},_getScaleWidth:function(e){var t={};return 16>=e?(t.halfpx=50,t.allpx=100,t.halfmeter=Math.round(50*e)+"m",t.allmeter=2*Math.round(50*e)+"m"):(t.halfpx=50,t.allpx=100,t.halfmeter=Math.round(50*e/1e3)+"km",t.allmeter=2*Math.round(50*e/1e3)+"km"),t},clear:function(){var e=this._container;this._ctx.clearRect(0,0,e.width,e.height)},renew:function(){this.clear(),this._showScale(this._map)}}),gEcnu.Control.EagleEye=gEcnu.Control.extend({init:function(e,t,i){eagleEye_self=this,this.id=e,this.mapSource=t,this.options={top:0,left:0,zIndex:500},this.oClass="eagleMapControl",this.options=gEcnu.Util.setOptions(this,i)},_initContainer:function(){var e=document.getElementById(this.id),t=gEcnu.Util.delpx(gEcnu.Util.getEleStyle(e,"width")),i=gEcnu.Util.delpx(gEcnu.Util.getEleStyle(e,"height")),n=gEcnu.Util.createDiv("eagle_tMap",t,i,!0),r=gEcnu.Util.createDiv("eagle_dynlyr",t,i,!0),a=gEcnu.Util.createCanvas("canvas_grid",t,i,!0);a.style.zIndex=10,e.appendChild(n),e.appendChild(r),e.appendChild(a),this._container=e,this._tianContainer=n,this._dynContainer=r,this._posCanvas=a,this._eagleWidth=t,this._eagleHeight=i},setPos:function(){},onAdd:function(e){this._map=e,this._initContainer(),this._initProp(e),this.reqEagle()},_initProp:function(e){var t=e.getZoom(),i=e.getCenter();this._mapzoom=t.z,this.eagleZoom=2*t.z,this.eCenterX=i.x,this.eCenterY=i.y,this.eagleBasemap=null},eagleMapChange:function(e,t,i){this.eagleZoom=e,this.eCenterX=t,this.eCenterY=i,this.reqEagle()},reqEagle:function(){this._reqMap(),this._reqDyn(),this._showPosinEagle()},_reqMap:function(){null!=this.eagleBasemap?this._renewBasemap():this._firstReqmap()},_renewBasemap:function(){var e=this._eagleWidth,t=this.eCenterX,i=this.eCenterY,n=this.eagleZoom,r=n/e,a=parseInt(Math.log(r)/Math.log(2))+1;console.log("other zl",18-a);var s=gEcnu.Util.shToLngLat(t,i);switch(this.mapSource){case"GOOGLE":this.eagleBasemap.setCenter(new google.maps.LatLng(s.lat,s.lng)),this.eagleBasemap.setZoom(18-a);break;case"BAIDU":this.eagleBasemap.centerAndZoom(new BMap.Point(s.lng,s.lat),19-a);break;case"TMAP":var s=gEcnu.Util.shToLngLat(t-400,i+230);this.eagleBasemap.centerAndZoom(new TLngLat(s.lng,s.lat),18-a)}},_firstReqmap:function(){var e=this,t=document.createElement("script");switch(this.mapSource){case"GOOGLE":t.src="https://maps.googleapis.com/maps/api/js?sensor=false&callback=showOtherMap_eagle",document.getElementsByTagName("head")[0].appendChild(t);break;case"BAIDU":t.src="http://api.map.baidu.com/api?v=1.4&callback=showOtherMap_eagle",document.getElementsByTagName("head")[0].appendChild(t);break;case"TMAP":var i="http://api.tianditu.com/js/maps.js";e._isLoadScript(i)?showOtherMap_eagle():(t.src=i,t.onload=showOtherMap_eagle,document.getElementsByTagName("head")[0].appendChild(t));break;case"NONE":}},_isLoadScript:function(e){var t=document.getElementsByTagName("head")[0].getElementsByTagName("script");if(void 0==t)return!1;for(var i=0,n=t.length;n>i;i++)if(t[i].src==e)return!0;return!1},_reqDyn:function(){var e=this._dynContainer,t=document.getElementById("eagleImg");void 0==t&&(t=new Image,t.id="eagleImg",e.appendChild(t));var i=this.eCenterX,n=this.eCenterY,r=this._eagleWidth,a=this._eagleHeight,s=this.eagleZoom,o=(gEcnu.config.geoserver+"WebMap","ecnugis/1"),l="zhenjiedaomian",c={map:o,cx:i,cy:n,w:r,h:a,zoom:s,lyrs:l,mt:"zoomto","return":"json"};console.log("params",c)},_showPosinEagle:function(){var e=this._map,t=e.getCenter(),i=(this._eagleWidth,this._eagleHeight,this.eCenterX,this.eCenterY,this.eagleZoom,e.getBounds()),n=i.nw.x,r=i.nw.y,a=i.se.x,s=i.se.y,o=this._worldToScr_eagle(t.x,t.y),l=this._worldToScr_eagle(n,r),c=this._worldToScr_eagle(a,s),g=(o.x,o.y,c.x-l.x),h=c.y-l.y;this._drawPosCanvas(l.x,l.y,g,h)},isInEagleEyemap:function(){var e=this._map.getBounds(),t=e.nw.x,i=e.nw.y,n=e.se.x,r=e.se.y,a=this._worldToScr_eagle(t,i),s=this._worldToScr_eagle(n,r),o=a.x,l=a.y,c=s.x,g=s.y,h=this._eagleWidth,u=this._eagleHeight;return 0>o||0>l||c>h||g>u?!1:!0},_drawPosCanvas:function(e,t,i,n){var r=this._posCanvas,a=r.getContext("2d");a.clearRect(0,0,this._eagleWidth,this._eagleHeight),a.strokeStyle="red",a.lineWidth=1,a.strokeRect(e,t,i,n)},_worldToScr_eagle:function(e,t){var i=this._eagleWidth,n=this._eagleHeight,r=this.eCenterX,a=this.eCenterY,s=this.eagleZoom,o=s/i,l=i/2+(e-r)/o,c=n/2-(t-a)/o;return{x:l,y:c}},renew:function(){var e=this._map.getZoom(),t=e.z,i=this._mapzoom;t==i&&this.isInEagleEyemap()?this._showPosinEagle():(this._initProp(this._map),this.reqEagle())}}),gEcnu.DrawFeature=gClass.extend({init:function(e){this.name=e}}),gEcnu.DrawFeature.setting=null,gEcnu.DrawFeature.Marker=gEcnu.DrawFeature.extend({init:function(){this._layer=gSelf.mLayer},activate:function(){this._layer._map.setMode("drawMarker"),gEcnu.DrawFeature.setting=this},deactivate:function(){this._layer._map.setMode("map")},events:{_events:{},on:function(e,t){switch(e){case"added":this._events.added=t}}}}),gEcnu.DrawFeature.Point=gEcnu.DrawFeature.extend({init:function(e){this._layer=e},reVoke:function(){},activate:function(){this._layer._map.setMode("drawPoint"),gEcnu.DrawFeature.setting=this},deactivate:function(){this._layer._map.setMode("map")},events:{_events:{},on:function(e,t){switch(e){case"added":this._events.added=t}}}}),gEcnu.DrawFeature.Line=gEcnu.DrawFeature.extend({init:function(e,t){this._layer=e,this._catchable=!0,arguments.length>1&&(this._catchable=t)},setCatchable:function(e){this._catchable=e},reVoke:function(){if(gEcnu.Edit.draw_line_points.length>0){gEcnu.Edit.draw_line_points.pop();var e=new gEcnu.Style({opacity:1,fillColor:"#82D900",strokeColor:"#82D900",lineWeight:1});this._layer._map.overLayer.setStyle(e);var t=this._layer._map.overLayer._ctx;gEcnu.Util.setStyle(t,e);var i=gEcnu.Edit.draw_line_points.length,n=gEcnu.Edit.draw_line_points;if(this._layer._map.overLayer.clear(),i>=1){var r=gEcnu.Util.worldToScreen(n[i-1].x,n[i-1].y);if(gEcnu.Graph.drawLine(t,r,gEcnu.Edit.NowPoint),i>=2){var a=gEcnu.Util.worldToScreen(n[0].x,n[0].y);gEcnu.Graph.drawLine(t,a,gEcnu.Edit.NowPoint)}gEcnu.Graph.drawLines_geo(t,n)}gEcnu.Graph.drawPoints_geo(t,n)}else alert("节点为空，不能撤销节点")},activate:function(){this._layer._map.setMode("drawLine"),gEcnu.DrawFeature.setting=this},deactivate:function(){this._layer._map.setMode("map")},events:{_events:{},on:function(e,t){switch(e){case"added":this._events.added=t}}}}),gEcnu.DrawFeature.Polygon=gEcnu.DrawFeature.extend({init:function(e,t){this._layer=e,this._catchable=!0,arguments.length>1&&(this._catchable=t)},setCatchable:function(e){this._catchable=e},reVoke:function(){if(gEcnu.Edit.draw_polygon_points.length>0){gEcnu.Edit.draw_polygon_points.pop();var e=new gEcnu.Style({opacity:1,fillColor:"#82D900",strokeColor:"#82D900",lineWeight:1});this._layer._map.overLayer.setStyle(e);var t=this._layer._map.overLayer._ctx;gEcnu.Util.setStyle(t,e);var i=gEcnu.Edit.draw_polygon_points.length,n=gEcnu.Edit.draw_polygon_points;if(this._layer._map.overLayer.clear(),i>=1){var r=gEcnu.Util.worldToScreen(n[i-1].x,n[i-1].y);if(gEcnu.Graph.drawLine(t,r,gEcnu.Edit.NowPoint),i>=2){var a=gEcnu.Util.worldToScreen(n[0].x,n[0].y);gEcnu.Graph.drawLine(t,a,gEcnu.Edit.NowPoint)}gEcnu.Graph.drawLines_geo(t,n)}gEcnu.Graph.drawPoints_geo(t,n)}else alert("节点为空，不能撤销节点")},activate:function(){this._layer._map.setMode("drawPolygon"),gEcnu.DrawFeature.setting=this},deactivate:function(){this._layer._map.setMode("map")},events:{_events:{},on:function(e,t){switch(e){case"added":this._events.added=t}}}}),gEcnu.DrawFeature.Rect=gEcnu.DrawFeature.extend({init:function(e){this._layer=e},activate:function(){this._layer._map.setMode("drawRect"),gEcnu.DrawFeature.setting=this},deactivate:function(){this._layer._map.setMode("map")},events:{_events:{},on:function(e,t){switch(e){case"added":this._events.added=t}}}}),gEcnu.DrawFeature.Circle=gEcnu.DrawFeature.extend({init:function(e,t){this._layer=e,this.isDisplayRadius=arguments.length>1?arguments[1]:!1},activate:function(){this._layer._map.setMode("drawCircle"),gEcnu.DrawFeature.setting=this},deactivate:function(){this._layer._map.setMode("map")},events:{_events:{},on:function(e,t){switch(e){case"added":this._events.added=t}}}}),gEcnu.DrawFeature.Text=gEcnu.DrawFeature.extend({init:function(e){this._layer=e},activate:function(){this._layer._map.setMode("drawText"),gEcnu.DrawFeature.setting=this},deactivate:function(){this._layer._map.setMode("map")},events:{_events:{},on:function(e,t){switch(e){case"added":this._events.added=t}}}}),gEcnu.EditFeature=gClass.extend({init:function(){}}),gEcnu.EditFeature.setting=null,gEcnu.EditFeature.Polygon=gEcnu.EditFeature.extend({init:function(e,t){this._layer=e,this._catchable=!0,this._reshape=!1,arguments.length>1&&(this._catchable=t)},activate:function(e){this._layer._map.setMode("selectPolygon"),arguments.length>0&&(this._reshape=e),gEcnu.EditFeature.setting=this},deactivate:function(){this._layer._map.setMode("map"),this._layer._map.overLayer.clear(),gEcnu.EditFeature.setting=null,gEcnu.Edit.selectedPolygon=null,gEcnu.Edit.selectedPolygon_pre=null,gEcnu.Edit.Poly_sellineRing_index=-1,gEcnu.Edit.Poly_selPoint_index=-1,gEcnu.Edit.multiSelectedFeatures=[],this._layer._map.mLayer.getLayerContainer().style.cursor="default"},addPoint:function(){null!=gEcnu.EditFeature.setting&&null!=gEcnu.Edit.selectedPolygon&&this._layer._map.setMode("addPoint")},delPoint:function(){null!=gEcnu.EditFeature.setting&&null!=gEcnu.Edit.selectedPolygon&&this._layer._map.setMode("delPoint")},reShape:function(){this._reshape=!0},offReShape:function(){this._reshape=!1},setCatchable:function(e){this._catchable=e},events:{_events:{},on:function(e,t){switch(e){case"selected":this._events.selected=t;break;case"multiSelected":this._events.multiSelected=t;break;case"updateCompleted":this._events.updateCompleted=t}}}}),gEcnu.EditFeature.Line=gEcnu.EditFeature.extend({init:function(e,t){this._layer=e,this._catchable=!0,arguments.length>1&&(this._catchable=t),this._reshape=!1},activate:function(e){this._layer._map.setMode("selectLine"),arguments.length>0&&(this._reshape=e),gEcnu.EditFeature.setting=this},deactivate:function(){this._layer._map.setMode("map"),this._layer._map.overLayer.clear(),gEcnu.EditFeature.setting=null,gEcnu.Edit.selectedLine=null,gEcnu.Edit.selectedLine_pre=null,gEcnu.Edit.Line_sellineString_index=-1,gEcnu.Edit.Line_selPoint_index=-1,gEcnu.Edit.multiSelectedFeatures=[],this._layer._map.mLayer.getLayerContainer().style.cursor="default"},addPoint:function(){null!=gEcnu.EditFeature.setting&&null!=gEcnu.Edit.selectedLine&&this._layer._map.setMode("addPoint_line")},delPoint:function(){null!=gEcnu.EditFeature.setting&&null!=gEcnu.Edit.selectedLine&&this._layer._map.setMode("delPoint_line")},reShape:function(){this._reshape=!0},offReShape:function(){this._reshape=!1},setCatchable:function(e){this._catchable=e},events:{_events:{},on:function(e,t){switch(e){case"selected":this._events.selected=t;break;case"multiSelected":this._events.multiSelected=t;break;case"updateCompleted":this._events.updateCompleted=t}}}}),gEcnu.EditFeature.Point=gEcnu.EditFeature.extend({init:function(e){this._layer=e},activate:function(){this._layer._map.setMode("selectPoint"),gEcnu.EditFeature.setting=this},deactivate:function(){this._layer._map.setMode("map"),this._layer._map.overLayer.clear(),gEcnu.EditFeature.setting=null,gEcnu.Edit.selectedPoint=null,gEcnu.Edit.multiSelectedFeatures=[],this._layer._map.mLayer.getLayerContainer().style.cursor="default"},events:{_events:{},on:function(e,t){switch(e){case"selected":this._events.selected=t;break;case"multiSelected":this._events.multiSelected=t;break;case"updateCompleted":this._events.updateCompleted=t}}}}),gEcnu.EditFeature.Text=gEcnu.EditFeature.extend({init:function(e){this._layer=e},activate:function(){this._layer._map.setMode("selectText"),gEcnu.EditFeature.setting=this},deactivate:function(){this._layer._map.setMode("map"),this._layer._map.overLayer.clear(),gEcnu.EditFeature.setting=null,this._layer._map.mLayer.getLayerContainer().style.cursor="default"},events:{_events:{},on:function(e,t){switch(e){case"selected":this._events.selected=t}}}}),gEcnu.Style=gClass.extend({init:function(e){this.oStyle="singleStyle",void 0==e.fillColor?this.fillColor="#00DD00":this.fillColor=e.fillColor,void 0==e.strokeColor?this.strokeColor="#00DD00":this.strokeColor=e.strokeColor,void 0==e.lineWeight?this.lineWeight=1:this.lineWeight=e.lineWeight,void 0==e.borderStatus?this.borderStatus=!0:this.borderStatus=!1,void 0==e.cirRadius?this.cirRadius=3:this.cirRadius=e.cirRadius,void 0==e.fillStatus?this.fillStatus=!0:this.fillStatus=!1,void 0==e.vtxStatus?this.vtxStatus=!1:this.vtxStatus=!0,void 0==e.vtxRadius?this.vtxRadius=3:this.vtxRadius=e.vtxRadius,void 0==e.tlr?this.tlr=5:this.tlr=e.tlr,void 0==e.opacity?this.opacity=.4:this.opacity=e.opacity,void 0==e.mappingValue?this.mappingValue="default":this.mappingValue=e.mappingValue,void 0==e.fontSize?this.fontSize=13:this.fontSize=e.fontSize,void 0==e.fontFamily?this.fontFamily="KaiTi":this.fontFamily=e.fontFamily,void 0==e.fontColor?this.fontColor="#333333":this.fontColor=e.fontColor,void 0==e.bgColor?this.bgColor="#ffffff":this.bgColor=e.bgColor,e.levelRange&&(this.levelRange=e.levelRange),e.shadowColor&&(this.shadowColor=e.shadowColor),e.shadowOffsetX&&(this.shadowOffsetX=e.shadowOffsetX),e.shadowOffsetY&&(this.shadowOffsetY=e.shadowOffsetY),e.shadowBlur&&(this.shadowBlur=e.shadowBlur)}}),gEcnu.Style_Ex=gClass.extend({init:function(e,t){this.oStyle="multiStyles",this.styles=e,this.mappingField=t}}),gEcnu.Marker=gClass.extend({init:function(e,t,i){this.name=e,this._img=new Image,this._img.src=t.src,this.src=t.src,this._img.style.position="absolute",this._img.style.zIndex=100,this.info=t},onAdd:function(e){this._layer=e;var t=(e.getMap(),this._container=e.getLayerContainer());this.x=this.info.x,this.y=this.info.y;var i=gEcnu.Util.worldToScreen(this.info.x,this.info.y);this._img.style.left=i.x+this.info.offset.x+"px",this._img.style.top=i.y+this.info.offset.y+"px",this._img.style.cursor="pointer",t.appendChild(this._img)},onRemove:function(){this._container.removeChild(this._img)},getContainer:function(){return this._img},regEvent:function(e,t){if("click"==e){var i=this;gEcnu.Util.addEvtHandler(this.getContainer(),"mousedown",function(e){gEcnu.Util.preventDefault(e),gEcnu.Util.stopPropagation(e),0==gEcnu.Util.getButton(e)&&t.apply(i,arguments)}),this._img.onmouseup=function(e){gEcnu.Util.preventDefault(e),gEcnu.Util.stopPropagation(e)},this._img.onclick=function(e){gEcnu.Util.preventDefault(e),gEcnu.Util.stopPropagation(e)}}else if("Rclick"==e){var i=this;gEcnu.Util.addEvtHandler(this.getContainer(),"mousedown",function(e){gEcnu.Util.preventDefault(e),gEcnu.Util.stopPropagation(e),2==gEcnu.Util.getButton(e)&&t.apply(i,arguments)}),this._img.onmouseup=function(e){gEcnu.Util.preventDefault(e),gEcnu.Util.stopPropagation(e)},this._img.onclick=function(e){gEcnu.Util.preventDefault(e),gEcnu.Util.stopPropagation(e)}}},renew:function(){var e=(this._layer.getMap(),gEcnu.Util.worldToScreen(this.info.x,this.info.y));this._img.style.left=e.x+this.info.offset.x+"px",this._img.style.top=e.y+this.info.offset.y+"px"},showInfo:function(){console.log("Hello WebGIS")}}),gEcnu.Text=gClass.extend({init:function(e,t,i,n){this.id=e,this.startPoint=t.startPoint,this.boxMaxWidth=t.boxMaxWidth,this.text=t.text,this.fields=i,this.boxScrSize={xmin:0,ymin:0,xmax:0,ymax:0}},addFields:function(e){for(var t in e)this.fields[t]=e[t]},delFields:function(e){for(var t=e.length,i=0;t>i;i++){var n=e[i];delete this.fields[n]}},delAllFields:function(){this.fields={}},onAdd:function(e){var t=this.id;this._w=this.boxMaxWidth,this._h=50;var i=gEcnu.Util.createTextArea(t,this._w,this._h,!0);i.style.borderWidth=0,this._textContainer=i;var n=this._container=e.getLayerContainer();n.appendChild(this._textContainer),this._layer=e,this.onDraw(e)},onDraw:function(e){var t=e.style,i=gEcnu.Util.worldToScreen(this.startPoint.x,this.startPoint.y),n=e.resetStyle;("undefined"==typeof this.style||n)&&(this.style=t),this._textContainer.style.fontSize=this.style.fontSize+"px",this._textContainer.style.fontFamily=this.style.fontFamily+",SimSun",this._textContainer.style.color=this.style.fontColor,this._textContainer.style.borderRadius="3px",this._textContainer.style.padding="2px";var r=gEcnu.Util.resizeDivByContent(this.style.fontSize,this.text,this._w);this._textContainer.style.width=r.w+"px",this._textContainer.style.height=r.h+"px";var a=gEcnu.Util.colorRgb(this.style.bgColor,this.style.opacity-.1);this._textContainer.style.background=a,this._textContainer.textContent=this.text,this._textContainer.style.left=i.x+"px",this._textContainer.style.top=i.y+"px",this.boxScrSize={xmin:i.x,ymin:i.y,xmax:i.x+r.w,ymax:i.y+r.h},e._layerContainer.appendChild(this._textContainer)},setContent:function(e){this.text=e},setPosition:function(e,t){this.startPoint.x=e,this.startPoint.y=t},setSize:function(e){this._w=this.boxMaxWidth=e},onRemove:function(){this._container.removeChild(this._textContainer)},getContainer:function(){return this._textContainer},renew:function(){var e=this._layer;this.onDraw(e)},refresh:function(){this.renew()}}),gEcnu.Geometry=gClass.extend({init:function(e){this.name=e},getVertices:function(){},getBounds:function(){},calcBounds:function(){}}),gEcnu.Geometry.Point=gClass.extend({init:function(e,t){this.x=e,this.y=t,this.className="point"}}),gEcnu.Geometry.LineString=gEcnu.Geometry.extend({init:function(e){
this.className="line",this.points=[];for(var t=0;t<e.length;t++){var i=e[t];i instanceof gEcnu.Geometry.Point?this.points.push(i):alert("初始化节点失败！")}},addPoint:function(e,t){var i=/^\d+$/;i.test(t)?this.points.splice(t,0,e):this.points.push(e)},delPoint:function(e){this.points.splice(e,1)},removePoint:function(e){for(var t=0;t<this.points.length;t++)if(this.points[t]==e){this.points.splice(t,1);break}},getLength:function(){for(var e=this.points.length,t=0,i=0;e-1>i;i++){var n=Math.sqrt((this.points[i].x-this.points[i+1].x)*(this.points[i].x-this.points[i+1].x)+(this.points[i].y-this.points[i+1].y)*(this.points[i].y-this.points[i+1].y));t+=n}return t}}),gEcnu.Geometry.LinearRing=gEcnu.Geometry.LineString.extend({init:function(e){var t=e.length;if(2>=t)return void alert("组成多边形节点个数不足！");this._super(e),this.className="polygon";var i=e[0];this.points.push(i)},addPoint:function(e,t){this.points.splice(t,0,e)},delPoint:function(e){if(4==this.points.length)return void alert("节点数低于3个，不能删除！");if(this.points.splice(e,1),0==e){this.points.pop();var t=this.points[0];this.points.push(t)}},getCenterPoint:function(){for(var e=this.points,t=e.length,i=0,n=0,r=0;t>r;r++)i+=e[r].x,n+=e[r].y;var a=i/t,s=n/t,o=new gEcnu.Geometry.Point(a,s);return o},getArea:function(){for(var e=0,t=this.points,i=0;i<t.length;i++)e+=t[i].x*t[(i+1)%t.length].y-t[(i+1)%t.length].x*t[i].y;var n=parseInt(Math.abs(.5*e));return n}}),gEcnu.Geometry.RectRing=gEcnu.Geometry.LineString.extend({init:function(e){var t=e.length;return 4>t?void alert("组成矩形节点个数不足！"):(this._super(e),void(this.className="rect"))},addPoint:function(e,t){this.points.splice(t,0,e)},delPoint:function(e){if(4==this.points.length)return void alert("节点数低于3个，不能删除！");if(this.points.splice(e,1),0==e){this.points.pop();var t=this.points[0];this.points.push(t)}},getArea:function(){for(var e=0,t=this.points,i=0;i<t.length;i++)e+=t[i].x*t[(i+1)%t.length].y-t[(i+1)%t.length].x*t[i].y;var n=parseInt(Math.abs(.5*e));return n}}),gEcnu.Geometry.RadiusRing=gEcnu.Geometry.extend({init:function(e,t){this.radius=t,this.centerPoint=e,this.className="radius"},getArea:function(){return 6.28318*this.radius*this.radius}}),gEcnu.Graph={},gEcnu.Graph.drawPoint=function(e,t){e.beginPath(),e.arc(t.x,t.y,4,0,2*Math.PI,!0),e.closePath(),e.fill()},gEcnu.Graph.drawLine=function(e,t,i){e.beginPath(),e.moveTo(t.x,t.y),e.lineTo(i.x,i.y),e.closePath(),e.stroke()},gEcnu.Graph.drawPoint_geo=function(e,t){var i=gEcnu.Util.worldToScreen(t.x,t.y);e.beginPath(),e.arc(i.x,i.y,3,0,2*Math.PI,!0),e.closePath(),e.fill()},gEcnu.Graph.drawLine_geo=function(e,t,i){var n=gEcnu.Util.worldToScreen(t.x,t.y),r=gEcnu.Util.worldToScreen(i.x,i.y);e.beginPath(),e.moveTo(n.x,n.y),e.lineTo(r.x,r.y),e.closePath(),e.stroke()},gEcnu.Graph.drawPoints=function(e,t){for(var i=0;i<t.length;i++){var n={x:t[i].x,y:t[i].y};this.drawPoint(e,n)}},gEcnu.Graph.drawLines=function(e,t){t.length;e.beginPath();var i={x:t[0].x,y:t[0].y};e.moveTo(i.x,i.y);for(var n=1;n<t.length;n++)i={x:t[n].x,y:t[n].y},e.lineTo(i.x,i.y);e.stroke()},gEcnu.Graph.drawPoints_geo=function(e,t){for(var i=0;i<t.length;i++){var n=gEcnu.Util.worldToScreen(t[i].x,t[i].y);this.drawPoint(e,n)}},gEcnu.Graph.drawLines_geo=function(e,t){t.length;e.beginPath();var i=gEcnu.Util.worldToScreen(t[0].x,t[0].y);e.moveTo(i.x,i.y);for(var n=1;n<t.length;n++)i=gEcnu.Util.worldToScreen(t[n].x,t[n].y),e.lineTo(i.x,i.y);e.stroke()},gEcnu.Graph.catchPoint=function(e,t){var i="false",n=3;if(0==t.length)return i;for(var r=0;r<t.length;r++){var a=t[r]._lineStrings;if("undefined"==typeof a)var s=t[r]._lineRings;else var s=t[r]._lineStrings;for(var o=0;o<s.length;o++)for(var l=s[o].points,c=l.length,g=0;c>g;g++){var h=l[g],u=gEcnu.Util.worldToScreen(h.x,h.y),p=Math.sqrt((e.x-u.x)*(e.x-u.x)+(e.y-u.y)*(e.y-u.y));if(n>=p&&(e.x=u.x,e.y=u.y,"false"==i))return i="true|"+e.x+","+e.y+","+h.x+","+h.y+"|"+o+","+g}}return i},gEcnu.Graph.catchLine=function(e,t){for(var i=e.x,n=e.y,r=3,a="false",s=gEcnu.Util.screenToWorld(i,n),o=s.x,l=s.y,c=t.length,g=0;c>g;g++){var h=t[g]._lineStrings;if("undefined"==typeof h)var u=t[g]._lineRings;else var u=t[g]._lineStrings;for(var p=0;p<u.length;p++)for(var d=u[p].points,f=d.length,y=0;f>y;y++){var v=d[y];if(f-1>y){var m=d[y+1],E=gEcnu.Util.worldToScreen(v.x,v.y),_=v.x,S=v.y,x=gEcnu.Util.worldToScreen(m.x,m.y),b=m.x,w=m.y,L=Math.min(_,b),M=Math.max(_,b),C=Math.min(S,w),P=Math.max(S,w);if(_!=b&&S!=w){var T=(w-S)/(b-_),F=-1/T,U=S-T*_,I=l-F*o,A=(I-U)/(T-F),k=T*A+U;if(A>L&&M>A&&k>C&&P>k){var D=(x.y-E.y)/(x.x-E.x),z=-1/D,R=E.y-D*E.x,O=n-z*i,W=(O-R)/(D-z),G=D*W+R,B=Math.sqrt((i-W)*(i-W)+(n-G)*(n-G));if(r>B){a="true|"+W+","+G+","+A+","+k+"|"+E.x+","+E.y+"|"+x.x+","+x.y+"|"+p+","+y+","+g;break}}}if(_==b){var A=E.x,k=n,H=gEcnu.Util.screenToWorld(A,k);if(_>=L&&M>=_&&H.y>=C&&H.y<=P){var B=Math.abs(A-i);if(r>B){a="true|"+A+","+k+","+_+","+H.y+"|"+E.x+","+E.y+"|"+x.x+","+x.y+"|"+p+","+y+","+g;break}}}if(S==w){var A=i,k=E.y,H=gEcnu.Util.screenToWorld(A,k);if(H.x>=L&&H.x<=M&&S>=C&&P>=S){var B=Math.abs(n-k);if(r>B){a="true|"+A+","+k+","+H.x+","+S+"|"+E.x+","+E.y+"|"+x.x+","+x.y+"|"+p+","+y+","+g;break}}}}}}return a},gEcnu.Graph.pointInPoly=function(e,t){for(var i=!1,n=-1,r=t.length,a=r-1;++n<r;a=n)(t[n].y<=e.y&&e.y<t[a].y||t[a].y<=e.y&&e.y<t[n].y)&&e.x<(t[a].x-t[n].x)*(e.y-t[n].y)/(t[a].y-t[n].y)+t[n].x&&(i=!i);return i},gEcnu.Graph.pointJionLine=function(e,t){var i=t.length,n=!1;return 0>=i?n:n},gEcnu.WebFeatureServices=gClass.extend({init:function(){}}),gEcnu.QueryType={},gEcnu.QueryType.Point="point_qry",gEcnu.QueryType.Line="line_qry",gEcnu.QueryType.Polygon="polygon_qry",gEcnu.QueryType.Rect="rect_qry",gEcnu.layerType={},gEcnu.layerType.Esri="shp",gEcnu.layerType.GeoDB="geodb",gEcnu.WebFeatureServices.QueryByGeometry=gEcnu.WebFeatureServices.extend({init:function(e){"undefined"!=typeof e&&(this.events._events.processCompleted=e.processCompleted,this.events._events.processFailed=e.processFailed)},processAscyn:function(e,t,i,n,r,a,s){var o=gEcnu.config.geoserver+"WebFeature",l=0;if(l=a?1:0,e instanceof gEcnu.Geometry.Point){var c={};"geodb"==t?c={mt:"SeachAt",geoDB:i,ftSet:n,Point:{x:e.x,y:e.y},Err:r,"return":{shape:l,fields:s}}:"shp"==t&&(c={mt:"SeachAt",map:i,lyr:n,Point:{x:e.x,y:e.y},Err:r,"return":{shape:l,fields:s}});var g=JSON.stringify(c),h={req:g}}else if(e instanceof gEcnu.Geometry.LineString&&"line"==e.className);else if(e instanceof gEcnu.Geometry.LinearRing&&"polygon"==e.className){var u={},p=new gEcnu.Feature.Polygon([e],{}),d=p.shape;"geodb"==t?u={mt:"SelectByShape",geoDB:i,ftSet:n,shape:d,sMode:0,"return":{shape:l,fields:s}}:"shp"==t&&(u={mt:"SelectByShape",map:i,lyr:n,shape:d,sMode:0,"return":{shape:l,fields:s}});var g=JSON.stringify(u),h={req:g}}else if(e instanceof gEcnu.Geometry.RectRing&&"rect"==e.className){var f={},y=gEcnu.Util.getShpBox(e.points);"geodb"==t?f={mt:"SelectByRect",geoDB:i,ftSet:n,rect:{xmin:y[0],ymin:y[1],xmax:y[2],ymax:y[3]},"return":{shape:l,fields:s}}:"shp"==t&&(f={mt:"SelectByRect",map:i,lyr:n,rect:{xmin:y[0],ymin:y[1],xmax:y[2],ymax:y[3]},"return":{shape:l,fields:s}});var g=JSON.stringify(f),h={req:g}}else if(e instanceof gEcnu.Geometry.RadiusRing&&"radius"==e.className){var v={};"geodb"==t?v={mt:"SelectByRadius",geoDB:i,ftSet:n,Point:{x:e.centerPoint.x,y:e.centerPoint.y},R:e.radius,"return":{shape:l,fields:s}}:"shp"==t&&(v={mt:"SelectByRadius",map:i,lyr:n,Point:{x:e.centerPoint.x,y:e.centerPoint.y},R:e.radius,"return":{shape:l,fields:s}});var g=JSON.stringify(v),h={req:g}}var E=this,_=E.events._events.processCompleted,S=E.events._events.processFailed;try{gEcnu.Util.ajax("POST",o,h,!0,function(e,t){var i=t.suc,n=JSON.parse(e),r=[];if(r=n.Features,0==r.length)"undefined"!=typeof i&&i(r);else if(1==l){for(var a=[],s=0;s<r.length;s++){var o=r[s],c=o.shape.shpType;if(5==c){for(var g=o.shape.Parts,h=g.length,u=o.shape.Points,p=[],d=0;h>d;d++){var f=g[d];if(d==h-1)var y=u.length;else var y=g[d+1];for(var v=[],E=f;y-1>E;E++){var _=new gEcnu.Geometry.Point(u[E].X,u[E].Y);v.push(_)}var S=new gEcnu.Geometry.LinearRing(v);p.push(S)}var x=o.fields,b={};if("undefined"!=typeof x)for(var w=x.length,L=0;w>L;L++){var M=x[L];for(m in M)b[m]=M[m]}b.FID=o.FID;var C=new gEcnu.Feature.Polygon(p,b);a.push(C)}else if(3==c){for(var g=o.shape.Parts,h=g.length,u=o.shape.Points,P=[],d=0;h>d;d++){var f=g[d];if(d==h-1)var y=u.length;else var y=g[d+1];for(var T=[],E=f;y>E;E++){var _=new gEcnu.Geometry.Point(u[E].X,u[E].Y);T.push(_)}var F=new gEcnu.Geometry.LineString(T);P.push(F)}var x=o.fields,b={};if("undefined"!=typeof x)for(var w=x.length,L=0;w>L;L++){var M=x[L];for(m in M)b[m]=M[m]}b.FID=o.FID;var C=new gEcnu.Feature.Polyline(P,b);a.push(C)}else{for(var u=o.shape.Points,U=[],d=0;d<u.length;d++){var _=new gEcnu.Geometry.Point(u[d].X,u[d].Y);U.push(_)}var x=o.fields,b={};if("undefined"!=typeof x)for(var w=x.length,L=0;w>L;L++){var M=x[L];for(m in M)b[m]=M[m]}b.FID=o.FID;var C=new gEcnu.Feature.Point(U,b);a.push(C)}}"undefined"!=typeof i&&i(a)}else if(0==l){for(var a=[],s=0;s<r.length;s++){var o=r[s],x=o.fields,b={};if("undefined"!=typeof x)for(var w=x.length,L=0;w>L;L++){var M=x[L];for(m in M)b[m]=M[m]}b.FID=o.FID,b.cx=o.cx,b.cy=o.cy,a.push(b)}"undefined"!=typeof i&&i(a)}},function(){alert("webfeature请求超时")},5e4,{suc:_,fail:S})}catch(x){"undefined"!=typeof S&&S(x)}},events:{_events:{},on:function(e,t){switch(e){case"processCompleted":this._events.processCompleted=t;break;case"processFailed":this._events.processFailed=t}}}}),gEcnu.WebFeatureServices.QueryBySQL=gEcnu.WebFeatureServices.extend({init:function(e){"undefined"!=typeof e&&(this.events._events.processCompleted=e.processCompleted,this.events._events.processFailed=e.processFailed)},processAscyn:function(e,t,i,n,r,a){var s=gEcnu.config.geoserver+"WebFeature",o=0;o=r?1:0;var l={};if("geodb"==t)l={mt:"SQLQuery",geoDB:i,ftSet:n,sql:e,"return":{shape:o,fields:a}};else if("shp"==t)return void alert("暂时不支持shp图层查询");var c=JSON.stringify(l),g={req:c},h=this,u=h.events._events.processCompleted,p=h.events._events.processFailed;try{gEcnu.Util.ajax("POST",s,g,!0,function(e,t){var i=t.suc,n=JSON.parse(e),r=[];if(r=n.Features,0==r.length)"undefined"!=typeof i&&i(r);else if(1==o){for(var a=[],s=0;s<r.length;s++){var l=!1,c=r[s],g=c.shape.shpType;if(5==g){for(var h=c.shape.Parts,u=h.length,p=c.shape.Points,d=[],f=0;u>f;f++){var y=h[f];if(f==u-1)var v=p.length;else var v=h[f+1];for(var E=[],_=y;v-1>_;_++){var S=new gEcnu.Geometry.Point(p[_].X,p[_].Y);E.push(S)}var x=new gEcnu.Geometry.LinearRing(E);if("polygon"!=x.className){l=!0;break}d.push(x)}if(l)continue;var b=c.fields,w={};if("undefined"!=typeof b)for(var L=b.length,M=0;L>M;M++){var C=b[M];for(m in C)w[m]=C[m]}w.FID=c.FID;var P=new gEcnu.Feature.Polygon(d,w);a.push(P)}else if(3==g){for(var h=c.shape.Parts,u=h.length,p=c.shape.Points,T=[],f=0;u>f;f++){var y=h[f];if(f==u-1)var v=p.length;else var v=h[f+1];for(var F=[],_=y;v>_;_++){var S=new gEcnu.Geometry.Point(p[_].X,p[_].Y);F.push(S)}var U=new gEcnu.Geometry.LineString(F);T.push(U)}var b=c.fields,w={};if("undefined"!=typeof b)for(var L=b.length,M=0;L>M;M++){var C=b[M];for(m in C)w[m]=C[m]}w.FID=c.FID;var P=new gEcnu.Feature.Polyline(T,w);a.push(P)}else{for(var p=c.shape.Points,I=[],f=0;f<p.length;f++){var S=new gEcnu.Geometry.Point(p[f].X,p[f].Y);I.push(S)}var b=c.fields,w={};if("undefined"!=typeof b)for(var L=b.length,M=0;L>M;M++){var C=b[M];for(m in C)w[m]=C[m]}w.FID=c.FID;var P=new gEcnu.Feature.Point(I,w);a.push(P)}}"undefined"!=typeof i&&i(a)}else if(0==o){for(var a=[],s=0;s<r.length;s++){var c=r[s],b=c.fields,w={};if("undefined"!=typeof b)for(var L=b.length,M=0;L>M;M++){var C=b[M];for(m in C)w[m]=C[m]}w.FID=c.FID,w.cx=c.cx,w.cy=c.cy,a.push(w)}"undefined"!=typeof i&&i(a)}},function(){alert("webfeature请求超时")},5e5,{suc:u,fail:p})}catch(d){"undefined"!=typeof p&&p(d)}},events:{_events:{},on:function(e,t){switch(e){case"processCompleted":this._events.processCompleted=t;break;case"processFailed":this._events.processFailed=t}}}}),gEcnu.ActType={},gEcnu.ActType.ADD="ADD",gEcnu.ActType.DELETE="DELETE",gEcnu.ActType.UPDATE="UPDATE",gEcnu.ActType.SQLTask="SQLTask",gEcnu.WebFeatureServices.FeatureServices=gEcnu.WebFeatureServices.extend({init:function(e){"undefined"!=typeof e&&(this.events._events.processCompleted=e.processCompleted,this.events._events.processFailed=e.processFailed)},processAscyn:function(e,t,i,n,r){var a=gEcnu.config.geoserver+"WebFeature";if("ADD"==e){for(var s={},o=r.length,l=[],c=0;o>c;c++){var g={};g.shape=r[c].shape,g.fields=[];var h=r[c].fields;for(var u in h){var p={};p[u]=escape(h[u]),g.fields.push(p)}l.push(g)}"geodb"==t?s={mt:"SQLInsert",geoDB:i,ftSet:n,features:l}:"shp"==t&&(s={mt:"SQLInsert",map:i,lyr:n,features:l});var d=JSON.stringify(s),f={req:d}}else if("DELETE"==e){var y={};"geodb"==t?y={mt:"SQLDelete",geoDB:i,ftSet:n,sql:r}:"shp"==t&&(y={mt:"SQLDelete",map:i,lyr:n,sql:r});var d=JSON.stringify(y),f={req:d}}else if("UPDATE"==e){for(var v={},o=r.length,m=[],c=0;o>c;c++){var E={};if(E.FID=r[c].FID,"SHP"==r[c].UPDATE)E.shape=r[c].Feature.shape;else if("FIELDS"==r[c].UPDATE){E.fields=[];var h=r[c].Feature.fields;for(var u in h){var p={};p[u]=escape(h[u]),E.fields.push(p)}}else{E.shape=r[c].Feature.shape,E.fields=[];var h=r[c].Feature.fields;for(var u in h){var p={};p[u]=escape(h[u]),E.fields.push(p)}}m.push(E)}"geodb"==t?v={mt:"SQLUpdate",geoDB:i,ftSet:n,features:m}:"shp"==t&&(v={mt:"SQLUpdate",map:i,lyr:n,features:m});var d=JSON.stringify(v),f={req:d}}else if("SQLTask"==e){var _={};"geodb"==t?_={mt:"SQLTask",geoDB:i,task:n}:"shp"==t&&(alert("对不起，暂时不支持shp图层批量操作！"),_={mt:"SQLTask",map:i,task:n});var d=JSON.stringify(_),f={req:d}}var S=this;try{gEcnu.Util.ajax("POST",a,f,!0,function(e){"undefined"!=typeof S.events._events.processCompleted&&S.events._events.processCompleted()},function(){alert("webfeature请求超时")},5e5)}catch(x){"undefined"!=typeof S.events._events.processFailed&&S.events._events.processFailed(x)}},events:{_events:{},on:function(e,t){switch(e){case"processCompleted":this._events.processCompleted=t;break;case"processFailed":this._events.processFailed=t}}}}),gEcnu.WebFeatureServices.SQLTasks=gEcnu.WebFeatureServices.extend({init:function(e,t,i,n){if("ADD"==e){for(var r={},a=n.length,s=[],o=0;a>o;o++){var l={};l.shape=n[o].shape,l.fields=[];var c=n[o].fields;for(var g in c){var h={};h[g]=c[g],l.fields.push(h)}s.push(l)}"geodb"==t?r={mt:"SQLInsert",ftSet:i,features:s}:"shp"==t&&(r={mt:"SQLInsert",lyr:i,features:s}),this.taskParams=r}else if("DELETE"==e){var u={};"geodb"==t?u={mt:"SQLDelete",ftSet:i,sql:n}:"shp"==t&&(u={mt:"SQLDelete",lyr:i,sql:n}),this.taskParams=u}else if("UPDATE"==e){for(var p={},a=n.length,d=[],o=0;a>o;o++){var f={};if(f.FID=n[o].FID,"SHP"==n[o].UPDATE)f.shape=n[o].Feature.shape;else if("FIELDS"==n[o].UPDATE){f.fields=[];var c=n[o].Feature.fields;for(var g in c){var h={};h[g]=c[g],f.fields.push(h)}}else{f.shape=n[o].Feature.shape,f.fields=[];var c=n[o].Feature.fields;for(var g in c){var h={};h[g]=c[g],f.fields.push(h)}}d.push(f)}"geodb"==t?p={mt:"SQLUpdate",ftSet:i,features:d}:"shp"==t&&(p={mt:"SQLUpdate",lyr:i,features:d}),this.taskParams=p}}}),gEcnu.FtSetParams={},gEcnu.FtSetParams.PUBLICDB="publicdb",gEcnu.FtSetParams.FIELDMETEDATA="fieldinfo",gEcnu.FtSetParams.FEATURESETLIST="ftSetList",gEcnu.WebFeatureServices.createFeatureSet=gEcnu.WebFeatureServices.extend({init:function(e,t,i,n,r,a){this.ftsetName=e,this.shpType=t,this.viewExtent=i,this.coordSystem=n,this.fields=[],this.fields=this.fields.concat(r),this._callback=a,this._createFtset()},_createFtset:function(){var e=this,t="f_"+this.ftsetName,i=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(t){alert("创建要素表成功"),e._addftsetRecord()},processFailed:function(){}}),n="create table if not exists "+t+" (FID integer PRIMARY KEY,shpType integer,xmin double,ymin double,xmax double,ymax double,shpLen double,shpArea double,shpData blob,V1,V2,V3,V4,V5,V6,V7,V8,V9,V10,V11,V12,V13,V14,V15)";i.processAscyn(gEcnu.ActType.SQLEXEC,gEcnu.FtSetParams.PUBLICDB,n)},_addftsetRecord:function(){var e=this,t=this.ftsetName,i=this.shpType,n=this.viewExtent,r=this.coordSystem,a=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(t){alert("添加要素列表记录成功"),e._addFieldinfoRecord()},processFailed:function(){}}),s={Fields:["ftsetName","shptype","viewextent","coordsys","datasource"],Data:[[t,i,n,r,t]]};a.processAscyn(gEcnu.ActType.ADD,gEcnu.FtSetParams.PUBLICDB,gEcnu.FtSetParams.FEATURESETLIST,s)},_addFieldinfoRecord:function(){var e=[],t=this.fields;e=e.concat(t);var i="f_"+this.ftsetName,n=[],r=this._callback;if(e.length<1)return void(void 0!=r&&r());for(var a=0,s=e.length;s>a;a++){var o=e[a],l=o.field,c=o.fieldType,g="V"+a,h=[g,i,l,c];n.push(h)}var u=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(e){alert("向字段元数据表中添加记录成功"),void 0!=r&&r()},processFailed:function(){}}),p={Fields:["field","tabname","fieldRealname","fieldtype"],Data:n};console.log("addfield",p),u.processAscyn(gEcnu.ActType.ADD,gEcnu.FtSetParams.PUBLICDB,gEcnu.FtSetParams.FIELDMETEDATA,p)}}),gEcnu.WebFeatureServices.editFeatureSet=gEcnu.WebFeatureServices.extend({init:function(e){this.ftsetName=e},addFields:function(e){var t=this.ftsetName,i="f_"+t,n=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(t){var n=t.length,r=t[n-1].field;endfldindex=parseInt(r.substring(1))+1,console.log(endfldindex);for(var a=[],s=0,o=e.length;o>s;s++){var l=e[s],c=l.field,g=l.fieldType,h=endfldindex+s,u="V"+h,p=[u,i,c,g];a.push(p)}var d=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(e){alert("添加字段成功")},processFailed:function(){}}),f={Fields:["field","tabname","fieldRealname","fieldtype"],Data:a};console.log("addfield",f),d.processAscyn(gEcnu.ActType.ADD,gEcnu.FtSetParams.PUBLICDB,gEcnu.FtSetParams.FIELDMETEDATA,f)},processFailed:function(){}}),r={lyr:gEcnu.FtSetParams.FIELDMETEDATA,fields:"field",filter:"tabname='"+i+"'"};n.processAscyn(gEcnu.ActType.SQLQUERY,gEcnu.FtSetParams.PUBLICDB,r)},deleteFields:function(e){for(var t="f_"+this.ftsetName,i=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(e){alert("删除字段成功")},processFailed:function(){}}),n="",r=e.length,a=0;r>a;a++)n=r-1>a?n+"fieldRealname='"+e[a]+"' or ":n+"fieldRealname='"+e[a]+"'";n="("+n+")";var s="delete from "+gEcnu.FtSetParams.FIELDMETEDATA+" where "+n+" and tabname='"+t+"'";console.log(s),i.processAscyn(gEcnu.ActType.SQLEXEC,gEcnu.FtSetParams.PUBLICDB,s)}}),gEcnu.WebFeatureServices.createMap=gEcnu.WebFeatureServices.extend({init:function(e,t,i,n,r,a){this.mapName=e,this.mapAlias=t,this.ftSets=i,this.mapCoords=n,this.mapExtent=r,this._callback=a,this._checkMapExist()},_checkMapExist:function(){var e=this.mapName,t=this,i=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(e){return console.log(e),e.length>0?void alert("已经存在该地图，请更换地图名"):void t._getMapId()},processFailed:function(){}}),n={lyr:"g_map",fields:"map_name",filter:"map_name='"+e+"'"};i.processAscyn(gEcnu.ActType.SQLQUERY,gEcnu.FtSetParams.PUBLICDB,n)},_getMapId:function(){var e=this,t=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(t){var i=t[0]["max(map_id)"];"null"==i&&(i=0),i=parseInt(i)+1,e._addMapRecord(i)},processFailed:function(){}}),i={lyr:"g_map",fields:"max(map_id)",filter:""};t.processAscyn(gEcnu.ActType.SQLQUERY,gEcnu.FtSetParams.PUBLICDB,i)},_addMapRecord:function(e){var t=this,i=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(i){alert("添加g_map记录成功"),t._getLyrFieldsByName(e)},processFailed:function(){}}),n=this.mapName,r=this.mapAlias,a=this.mapExtent,s=this.mapCoords,o={Fields:["map_name","map_alias","ViewExtent","coordsys"],Data:[[n,r,a,s]]};i.processAscyn(gEcnu.ActType.ADD,gEcnu.FtSetParams.PUBLICDB,"g_map",o)},_getLyrFieldsByName:function(e){var t=this,i=[],n=[];n=n.concat(this.ftSets),console.log();var r=0,a=n.length;!function s(){if(a>r){var o=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(e){i=i.concat(e),r++,s()},processFailed:function(){}}),l={lyr:gEcnu.FtSetParams.FEATURESETLIST,fields:"shptype,datasource",filter:"ftsetName='"+n[r]+"'"};o.processAscyn(gEcnu.ActType.SQLQUERY,gEcnu.FtSetParams.PUBLICDB,l)}else r==a&&t._addLayerRecord(e,i)}()},_addLayerRecord:function(e,t){var i=this._callback,n=new gEcnu.WebSQLServices.SQLServices({processCompleted:function(e){alert("添加g_layers记录成功"),void 0!=i&&i()},processFailed:function(){}}),r=[];r=r.concat(this.ftSets);var a="0,$00006432,1,0,$00006432",s="134,宋体,0,-14,0",o=[];console.log(r);for(var l=0,c=r.length;c>l;l++){console.log(l,c);var g=[],h=r[l];g[0]=h,g[1]=t[l].shptype,console.log(l,t[l]),g[2]=e,g[3]=h,g[4]=t[l].datasource,g[5]=s,g[6]=a,o.push(g)}var u={Fields:["lyr_name","lyr_type","map_id","alias","datasource","labelstyle","lyr_style"],Data:o};n.processAscyn(gEcnu.ActType.ADD,gEcnu.FtSetParams.PUBLICDB,"g_layers",u)}}),gEcnu.WebSQLServices=gClass.extend({init:function(){}}),gEcnu.ActType={},gEcnu.ActType.ADD="ADD",gEcnu.ActType.DELETE="DELETE",gEcnu.ActType.UPDATE="UPDATE",gEcnu.ActType.SQLQUERY="SQLQUERY",gEcnu.ActType.SQLEXEC="SQLEXEC",gEcnu.ActType.SQLTask="SQLTask",gEcnu.WebSQLServices.SQLServices=gEcnu.WebSQLServices.extend({init:function(e){"undefined"!=typeof e&&(this.events._events.processCompleted=e.processCompleted,this.events._events.processFailed=e.processFailed)},processAscyn:function(e,t,i,n){var r=gEcnu.config.geoserver+"WebSQL";if("ADD"==e)var a={mt:"SQLInsert",GeoDB:t,tablename:i,fldnames:n.Fields,data:n.Data},s=JSON.stringify(a),o={req:s};else if("SQLQUERY"==e){var l="select "+i.fields+" from "+i.lyr;"undefined"!=typeof i.filter&&""!=i.filter&&(l=l+" where "+i.filter);var c={mt:"SQLQuery",GeoDB:t,SQL:l},s=JSON.stringify(c),o={req:s}}else if("DELETE"==e)var g={mt:"SQLDelete",GeoDB:t,tablename:i,KeyFld:n.Fields,key:n.Data},s=JSON.stringify(g),o={req:s};else if("UPDATE"==e)var h={mt:"SQLUpdate",GeoDB:t,tablename:i,fldnames:n.Fields,data:n.Data},s=JSON.stringify(h),o={req:s};else if("SQLEXEC"==e)var u={mt:"SQLExec",GeoDB:t,SQL:i},s=JSON.stringify(u),o={req:s};else if("SQLTask"==e)var p={mt:"SQLTask",GeoDB:t,task:i},s=JSON.stringify(p),o={req:s};var d=this,f=d.events._events.processCompleted,y=d.events._events.processFailed;try{gEcnu.Util.ajax("POST",r,o,!0,function(t,n){var r=n.suc;if("undefined"!=typeof r){var a;if("SQLQUERY"==e){for(var s=JSON.parse(t),o=s.data,l=o.length,c=s.fldsDef,g=[],h=[],u=0;u<c.length;u++){var p=c[u].name;g.push(p)}for(var d=0;l>d;d++){var f=o[d];if("*"!=i.fields&&i.fields.indexOf("*")<0){var y=i.fields.split(","),v=f.length;if(v!=y.length)return void alert("查询字段与返回字段个数不统一，问题：存在数据库中不存在字段！");for(var m={},E=0;v>E;E++){var _=y[E],S=f[E];m[_]=S}h.push(m)}else{for(var m={},v=f.length,E=0;v>E;E++){var _=g[E],S=f[E];m[_]=S}h.push(m)}}a=h}else a=JSON.parse(t);r(a,c)}},function(){alert("websql请求超时")},5e5,{suc:f,fail:y})}catch(v){"undefined"!=typeof y&&y(v)}},events:{_events:{},on:function(e,t){switch(e){case"processCompleted":this._events.processCompleted=t;break;case"processFailed":this._events.processFailed=t}}}}),gEcnu.WebSQLServices.SQLTasks=gEcnu.WebSQLServices.extend({init:function(e,t,i){if("ADD"==e){var n={mt:"SQLInsert",tablename:t,fldnames:i.Fields,data:i.Data};this.sqlTaskParams=n}else if("DELETE"==e){var r={mt:"SQLDelete",tablename:t,KeyFld:i.Fields,key:i.Data};this.sqlTaskParams=r}else if("UPDATE"==e){var a={mt:"SQLUpdate",tablename:t,fldnames:i.Fields,data:i.Data};this.sqlTaskParams=a}else if("SQLEXEC"==e){var s={mt:"SQLExec",SQL:t};this.sqlTaskParams=s}}}),gEcnu.WebGeoCoding=gClass.extend({init:function(e){"undefined"!=typeof e&&(this.events._events.processCompleted=e.processCompleted,this.events._events.processFailed=e.processFailed)},geoCoding:function(e){var t=gEcnu.config.geoserver+"GeoUtils",i={mt:"GeoCoding",shape:e.shape},n=JSON.stringify(i),r={req:n},a=this;try{gEcnu.Util.ajax("POST",t,r,!1,function(e){if("undefined"!=typeof a.events._events.processCompleted){var t=JSON.parse(e);a.events._events.processCompleted(t)}},function(){alert("webgeocoding请求超时")},5e5)}catch(s){"undefined"!=typeof a.events._events.processFailed&&a.events._events.processFailed(s)}},deGeoCoding:function(e){},events:{_events:{},on:function(e,t){switch(e){case"processCompleted":this._events.processCompleted=t;break;case"processFailed":this._events.processFailed=t}}}});