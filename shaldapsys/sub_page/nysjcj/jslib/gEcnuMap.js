(function(){ var initializing=false;gClass=function(){};gClass.extend=function(prop){var baseClass=null;if(this!==gClass){baseClass=this}function F(){if(!initializing){if(baseClass){this._superprototype=baseClass.prototype}this.init.apply(this,arguments)}}if(baseClass){initializing=true;F.prototype=new baseClass();F.prototype.constructor=F;initializing=false}F.extend=arguments.callee;for(var name in prop){if(prop.hasOwnProperty(name)){if(baseClass&&typeof(prop[name])==="function"&&typeof(F.prototype[name])==="function"&&/\b_super\b/.test(prop[name])){F.prototype[name]=(function(name,fn){return function(){this._super=baseClass.prototype[name];return fn.apply(this,arguments)}})(name,prop[name])}else{F.prototype[name]=prop[name]}}}return F}})();gEcnu.WebSQLServices=gClass.extend({init:function(){},});gEcnu.ActType={};gEcnu.ActType.ADD="ADD";gEcnu.ActType.DELETE="DELETE";gEcnu.ActType.UPDATE="UPDATE";gEcnu.ActType.SQLQUERY="SQLQUERY";gEcnu.ActType.SQLEXEC="SQLEXEC";gEcnu.ActType.SQLTask="SQLTask";gEcnu.WebSQLServices.SQLServices=gEcnu.WebSQLServices.extend({init:function(eventsListener){if(typeof eventsListener!="undefined"){this.events._events.processCompleted=eventsListener.processCompleted;this.events._events.processFailed=eventsListener.processFailed}},processAscyn:function(ActionType,map,lyrOrSQL,Params){var websqlUrl="http://"+gEcnu.config.webHostIP+":"+gEcnu.config.port+"/WebSQL";if(ActionType=="ADD"){var addParams={"mt":"SQLInsert","GeoDB":map,"tablename":lyrOrSQL,"fldnames":Params.Fields,"data":Params.Data};var datastr=JSON.stringify(addParams);var params={req:datastr}}else{if(ActionType=="SQLQUERY"){var sqlqrysql="select "+lyrOrSQL.fields+" from "+lyrOrSQL.lyr;if(typeof(lyrOrSQL.filter)!="undefined"&&lyrOrSQL.filter!=""){sqlqrysql=sqlqrysql+" where "+lyrOrSQL.filter}var qryParams={"mt":"SQLQuery","GeoDB":map,"SQL":sqlqrysql};var datastr=JSON.stringify(qryParams);var params={req:datastr}}else{if(ActionType=="DELETE"){var delParams={"mt":"SQLDelete","GeoDB":map,"tablename":lyrOrSQL,"KeyFld":Params.Fields,"key":Params.Data};var datastr=JSON.stringify(delParams);var params={req:datastr}}else{if(ActionType=="UPDATE"){var updateParams={"mt":"SQLUpdate","GeoDB":map,"tablename":lyrOrSQL,"fldnames":Params.Fields,"data":Params.Data};var datastr=JSON.stringify(updateParams);var params={req:datastr}}else{if(ActionType=="SQLEXEC"){var sqlexecParams={"mt":"SQLExec","GeoDB":map,"SQL":lyrOrSQL};var datastr=JSON.stringify(sqlexecParams);var params={req:datastr}}else{if(ActionType=="SQLTask"){var sqltaskParams={"mt":"SQLTask","GeoDB":map,"task":lyrOrSQL};var datastr=JSON.stringify(sqltaskParams);var params={req:datastr}}}}}}}var websqlServices=this;try{gEcnu.Util.ajax("POST",websqlUrl,params,true,function(data){if(typeof(websqlServices.events._events.processCompleted)!="undefined"){var jsonparase;if(ActionType=="SQLQUERY"){var jsonparase_tmp=JSON.parse(data);var returnfields=jsonparase_tmp.data;var returnfields_len=returnfields.length;var returnArrays=[];for(var nn=0;nn<returnfields_len;nn++){var tmprecords=returnfields[nn];if(lyrOrSQL.fields!="*"){var qryFields=lyrOrSQL.fields.split(",");var returnFields_len=tmprecords.length;if(returnFields_len!=qryFields.length){alert("查询字段与返回字段个数不统一，问题：存在数据库中不存在字段！");return}var recordjson={};for(var tt=0;tt<returnFields_len;tt++){var fieldname=qryFields[tt];var fieldvalue=tmprecords[tt];recordjson[fieldname]=fieldvalue}returnArrays.push(recordjson)}else{var recordjson={};var returnFields_len=tmprecords.length;var allFieldsArr=jsonparase_tmp.fldsDef;var allFlds=[];for(var ii=0;ii<allFieldsArr.length;ii++){var fldname=allFieldsArr[ii].name;allFlds.push(fldname);}for(var tt=0;tt<returnFields_len;tt++){var fieldname=allFlds[tt];var fieldvalue=tmprecords[tt];recordjson[fieldname]=fieldvalue}returnArrays.push(recordjson)}}jsonparase=returnArrays}else{jsonparase=JSON.parse(data)}websqlServices.events._events.processCompleted(jsonparase)}},function(){alert("websql请求超时")},500000)}catch(e){if(typeof(websqlServices.events._events.processFailed)!="undefined"){websqlServices.events._events.processFailed(e)}}},events:{_events:{},on:function(eventType,callback){switch(eventType){case"processCompleted":this._events.processCompleted=callback;break;case"processFailed":this._events.processFailed=callback;break}}}});gEcnu.WebSQLServices.SQLTasks=gEcnu.WebSQLServices.extend({init:function(ActionType,lyrOrSQL,Params){if(ActionType=="ADD"){var addParams={"mt":"SQLInsert","tablename":lyrOrSQL,"fldnames":Params.Fields,"data":Params.Data};this.sqlTaskParams=addParams}else{if(ActionType=="DELETE"){var delParams={"mt":"SQLDelete","tablename":lyrOrSQL,"KeyFld":Params.Fields,"key":Params.Data};this.sqlTaskParams=delParams}else{if(ActionType=="UPDATE"){var updateParams={"mt":"SQLUpdate","tablename":lyrOrSQL,"fldnames":Params.Fields,"data":Params.Data};this.sqlTaskParams=updateParams}else{if(ActionType=="SQLEXEC"){var sqlexecParams={"mt":"SQLExec","SQL":lyrOrSQL};this.sqlTaskParams=sqlexecParams}}}}}});gEcnu.Layer=gClass.extend({init:function(id,options){this.id=id;this.visible=true;this.options={opacity:1,zIndex:0}},onAdd:function(map){var self=this;this._map=map;this._container=map.getContainer();
var size=map.getSize();this._initLayerContainer(this.id,size.w,size.h);this._initProp(map);this._initParams(map);this._container.appendChild(this._layerContainer);this.setzIndex();this.setOpacity(this.options.opacity)},onRemove:function(map){var container=map.getContainer();container.removeChild(this._layerContainer)},_initProp:function(map){},_initParams:function(map){},onDrag:function(dltx,dlty){this._layerContainer.style.left=this.startLeft+dltx+"px";this._layerContainer.style.top=this.startTop+dlty+"px"},zoomIn:function(){this.renew()},zoomOut:function(){this.renew()},zoomTo:function(){this.renew()},renew:function(){this._layerContainer.style.left=0+"px";this._layerContainer.style.top=0+"px"},show:function(){this.zoomTo();this._layerContainer.style.display="block";this.visible=true},hide:function(){this._layerContainer.style.display="none";this.visible=false},getSize:function(){return{w:this._layerContainer.clientWidth,h:this._layerContainer.clientHeight}},getScreenCenter:function(){return{x:parseInt(this._layerContainer.clientWidth/2),y:parseInt(this._layerContainer.clientHeight/2)}},getMap:function(){return this._map},getLayerContainer:function(){return this._layerContainer},setzIndex:function(){if(!isNaN(this.options.zIndex)){this._layerContainer.style.zIndex=this.options.zIndex}},setOpacity:function(val){this.getLayerContainer().style.opacity=val},resize:function(){this._layerContainer.style.width=this._map.w+"px";this._layerContainer.style.height=this._map.h+"px"}});gEcnu.Layer.Dyn=gEcnu.Layer.extend({init:function(ws,id,lyrStr,options){this._super(id,options);this.options={zIndex:4};this.lyrStr=lyrStr;this.ws=ws;this.oClass="dynLayer"},_initParams:function(map){var cxy=map.getCenter();var zoom=map.getZoom();var size=map.getSize();this.webMapURL=map.webMapURL;this.fileServer=map.fileServer;this._params={map:this.ws,w:size.w,h:size.h,mt:"zoomto",cx:cxy.x,cy:cxy.y,zoom:zoom.z,"return":"json",lyrs:""}},_initProp:function(map){var size=map.getSize();this._mapImg=new Image();this._layerContainer.appendChild(this._mapImg);this._mapImg.width=size.w;this._mapImg.height=size.h;this.ctrlLyrs=[];this.mapUrl=null;this.startLeft=0;this.startTop=0;this.requestTimer=null;this.ifInit=true},_initLayerContainer:function(id,w,h){var div=gEcnu.Util.createDiv(id,w,h,true);div.style.zIndex=2;this._layerContainer=div},onAdd:function(map){map.ownDyn=true;this._super(map);this.addLyr(this.lyrStr)},addLyr:function(lyrStr){var arr=lyrStr.split(",");for(var i=0;i<arr.length;i++){var j=this.ctrlLyrs.indexOf(arr[i]);if(j<0){this.ctrlLyrs.push(arr[i])}}this._params.lyrs=this.ctrlLyrs.join(",");this._params.mt="zoomto";this._request(this._params)},removeLyr:function(lyrStr){var arr=lyrStr.split(",");for(var i=0;i<arr.length;i++){var k=this.ctrlLyrs.indexOf(arr[i]);if(k>=0){for(var j=k;j<this.ctrlLyrs.length-1;j++){this.ctrlLyrs[j]=this.ctrlLyrs[j+1]}this.ctrlLyrs.length--}}this._params.lyrs=this.ctrlLyrs.join(",");this._params.mt="zoomto";this._request(this._params)},zoomIn:function(mouseXY){var params=this._params;params.zoom=params.zoom/2;this.scaleMap("zoomin",mouseXY);this.renew()},zoomOut:function(mouseXY){var params=this._params;params.zoom=params.zoom*2;this.scaleMap("zoomout",mouseXY);this.renew()},zoomTo:function(){this._params.zoom=this._map.zoom;this._params.cx=this._map.cx;this._params.cy=this._map.cy;this.renew()},scaleMap:function(tool,mouseXY){var d=this._layerContainer;if(typeof mouseXY=="undefined"){}else{var tx=mouseXY.x;var ty=mouseXY.y;var s=tx+"px "+ty+"px";d.style.webkitTransformOrigin=s;d.style.transformOrigin=s}d.style.transition="transform 100ms ease-in-out";d.style.transition="-webkit-transform 100ms ease-in-out";if(tool=="zoomin"){d.style.transform="scale(2,2)";d.style.webkitTransform="scale(2,2)"}if(tool=="zoomout"){d.style.transform="scale(0.5,0.5)";d.style.webkitTransform="scale(0.5,0.5)"}},renew:function(){this._params.cx=this._map.cx;this._params.cy=this._map.cy;this._params.zoom=this._map.zoom;var self=this;clearTimeout(self.requestTimer);self.requestTimer=setTimeout(function(){self._request(self._params)},150)},resize:function(){this._super();var map=this.getMap();var size=this.getSize();this._mapImg.width=size.w;this._mapImg.height=size.h;this._params.w=size.w;this._params.h=size.h;this._params.zoom="";this.renew()},_request:function(params){var self=this;var mapurl=this.webMapURL;var reqUrl="http://58.198.182.28:81/webmap?map=shxz2008&w="+params.w+"&h="+params.h+"&cx="+params.cx+"&cy="+params.cy+"&zoom="+params.zoom+"&lyrs="+params.lyrs+"&mt="+params.mt+"&return=json";var d=this._layerContainer;try{gEcnu.Util.ajax("get",mapurl,params,true,function(data){data=JSON.parse(data);if(!data.mapURL){alert("地图请求失败！");return}var req_lyrs=params.lyrs.toLowerCase();var res_lyrs=data.visibleLayers.toLowerCase();var paraX=Math.round(params.cx);var paraY=Math.round(params.cy);var resX=Math.round(data.centerX);var resY=Math.round(data.centerY);if((params.zoom==data.mapZoom)&&(paraX==resX)&&(paraY==resY)&&(req_lyrs==res_lyrs)){self._mapImg.src=self.fileServer+data.mapURL;
self._mapImg.onload=function(){d.style.left="0px";d.style.top="0px";d.style.transform="scale(1,1)";d.style.webkitTransform="scale(1,1)";d.style.transition="transform 0ms ease-in-out";d.style.transition="-webkit-transform 0ms ease-in-out";self.ifInit=false;self._mapImg.onload=null}}})}catch(e){alert("出现异常在："+e)}}});gEcnu.Layer.Tile=gEcnu.Layer.extend({init:function(id,options){this._super(id,options);this.options={opacity:1,zIndex:3};this.oClass="tileLayer"},_initLayerContainer:function(id,w,h){var div=gEcnu.Util.createDiv(id,w,h,true);this._layerContainer=div},_initMapView:function(w,h){this.mapView=document.createElement("div");this.mapView.id="mapView";this.mapView.width=this.w;this.mapView.height=this.h;this.mapView.style.position="absolute";this.mapView.style.top="0px";this.mapView.style.left="0px";this.mapView.style.width=w+"px";this.mapView.style.height=h+"px";this.mapView.style.overflow="hidden";this.mapView.style.zIndex=1;this.baseMap=document.createElement("div");this.baseMap.id="baseMap";this.baseMap.style.position="absolute";this.baseMap.style.left=this.xOffset+"px";this.baseMap.style.top=this.yOffset+"px";this.baseMap.style.width=this.nWidth*this.tileWidth+"px";this.baseMap.style.height=this.nHeight*this.tileHeight+"px";this.baseMap.style.zIndex=2;this.baseBgMap=this.baseMap.cloneNode();this.baseBgMap.id="baseBgMap";this.mapView.appendChild(this.baseMap);this.mapView.appendChild(this.baseBgMap);this._layerContainer.appendChild(this.mapView);this.baseBgMap.style.zIndex=1},_initParams:function(map){var size=map.getSize();var cxy=map.getCenter();var zoom=map.getZoom();this._params={req:"getmap",w:size.w,h:size.h,zl:zoom.zl,cx:cxy.x,cy:cxy.y,"return":"json"}},_initProp:function(map){this.mapLeft=this._container.offsetLeft;this.mapTop=this._container.offsetTop;this.startLeft=0;this.startTop=0;this.xOffset=-100;this.yOffset=-100;this.imgURL=gEcnu.config.imgPath+"blank.png";this.hasImgURL=[];this.tileWidth=map.tileWidth;this.tileHeight=map.tileHeight;var size=map.getSize();this.nWidth=Math.ceil(parseInt(size.w)/map.tileWidth)+1;this.nHeight=Math.ceil(parseInt(size.h)/map.tileHeight)+1;this.tileMapURL=map.tileMapURL;this.fileServer=map.fileServer;this.mapTool="pan";this.ifInit=false;this.ifZoomTo=false;this.requestTimer=null;var size=this.getMap().getSize();this._initMapView(size.w,size.h)},onAdd:function(map){map.ownTile=true;this._super(map);this._createTiles();this.ifInit=true;this._request(this._params)},onDrag:function(dltx,dlty){if(this.visible){this.baseMap.style.left=this.startLeft+dltx+"px";this.baseMap.style.top=this.startTop+dlty+"px"}},_panMap:function(){this.hideLayer("baseMap");while(this.xOffset>0){this.wrapR2L()}while(this.yOffset>0){this.wrapB2T()}while(this.xOffset<-this.tileWidth){this.wrapL2R()}while(this.yOffset<-this.tileHeight){this.wrapT2B()}this.showLayer("baseMap")},zoomIn:function(mouseXY){this.mapTool="zoomin";this.scaleMap(mouseXY);this.renew()},zoomOut:function(mouseXY){this.mapTool="zoomout";this.scaleMap(mouseXY);this.renew()},zoomTo:function(){this.ifZoomTo=true;this._params.zl=this._map.zl;this._params.cx=this._map.cx;this._params.cy=this._map.cy;this._resetTile();this.renew();this.mapTool="pan"},scaleMap:function(mouseXY){this.hideLayer("baseMap");var tx,ty;var scxy=this.getScreenCenter();var d=this.baseBgMap;if(typeof mouseXY=="undefined"){var tx=scxy.x-gEcnu.Util.delpx(this.baseMap.style.left);var ty=scxy.y-gEcnu.Util.delpx(this.baseMap.style.top)}else{var tx=mouseXY.x-gEcnu.Util.delpx(this.baseMap.style.left);var ty=mouseXY.y-gEcnu.Util.delpx(this.baseMap.style.top)}var bx=this.tileWidth*this.nWidth/2;var by=this.tileHeight*this.nHeight/2;var s=tx+"px "+ty+"px";d.style.webkitTransformOrigin=s;d.style.transformOrigin=s;var len=this.baseMap.childNodes.length;for(var i=0;i<len;i++){var imgtmp=this.baseMap.childNodes[0];d.appendChild(imgtmp)}if(this.mapTool=="zoomin"){d.style.transform="scale(2,2)";d.style.webkitTransform="scale(2,2)"}if(this.mapTool=="zoomout"){d.style.transform="scale(0.5,0.5)";d.style.webkitTransform="scale(0.5,0.5)"}d.style.transition="transform 100ms ease-in-out";d.style.transition="-webkit-transform 100ms ease-in-out"},renew:function(){this._params.cx=this._map.cx;this._params.cy=this._map.cy;this._params.zl=this._map.zl;if(this.mapTool=="pan"){this._panMap()}var self=this;clearTimeout(this.requestTimer);this.requestTimer=setTimeout(function(){self._request(self._params)},150)},resize:function(){this._super();var map=this.getMap();var size=map.getSize();this.nWidth=Math.ceil(parseInt(size.w)/map.tileWidth)+1;this.nHeight=Math.ceil(parseInt(size.h)/map.tileHeight)+1;this.mapView.style.width=size.w+"px";this.mapView.style.height=size.h+"px";this.baseMap.style.width=this.baseBgMap.style.width=this.nWidth*this.tileWidth+"px";this.baseMap.style.height=this.baseBgMap.style.height=this.nHeight*this.tileHeight+"px";this._params.w=size.w;this._params.h=size.h;for(var i=this.baseMap.childNodes.length-1;i>=0;i--){var tmpimg=this.baseMap.childNodes[i];this.baseMap.removeChild(tmpimg);
tmpimg=null}this.ifZoomTo=true;this._createTiles();this.renew();this.ifZoomTo=false},_request:function(params){var self=this;var mapurl=this.tileMapURL;var reqUrl=mapurl+"?w="+params.w+"&h="+params.h+"&cx="+params.cx+"&cy="+params.cy+"&zl="+params.zl+"&return='json'";try{var ifinit=false;if(this.ifInit){ifinit=false}else{ifinit=true}gEcnu.Util.ajax("get",mapurl,params,ifinit,function(data){data=JSON.parse(data);self._showMap(data)})}catch(e){alert("出现异常在："+e)}},_showMap:function(data){var self=this;var d=this.baseMap;var nWidth=this.nWidth;var nHeight=this.nHeight;if(this.ifInit||this.ifZoomTo||(this.mapTool=="zoomin")||(this.mapTool=="zoomout")){this.ifZoomTo=false;this.xOffset=data.tileInfo.xoff;this.yOffset=data.tileInfo.yoff;d.style.left=this.xOffset+"px";d.style.top=this.yOffset+"px";this._map.setZoom(data.tileInfo.zoom)}if(this.ifInit){this.baseBgMap.style.left=d.style.left;this.baseBgMap.style.top=d.style.top;this.ifInit=false}if(this._map.ownDyn){var oLayers=this._map.getAllLayers();var layer_len=oLayers.length;for(var i=0;i<layer_len;i++){if((oLayers[i].oClass=="dynLayer")&&(!(oLayers[i].ifInit))&&(this.mapTool!="zoomin")&&(this.mapTool!="zoomout")){oLayers[i].renew()}}}if((this.mapTool=="zoomin")||(this.mapTool=="zoomout")){this._createTiles()}var len=data.tiles.length;var responseCenterx=parseInt(data.tileInfo.cx,10);var responseCentery=parseInt(data.tileInfo.cy,10);var requestCenterx=parseInt(this._params.cx,10);var requestCentery=parseInt(this._params.cy,10);var j=0;var i=0;function getImg(){if(j>=len){self.mapTool="pan";return}var row=data.tiles[j].row;var col=data.tiles[j].col;var k=(row-1)*nWidth+(col-1);var imgtmp=d.childNodes[k];var tmpUrl=data.tiles[j].url;var tmpzl=tmpUrl.substring(16,17);var bx=this.tileWidth*this.nWidth/2;var by=this.tileHeight*this.nHeight/2;if(typeof(imgtmp)!="undefined"&&tmpzl==self._params.zl&&responseCenterx==requestCenterx&&requestCentery==responseCentery){var imgUrl=self.fileServer+tmpUrl;imgtmp.src=imgUrl;imgtmp.onload=function(){i++;if(i==len){var bg=self.baseBgMap;bg.style.left=self.baseMap.style.left;bg.style.top=self.baseMap.style.top;self.showLayer("baseMap");for(var q=bg.childNodes.length;q>0;q--){var imgtmp=bg.childNodes[q-1];bg.removeChild(imgtmp);imgtmp=null}bg.style.webkitTransform="scale(1,1)";bg.style.transform="scale(1,1)";var s=bx+"px "+by+"px";bg.style.webkitTransformOrigin=s;bg.style.transformOrigin=s;bg.style.transition="transform 10ms ease-in-out";bg.style.transition="-webkit-transform 10ms ease-in-out"}};self.hasImgURL[imgtmp.id]=true}j++;getImg()}getImg()},_resetTile:function(){var d=this.baseMap;for(var q=d.childNodes.length;q>0;q--){var imgtmp=d.childNodes[q-1];d.removeChild(imgtmp);imgtmp=null}this._createTiles()},_createTiles:function(){var ileft,itop;var num=this.nWidth*this.nHeight;for(var i=0;i<num;i++){var newImg=document.createElement("img");newImg.id="mt_"+i;newImg.src=this.imgURL;this.hasImgURL[newImg.id]=false;newImg.style.position="absolute";itop=Math.floor(i/this.nWidth)*this.tileHeight;ileft=Math.floor(i%this.nWidth)*this.tileWidth;newImg.style.left=ileft+"px";newImg.style.top=itop+"px";newImg.style.width=this.tileWidth+"px";newImg.style.height=this.tileHeight+"px";this.baseMap.appendChild(newImg)}},wrapR2L:function(){this.xOffset=this.xOffset-this.tileWidth;var d=this.baseMap;if(d.childNodes[0]!=undefined){var offLeft=gEcnu.Util.delpx(d.childNodes[0].style.left);for(var j=0;j<this.nHeight;j++){var imgLast=d.childNodes[((j+1)*this.nWidth)-1];var imgNext=d.childNodes[j*this.nWidth];imgLast.style.left=(offLeft-this.tileWidth)+"px";imgLast.src=this.imgURL;d.removeChild(imgLast);d.insertBefore(imgLast,imgNext);this.hasImgURL[imgLast.id]=false}}},wrapL2R:function(){this.xOffset=this.xOffset+this.tileWidth;var d=this.baseMap;if(d.childNodes[this.nWidth-1]!=undefined){var offLeft=gEcnu.Util.delpx(d.childNodes[this.nWidth-1].style.left);for(var j=0;j<this.nHeight;j++){var imgFirst=d.childNodes[j*this.nWidth];var imgNext;if(j<this.nHeight-1){imgNext=d.childNodes[(j+1)*this.nWidth]}else{imgNext=null}imgFirst.style.left=(offLeft+this.tileWidth)+"px";imgFirst.src=this.imgURL;d.removeChild(imgFirst);if(imgNext){d.insertBefore(imgFirst,imgNext)}else{d.appendChild(imgFirst)}this.hasImgURL[imgFirst.id]=false}}},wrapT2B:function(){this.yOffset=this.yOffset+this.tileHeight;var d=this.baseMap;if(d.childNodes[(this.nHeight*this.nWidth)-1]!=undefined){var offTop=gEcnu.Util.delpx(d.childNodes[(this.nHeight*this.nWidth)-1].style.top);for(var i=0;i<this.nWidth;i++){var imgBottom=d.childNodes[0];imgBottom.style.top=(offTop+this.tileHeight)+"px";imgBottom.src=this.imgURL;d.removeChild(imgBottom);d.appendChild(imgBottom);this.hasImgURL[imgBottom.id]=false}}},wrapB2T:function(){this.yOffset=this.yOffset-this.tileHeight;var d=this.baseMap;if(d.childNodes[0]!=undefined){var offTop=gEcnu.Util.delpx(d.childNodes[0].style.top);for(var i=0;i<this.nWidth;i++){var imgTop=d.childNodes[(this.nHeight*this.nWidth)-1];imgTop.style.top=(offTop-this.tileHeight)+"px";imgTop.src=this.imgURL;
d.removeChild(imgTop);d.insertBefore(imgTop,d.childNodes[0]);this.hasImgURL[imgTop.id]=false}}},showLayer:function(type){switch(type){case"baseMap":this.baseMap.style.display="block";break;case"bgMap":this.baseBgMap.style.display="block";break}},hideLayer:function(type){switch(type){case"baseMap":this.baseMap.style.display="none";break;case"bgMap":this.baseBgMap.style.display="none";break}}});gEcnu.Layer.Other=gEcnu.Layer.extend({init:function(id,source,options){this._super(id,options);this.options={opacity:1,zIndex:2};this.options=gEcnu.Util.setOptions(this,options);this.mapSource=source;this.oClass="otherLayer";var tmpOptions={mapType:"roadmap",zoomlevel:10,center:{lat:30,lng:30},control:{pan:false,scale:false,zoom:false,mapType:false}};this.oMap=null},_initLayerContainer:function(id,w,h){var div=gEcnu.Util.createDiv(id,w,h,true);this._layerContainer=div;gSelf.activeLayer=this},onAdd:function(map){map.ownOther=true;this._map=map;this._super(map);var script=document.createElement("script");switch(this.mapSource){case"google":script.src="https://maps.googleapis.com/maps/api/js?sensor=false&callback=showOtherMap";break;case"baidu":script.src="http://api.map.baidu.com/api?v=1.4&callback=showOtherMap";break;case"tianditu":script.src="http://api.tianditu.com/js/maps.js";script.onload=showOtherMap;break}document.getElementsByTagName("head")[0].appendChild(script)},zoomIn:function(){this.renew()},zoomOut:function(){this.renew()},zoomTo:function(){this.renew()},setMapType:function(type){switch(this.mapSource){case"google":switch(type){case"ROAD":this.oMap.setMapTypeId(google.maps.MapTypeId.ROADMAP);break;case"SATELLITE":this.oMap.setMapTypeId(google.maps.MapTypeId.SATELLITE);break;case"HYBRID":this.oMap.setMapTypeId(google.maps.MapTypeId.HYBRID);break}break;case"baidu":switch(type){case"ROAD":this.oMap.setMapType(BMAP_NORMAL_MAP);break;case"SATELLITE":this.oMap.setMapType(BMAP_SATELLITE_MAP);break;case"HYBRID":this.oMap.setMapType(BMAP_HYBRID_MAP);break}break;case"tianditu":switch(type){case"ROAD":this.oMap.setMapType(TMAP_NORMAL_MAP);break;case"SATELLITE":this.oMap.setMapType(TMAP_SATELLITE_MAP);break;case"HYBRID":this.oMap.setMapType(TMAP_HYBRID_MAP);break}break;break}},resize:function(){var size=this._map.getSize();var cxy=gSelf.getCenter();var zoom=gSelf.getZoom();var latlng=gEcnu.Util.shToLngLat(cxy.x,cxy.y);var layerContainer=document.getElementById(this._layerContainer.id);layerContainer.style.width=size.w+"px";layerContainer.style.height=size.h+"px";this._layerContainer=layerContainer;switch(this.mapSource){case"google":var latlng=gEcnu.Util.shToLngLat(cxy.x,cxy.y);this.oMap.setCenter(new google.maps.LatLng(latlng.lat,latlng.lng));break;case"baidu":this.oMap.setCenter(new BMap.Point(latlng.lng,latlng.lat));break;case"tianditu":var latlng=gEcnu.Util.shToLngLat(cxy.x-400,cxy.y+230);this.oMap.setCenterAtLngLat(new TLngLat(latlng.lng,latlng.lat));break}},renew:function(){this._super();var cxy=this._map.getCenter();var zoom=this._map.getZoom();var latlng=gEcnu.Util.shToLngLat(cxy.x,cxy.y);switch(this.mapSource){case"google":this.oMap.setCenter(new google.maps.LatLng(latlng.lat,latlng.lng));this.oMap.setZoom(18-zoom.zl);break;case"baidu":this.oMap.centerAndZoom(new BMap.Point(latlng.lng,latlng.lat),19-zoom.zl);break;case"tianditu":var latlng=gEcnu.Util.shToLngLat(cxy.x-400,cxy.y+230);this.oMap.centerAndZoom(new TLngLat(latlng.lng,latlng.lat),18-zoom.zl);break}}});gEcnu.Layer.Feature=gEcnu.Layer.extend({init:function(id,style,options){this._super(id);this.options={zIndex:5};this.options=gEcnu.Util.setOptions(this,options);if(arguments.length>1){this.style=style}else{var defaultStyle=new gEcnu.Style({});this.style=defaultStyle}this.oClass="featureLayer";this.featureID=0;this.ctrlLyrs=[]},_initLayerContainer:function(id,w,h){var canvas=gEcnu.Util.createCanvas(id,w,h,true);this._layerContainer=canvas;this._ctx=canvas.getContext("2d")},onAdd:function(map){this._map=map;var size=map.getSize();var container=this._map.getContainer();this._initLayerContainer(this.id,size.w,size.h);container.appendChild(this._layerContainer);this.setzIndex();this.oFeatures=[]},setStyle:function(style){this.style=style},addFeature:function(feature){var oFeatures=this.getAllFeatures();if(!gEcnu.Util.isInArray(oFeatures,feature)){oFeatures.push(feature);feature.onAdd(this)}},removeFeature:function(feature){var oFeature=[];for(var i=0,a=0;i<this.oFeatures.length;i++){if(this.oFeatures[i]!=feature){oFeature[a]=this.oFeatures[i];a++}else{feature.onRemove(this)}}this.oFeatures=oFeature;var map=this.getMap();this.renew()},addFeatures:function(features){for(var i=0;i<features.length;i++){this.addFeature(features[i])}},removeFeatures:function(features){for(var i=0;i<features.length;i++){this.removeFeature(features[i])}},removeAllFeatures:function(){this.oFeatures=[];this.renew()},draw:function(){var oFeatures=this.getAllFeatures();for(var i=0;i<oFeatures.length;i++){this.setFeatureStyle(this,oFeatures[i].info);oFeatures[i].onDraw(this)}},setFeatureStyle:function(){},renew:function(){this._super();
this._map.overLayer.clear();this.clear();this.draw()},refresh:function(){var oFeatures=this.getAllFeatures();this.removeAllFeatures();for(var i=0;i<oFeatures.length;i++){this.oFeatures.push(oFeatures[i]);oFeatures[i].onAdd(this)}},resize:function(){this._super();this._layerContainer.width=this._map.w;this._layerContainer.height=this._map.h;this.renew()},clear:function(){var canvas=this.getLayerContainer();this._ctx.clearRect(0,0,canvas.width,canvas.height)},getAllFeatures:function(){return this.oFeatures},getScrFeatures:function(){var returnFeas=[];var allfeatures=this.oFeatures;var map=this._map;var len_fea=allfeatures.length;if(len_fea<=0){return returnFeas}for(var i=0;i<len_fea;i++){var curFea=allfeatures[i];var shpBox=curFea.shape.shpBox;var fea_xmin=shpBox[0];var fea_ymin=shpBox[1];var fea_xmax=shpBox[2];var fea_ymax=shpBox[3];var mapbounds=map.getBounds();var map_xmin=mapbounds.nw.x;var map_ymin=mapbounds.se.y;var map_xmax=mapbounds.se.x;var map_ymax=mapbounds.nw.y;var leftbot=(fea_xmin>=map_xmin&&fea_xmin<map_xmax&&fea_ymin>=map_ymin&&fea_ymin<=map_ymax);var lefttop=(fea_xmin>=map_xmin&&fea_xmin<map_xmax&&fea_ymax>=map_ymin&&fea_ymax<=map_ymax);var rightbot=(fea_xmax>=map_xmin&&fea_xmax<map_xmax&&fea_ymin>=map_ymin&&fea_ymin<=map_ymax);var righttop=(fea_xmax>=map_xmin&&fea_xmax<map_xmax&&fea_ymax>=map_ymin&&fea_ymax<=map_ymax);if(leftbot||lefttop||rightbot||righttop){returnFeas.push(curFea)}}return returnFeas},getCtx:function(){return this._ctx}});gEcnu.Layer.Overlay=gEcnu.Layer.Feature.extend({init:function(id,options){this._super(id,options);this.options={opacity:1,zIndex:10};this.options=gEcnu.Util.setOptions(this,options);this.oClass="overlayLayer"},setStyle:function(style){this.style=style},initStyle:function(){var ctx=this.getCtx();ctx.strokeStyle="green";ctx.fillStyle="green";ctx.gloablAlpha=0.7},onAdd:function(map){this._super(map);this.initStyle()},resize:function(){this._super();this._layerContainer.width=this._map.w;this._layerContainer.height=this._map.h;this.renew()}});gEcnu.Layer.Marker=gEcnu.Layer.extend({init:function(id,options){this._super(id,options);this.options={opacity:1,zIndex:20};this.options=gEcnu.Util.setOptions(this,options);this.id=id;this.oClass="markerLayer";this.oMarkers=[]},_initLayerContainer:function(id,w,h){var div=gEcnu.Util.createDiv(id,w,h,true);this._layerContainer=div},addMarker:function(marker){if(!gEcnu.Util.isInArray(this.oMarkers,marker)){this.oMarkers.push(marker);marker.onAdd(this)}},removeMarker:function(marker){var oMarker=[];for(var i=0,a=0;i<this.oMarkers.length;i++){if(this.oMarkers[i]!=marker){oMarker[a]=this.oMarkers[i];a++}else{this.oMarkers[i].onRemove(this)}}this.oMarkers=oMarker;this.renew()},addMarkers:function(markers){var oMarkers=this.oMarkers;for(var i=0;i<markers.length;i++){this.addMarker(markers[i])}},removeMarkers:function(markers){var removeMarkers=markers;var len_removeMarkers=removeMarkers.length;for(var i=0;i<len_removeMarkers;i++){var tmpremoveMark=removeMarkers[i];this.removeMarker(tmpremoveMark)}},renew:function(){this._super();for(var i=0;i<this.oMarkers.length;i++){this.oMarkers[i].renew()}},resize:function(){this._super();this.renew()},getMarkersInWindow:function(){var oMarker=this.oMarkers;var curMarkers=[];var oMarker_len=oMarker.length;var mapWindow=this._map.getBounds();for(var i=0;i<oMarker_len;i++){var tmpmarker=oMarker[i];var minx=mapWindow.sw.x;var maxx=mapWindow.ne.x;var miny=mapWindow.sw.y;var maxy=mapWindow.ne.y;if(tmpmarker.x>minx&&tmpmarker.x<maxx&&tmpmarker.y>miny&&tmpmarker.y<maxy){curMarkers.push(tmpmarker)}}return curMarkers}});function showOtherMap(){var cxy=gSelf.getCenter();var zoom=gSelf.getZoom();var latlng=gEcnu.Util.shToLngLat(cxy.x,cxy.y);switch(gSelf.activeLayer.mapSource){case"google":var mapOptions={center:new google.maps.LatLng(latlng.lat,latlng.lng),zoom:18-zoom.zl,mapTypeControl:false,panControl:false,zoomControl:false,scaleControl:false,rotateControl:false,streetViewControl:false};var tmpele=document.getElementById(gSelf.activeLayer.id);gSelf.activeLayer.oMap=new google.maps.Map(tmpele,mapOptions);break;case"baidu":var centerPt=new BMap.Point(latlng.lng,latlng.lat);gSelf.activeLayer.oMap=new BMap.Map(gSelf.activeLayer.id);gSelf.activeLayer.oMap.centerAndZoom(centerPt,19-zoom.zl);break;case"tianditu":var latlng=gEcnu.Util.shToLngLat(cxy.x-400,cxy.y+230);gSelf.activeLayer.oMap=new TMap(gSelf.activeLayer.id);gSelf.activeLayer.oMap.centerAndZoom(new TLngLat(latlng.lng,latlng.lat),18-zoom.zl);break}}gEcnu.WebFeatureServices=gClass.extend({init:function(){},});gEcnu.QueryType={};gEcnu.QueryType.Point="point_qry";gEcnu.QueryType.Line="line_qry";gEcnu.QueryType.Polygon="polygon_qry";gEcnu.QueryType.Rect="rect_qry";gEcnu.layerType={};gEcnu.layerType.Esri="shp";gEcnu.layerType.GeoDB="geodb";gEcnu.WebFeatureServices.QueryByGeometry=gEcnu.WebFeatureServices.extend({init:function(eventsListener){if(typeof eventsListener!="undefined"){this.events._events.processCompleted=eventsListener.processCompleted;this.events._events.processFailed=eventsListener.processFailed
}},processAscyn:function(geometry,lyrType,map,lyr,tolerance,shapeFlag_bool,returnFields){var webfeatureUrl="http://"+gEcnu.config.webHostIP+":"+gEcnu.config.port+"/WebFeature";var shapeFlag=0;if(shapeFlag_bool){shapeFlag=1}else{shapeFlag=0}if(geometry instanceof gEcnu.Geometry.Point){var pointParams={};if(lyrType=="geodb"){pointParams={"mt":"SeachAt","geoDB":map,"ftSet":lyr,"Point":{"x":geometry.x,"y":geometry.y},"Err":tolerance,"return":{"shape":shapeFlag,"fields":returnFields}}}else{if(lyrType=="shp"){pointParams={"mt":"SeachAt","map":map,"lyr":lyr,"Point":{"x":geometry.x,"y":geometry.y},"Err":tolerance,"return":{"shape":shapeFlag,"fields":returnFields}}}}var datastr=JSON.stringify(pointParams);var params={req:datastr}}else{if((geometry instanceof gEcnu.Geometry.LineString)&&geometry.className=="line"){}else{if((geometry instanceof gEcnu.Geometry.LinearRing)&&geometry.className=="polygon"){var polygonParams={};var qry_Polygon=new gEcnu.Feature.Polygon([geometry],{});var opeShape=qry_Polygon.shape;if(lyrType=="geodb"){polygonParams={"mt":"SelectByShape","geoDB":map,"ftSet":lyr,"shape":opeShape,"sMode":0,"return":{"shape":shapeFlag,"fields":returnFields}}}else{if(lyrType=="shp"){polygonParams={"mt":"SelectByShape","map":map,"lyr":lyr,"shape":opeShape,"sMode":0,"return":{"shape":shapeFlag,"fields":returnFields}}}}var datastr=JSON.stringify(polygonParams);var params={req:datastr}}else{if((geometry instanceof gEcnu.Geometry.RectRing)&&geometry.className=="rect"){var rectParams={};var shpBox=gEcnu.Util.getShpBox(geometry.points);if(lyrType=="geodb"){rectParams={"mt":"SelectByRect","geoDB":map,"ftSet":lyr,"rect":{"xmin":shpBox[0],"ymin":shpBox[1],"xmax":shpBox[2],"ymax":shpBox[3]},"return":{"shape":shapeFlag,"fields":returnFields}}}else{if(lyrType=="shp"){rectParams={"mt":"SelectByRect","map":map,"lyr":lyr,"rect":{"xmin":shpBox[0],"ymin":shpBox[1],"xmax":shpBox[2],"ymax":shpBox[3]},"return":{"shape":shapeFlag,"fields":returnFields}}}}var datastr=JSON.stringify(rectParams);var params={req:datastr}}else{if((geometry instanceof gEcnu.Geometry.RadiusRing)&&geometry.className=="radius"){var radiusParams={};if(lyrType=="geodb"){radiusParams={"mt":"SelectByRadius","geoDB":map,"ftSet":lyr,"Point":{"x":geometry.centerPoint.x,"y":geometry.centerPoint.y},"R":geometry.radius,"return":{"shape":shapeFlag,"fields":returnFields}}}else{if(lyrType=="shp"){radiusParams={"mt":"SelectByRadius","map":map,"lyr":lyr,"Point":{"x":geometry.centerPoint.x,"y":geometry.centerPoint.y},"R":geometry.radius,"return":{"shape":shapeFlag,"fields":returnFields}}}}var datastr=JSON.stringify(radiusParams);var params={req:datastr}}}}}}var webfeaServices=this;try{gEcnu.Util.ajax("POST",webfeatureUrl,params,true,function(data){var jsonparase=JSON.parse(data);var returnFeatures=[];returnFeatures=jsonparase.Features;if(returnFeatures.length==0){if(typeof(webfeaServices.events._events.processCompleted)!="undefined"){webfeaServices.events._events.processCompleted(returnFeatures)}}else{if(shapeFlag==1){var resultFeatures=[];for(var fetureNum=0;fetureNum<returnFeatures.length;fetureNum++){var returnFeature=returnFeatures[fetureNum];var returnFeatureType=returnFeature.shape.shpType;if(returnFeatureType==5){var shpParts=returnFeature.shape.Parts;var Parts_len=shpParts.length;var shpPoints=returnFeature.shape.Points;var lineRings=[];for(var j=0;j<Parts_len;j++){var begin_Index=shpParts[j];if(j==(Parts_len-1)){var next_Index=shpPoints.length}else{var next_Index=shpParts[j+1]}var lineRing_Points=[];for(var k=begin_Index;k<(next_Index-1);k++){var geometry_point=new gEcnu.Geometry.Point(shpPoints[k].X,shpPoints[k].Y);lineRing_Points.push(geometry_point)}var tmpLineRing=new gEcnu.Geometry.LinearRing(lineRing_Points);lineRings.push(tmpLineRing)}var shpfields=returnFeature.fields;var feature_Attr={};if(typeof shpfields!="undefined"){var shpfields_len=shpfields.length;for(var kk=0;kk<shpfields_len;kk++){var tmpfield=shpfields[kk];for(m in tmpfield){feature_Attr[m]=tmpfield[m]}}}feature_Attr.FID=returnFeature.FID;var tmpFeature=new gEcnu.Feature.Polygon(lineRings,feature_Attr);resultFeatures.push(tmpFeature)}else{if(returnFeatureType==3){var shpParts=returnFeature.shape.Parts;var Parts_len=shpParts.length;var shpPoints=returnFeature.shape.Points;var lineStrings=[];for(var j=0;j<Parts_len;j++){var begin_Index=shpParts[j];if(j==(Parts_len-1)){var next_Index=shpPoints.length}else{var next_Index=shpParts[j+1]}var lineString_Points=[];for(var k=begin_Index;k<next_Index;k++){var geometry_point=new gEcnu.Geometry.Point(shpPoints[k].X,shpPoints[k].Y);lineString_Points.push(geometry_point)}var tmpLineString=new gEcnu.Geometry.LineString(lineString_Points);lineStrings.push(tmpLineString)}var shpfields=returnFeature.fields;var feature_Attr={};if(typeof shpfields!="undefined"){var shpfields_len=shpfields.length;for(var kk=0;kk<shpfields_len;kk++){var tmpfield=shpfields[kk];for(m in tmpfield){feature_Attr[m]=tmpfield[m]}}}feature_Attr.FID=returnFeature.FID;var tmpFeature=new gEcnu.Feature.Polyline(lineStrings,feature_Attr);
resultFeatures.push(tmpFeature)}else{var shpPoints=returnFeature.shape.Points;var geometrys=[];for(var j=0;j<shpPoints.length;j++){var geometry_point=new gEcnu.Geometry.Point(shpPoints[j].X,shpPoints[j].Y);geometrys.push(geometry_point)}var shpfields=returnFeature.fields;var feature_Attr={};if(typeof shpfields!="undefined"){var shpfields_len=shpfields.length;for(var kk=0;kk<shpfields_len;kk++){var tmpfield=shpfields[kk];for(m in tmpfield){feature_Attr[m]=tmpfield[m]}}}feature_Attr.FID=returnFeature.FID;var tmpFeature=new gEcnu.Feature.Point(geometrys,feature_Attr);resultFeatures.push(tmpFeature)}}}if(typeof(webfeaServices.events._events.processCompleted)!="undefined"){webfeaServices.events._events.processCompleted(resultFeatures)}}else{if(shapeFlag==0){var resultFeatures=[];for(var fetureNum=0;fetureNum<returnFeatures.length;fetureNum++){var returnFeature=returnFeatures[fetureNum];var shpfields=returnFeature.fields;var feature_Attr={};if(typeof shpfields!="undefined"){var shpfields_len=shpfields.length;for(var kk=0;kk<shpfields_len;kk++){var tmpfield=shpfields[kk];for(m in tmpfield){feature_Attr[m]=tmpfield[m]}}}feature_Attr.FID=returnFeature.FID;feature_Attr.cx=returnFeature.cx;feature_Attr.cy=returnFeature.cy;resultFeatures.push(feature_Attr)}if(typeof(webfeaServices.events._events.processCompleted)!="undefined"){webfeaServices.events._events.processCompleted(resultFeatures)}}}}},function(){alert("webfeature请求超时")},5000)}catch(e){if(typeof(webfeaServices.events._events.processFailed)!="undefined"){webfeaServices.events._events.processFailed(e)}}},events:{_events:{},on:function(eventType,callback){switch(eventType){case"processCompleted":this._events.processCompleted=callback;break;case"processFailed":this._events.processFailed=callback;break}}}});gEcnu.WebFeatureServices.QueryBySQL=gEcnu.WebFeatureServices.extend({init:function(eventsListener){if(typeof eventsListener!="undefined"){this.events._events.processCompleted=eventsListener.processCompleted;this.events._events.processFailed=eventsListener.processFailed}},processAscyn:function(sql,lyrType,map,lyr,shapeFlag_bool,returnFields){var webfeatureUrl="http://"+gEcnu.config.webHostIP+":"+gEcnu.config.port+"/WebFeature";var shapeFlag=0;if(shapeFlag_bool){shapeFlag=1}else{shapeFlag=0}var sqlParams={};if(lyrType=="geodb"){sqlParams={"mt":"SQLQuery","geoDB":map,"ftSet":lyr,"sql":sql,"return":{"shape":shapeFlag,"fields":returnFields}}}else{if(lyrType=="shp"){alert("暂时不支持shp图层查询");return;sqlParams={"mt":"SQLQuery","map":map,"lyr":lyr,"sql":sql,"return":{"shape":shapeFlag,"fields":returnFields}}}}var datastr=JSON.stringify(sqlParams);var params={req:datastr};var webfeaServices=this;try{gEcnu.Util.ajax("POST",webfeatureUrl,params,true,function(data){var jsonparase=JSON.parse(data);var returnFeatures=[];returnFeatures=jsonparase.Features;if(returnFeatures.length==0){if(typeof(webfeaServices.events._events.processCompleted)!="undefined"){webfeaServices.events._events.processCompleted(returnFeatures)}}else{if(shapeFlag==1){var resultFeatures=[];for(var fetureNum=0;fetureNum<returnFeatures.length;fetureNum++){var returnFeature=returnFeatures[fetureNum];var returnFeatureType=returnFeature.shape.shpType;if(returnFeatureType==5){var shpParts=returnFeature.shape.Parts;var Parts_len=shpParts.length;var shpPoints=returnFeature.shape.Points;var lineRings=[];for(var j=0;j<Parts_len;j++){var begin_Index=shpParts[j];if(j==(Parts_len-1)){var next_Index=shpPoints.length}else{var next_Index=shpParts[j+1]}var lineRing_Points=[];for(var k=begin_Index;k<(next_Index-1);k++){var geometry_point=new gEcnu.Geometry.Point(shpPoints[k].X,shpPoints[k].Y);lineRing_Points.push(geometry_point)}var tmpLineRing=new gEcnu.Geometry.LinearRing(lineRing_Points);lineRings.push(tmpLineRing)}var shpfields=returnFeature.fields;var feature_Attr={};if(typeof shpfields!="undefined"){var shpfields_len=shpfields.length;for(var kk=0;kk<shpfields_len;kk++){var tmpfield=shpfields[kk];for(m in tmpfield){feature_Attr[m]=tmpfield[m]}}}feature_Attr.FID=returnFeature.FID;var tmpFeature=new gEcnu.Feature.Polygon(lineRings,feature_Attr);resultFeatures.push(tmpFeature)}else{if(returnFeatureType==3){var shpParts=returnFeature.shape.Parts;var Parts_len=shpParts.length;var shpPoints=returnFeature.shape.Points;var lineStrings=[];for(var j=0;j<Parts_len;j++){var begin_Index=shpParts[j];if(j==(Parts_len-1)){var next_Index=shpPoints.length}else{var next_Index=shpParts[j+1]}var lineString_Points=[];for(var k=begin_Index;k<next_Index;k++){var geometry_point=new gEcnu.Geometry.Point(shpPoints[k].X,shpPoints[k].Y);lineString_Points.push(geometry_point)}var tmpLineString=gEcnu.Geometry.LineString(lineString_Points);lineStrings.push(tmpLineString)}var shpfields=returnFeature.fields;var feature_Attr={};if(typeof shpfields!="undefined"){var shpfields_len=shpfields.length;for(var kk=0;kk<shpfields_len;kk++){var tmpfield=shpfields[kk];for(m in tmpfield){feature_Attr[m]=tmpfield[m]}}}feature_Attr.FID=returnFeature.FID;var tmpFeature=new gEcnu.Feature.Polyline(lineStrings,feature_Attr);
resultFeatures.push(tmpFeature)}else{var shpPoints=returnFeature.shape.Points;var geometrys=[];for(var j=0;j<shpPoints.length;j++){var geometry_point=new gEcnu.Geometry.Point(shpPoints[j].X,shpPoints[j].Y);geometrys.push(tmpLineString)}var shpfields=returnFeature.fields;var feature_Attr={};if(typeof shpfields!="undefined"){var shpfields_len=shpfields.length;for(var kk=0;kk<shpfields_len;kk++){var tmpfield=shpfields[kk];for(m in tmpfield){feature_Attr[m]=tmpfield[m]}}}feature_Attr.FID=returnFeature.FID;var tmpFeature=new gEcnu.Feature.Point(geometrys,feature_Attr);resultFeatures.push(tmpFeature)}}}if(typeof(webfeaServices.events._events.processCompleted)!="undefined"){webfeaServices.events._events.processCompleted(resultFeatures)}}else{if(shapeFlag==0){var resultFeatures=[];for(var fetureNum=0;fetureNum<returnFeatures.length;fetureNum++){var returnFeature=returnFeatures[fetureNum];var shpfields=returnFeature.fields;var feature_Attr={};if(typeof shpfields!="undefined"){var shpfields_len=shpfields.length;for(var kk=0;kk<shpfields_len;kk++){var tmpfield=shpfields[kk];for(m in tmpfield){feature_Attr[m]=tmpfield[m]}}}feature_Attr.FID=returnFeature.FID;feature_Attr.cx=returnFeature.cx;feature_Attr.cy=returnFeature.cy;resultFeatures.push(feature_Attr)}if(typeof(webfeaServices.events._events.processCompleted)!="undefined"){webfeaServices.events._events.processCompleted(resultFeatures)}}}}},function(){alert("webfeature请求超时")},500000)}catch(e){if(typeof(webfeaServices.events._events.processFailed)!="undefined"){webfeaServices.events._events.processFailed(e)}}},events:{_events:{},on:function(eventType,callback){switch(eventType){case"processCompleted":this._events.processCompleted=callback;break;case"processFailed":this._events.processFailed=callback;break}}}});gEcnu.ActType={};gEcnu.ActType.ADD="ADD";gEcnu.ActType.DELETE="DELETE";gEcnu.ActType.UPDATE="UPDATE";gEcnu.ActType.SQLTask="SQLTask";gEcnu.WebFeatureServices.FeatureServices=gEcnu.WebFeatureServices.extend({init:function(eventsListener){if(typeof eventsListener!="undefined"){this.events._events.processCompleted=eventsListener.processCompleted;this.events._events.processFailed=eventsListener.processFailed}},processAscyn:function(ActionType,lyrType,map,lyrOrSQLTask,featuresOrSQL){var webfeatureUrl="http://"+gEcnu.config.webHostIP+":"+gEcnu.config.port+"/WebFeature";if(ActionType=="ADD"){var addParams={};var featuresOrSQL_len=featuresOrSQL.length;var addFeatures=[];for(var i=0;i<featuresOrSQL_len;i++){var tmpAddfea={};tmpAddfea.shape=featuresOrSQL[i].shape;tmpAddfea.fields=[];var feaFields=featuresOrSQL[i].fields;var feaFields_len=feaFields.length;for(var mm=0;mm<feaFields_len;mm++){var tmpfield=feaFields[mm];for(var kk in tmpfield){var str={};str[kk]=escape(tmpfield[kk]);tmpAddfea.fields.push(str)}}addFeatures.push(tmpAddfea)}if(lyrType=="geodb"){addParams={"mt":"SQLInsert","geoDB":map,"ftSet":lyrOrSQLTask,"features":addFeatures}}else{if(lyrType=="shp"){addParams={"mt":"SQLInsert","map":map,"lyr":lyrOrSQLTask,"features":addFeatures}}}var datastr=JSON.stringify(addParams);var params={req:datastr}}else{if(ActionType=="DELETE"){var delParams={};if(lyrType=="geodb"){delParams={"mt":"SQLDelete","geoDB":map,"ftSet":lyrOrSQLTask,"sql":featuresOrSQL}}else{if(lyrType=="shp"){delParams={"mt":"SQLDelete","map":map,"lyr":lyrOrSQLTask,"sql":featuresOrSQL}}}var datastr=JSON.stringify(delParams);var params={req:datastr}}else{if(ActionType=="UPDATE"){var updateParams={};var featuresOrSQL_len=featuresOrSQL.length;var updateFeatures=[];for(var i=0;i<featuresOrSQL_len;i++){var tmpUpdatefea={};tmpUpdatefea.FID=featuresOrSQL[i].FID;if(featuresOrSQL[i].UPDATE=="SHP"){tmpUpdatefea.shape=featuresOrSQL[i].Feature.shape}else{if(featuresOrSQL[i].UPDATE=="FIELDS"){tmpUpdatefea.fields=[];var feaFields=featuresOrSQL[i].Feature.fields;var feaFields_len=feaFields.length;for(var mm=0;mm<feaFields_len;mm++){var tmpfield=feaFields[mm];for(var kk in tmpfield){var str={};str[kk]=escape(tmpfield[kk]);tmpUpdatefea.fields.push(str)}}}else{tmpUpdatefea.shape=featuresOrSQL[i].Feature.shape;tmpUpdatefea.fields=[];var feaFields=featuresOrSQL[i].Feature.fields;var feaFields_len=feaFields.length;for(var mm=0;mm<feaFields_len;mm++){var tmpfield=feaFields[mm];for(var kk in tmpfield){var str={};str[kk]=escape(tmpfield[kk]);tmpUpdatefea.fields.push(str)}}}}updateFeatures.push(tmpUpdatefea)}if(lyrType=="geodb"){updateParams={"mt":"SQLUpdate","geoDB":map,"ftSet":lyrOrSQLTask,"features":updateFeatures}}else{if(lyrType=="shp"){updateParams={"mt":"SQLUpdate","map":map,"lyr":lyrOrSQLTask,"features":updateFeatures}}}var datastr=JSON.stringify(updateParams);var params={req:datastr}}else{if(ActionType=="SQLTask"){var sqltaskParams={};if(lyrType=="geodb"){sqltaskParams={"mt":"SQLTask","geoDB":map,"task":lyrOrSQLTask}}else{if(lyrType=="shp"){alert("对不起，暂时不支持shp图层批量操作！");sqltaskParams={"mt":"SQLTask","map":map,"task":lyrOrSQLTask}}}var datastr=JSON.stringify(sqltaskParams);var params={req:datastr}}}}}var webfeaServices=this;try{gEcnu.Util.ajax("POST",webfeatureUrl,params,true,function(data){if(typeof(webfeaServices.events._events.processCompleted)!="undefined"){webfeaServices.events._events.processCompleted()
}},function(){alert("webfeature请求超时")},500000)}catch(e){if(typeof(webfeaServices.events._events.processFailed)!="undefined"){webfeaServices.events._events.processFailed(e)}}},events:{_events:{},on:function(eventType,callback){switch(eventType){case"processCompleted":this._events.processCompleted=callback;break;case"processFailed":this._events.processFailed=callback;break}}}});gEcnu.WebFeatureServices.SQLTasks=gEcnu.WebFeatureServices.extend({init:function(ActionType,lyrType,lyr,featuresOrSQL){if(ActionType=="ADD"){var addParams={};var featuresOrSQL_len=featuresOrSQL.length;var addFeatures=[];for(var i=0;i<featuresOrSQL_len;i++){var tmpAddfea={};tmpAddfea.shape=featuresOrSQL[i].shape;tmpAddfea.fields=[];var feaFields=featuresOrSQL[i].fields;var feaFields_len=feaFields.length;for(var mm=0;mm<feaFields_len;mm++){var tmpfield=feaFields[mm];for(var kk in tmpfield){var str={};str[kk]=escape(tmpfield[kk]);tmpAddfea.fields.push(str)}}addFeatures.push(tmpAddfea)}if(lyrType=="geodb"){addParams={"mt":"SQLInsert","ftSet":lyr,"features":addFeatures}}else{if(lyrType=="shp"){addParams={"mt":"SQLInsert","lyr":lyr,"features":addFeatures}}}this.taskParams=addParams}else{if(ActionType=="DELETE"){var delParams={};if(lyrType=="geodb"){delParams={"mt":"SQLDelete","ftSet":lyr,"sql":featuresOrSQL}}else{if(lyrType=="shp"){delParams={"mt":"SQLDelete","lyr":lyr,"sql":featuresOrSQL}}}this.taskParams=delParams}else{if(ActionType=="UPDATE"){var updateParams={};var featuresOrSQL_len=featuresOrSQL.length;var updateFeatures=[];for(var i=0;i<featuresOrSQL_len;i++){var tmpUpdatefea={};tmpUpdatefea.FID=featuresOrSQL[i].FID;tmpUpdatefea.shape=featuresOrSQL[i].Feature.shape;tmpUpdatefea.fields=[];var feaFields=featuresOrSQL[i].Feature.fields;var feaFields_len=feaFields.length;for(var mm=0;mm<feaFields_len;mm++){var tmpfield=feaFields[mm];for(var kk in tmpfield){var str={};str[kk]=escape(tmpfield[kk]);tmpUpdatefea.fields.push(str)}}updateFeatures.push(tmpUpdatefea)}if(lyrType=="geodb"){updateParams={"mt":"SQLUpdate","ftSet":lyr,"features":updateFeatures}}else{if(lyrType=="shp"){updateParams={"mt":"SQLUpdate","lyr":lyr,"features":updateFeatures}}}this.taskParams=updateParams}}}}});gEcnu.Graph={};gEcnu.Graph.drawPoint=function(ctx,pt){ctx.beginPath();ctx.arc(pt.x,pt.y,3,0,Math.PI*2,true);ctx.closePath();ctx.fill()};gEcnu.Graph.drawLine=function(ctx,pt1,pt2){ctx.beginPath();ctx.moveTo(pt1.x,pt1.y);ctx.lineTo(pt2.x,pt2.y);ctx.closePath();ctx.stroke()};gEcnu.Graph.drawPoint_geo=function(ctx,pt){var sxy=gEcnu.Util.worldToScreen(pt.x,pt.y);ctx.beginPath();ctx.arc(sxy.x,sxy.y,3,0,Math.PI*2,true);ctx.closePath();ctx.fill()};gEcnu.Graph.drawLine_geo=function(ctx,pt1,pt2){var sxy1=gEcnu.Util.worldToScreen(pt1.x,pt1.y);var sxy2=gEcnu.Util.worldToScreen(pt2.x,pt2.y);ctx.beginPath();ctx.moveTo(sxy1.x,sxy1.y);ctx.lineTo(sxy2.x,sxy2.y);ctx.closePath();ctx.stroke()};gEcnu.Graph.drawPoints=function(ctx,ptArr){for(var i=0;i<ptArr.length;i++){var sxy={x:ptArr[i].x,y:ptArr[i].y};this.drawPoint(ctx,sxy)}};gEcnu.Graph.drawLines=function(ctx,ptArr){var len=ptArr.length;ctx.beginPath();var sxy={x:ptArr[0].x,y:ptArr[0].y};ctx.moveTo(sxy.x,sxy.y);for(var i=1;i<ptArr.length;i++){sxy={x:ptArr[i].x,y:ptArr[i].y};ctx.lineTo(sxy.x,sxy.y)}ctx.stroke()};gEcnu.Graph.drawPoints_geo=function(ctx,ptArr){for(var i=0;i<ptArr.length;i++){var sxy=gEcnu.Util.worldToScreen(ptArr[i].x,ptArr[i].y);this.drawPoint(ctx,sxy)}};gEcnu.Graph.drawLines_geo=function(ctx,ptArr){var len=ptArr.length;ctx.beginPath();var sxy=gEcnu.Util.worldToScreen(ptArr[0].x,ptArr[0].y);ctx.moveTo(sxy.x,sxy.y);for(var i=1;i<ptArr.length;i++){sxy=gEcnu.Util.worldToScreen(ptArr[i].x,ptArr[i].y);ctx.lineTo(sxy.x,sxy.y)}ctx.stroke()};gEcnu.Graph.catchPoint=function(pt,storePolygons){var returncatchPoint="false";var catchTole=5;if(storePolygons.length==0){return returncatchPoint}else{for(var i=0;i<storePolygons.length;i++){var _linestrings=storePolygons[i]._lineStrings;if(typeof _linestrings=="undefined"){var opelinePoints=storePolygons[i]._lineRings}else{var opelinePoints=storePolygons[i]._lineStrings}for(var jnum=0;jnum<opelinePoints.length;jnum++){var tmppoints=opelinePoints[jnum].points;var tmppoints_len=tmppoints.length;for(var j=0;j<tmppoints_len;j++){var tmppoint=tmppoints[j];var sxy=gEcnu.Util.worldToScreen(tmppoint.x,tmppoint.y);var dis=Math.sqrt((pt.x-sxy.x)*(pt.x-sxy.x)+(pt.y-sxy.y)*(pt.y-sxy.y));if(dis<=catchTole){pt.x=sxy.x;pt.y=sxy.y;if(returncatchPoint=="false"){returncatchPoint="true|"+pt.x+","+pt.y+","+tmppoint.x+","+tmppoint.y+"|"+jnum+","+j;return returncatchPoint}}}}}}return returncatchPoint};gEcnu.Graph.catchLine=function(pt,storePolygons){var x=pt.x;var y=pt.y;var catchTole=5;var returnString="false";var mouse_WXY=gEcnu.Util.screenToWorld(x,y);var wcoord_x=mouse_WXY.x;var wcoord_y=mouse_WXY.y;var poly_len=storePolygons.length;for(var i=0;i<poly_len;i++){var _linestrings=storePolygons[i]._lineStrings;if(typeof _linestrings=="undefined"){var opelinePoints=storePolygons[i]._lineRings}else{var opelinePoints=storePolygons[i]._lineStrings
}for(var jnum=0;jnum<opelinePoints.length;jnum++){var tmppoints=opelinePoints[jnum].points;var tmppoints_len=tmppoints.length;for(var j=0;j<tmppoints_len;j++){var tmppoint=tmppoints[j];if(j<tmppoints_len-1){var tmppoint2=tmppoints[j+1];var sxy1=gEcnu.Util.worldToScreen(tmppoint.x,tmppoint.y);var wx1=tmppoint.x;var wy1=tmppoint.y;var sxy2=gEcnu.Util.worldToScreen(tmppoint2.x,tmppoint2.y);var wx2=tmppoint2.x;var wy2=tmppoint2.y;var minx=Math.min(wx1,wx2);var maxx=Math.max(wx1,wx2);var miny=Math.min(wy1,wy2);var maxy=Math.max(wy1,wy2);if((wx1!=wx2)&&(wy1!=wy2)){var k=(wy2-wy1)/(wx2-wx1);var k_v=(-1)/k;var b=wy1-k*wx1;var b_v=wcoord_y-k_v*wcoord_x;var interVtx_X=(b_v-b)/(k-k_v);var interVtx_Y=k*interVtx_X+b;if(interVtx_X>minx&&interVtx_X<maxx&&interVtx_Y>miny&&interVtx_Y<maxy){var scr_k=(sxy2.y-sxy1.y)/(sxy2.x-sxy1.x);var scr_k_v=(-1)/scr_k;var scr_b=sxy1.y-scr_k*(sxy1.x);var scr_b_v=y-scr_k_v*x;var scr_interVtx_X=(scr_b_v-scr_b)/(scr_k-scr_k_v);var scr_interVtx_Y=scr_k*scr_interVtx_X+scr_b;var dis=Math.sqrt((x-scr_interVtx_X)*(x-scr_interVtx_X)+(y-scr_interVtx_Y)*(y-scr_interVtx_Y));if(dis<catchTole){returnString="true|"+scr_interVtx_X+","+scr_interVtx_Y+","+interVtx_X+","+interVtx_Y+"|"+sxy1.x+","+sxy1.y+"|"+sxy2.x+","+sxy2.y+"|"+jnum+","+j+","+i;break}}}if(wx1==wx2){var interVtx_X=sxy1.x;var interVtx_Y=y;var w_XY=gEcnu.Util.screenToWorld(interVtx_X,interVtx_Y);if(wx1>=minx&&wx1<=maxx&&w_XY.y>=miny&&w_XY.y<=maxy){var dis=Math.abs(interVtx_X-x);if(dis<catchTole){returnString="true|"+interVtx_X+","+interVtx_Y+","+wx1+","+w_XY.y+"|"+sxy1.x+","+sxy1.y+"|"+sxy2.x+","+sxy2.y+"|"+jnum+","+j+","+i;break}}}if(wy1==wy2){var interVtx_X=x;var interVtx_Y=sxy1.y;var w_XY=gEcnu.Util.screenToWorld(interVtx_X,interVtx_Y);if(w_XY.x>=minx&&w_XY.x<=maxx&&wy1>=miny&&wy1<=maxy){var dis=Math.abs(y-interVtx_Y);if(dis<catchTole){returnString="true|"+interVtx_X+","+interVtx_Y+","+w_XY.x+","+wy1+"|"+sxy1.x+","+sxy1.y+"|"+sxy2.x+","+sxy2.y+"|"+jnum+","+j+","+i;break}}}}}}}return returnString};gEcnu.Graph.pointInPoly=function(pt,poly){for(var c=false,i=-1,l=poly.length,j=l-1;++i<l;j=i){((poly[i].y<=pt.y&&pt.y<poly[j].y)||(poly[j].y<=pt.y&&pt.y<poly[i].y))&&(pt.x<(poly[j].x-poly[i].x)*(pt.y-poly[i].y)/(poly[j].y-poly[i].y)+poly[i].x)&&(c=!c)}return c};gEcnu.Graph.pointJionLine=function(pt,points){var len=points.length;var c=false;if(len<=0){return c}return c};gEcnu.Util={};gEcnu.Util.createDiv=function(id,w,h,pos){var div=document.createElement("div");div.id=id;div.style.width=w+"px";div.style.height=h+"px";if(pos){div.style.position="absolute"}div.style.zIndex=1;return div};gEcnu.Util.createCanvas=function(id,w,h,pos){var canvas=document.createElement("canvas");if(gEcnu.Util.getIEVersion()!=0){canvas=window.G_vmlCanvasManager.initElement(canvas)}canvas.id=id;canvas.width=w;canvas.height=h;canvas.style.width=w+"px";canvas.style.height=h+"px";if(pos){canvas.style.position="absolute"}return canvas};gEcnu.Util.isInArray=function(arr,val){for(var i in arr){if(arr[i]==val){return true}}return false};gEcnu.Util.isObjInArray=function(arr,obj){for(var i in arr){if(arr[i].id==obj.id){alert("已被添加，请更换图层id");return true}}return false};gEcnu.Util.worldToScreen=function(wx,wy){var cxy=gSelf.getCenter();var wcx=cxy.x;var wcy=cxy.y;var scx=parseInt(gSelf.w)/2;var scy=parseInt(gSelf.h)/2;var scale=gSelf.zoom/parseInt(gSelf.w);var sx=scx+(wx-wcx)/scale+0.5;var sy=scy-(wy-wcy)/scale+0.5;return{x:sx,y:sy}};gEcnu.Util.screenToWorld=function(sx,sy){var cxy=gSelf.getCenter();var wcx=cxy.x;var wcy=cxy.y;var scx=parseInt(gSelf.w)/2;var scy=parseInt(gSelf.h)/2;var scale=gSelf.zoom/parseInt(gSelf.w);var wx=wcx+(sx-scx)*scale;var wy=wcy-(sy-scy)*scale;return{x:wx,y:wy}};gEcnu.Util.worldToScreen_geo=function(wx,wy){var cxy=gSelf.getCenter();var wcx=cxy.x;var wcy=cxy.y;var scx=parseInt(gSelf.w)/2;var scy=parseInt(gSelf.h)/2;var scale=gSelf.zoom/parseInt(gSelf.w);if(gSelf.coordsFlag=="GEOGRAPHIC"){var lon=cxy.x;var lat=cxy.y;wcx=lon*111000*Math.cos(lat);wcy=lat*111000;var actualZoom=gSelf.zoom*111.31955*1000;scale=actualZoom/parseInt(gSelf.w)}var sx=scx+(wx-wcx)/scale+0.5;var sy=scy-(wy-wcy)/scale+0.5;return{x:sx,y:sy}};gEcnu.Util.screenToWorld_geo=function(sx,sy){var cxy=gSelf.getCenter();var wcx=cxy.x;var wcy=cxy.y;var scx=parseInt(gSelf.w)/2;var scy=parseInt(gSelf.h)/2;var scale=gSelf.zoom/parseInt(gSelf.w);if(gSelf.coordsFlag=="GEOGRAPHIC"){var lon=cxy.x;var lat=cxy.y;wcx=lon*111000*Math.cos(lat);wcy=lat*111000;var actualZoom=gSelf.zoom*111.31955*1000;scale=actualZoom/parseInt(gSelf.w)}var wx=wcx+(sx-scx)*scale;var wy=wcy-(sy-scy)*scale;return{x:wx,y:wy}};gEcnu.Util.getMouseXY=function(ele,e){var x=0,y=0;var obj=e.srcElement?e.srcElement:e.target;if(!document.attachEvent){while(obj&&obj!=ele){var btw=gEcnu.Util.getEleStyle(obj,"border-top-width")=="medium"?0:gEcnu.Util.delpx(gEcnu.Util.getEleStyle(obj,"border-top-width"));var blw=gEcnu.Util.getEleStyle(obj,"border-left-width")=="medium"?0:gEcnu.Util.delpx(gEcnu.Util.getEleStyle(obj,"border-left-width"));x+=obj.offsetLeft+blw;
y+=obj.offsetTop+btw;obj=obj.offsetParent}x=e.offsetX+x+document.body.scrollLeft;y=e.offsetY+y+document.body.scrollTop}else{var btw=gEcnu.Util.getEleStyle(obj,"border-top-width")=="medium"?0:gEcnu.Util.delpx(gEcnu.Util.getEleStyle(obj,"border-top-width"));var blw=gEcnu.Util.getEleStyle(obj,"border-left-width")=="medium"?0:gEcnu.Util.delpx(gEcnu.Util.getEleStyle(obj,"border-left-width"));x=e.layerX-blw;y=e.layerY-btw}return{x:x,y:y}};gEcnu.Util.getTouchXY=function(evt){for(var i=0;i<evt.targetTouches.length;i++){var touch=evt.targetTouches[i];ox=touch.pageX;oy=touch.pageY}x=ox-gSelf.mapLeft;y=oy-gSelf.mapTop;return{x:x,y:y}};gEcnu.Util.getTouchPos=function(event){var touchxy={"x":0,"y":0};try{touchxy.x=event.touches[0].screenX;touchxy.y=event.touches[0].screenY}catch(e){console.log(e.toString())}return touchxy};gEcnu.Util.getShpBox=function(points){var len=points.length;if(len>=1){var shpbox=[];var xmin=points[0].x;var ymin=points[0].y;var xmax=points[0].x;var ymax=points[0].y;if(len>=2){for(var j=1;j<len;j++){var tmppoint=points[j];if(xmin>=tmppoint.x){xmin=tmppoint.x}if(xmax<=tmppoint.x){xmax=tmppoint.x}if(ymin>=tmppoint.y){ymin=tmppoint.y}if(ymax<=tmppoint.y){ymax=tmppoint.y}}}shpbox=[xmin,ymin,xmax,ymax];return shpbox}else{alert("获取最小外接矩形失败！");return}};gEcnu.Util.getType=function(o){var _t;return((_t=typeof(o))=="object"?o==null&&"null"||Object.prototype.toString.call(o).slice(8,-1):_t).toLowerCase()};gEcnu.Util.extend=function(destination,source){for(var p in source){if(gEcnu.Util.getType(source[p])=="array"||gEcnu.Util.getType(source[p])=="object"){destination[p]=gEcnu.Util.getType(source[p])=="array"?[]:{};arguments.callee(destination[p],source[p])}else{destination[p]=source[p]}}};gEcnu.Util.getTouchPt=function(touch){var x=touch.pageX-gSelf.mapLeft;var y=touch.pageY-gSelf.mapTop;return{x:x,y:y}};gEcnu.Util.getMousePos=function(event){var e=event||window.event;return{"x":e.screenX,"y":e.screenY}};gEcnu.Util.p1top2Dis=function(p1,p2){var dx=parseInt(p1.x-p2.x);var dy=parseInt(p1.y-p2.y);var dis=parseInt(Math.sqrt(dx*dx+dy*dy));return dis};gEcnu.Util.getEleStyle=function(obj,attribute){var arr=attribute.split("-");var attr=arr[0];if(attr.length>1){for(var i=1;i<arr.length;i++){attr+=arr[i].substring(0,1).toUpperCase()+arr[i].substring(1)}}else{attr=attribute}return obj.currentStyle?obj.currentStyle[attr]:document.defaultView.getComputedStyle(obj,false)[attr]};gEcnu.Util.setOptions=function(obj,options){var tmpObj=gEcnu.Util.cloneObj(obj.options);for(var k in options){if(options[k]!=null||options[k]!=undefined||options[k]!=""){tmpObj[k]=options[k]}}return tmpObj};gEcnu.Util.shToLngLat=function(x,y){var A=95418.0172735741;var B=48.3052839794785;var C=-11592069.1853624;var D=63.9932503167748;var E=110821.847990882;var F=-3469087.15690168;var lat=(D*x-A*y-(C*D-A*F))/(B*D-A*E);var lng=(E*x-B*y-(C*E-B*F))/(A*E-B*D);return{lat:lat,lng:lng}};gEcnu.Util.lnglatToSh=function(lng,lat){var A=95418.0172735741;var B=48.3052839794785;var C=-11592069.1853624;var D=63.9932503167748;var E=110821.847990882;var F=-3469087.15690168;var x=A*lng+B*lat+C-50+470;var y=D*lng+E*lat+F-50-235;return{x:x,y:y}};gEcnu.Util.delpx=function(value){if(value==""){return 0}return parseInt(value.substring(0,value.length-2))};gEcnu.Util.ajax=function(method,url,data,async,callback,timoutFunc,timeout){var timer_out;if(arguments.length==7){timer_out=setTimeout(function(){if(xdr){xdr.abort()}else{if(xhr){alert(typeof xhr);alert(xhr);xhr.abort()}}timoutFunc()},timeout)}var xhr=null;var xdr=null;if(data instanceof Object){var str="";for(k in data){str+=k+"="+escape(data[k])+"&"}data=str}if(window.XDomainRequest){xdr=new XDomainRequest();if(xdr){xdr.onerror=showerr;xdr.onload=function(){if(timer_out){clearTimeout(timer_out)}callback(xdr.responseText)};if("get"==method.toLowerCase()){if(data==null||data==""){xdr.open("get",url)}else{xdr.open("get",url+"?"+data)}xdr.send()}else{if("post"==method.toLowerCase()){xdr.open("post",url);xdr.setRequestHeader("content-Type","application/x-www-form-urlencoded");xdr.send(data)}}}}else{if(window.XMLHttpRequest){xhr=new XMLHttpRequest()}else{if(window.ActiveXObject){xhr=new ActiveXObject("Microsoft.XMLHTTP")}}xhr.onreadystatechange=function(e){if(4==xhr.readyState){if(200==xhr.status){if(callback){if(timer_out){clearTimeout(timer_out)}callback(xhr.responseText)}}else{if(404==xhr.status){if(hander404){hander404()}}else{if(500==xhr.status){if(hander500){hander500()}}}}}};if("get"==method.toLowerCase()){if(data==null||data==""){xhr.open("get",url,async)}else{xhr.open("get",url+"?"+data,async)}xhr.send(null)}else{if("post"==method.toLowerCase()){xhr.open("post",url,async);xhr.setRequestHeader("content-Type","application/x-www-form-urlencoded");xhr.send(data)}}}function handler404(){alert("ReqUrl：not found")}function handler500(){alert("服务器错误，请稍后再试")}function showerr(e){}};gEcnu.Util.cloneObj=function(obj){var newobj,s;if(typeof obj!=="object"){return}newobj=obj.constructor===Object?{}:[];if(window.JSON){s=JSON.stringify(obj),newobj=JSON.parse(s)
}else{if(newobj.constructor===Array){newobj.concat(obj)}else{for(var i in obj){newobj[i]=obj[i]}}}return newobj};gEcnu.Util.drawLine=function(ctx,x1,y1,x2,y2){ctx.beginPath();ctx.moveTo(x1,y1);ctx.lineTo(x2,y2);ctx.closePath();ctx.stroke()};gEcnu.Util.getPolylineLength=function(polyPtArr){var len=polyPtArr.length;var totalDis=0;for(var j=0;j<(len-1);j++){var mdis=Math.sqrt((polyPtArr[j].x-polyPtArr[j+1].x)*(polyPtArr[j].x-polyPtArr[j+1].x)+(polyPtArr[j].y-polyPtArr[j+1].y)*(polyPtArr[j].y-polyPtArr[j+1].y));totalDis=totalDis+mdis}return totalDis};gEcnu.Util.calcAreaMap=function(PtArr){var ta=0;var ax=PtArr;for(var i=0;i<ax.length;i++){ta=ta+(ax[i].x*ax[(i+1)%ax.length].y-ax[(i+1)%ax.length].x*ax[i].y)}var meter2=parseInt(Math.abs(0.5*ta));return meter2};gEcnu.Util.drawCalPolyline=function(ctx,ptArr){gEcnu.Util.setStyle(ctx);var len=ptArr.length;ctx.beginPath();var sxy=gEcnu.Util.worldToScreen(ptArr[0].x,ptArr[0].y);ctx.moveTo(sxy.x,sxy.y);for(var i=1;i<ptArr.length;i++){sxy=gEcnu.Util.worldToScreen(ptArr[i].x,ptArr[i].y);ctx.lineTo(sxy.x,sxy.y)}ctx.stroke()};gEcnu.Util.setStyle=function(ctx,style){var tmpOpt={"fillColor":"blue","strokeColor":"blue","lineWeight":2,"borderStatus":true,"fillStatus":true,"vtxStatus":false,"vtxRadius":3,"tlr":5,"opacity":1};if(arguments.length>1){tmpOpt=style}ctx.fillStyle=tmpOpt.fillColor;ctx.strokeStyle=tmpOpt.strokeColor;ctx.lineWidth=tmpOpt.lineWeight;ctx.globalAlpha=tmpOpt.opacity;return tmpOpt};gEcnu.Util.debounce=function(func,threshold,execAsap,fun){var timeout;return function debounced(){var obj=this,args=arguments;function delayed(){if(!execAsap){func.apply(obj,args)}timeout=null}if(timeout){clearTimeout(timeout)}else{if(execAsap){func.apply(obj,args)}}timeout=setTimeout(delayed,threshold||100);fun()}};gEcnu.Util.addEvtHandler=function(element,evt,func){if(element.addEventListener){element.addEventListener(evt,func,false)}else{if(element.attachEvent){element.attachEvent("on"+evt,func)}else{element["on"+evt]=func}}if(evt=="mousewheel"&&gEcnu.Util.getIEVersion()==0){element.addEventListener("DOMMouseScroll",func,false)}};gEcnu.Util.removeEvtHandler=function(element,evt,func){if(element.removeEventListener){element.removeEventListener(evt,func,false)}else{if(element.detachEvent){element.detachEvent("on"+evt,func)}else{element["on"+evt]=func}}if(evt=="mousewheel"){element.removeEventListener("DOMMouseScroll",func,false)}};gEcnu.Util.preventDefault=function(event){if(event.preventDefault){event.preventDefault()}else{window.event.returnValue=false}};gEcnu.Util.stopPropagation=function(event){if(event.stopPropagation){event.stopPropagation()}else{window.event.cancelBubble=true}};gEcnu.Util.bindCusEvt=function(ele,customEvt,callback){var e=document.createEvent("Event");e.initEvent(customEvt,false,false);gSelf.cusEvtArr[customEvt]=e;ele.addEventListener(customEvt,callback,false)};gEcnu.Util.triggerCusEvt=function(ele,custom){ele.dispatchEvent(gSelf.cusEvtArr[custom])};gEcnu.Util.ifctrl=function(e){var nav4=window.Event?true:false;if(nav4){if((typeof e.ctrlKey!="undefined")?e.ctrlKey:e.modifiers&Event.CONTROL_MASK>0){return true}else{return false}}else{if(window.event.ctrlKey){return true}else{return false}}return false};gEcnu.Util.ifshift=function(e){var nav4=window.Event?true:false;if(nav4){if((typeof e.shiftKey!="undefined")?e.shiftKey:e.modifiers&Event.SHIFT_MASK>0){return true}else{return false}}else{if(window.event.shiftKey){return true}else{return false}}return false};gEcnu.Util.getIEVersion=function(){var userAgent=window.navigator.userAgent.toLowerCase();if(/msie 8\.0/i.test(userAgent)){return 8}if(/msie 7\.0/i.test(userAgent)){return 7}if(/msie 6\.0/i.test(userAgent)){return 6}return 0};if(!Array.indexOf){Array.prototype.indexOf=function(obj){for(var i=0;i<this.length;i++){if(this[i]==obj){return i}}return -1}}gEcnu.Util.getButton=function(event){event=event||window.event;if(!+[1,]){switch(event.button){case 0:case 1:case 3:case 5:case 7:return 0;case 2:case 6:return 2;case 4:return 1}}else{return event.button}};gEcnu.Geometry=gClass.extend({init:function(name){this.name=name},getVertices:function(){},getBounds:function(){},calcBounds:function(){}});gEcnu.Geometry.Point=gClass.extend({init:function(x,y){this.x=x;this.y=y;this.className="point"}});gEcnu.Geometry.LineString=gEcnu.Geometry.extend({init:function(points){this.className="line";this.points=[];for(var i=0;i<points.length;i++){var pt=points[i];if(pt instanceof gEcnu.Geometry.Point){this.points.push(pt)}else{alert("初始化节点失败！")}}},addPoint:function(pt,index){var r=/^\d+$/;if(r.test(index)){this.points.splice(index,0,pt)}else{this.points.push(pt)}},delPoint:function(index){this.points.splice(index,1)},removePoint:function(pt){for(var i=0;i<this.points.length;i++){if(this.points[i]==pt){this.points.splice(i,1);break}}},getLength:function(){var len=this.points.length;var totalDis=0;for(var j=0;j<(len-1);j++){var mdis=Math.sqrt((this.points[j].x-this.points[j+1].x)*(this.points[j].x-this.points[j+1].x)+(this.points[j].y-this.points[j+1].y)*(this.points[j].y-this.points[j+1].y));
totalDis=totalDis+mdis}return totalDis}});gEcnu.Geometry.LinearRing=gEcnu.Geometry.LineString.extend({init:function(points){var points_len=points.length;if(points_len<=2){alert("组成多边形节点个数不足！");return}this._super(points);this.className="polygon";var lastPoint=points[0];this.points.push(lastPoint)},addPoint:function(pt,index){this.points.splice(index,0,pt)},delPoint:function(index){if(this.points.length==4){alert("节点数低于3个，不能删除！");return}this.points.splice(index,1);if(index==0){this.points.pop();var firstPoint=this.points[0];this.points.push(firstPoint)}else{}},getArea:function(){var ta=0;var ax=this.points;for(var i=0;i<ax.length;i++){ta=ta+(ax[i].x*ax[(i+1)%ax.length].y-ax[(i+1)%ax.length].x*ax[i].y)}var meter2=parseInt(Math.abs(0.5*ta));return meter2}});gEcnu.Geometry.RectRing=gEcnu.Geometry.LineString.extend({init:function(points){var points_len=points.length;if(points_len<4){alert("组成矩形节点个数不足！");return}this._super(points);this.className="rect"},addPoint:function(pt,index){this.points.splice(index,0,pt)},delPoint:function(index){if(this.points.length==4){alert("节点数低于3个，不能删除！");return}this.points.splice(index,1);if(index==0){this.points.pop();var firstPoint=this.points[0];this.points.push(firstPoint)}else{}},getArea:function(){var ta=0;var ax=this.points;for(var i=0;i<ax.length;i++){ta=ta+(ax[i].x*ax[(i+1)%ax.length].y-ax[(i+1)%ax.length].x*ax[i].y)}var meter2=parseInt(Math.abs(0.5*ta));return meter2}});gEcnu.Geometry.RadiusRing=gEcnu.Geometry.extend({init:function(point,radius){this.radius=radius;this.centerPoint=point;this.className="radius"},getArea:function(){return 2*3.14159*(this.radius)*(this.radius)}});gEcnu.Style=gClass.extend({init:function(options){this.oStyle="singleStyle";if(options.fillColor==undefined){this.fillColor="green"}else{this.fillColor=options.fillColor}if(options.strokeColor==undefined){this.strokeColor="green"}else{this.strokeColor=options.strokeColor}if(options.lineWeight==undefined){this.lineWeight=1}else{this.lineWeight=options.lineWeight}if(options.borderStatus==undefined){this.borderStatus=true}else{this.borderStatus=false}if(options.cirRadius==undefined){this.cirRadius=3}else{this.cirRadius=options.cirRadius}if(options.fillStatus==undefined){this.fillStatus=true}else{this.fillStatus=false}if(options.vtxStatus==undefined){this.vtxStatus=false}else{this.vtxStatus=true}if(options.vtxRadius==undefined){this.vtxRadius=3}else{this.vtxRadius=options.vtxRadius}if(options.tlr==undefined){this.tlr=5}else{this.tlr=options.tlr}if(options.opacity==undefined){this.opacity=0.4}else{this.opacity=options.opacity}if(options.mappingValue==undefined){this.mappingValue="default"}else{this.mappingValue=options.mappingValue}}});gEcnu.Style_Ex=gClass.extend({init:function(styleArr,field){this.oStyle="multiStyles";this.styles=styleArr;this.mappingField=field}});gEcnu.WebGeoCoding=gClass.extend({init:function(eventsListener){if(typeof eventsListener!="undefined"){this.events._events.processCompleted=eventsListener.processCompleted;this.events._events.processFailed=eventsListener.processFailed}},geoCoding:function(feature){var webgeoCodingUrl="http://"+gEcnu.config.webHostIP+":"+gEcnu.config.port+"/GeoUtils";var geoParmas={"mt":"GeoCoding","shape":feature.shape};var datastr=JSON.stringify(geoParmas);var params={req:datastr};var webgeocodingServices=this;try{gEcnu.Util.ajax("POST",webgeoCodingUrl,params,false,function(data){if(typeof(webgeocodingServices.events._events.processCompleted)!="undefined"){var jsonparase=JSON.parse(data);webgeocodingServices.events._events.processCompleted(jsonparase)}},function(){alert("webgeocoding请求超时")},500000)}catch(e){if(typeof(webgeocodingServices.events._events.processFailed)!="undefined"){webgeocodingServices.events._events.processFailed(e)}}},deGeoCoding:function(geoCode){},events:{_events:{},on:function(eventType,callback){switch(eventType){case"processCompleted":this._events.processCompleted=callback;break;case"processFailed":this._events.processFailed=callback;break}}}});gEcnu.Marker=gClass.extend({init:function(name,info,options){this.name=name;this._img=new Image();this._img.src=info.src;this.src=info.src;this._img.style.position="absolute";this._img.style.zIndex=100;this.info=info},onAdd:function(layer){this._layer=layer;var map=layer.getMap();var container=this._container=layer.getLayerContainer();this.x=this.info.x;this.y=this.info.y;var sxy=gEcnu.Util.worldToScreen(this.info.x,this.info.y);this._img.style.left=sxy.x+this.info.offset.x+"px";this._img.style.top=sxy.y+this.info.offset.y+"px";this._img.style.cursor="pointer";container.appendChild(this._img)},onRemove:function(){this._container.removeChild(this._img)},getContainer:function(){return this._img},regEvent:function(evt,callback){if(evt=="click"){var self=this;this.getContainer().onmousedown=function(e){gEcnu.Util.preventDefault(e);gEcnu.Util.stopPropagation(e);callback.apply(self,arguments)};this._img.onmouseup=function(e){gEcnu.Util.preventDefault(e);gEcnu.Util.stopPropagation(e)};this._img.onclick=function(e){gEcnu.Util.preventDefault(e);
gEcnu.Util.stopPropagation(e)}}else{if(evt=="Rclick"){var self=this;this.getContainer().onmousedown=function(e){gEcnu.Util.preventDefault(e);gEcnu.Util.stopPropagation(e);if(gEcnu.Util.getButton(e)==2){callback.apply(self,arguments)}};this._img.onmouseup=function(e){gEcnu.Util.preventDefault(e);gEcnu.Util.stopPropagation(e)};this._img.onclick=function(e){gEcnu.Util.preventDefault(e);gEcnu.Util.stopPropagation(e)}}}},renew:function(){var map=this._layer.getMap();var sxy=gEcnu.Util.worldToScreen(this.info.x,this.info.y);this._img.style.left=sxy.x+this.info.offset.x+"px";this._img.style.top=sxy.y+this.info.offset.y+"px"},showInfo:function(){console.log("Hello WebGIS")}});gEcnu.Feature=gClass.extend({init:function(name){this.name=name},getVertices:function(){},getBounds:function(){},calcBounds:function(){}});gEcnu.Feature.Point=gEcnu.Feature.extend({init:function(gpoints,data){this._gpoints=gpoints;this.shape={};this.shape.shpType=8;this.shape.shpBox=gEcnu.Util.getShpBox(gpoints);var len_point=gpoints.length;this.shape.NumPoints=len_point;this.shape.Points=[];for(var j=0;j<len_point;j++){var opepoint=gpoints[j];var tmppoint={"X":opepoint.x,"Y":opepoint.y};this.shape.Points.push(tmppoint)}this.fields=[];for(k in data){var str={};str[k]=data[k];this.fields.push(str)}},onAdd:function(layer){this._layer=layer;this.onDraw(layer)},onRemove:function(layer){},onDraw:function(layer){var ctx=layer.getCtx();var _style=layer.style;if(typeof(this.style)=="undefined"){if(_style instanceof gEcnu.Style_Ex){var mapfield=_style.mappingField;var fea_fields=this.fields;var fields_len=fea_fields.length;var mapvalue="default";for(var m=0;m<fields_len;m++){var field_sin=fea_fields[m];var ifexit=false;for(var key in field_sin){if(key==mapfield){mapvalue=field_sin[key];ifexit=true;continue}}if(ifexit){continue}}var stylearr=_style.styles;var len_style=stylearr.length;for(var j=0;j<len_style;j++){var tmpstyle=stylearr[j];if(tmpstyle.mappingValue==mapvalue){this.style=tmpstyle;continue}}}else{if(_style instanceof gEcnu.Style){this.style=_style}else{alert("style样式有问题！");return}}}var opt=gEcnu.Util.setStyle(ctx,this.style);var map=layer.getMap();var parts_len=this.shape.NumPoints;for(var l=0;l<parts_len;l++){var tmppoint=this._gpoints[l];var sxy=gEcnu.Util.worldToScreen(tmppoint.x,tmppoint.y);ctx.beginPath();ctx.arc(sxy.x,sxy.y,this.style.cirRadius,0,2*Math.PI);ctx.stroke();ctx.fill()}},getLayer:function(){return this._layer}});gEcnu.Feature.Polyline=gEcnu.Feature.extend({init:function(lineStrings,data){this.shape={};this.shape.shpType=3;this._lineStrings=lineStrings;this._data=data;var linstring_len=lineStrings.length;var points=[];this.shape.Parts=[];for(var j=0;j<linstring_len;j++){var tmppoints=lineStrings[j].points;var next_value=points.length;this.shape.Parts.push(next_value);points=points.concat(tmppoints)}this.shape.shpBox=gEcnu.Util.getShpBox(points);var pointslen=points.length;this.shape.NumPoints=pointslen;this.shape.NumParts=linstring_len;this.shape.Points=[];for(var i=0;i<pointslen;i++){var tmpPoint=points[i];var _tmpPoint={"x":tmpPoint.x,"y":tmpPoint.y};this.shape.Points.push(_tmpPoint)}this.fields=[];for(k in data){var str={};str[k]=data[k];this.fields.push(str)}},onAdd:function(layer){this._layer=layer;this.onDraw(layer)},onRemove:function(layer){},onDraw:function(layer){var ctx=layer.getCtx();var _style=layer.style;if(typeof(this.style)=="undefined"){if(_style instanceof gEcnu.Style_Ex){var mapfield=_style.mappingField;var fea_fields=this.fields;var fields_len=fea_fields.length;var mapvalue="default";for(var m=0;m<fields_len;m++){var field_sin=fea_fields[m];var ifexit=false;for(var key in field_sin){if(key==mapfield){mapvalue=field_sin[key];ifexit=true;continue}}if(ifexit){continue}}var stylearr=_style.styles;var len_style=stylearr.length;var ifexit=false;for(var j=0;j<len_style;j++){var tmpstyle=stylearr[j];if(tmpstyle.mappingValue==mapvalue){this.style=tmpstyle;ifexit=true;continue}}if(!ifexit){var defaultStyle=new gEcnu.Style({});this.style=defaultStyle}}else{if(_style instanceof gEcnu.Style){this.style=_style}else{alert("style样式有问题！");return}}}var opt=gEcnu.Util.setStyle(ctx,this.style);var map=layer.getMap();var parts_len=this.shape.NumParts;for(var l=0;l<parts_len;l++){var tmplineStr=this._lineStrings[l];var len=tmplineStr.points.length;if(len>=2){ctx.beginPath();var sxy=gEcnu.Util.worldToScreen(tmplineStr.points[0].x,tmplineStr.points[0].y);ctx.moveTo(sxy.x,sxy.y);for(var i=1;i<len;i++){sxy=gEcnu.Util.worldToScreen(tmplineStr.points[i].x,tmplineStr.points[i].y);ctx.lineTo(sxy.x,sxy.y)}}ctx.stroke()}},onSelect:function(){var len=this._lineStrings.length;var map=gSelf;map.overLayer.clear();for(var j=0;j<len;j++){var points=this._lineStrings[j].points;var line_point_style=new gEcnu.Style({cirRadius:3,opacity:1,fillColor:"#118811",strokeColor:"#118811",lineWeight:1});map.overLayer.setStyle(line_point_style);var ctx=map.overLayer._ctx;gEcnu.Util.setStyle(ctx,line_point_style);gEcnu.Graph.drawPoints_geo(ctx,points);var line_style=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});
map.overLayer.setStyle(line_style);var ctx=map.overLayer._ctx;gEcnu.Util.setStyle(ctx,line_style);gEcnu.Graph.drawLines_geo(ctx,points)}},onSelect_ex:function(){var len=this._lineStrings.length;var map=gSelf;if(gEcnu.Edit.selectedLine!=null){gEcnu.Edit.selectedLine=null;map.overLayer.clear()}for(var j=0;j<len;j++){var points=this._lineStrings[j].points;var ctx=map.overLayer._ctx;var line_style=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});map.overLayer.setStyle(line_style);var ctx=map.overLayer._ctx;gEcnu.Util.setStyle(ctx,line_style);gEcnu.Graph.drawLines_geo(ctx,points)}},getLayer:function(){return this._layer}});gEcnu.Feature.Polygon=gEcnu.Feature.extend({init:function(lineRings,data){this.shape={};this.shape.shpType=5;this._lineRings=lineRings;this._data=data;var linering_len=lineRings.length;var points=[];this.shape.Parts=[];for(var j=0;j<linering_len;j++){var tmppoints=lineRings[j].points;var next_value=points.length;this.shape.Parts.push(next_value);points=points.concat(tmppoints)}this.shape.shpBox=gEcnu.Util.getShpBox(points);var pointslen=points.length;this.shape.NumPoints=pointslen;this.shape.NumParts=linering_len;this.shape.Points=[];for(var i=0;i<pointslen;i++){var tmpPoint=points[i];var _tmpPoint={"x":tmpPoint.x,"y":tmpPoint.y};this.shape.Points.push(_tmpPoint)}this.fields=[];for(k in data){var str={};str[k]=data[k];this.fields.push(str)}},onAdd:function(layer){this._layer=layer;this.onDraw(layer)},onRemove:function(layer){},onDraw:function(layer){var ctx=layer.getCtx();var _style=layer.style;if(typeof(this.style)=="undefined"){if(_style instanceof gEcnu.Style_Ex){var mapfield=_style.mappingField;var fea_fields=this.fields;var fields_len=fea_fields.length;var mapvalue="default";for(var m=0;m<fields_len;m++){var field_sin=fea_fields[m];var ifexit=false;for(var key in field_sin){if(key==mapfield){mapvalue=field_sin[key];ifexit=true;continue}}if(ifexit){continue}}var stylearr=_style.styles;var len_style=stylearr.length;for(var j=0;j<len_style;j++){var tmpstyle=stylearr[j];if(tmpstyle.mappingValue==mapvalue){this.style=tmpstyle;continue}}}else{if(_style instanceof gEcnu.Style){this.style=_style}else{alert("style样式有问题！");return}}}var opt=gEcnu.Util.setStyle(ctx,this.style);var map=layer.getMap();var parts_len=this.shape.NumParts;for(var l=0;l<parts_len;l++){var tmplineRin=this._lineRings[l];var len=tmplineRin.points.length;if(len>=2){ctx.beginPath();var sxy=gEcnu.Util.worldToScreen(tmplineRin.points[0].x,tmplineRin.points[0].y);ctx.moveTo(sxy.x,sxy.y);for(var i=1;i<len;i++){sxy=gEcnu.Util.worldToScreen(tmplineRin.points[i].x,tmplineRin.points[i].y);ctx.lineTo(sxy.x,sxy.y)}ctx.closePath()}ctx.stroke();ctx.fill()}},onSelect:function(){var len=this._lineRings.length;var map=gSelf;map.overLayer.clear();for(var j=0;j<len;j++){var points=this._lineRings[j].points;var line_point_style=new gEcnu.Style({cirRadius:3,opacity:1,fillColor:"#118811",strokeColor:"#118811",lineWeight:1});map.overLayer.setStyle(line_point_style);var ctx=map.overLayer._ctx;gEcnu.Util.setStyle(ctx,line_point_style);gEcnu.Graph.drawPoints_geo(ctx,points);var line_style=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});map.overLayer.setStyle(line_style);var ctx=map.overLayer._ctx;gEcnu.Util.setStyle(ctx,line_style);gEcnu.Graph.drawLines_geo(ctx,points)}},onSelect_ex:function(){var len=this._lineRings.length;var map=gSelf;if(gEcnu.Edit.selectedPolygon!=null){gEcnu.Edit.selectedPolygon=null;map.overLayer.clear()}for(var j=0;j<len;j++){var points=this._lineRings[j].points;var ctx=map.overLayer._ctx;var line_style=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});map.overLayer.setStyle(line_style);var ctx=map.overLayer._ctx;gEcnu.Util.setStyle(ctx,line_style);gEcnu.Graph.drawLines_geo(ctx,points)}},getLayer:function(){return this._layer},getGeometrys:function(){return this._lineRings},pointInFeature:function(geometry_point){var len=this._lineRings.length;for(var j=0;j<len;j++){var tmppoints=this._lineRings[j].points;if(gEcnu.Graph.pointInPoly(geometry_point,tmppoints)){return true}}return false}});var gSelf;gEcnu.Map=gClass.extend({init:function(containerId){gSelf=this;this._initContainer(containerId);this._initProp();this.overLayer=new gEcnu.Layer.Overlay("overlay");this.mLayer=new gEcnu.Layer.Marker("markerLayer");this.addLayer(this.mLayer);this.addLayer(this.overLayer);this._initEvent();this.activeLayer=null;document.ondragstart=function(){return false}},_initContainer:function(containerId){this._container=document.getElementById(containerId);this.w=this._container.clientWidth;this.h=this._container.clientHeight;this._container.style.overflow="hidden"},_initProp:function(){this.oLayers=[];this.mode="map";this.mapTool="pan";this.dragging=false;this.isTouch=false;this.coordsFlag="PROJECTED";this.oLayers=[];this.cx=0;this.cy=0;this.zl=1;this.zoom=parseInt(1*this.w);this.ownDyn=false;this.ownTile=false;this.ownOther=false;this.maxLevel=gEcnu.config.maxLevel;this.minLevel=gEcnu.config.minLevel;
this.tileWidth=gEcnu.config.tileWidth;this.tileHeight=gEcnu.config.tileHeight;this.cusEvtArr=[];this.mapLeft=this._container.offsetLeft;this.mapTop=this._container.offsetTop;this.disMinus=0;this.pinchPt1;this.pinchPt2;this.startDis;this.endDis;this.startX=0;this.startY=0;this.startScrX=0;this.startSrcY=0;this.lengthPtArr=[];this.areaPtArr=[];this.oControls=[];this.resizeTimer=null;this.forbidPan_ex=false;this.curScrPolys=[];this.tlr=5;this.webHost="http://"+gEcnu.config.webHostIP;this.serverURL=this.webHost+":"+gEcnu.config.port+"/";this.webMapURL=this.serverURL+"WebMap";this.webFeatureUrl=this.serverURL+"WebFeature";this.tileMapURL=this.serverURL+"TileMap";this.fileServer=this.serverURL+"FileServer?fn="},_initEvent:function(){var startName="ontouchstart";var doc=document.documentElement;var ctn;if(gEcnu.Util.getIEVersion()==0){ctn=this.mLayer.getLayerContainer()}else{ctn=this._container}if(startName in doc){ctn.ontouchstart=mapMouseDownEvt;ctn.ontouchmove=mapMouseMoveEvt;ctn.ontouchend=mapMouseUpEvt}gEcnu.Util.addEvtHandler(ctn,"mousedown",mapMouseDownEvt_pan);gEcnu.Util.addEvtHandler(ctn,"mousedown",mapMouseDownEvt);gEcnu.Util.addEvtHandler(ctn,"mousemove",mapMouseMoveEvt);gEcnu.Util.addEvtHandler(ctn,"mouseup",mapMouseUpEvt);gEcnu.Util.addEvtHandler(ctn,"mousewheel",mapMouseWheelEvt);gEcnu.Util.addEvtHandler(ctn,"dblclick",mapMouseDblEvt);function mapMouseDblEvt(e){if(gSelf.mode=="map"){calLenAreMouseDblClickEvt(e)}else{gSelf.mousedblclickCustom(e)}}function mapMouseDownEvt_pan(e){var e=e?e:window.event;if(!window.event){e.preventDefault()}if(gSelf.forbidPan_ex&&(gSelf.mapTool!="rulerLength")&&(gSelf.mapTool!="rulerArea")){return}mapMouseDown_pan(e);document.onmousemove=function(e){if(gSelf.forbidPan_ex){return}mapMouseMove_pan(e)};document.onmouseup=function(e){if(gSelf.forbidPan_ex){return}document.onmousemove=null;document.onmouseup=null;mapMouseUp_pan(e)}}function mapMouseDown_pan(e){gEcnu.Util.preventDefault(e);gEcnu.Util.stopPropagation(e);if(gSelf.mode=="map"){if(e.type=="touchstart"&&e.touches.length==2){var tp1=gEcnu.Util.getTouchPt(e.touches[0]);var tp2=gEcnu.Util.getTouchPt(e.touches[1]);gSelf.pinchPt1=tp1;gSelf.pinchPt2=tp2;gSelf.startDis=gEcnu.Util.p1top2Dis(tp1,tp2)}else{if(gSelf.mapTool=="pan"){gSelf.dragging=true}var mxy,scrxy;if(e.type=="touchstart"){mxy=gEcnu.Util.getTouchXY(e);scrxy=gEcnu.Util.getTouchPos(e)}else{mxy=gEcnu.Util.getMouseXY(gSelf._container,e);scrxy=gEcnu.Util.getMousePos(e)}gSelf.startX=mxy.x;gSelf.startY=mxy.y;gSelf.startScrX=scrxy.x;gSelf.startScrY=scrxy.y;var oLayers=gSelf.getAllLayers();for(var i=0;i<oLayers.length;i++){if(oLayers[i].oClass=="tileLayer"){oLayers[i].startLeft=gEcnu.Util.delpx(oLayers[i].baseMap.style.left);oLayers[i].startTop=gEcnu.Util.delpx(oLayers[i].baseMap.style.top)}else{oLayers[i].startLeft=gEcnu.Util.delpx(oLayers[i]._layerContainer.style.left);oLayers[i].startTop=gEcnu.Util.delpx(oLayers[i]._layerContainer.style.top);oLayers[i].startLeft=gEcnu.Util.delpx(oLayers[i]._layerContainer.style.left);oLayers[i].startTop=gEcnu.Util.delpx(oLayers[i]._layerContainer.style.top)}}}}}function mapMouseDownEvt(e){gEcnu.Util.preventDefault(e);gEcnu.Util.stopPropagation(e);if(gSelf.mode=="map"){calLenAreMouseDownEvt(e)}else{gSelf.mousedownCustom(e)}}function mapMouseMove_pan(e){gEcnu.Util.preventDefault(e);if(gSelf.mode=="map"&&gSelf.mapTool=="pan"){var mxy,scrxy;if(e.type=="touchmove"&&e.touches.length==2){var tp1=gEcnu.Util.getTouchPt(e.touches[0]);var tp2=gEcnu.Util.getTouchPt(e.touches[1]);gSelf.pinchPt1=tp1;gSelf.pinchPt2=tp2;gSelf.endDis=gEcnu.Util.p1top2Dis(tp1,tp2);gSelf.disMinus=gSelf.endDis-gSelf.startDis}else{if(e.type=="touchmove"){mxy=gEcnu.Util.getTouchXY(e);scrxy=gEcnu.Util.getTouchPos(e);gSelf.endScrX=scrxy.x;gSelf.endScrY=scrxy.y}else{mxy=gEcnu.Util.getMouseXY(gSelf._container,e);scrxy=gEcnu.Util.getMousePos(e)}gSelf.currentX=mxy.x;gSelf.currentY=mxy.y;if(gSelf.dragging&&gSelf.mapTool=="pan"){var dltx=scrxy.x-gSelf.startScrX;var dlty=scrxy.y-gSelf.startScrY;var oLayers=gSelf.getAllLayers();if(Math.abs(dltx)>0||Math.abs(dlty)>0){for(var i=0;i<oLayers.length;i++){if(oLayers[i].visible){oLayers[i].onDrag(dltx,dlty)}if(oLayers[i].oClass=="dynLayer"){}}}}}}}function mapMouseMoveEvt(e){gEcnu.Util.preventDefault(e);if(gSelf.mode=="map"){var mxy;if(e.type=="touchmove"){mxy=gEcnu.Util.getTouchXY(e)}else{mxy=gEcnu.Util.getMouseXY(gSelf._container,e)}gSelf.currentX=mxy.x;gSelf.currentY=mxy.y;calLenAreMouseMoveEvt(e)}else{gSelf.mousemoveCustom(e)}}function mapMouseUp_pan(e){if(gSelf.mode=="map"&&gSelf.mapTool=="pan"){var mxy,scrxy;if(Math.abs(gSelf.disMinus)>0){if(gSelf.disMinus>0){gSelf.zoomIn()}else{gSelf.zoomOut()}gSelf.disMinus=0}else{if(e.type=="touchend"){scrxy={x:gSelf.endScrX,y:gSelf.endScrY}}else{mxy=gEcnu.Util.getMouseXY(gSelf._container,e);scrxy=gEcnu.Util.getMousePos(e)}if(gSelf.mapTool=="pan"){var dltx=scrxy.x-gSelf.startScrX;var dlty=scrxy.y-gSelf.startScrY;if(Math.abs(dltx)>0||Math.abs(dlty)>0){var scxy=gSelf.getScreenCenter();var nscx=scxy.x-dltx;
var nscy=scxy.y-dlty;var wxy=gEcnu.Util.screenToWorld(nscx,nscy);gSelf.setCenter(wxy.x,wxy.y);var oLayers=gSelf.getAllLayers();var lyrs_len=oLayers.length;for(var i=0;i<lyrs_len;i++){if(oLayers[i].oClass=="tileLayer"&&oLayers[i].visible){oLayers[i].xOffset=oLayers[i].xOffset+dltx;oLayers[i].yOffset=oLayers[i].yOffset+dlty;oLayers[i].baseMap.style.left=oLayers[i].startLeft+dltx+"px";oLayers[i].baseMap.style.top=oLayers[i].startTop+dlty+"px"}if(oLayers[i].visible){if(oLayers[i].oClass!="dynLayer"){oLayers[i].renew()}else{if(!(gSelf.ownTile)){oLayers[i].renew()}}}}gSelf.dragging=false;gSelf._boundsChanged()}}}}}function mapMouseUpEvt(e){if(gSelf.mode=="map"){}else{gSelf.mouseupCustom(e)}}var mousewheel_timer;function mapMouseWheelEvt(e){gEcnu.Util.preventDefault(e);if(gSelf.forbidPan_ex){return}clearTimeout(mousewheel_timer);mousewheel_timer=setTimeout(function(){if(gSelf.mode=="map"&&gSelf.mapTool=="pan"){var delta=e.wheelDelta||-e.detail;if(delta>0){if(gSelf.ownTile){if(gSelf.zl<=gSelf.minLevel){gSelf._boundsChanged({"error":"zoomin"});return}}var mouseXY=gEcnu.Util.getMouseXY(gSelf._container,e);var wxy=gEcnu.Util.screenToWorld(mouseXY.x,mouseXY.y);var halfwdltx=(wxy.x-gSelf.cx)/2;var halfwdlty=(wxy.y-gSelf.cy)/2;var newcx=wxy.x-halfwdltx;var newcy=wxy.y-halfwdlty;gSelf.setCenter(newcx,newcy);gSelf.zoomIn(mouseXY)}else{if(gSelf.ownTile){if(gSelf.zl>=gSelf.maxLevel){gSelf._boundsChanged({"error":"zoomout"});return}}var mouseXY=gEcnu.Util.getMouseXY(gSelf._container,e);var wxy=gEcnu.Util.screenToWorld(mouseXY.x,mouseXY.y);var halfwdltx=(wxy.x-gSelf.cx)*2;var halfwdlty=(wxy.y-gSelf.cy)*2;var newcx=wxy.x-halfwdltx;var newcy=wxy.y-halfwdlty;gSelf.setCenter(newcx,newcy);gSelf.zoomOut(mouseXY)}}else{gSelf.mousewheelCustom(e)}},280)}function calLenAreMouseDownEvt(e){var ctx=gSelf.overLayer.getCtx();if(gSelf.mapTool=="rulerLength"){var wxy=gEcnu.Util.screenToWorld(gSelf.startX,gSelf.startY);if(gSelf.coordsFlag=="GEOGRAPHIC"){wxy=gEcnu.Util.screenToWorld_geo(gSelf.startX,gSelf.startY)}var measurepoint={x:wxy.x,y:wxy.y};gSelf.lengthPtArr.push(measurepoint);if(gSelf.lengthPtArr.length>1){gEcnu.Util.drawCalPolyline(ctx,gSelf.lengthPtArr)}}else{if(gSelf.mapTool=="rulerArea"){var wxy=gEcnu.Util.screenToWorld(gSelf.startX,gSelf.startY);if(gSelf.coordsFlag=="GEOGRAPHIC"){wxy=gEcnu.Util.screenToWorld_geo(gSelf.startX,gSelf.startY)}var measurepoint={x:wxy.x,y:wxy.y};gSelf.areaPtArr.push(measurepoint);if(gSelf.areaPtArr.length>1){gEcnu.Util.drawCalPolyline(ctx,gSelf.areaPtArr)}}else{gSelf.overLayer.clear()}}}function calLenAreMouseMoveEvt(e){var ctx=gSelf.overLayer.getCtx();if(gSelf.mapTool=="rulerLength"){if(gSelf.lengthPtArr.length>0){gSelf.overLayer.clear();var pt={x:gSelf.lengthPtArr[gSelf.lengthPtArr.length-1].x,y:gSelf.lengthPtArr[gSelf.lengthPtArr.length-1].y};var sxy=gEcnu.Util.worldToScreen(pt.x,pt.y);if(gSelf.coordsFlag=="GEOGRAPHIC"){sxy=gEcnu.Util.worldToScreen_geo(pt.x,pt.y)}gEcnu.Util.drawLine(ctx,sxy.x,sxy.y,gSelf.currentX,gSelf.currentY);gEcnu.Util.drawCalPolyline(ctx,gSelf.lengthPtArr);if(gSelf.lengthPtArr.length==1){var currDis=0;var wxy=gEcnu.Util.screenToWorld(gSelf.currentX,gSelf.currentY);if(gSelf.coordsFlag=="GEOGRAPHIC"){wxy=gEcnu.Util.screenToWorld_geo(gSelf.currentX,gSelf.currentY)}currDis=Math.sqrt((wxy.x-gSelf.lengthPtArr[0].x)*(wxy.x-gSelf.lengthPtArr[0].x)+(wxy.y-gSelf.lengthPtArr[0].y)*(wxy.y-gSelf.lengthPtArr[0].y));var msgText="当前距离："+Math.round(currDis)+"米"+";"+"总距离："+Math.round(currDis)+"米";ctx.font="bold 15px 幼圆";ctx.fillText(msgText,gSelf.currentX,gSelf.currentY)}else{var currDis=0;var totalDis=0;var i=(gSelf.lengthPtArr.length-1);var currDis="";var wxy=gEcnu.Util.screenToWorld(gSelf.currentX,gSelf.currentY);if(gSelf.coordsFlag=="GEOGRAPHIC"){wxy=gEcnu.Util.screenToWorld_geo(gSelf.currentX,gSelf.currentY)}currDis=Math.sqrt((wxy.x-gSelf.lengthPtArr[i].x)*(wxy.x-gSelf.lengthPtArr[i].x)+(wxy.y-gSelf.lengthPtArr[i].y)*(wxy.y-gSelf.lengthPtArr[i].y));totalDis=gEcnu.Util.getPolylineLength(gSelf.lengthPtArr);totalDis=totalDis+currDis;var msgText="当前距离："+Math.round(currDis)+"米"+";"+"总距离:"+Math.round(totalDis)+"米";ctx.font="bold 15px 幼圆";ctx.fillText(msgText,gSelf.currentX,gSelf.currentY)}}}else{if(gSelf.mapTool=="rulerArea"){if(gSelf.areaPtArr.length>0){gSelf.overLayer.clear();var maxi=gSelf.areaPtArr.length-1;var sxy=gEcnu.Util.worldToScreen(gSelf.areaPtArr[maxi].x,gSelf.areaPtArr[maxi].y);if(gSelf.coordsFlag=="GEOGRAPHIC"){sxy=gEcnu.Util.worldToScreen_geo(gSelf.areaPtArr[maxi].x,gSelf.areaPtArr[maxi].y)}gEcnu.Util.drawLine(ctx,sxy.x,sxy.y,gSelf.currentX,gSelf.currentY);if(gSelf.areaPtArr.length>1){gEcnu.Util.drawCalPolyline(ctx,gSelf.areaPtArr);var sxy=gEcnu.Util.worldToScreen(gSelf.areaPtArr[0].x,gSelf.areaPtArr[0].y);if(gSelf.coordsFlag=="GEOGRAPHIC"){sxy=gEcnu.Util.worldToScreen_geo(gSelf.areaPtArr[0].x,gSelf.areaPtArr[0].y)}gEcnu.Util.drawLine(ctx,sxy.x,sxy.y,gSelf.currentX,gSelf.currentY);var perimeter=0;var totalDis=gEcnu.Util.getPolylineLength(gSelf.areaPtArr);var worldXY=gEcnu.Util.screenToWorld(gSelf.currentX,gSelf.currentY);
if(gSelf.coordsFlag=="GEOGRAPHIC"){worldXY=gEcnu.Util.screenToWorld_geo(gSelf.currentX,gSelf.currentY)}var dis1=Math.sqrt((worldXY.x-gSelf.areaPtArr[maxi].x)*(worldXY.x-gSelf.areaPtArr[maxi].x)+(worldXY.y-gSelf.areaPtArr[maxi].y)*(worldXY.y-gSelf.areaPtArr[maxi].y));var dis2=Math.sqrt((worldXY.x-gSelf.areaPtArr[0].x)*(worldXY.x-gSelf.areaPtArr[0].x)+(worldXY.y-gSelf.areaPtArr[0].y)*(worldXY.y-gSelf.areaPtArr[0].y));perimeter=totalDis+dis1+dis2;var temgareaPtArr;temgareaPtArr=gSelf.areaPtArr.concat();var temmouseXY={x:worldXY.x,y:worldXY.y};temgareaPtArr.push(temmouseXY);var area=gEcnu.Util.calcAreaMap(temgareaPtArr);var msgText="周长："+Math.round(perimeter)+"米"+"面积："+area+"平方米";ctx.font="bold 15px 幼圆";ctx.fillText(msgText,gSelf.currentX,gSelf.currentY)}}}}}function calLenAreMouseDblClickEvt(e){var ctx=gSelf.overLayer.getCtx();var returnLenArea="";if(gSelf.mapTool=="rulerLength"){gSelf.lengthPtArr.pop();var totalDis=gEcnu.Util.getPolylineLength(gSelf.lengthPtArr);gSelf.overLayer.clear();gEcnu.Util.drawCalPolyline(ctx,gSelf.lengthPtArr);var len=gSelf.lengthPtArr.length;var sxy=gEcnu.Util.worldToScreen(gSelf.lengthPtArr[len-1].x,gSelf.lengthPtArr[len-1].y);if(gSelf.coordsFlag=="GEOGRAPHIC"){sxy=gEcnu.Util.worldToScreen_geo(gSelf.lengthPtArr[len-1].x,gSelf.lengthPtArr[len-1].y)}var endx=sxy.x;var endy=sxy.y;gSelf.lengthPtArr=[];returnLenArea="总距离："+Math.round(totalDis)+"米";ctx.font="bold 15px 幼圆";ctx.fillText(returnLenArea,endx,endy)}else{if(gSelf.mapTool=="rulerArea"){gSelf.areaPtArr.pop();if(gSelf.areaPtArr.length<3){alert("绘制节点至少三个！");return returnLenArea}var totalDis=gEcnu.Util.getPolylineLength(gSelf.areaPtArr);var perimeter=0;var max=gSelf.areaPtArr.length-1;var dis=Math.sqrt((gSelf.areaPtArr[max].x-gSelf.areaPtArr[0].x)*(gSelf.areaPtArr[max].x-gSelf.areaPtArr[0].x)+(gSelf.areaPtArr[max].y-gSelf.areaPtArr[0].y)*(gSelf.areaPtArr[max].y-gSelf.areaPtArr[0].y));perimeter=totalDis+dis;var area=gEcnu.Util.calcAreaMap(gSelf.areaPtArr);gSelf.overLayer.clear();gEcnu.Util.drawCalPolyline(ctx,gSelf.areaPtArr);var sxy1=gEcnu.Util.worldToScreen(gSelf.areaPtArr[0].x,gSelf.areaPtArr[0].y);var sxy2=gEcnu.Util.worldToScreen(gSelf.areaPtArr[max].x,gSelf.areaPtArr[max].y);if(gSelf.coordsFlag=="GEOGRAPHIC"){sxy1=gEcnu.Util.worldToScreen_geo(gSelf.areaPtArr[0].x,gSelf.areaPtArr[0].y);sxy2=gEcnu.Util.worldToScreen_geo(gSelf.areaPtArr[max].x,gSelf.areaPtArr[max].y)}gEcnu.Util.drawLine(ctx,sxy1.x,sxy1.y,sxy2.x,sxy2.y);var sxy=gEcnu.Util.worldToScreen(gSelf.areaPtArr[gSelf.areaPtArr.length-1].x,gSelf.areaPtArr[gSelf.areaPtArr.length-1].y);if(gSelf.coordsFlag=="GEOGRAPHIC"){sxy=gEcnu.Util.worldToScreen_geo(gSelf.areaPtArr[gSelf.areaPtArr.length-1].x,gSelf.areaPtArr[gSelf.areaPtArr.length-1].y)}gSelf.areaPtArr=[];returnLenArea="周长："+Math.round(perimeter)+"米"+"；"+"面积："+Math.round(area)+"平方米";ctx.font="bold 15px 幼圆";ctx.fillText(returnLenArea,sxy.x,sxy.y)}}return returnLenArea}},addLayer:function(layer){var oLayers=this.oLayers;if(!gEcnu.Util.isObjInArray(oLayers,layer)){layer.onAdd(this);oLayers.push(layer)}},removeLayer:function(layer){var oLayer=[];var oLayers=this.oLayers;this.ownTile=false;for(var i=0,a=0;i<oLayers.length;i++){if(oLayers[i]!=layer){oLayer[a]=oLayers[i];if(oLayer[a].oClass=="tileLayer"){this.ownTile=true}a++}else{layer.onRemove(this)}}this.oLayers=oLayer},removeLayerById:function(layerid){var oLayer=[];var oLayers=this.oLayers;this.ownTile=false;for(var i=0,a=0;i<oLayers.length;i++){if(oLayers[i].id!=layerid){oLayer[a]=oLayers[i];if(oLayer[a].oClass=="tileLayer"){this.ownTile=true}a++}else{oLayers[i].onRemove(this)}}this.oLayers=oLayer},addLayers:function(layers){var oLayers=this.oLayers;for(var i in layers){if(!gEcnu.Util.isObjInArray(oLayers,layers[i])){layers[i].onAdd(this);oLayers.push(layers[i])}}},removeLayers:function(layers){var oLayer=[];var oLayers=this.oLayers;this.ownTile=false;for(var k in layers){for(var i=0,a=0;i<oLayers.length;i++){if(oLayers[i]!=layers[k]){oLayer[a]=oLayers[i];if(oLayer[a].oClass=="tileLayer"){this.ownTile=true}a++}else{layers[k].onRemove(this)}}}oLayers=oLayer},showLayer:function(layer){layer.show()},hideLayer:function(layer){layer.hide()},addControl:function(control){var oControls=this.getAllControls();if(!gEcnu.Util.isObjInArray(oControls,control)){control.onAdd(this);oControls.push(control)}},getAllLayers:function(){return this.oLayers},getAllControls:function(){return this.oControls},zoomIn:function(mouseXY){if(this.ownTile){if(this.zl<=this.minLevel){return}}var oLayers=this.getAllLayers();this.zoom=this.zoom/2;this.zl--;for(var i=0;i<oLayers.length;i++){if(oLayers[i].visible){oLayers[i].zoomIn(mouseXY)}}var oControls=this.getAllControls();for(var j=0;j<oControls.length;j++){oControls[j].renew()}gSelf._boundsChanged()},zoomOut:function(mouseXY){if(this.ownTile){if(this.zl>=this.maxLevel){return}}var oLayers=this.getAllLayers();this.zoom=this.zoom*2;this.zl++;for(var i=0;i<oLayers.length;i++){if(oLayers[i].visible){oLayers[i].zoomOut(mouseXY)}}var oControls=this.getAllControls();
for(var j=0;j<oControls.length;j++){oControls[j].renew()}gSelf._boundsChanged()},zoomTo:function(cx,cy,z){this.setCenter(cx,cy);var oLayers=this.getAllLayers();if(typeof z=="undefined"){for(var i=0;i<oLayers.length;i++){oLayers[i].zoomTo()}}else{if(z.hasOwnProperty("zl")){this.zl=z.zl;var MeterPerPx=Math.pow(2,(this.zl-1));var w=this._container.clientWidth;this.zoom=MeterPerPx*w;for(var i=0;i<oLayers.length;i++){if(oLayers[i].oClass=="tileLayer"){oLayers[i].zoomTo()}}for(var i=0;i<oLayers.length;i++){if(oLayers[i].oClass!="tileLayer"){oLayers[i].zoomTo()}}}else{if(z.hasOwnProperty("zoom")){this.zoom=z.zoom;for(var i=0;i<oLayers.length;i++){if(oLayers[i].oClass=="dynLayer"){oLayers[i].zoomTo()}}}}}var oControls=this.getAllControls();for(var j=0;j<oControls.length;j++){oControls[j].renew()}gSelf._boundsChanged()},resize:function(){var prew=this.w;var curZoom=this.zoom;var MeterPerPx=curZoom/prew;var preh=this.h;var w=this._container.clientWidth;var h=this._container.clientHeight;this.zoom=MeterPerPx*w;var wxy=gEcnu.Util.screenToWorld(w/2,h/2);this.cx=wxy.x;this.cy=wxy.y;this.w=w;this.h=h;var oLayers=this.getAllLayers();for(var i=0;i<oLayers.length;i++){oLayers[i].resize()}},getContainer:function(){return this._container},getSize:function(){return{w:this.w,h:this.h}},getZoom:function(){return{z:this.zoom,zl:this.zl}},setZoom:function(zoom){this.zoom=zoom},setZoomLevel:function(zl){},getCenter:function(){return{x:this.cx,y:this.cy}},clearOverlay:function(){this.overLayer.clear()},forbidPan:function(){this.forbidPan_ex=true},activePan:function(){this.forbidPan_ex=false},setCenter:function(cx,cy){this.cx=cx;this.cy=cy},getScreenCenter:function(){return{x:this.w/2,y:this.h/2}},getBounds:function(){var cxy=this.getCenter();var size=this.getSize();var z=this.getZoom();var wl=cxy.x-z.z/2;var wr=cxy.x+z.z/2;var scale=z.z/size.w;var ht=cxy.y-size.h*scale/2;var hb=cxy.y+size.h*scale/2;return{"nw":{"x":wl,"y":hb},"ne":{"x":wr,"y":hb},"sw":{"x":wl,"y":ht},"se":{"x":wr,"y":ht}}},getMode:function(){return this.mode},setMode:function(mode){this.mode=mode},getMapTool:function(){return this.mapTool},setMapTool:function(maptool){this.mapTool=maptool},events:{on:function(eventType,callback){switch(eventType){case"boundsChanged":gEcnu.Map.prototype._boundsChanged=function(result){callback(result)};break}}},_boundsChanged:function(){},mousedownCustom:function(e){gEcnu.Edit.graphMouseDownEvt(e,gSelf)},mousemoveCustom:function(e){gEcnu.Edit.graphMouseMoveEvt(e,gSelf)},mouseupCustom:function(e){gEcnu.Edit.graphMouseUpEvt(e,gSelf)},mousewheelCustom:function(e){},mousedblclickCustom:function(e){gEcnu.Edit.graphMouseDblClickEvt(e,gSelf)},setProjCoordsFlag:function(){gSelf.coordsFlag="PROJECTED"},setGeoCoordsFlag:function(){gSelf.coordsFlag="GEOGRAPHIC"},webSQL:function(tmpdatastr,callback){var datastr=JSON.stringify(tmpdatastr);var params={req:datastr};var sqlurl="http://"+gEcnu.config.webHostIP+":81/WebSQL";try{gEcnu.Util.ajax("POST",sqlurl,params,false,function(data){var jsonparase=JSON.parse(data);callback(jsonparase)})}catch(e){alert("出现异常在："+e)}}});gEcnu.Edit={};gEcnu.Edit.moving=false;gEcnu.Edit.draw_line_points=[];gEcnu.Edit.draw_polygon_points=[];gEcnu.Edit.selectedPolygon=null;gEcnu.Edit.selectedPolygon_pre=null;gEcnu.Edit.selectedLine=null;gEcnu.Edit.selectedLine_pre=null;gEcnu.Edit.Poly_sellineRing_index=-1;gEcnu.Edit.Poly_selPoint_index=-1;gEcnu.Edit.Line_sellineString_index=-1;gEcnu.Edit.Line_selPoint_index=-1;gEcnu.Edit.draw_rect_points=[];gEcnu.Edit.draw_circle_points=[];gEcnu.Edit.drawCircleEnd=false;gEcnu.Edit.graphMouseDownEvt=function(e,map){var mode=map.getMode();var mxy=gEcnu.Util.getMouseXY(gSelf._container,e);gSelf.startX=mxy.x;gSelf.startY=mxy.y;var wxy=gEcnu.Util.screenToWorld(mxy.x,mxy.y);var ctx=map.overLayer.getCtx();gEcnu.Edit.moving=true;switch(mode){case"drawMarker":var point_geometry=new gEcnu.Geometry.Point(wxy.x,wxy.y);var callback_marker=gEcnu.DrawFeature.setting.events._events.added;if(typeof callback_marker!="undefined"){callback_marker(e,point_geometry)}break;case"drawPoint":var point_geometry=new gEcnu.Geometry.Point(wxy.x,wxy.y);var callback_marker=gEcnu.DrawFeature.setting.events._events.added;if(typeof callback_marker!="undefined"){callback_marker(e,point_geometry)}break;case"drawLine":var curobj=gEcnu.DrawFeature.setting;var catchable=curobj._catchable;var catchLayer=curobj._layer;if(catchable){var returnpoint="",returnstring="";var features=catchLayer.getAllFeatures();returnpoint=gEcnu.Graph.catchPoint(mxy,features);if(returnpoint.indexOf("true")>=0){var pointx=parseFloat(returnpoint.split("|")[1].split(",")[0]);var pointy=parseFloat(returnpoint.split("|")[1].split(",")[1]);var pointx_geo=parseFloat(returnpoint.split("|")[1].split(",")[2]);var pointy_geo=parseFloat(returnpoint.split("|")[1].split(",")[3]);mxy={x:pointx,y:pointy};wxy={x:pointx_geo,y:pointy_geo}}else{map.mLayer.getLayerContainer().style.cursor="default";returnstring=gEcnu.Graph.catchLine(mxy,features);if(returnstring.indexOf("true")>=0){var interX_scr=parseFloat(returnstring.split("|")[1].split(",")[0]);
var interY_scr=parseFloat(returnstring.split("|")[1].split(",")[1]);var interX=parseFloat(returnstring.split("|")[1].split(",")[2]);var interY=parseFloat(returnstring.split("|")[1].split(",")[3]);mxy={x:interX_scr,y:interY_scr};wxy={x:interX,y:interY}}else{}}}var point_geometry=new gEcnu.Geometry.Point(wxy.x,wxy.y);gEcnu.Edit.draw_line_points.push(point_geometry);var line_point_style=new gEcnu.Style({cirRadius:3,opacity:1,fillColor:"#118811",strokeColor:"#118811",lineWeight:1});map.overLayer.setStyle(line_point_style);var ctx=map.overLayer._ctx;gEcnu.Util.setStyle(ctx,line_point_style);gEcnu.Graph.drawPoint(ctx,mxy);var len=gEcnu.Edit.draw_line_points.length;if(len>1){var line_line_style=new gEcnu.Style({opacity:1,fillColor:"#118811",strokeColor:"#118811",lineWeight:1});map.overLayer.setStyle(line_line_style);var ctx=map.overLayer._ctx;gEcnu.Util.setStyle(ctx,line_line_style);gEcnu.Graph.drawLines_geo(ctx,gEcnu.Edit.draw_line_points)}break;case"drawPolygon":var curobj=gEcnu.DrawFeature.setting;var catchable=curobj._catchable;var catchLayer=curobj._layer;if(catchable){var returnpoint="",returnstring="";var features=catchLayer.getAllFeatures();returnpoint=gEcnu.Graph.catchPoint(mxy,features);if(returnpoint.indexOf("true")>=0){var pointx=parseFloat(returnpoint.split("|")[1].split(",")[0]);var pointy=parseFloat(returnpoint.split("|")[1].split(",")[1]);var pointx_geo=parseFloat(returnpoint.split("|")[1].split(",")[2]);var pointy_geo=parseFloat(returnpoint.split("|")[1].split(",")[3]);mxy={x:pointx,y:pointy};wxy={x:pointx_geo,y:pointy_geo}}else{map.mLayer.getLayerContainer().style.cursor="default";returnstring=gEcnu.Graph.catchLine(mxy,features);if(returnstring.indexOf("true")>=0){var interX_scr=parseFloat(returnstring.split("|")[1].split(",")[0]);var interY_scr=parseFloat(returnstring.split("|")[1].split(",")[1]);var interX=parseFloat(returnstring.split("|")[1].split(",")[2]);var interY=parseFloat(returnstring.split("|")[1].split(",")[3]);mxy={x:interX_scr,y:interY_scr};wxy={x:interX,y:interY}}else{}}}var point_geometry=new gEcnu.Geometry.Point(wxy.x,wxy.y);gEcnu.Edit.draw_polygon_points.push(point_geometry);var poly_point_style=new gEcnu.Style({cirRadius:3,opacity:1,fillColor:"#118811",strokeColor:"#118811",lineWeight:1});map.overLayer.setStyle(poly_point_style);var ctx=map.overLayer._ctx;gEcnu.Util.setStyle(ctx,poly_point_style);gEcnu.Graph.drawPoint(ctx,mxy);var len=gEcnu.Edit.draw_polygon_points.length;if(len>1){var line_line_style=new gEcnu.Style({opacity:1,fillColor:"#118811",strokeColor:"#118811",lineWeight:1});map.overLayer.setStyle(line_line_style);var ctx=map.overLayer._ctx;gEcnu.Util.setStyle(ctx,line_line_style);gEcnu.Graph.drawLines_geo(ctx,gEcnu.Edit.draw_polygon_points)}break;case"selectPolygon":if(gEcnu.Util.ifctrl(e)){var curobj=gEcnu.EditFeature.setting;var catchLayer=curobj._layer;var features=catchLayer.getAllFeatures();var len=features.length;var returnfea=null;for(var i=0;i<len;i++){var ifexit=false;var linering_len=features[i]._lineRings.length;for(var j=0;j<linering_len;j++){var tmppoints=features[i]._lineRings[j].points;if(gEcnu.Graph.pointInPoly(wxy,tmppoints)){features[i].onSelect_ex();returnfea=features[i];ifexit=true;break}}if(ifexit){break}}var callback_marker=gEcnu.EditFeature.setting.events._events.multiSelected;var returnFeatures=[];if(returnfea!=null){returnFeatures.push(returnfea)}if(typeof callback_marker!="undefined"){callback_marker(e,returnFeatures)}}else{var curobj=gEcnu.EditFeature.setting;var catchLayer=curobj._layer;var features=catchLayer.getAllFeatures();var len=features.length;var returnfea=null;for(var i=0;i<len;i++){var ifexit=false;var linering_len=features[i]._lineRings.length;for(var j=0;j<linering_len;j++){var tmppoints=features[i]._lineRings[j].points;if(gEcnu.Graph.pointInPoly(wxy,tmppoints)){features[i].onSelect();returnfea=features[i];gEcnu.Edit.selectedPolygon=returnfea;gEcnu.Edit.selectedPolygon_pre=returnfea;ifexit=true;break}}if(ifexit){break}}var callback_marker=gEcnu.EditFeature.setting.events._events.selected;var returnFeatures=[];if(returnfea!=null){returnFeatures.push(returnfea)}if(typeof callback_marker!="undefined"){callback_marker(e,returnFeatures)}}break;case"addPoint":var returnstring="false";if(gEcnu.Edit.selectedPolygon==null){return}returnstring=gEcnu.Graph.catchLine(mxy,[gEcnu.Edit.selectedPolygon]);if(returnstring.indexOf("true")>=0){var pointx_geo=parseFloat(returnstring.split("|")[1].split(",")[2]);var pointy_geo=parseFloat(returnstring.split("|")[1].split(",")[3]);var lineerring_index=parseFloat(returnstring.split("|")[4].split(",")[0]);var linestrPoint_index=parseFloat(returnstring.split("|")[4].split(",")[1]);var opeLinerRing=gEcnu.Edit.selectedPolygon._lineRings[lineerring_index];var insertPoint=new gEcnu.Geometry.Point(pointx_geo,pointy_geo);var myindex=parseInt(linestrPoint_index)+1;opeLinerRing.addPoint(insertPoint,myindex);var curobj=gEcnu.EditFeature.setting;var catchLayer=curobj._layer;var allfeatures=catchLayer.getAllFeatures();
var catchPolygons=[];for(var m=0;m<allfeatures.length;m++){if(allfeatures[m]!=gEcnu.Edit.selectedPolygon_pre){catchPolygons.push(allfeatures[m])}}var opeFea=new gEcnu.Feature.Polygon(gEcnu.Edit.selectedPolygon._lineRings,gEcnu.Edit.selectedPolygon._data);catchPolygons.push(opeFea);gEcnu.Edit.selectedPolygon_pre=opeFea;gEcnu.Edit.selectedPolygon=opeFea;catchLayer.removeAllFeatures();catchLayer.addFeatures(catchPolygons);opeFea.onSelect();map.setMode("moveNode_mouseDwon");var callback_marker=gEcnu.EditFeature.setting.events._events.updateCompleted;if(typeof callback_marker!="undefined"){callback_marker(e,opeFea)}}else{}break;case"delPoint":var returnpoint="false";if(gEcnu.Edit.selectedPolygon==null){return}returnpoint=gEcnu.Graph.catchPoint(mxy,[gEcnu.Edit.selectedPolygon]);if(returnpoint.indexOf("true")>=0){var lineRing_index=parseFloat(returnpoint.split("|")[2].split(",")[0]);var lineRingPoint_index=parseFloat(returnpoint.split("|")[2].split(",")[1]);var opeLinerRing=gEcnu.Edit.selectedPolygon._lineRings[lineRing_index];var myindex=parseInt(lineRingPoint_index);opeLinerRing.delPoint(myindex);var curobj=gEcnu.EditFeature.setting;var catchLayer=curobj._layer;var allfeatures=catchLayer.getAllFeatures();var catchPolygons=[];for(var m=0;m<allfeatures.length;m++){if(allfeatures[m]!=gEcnu.Edit.selectedPolygon_pre){catchPolygons.push(allfeatures[m])}}var opeFea=new gEcnu.Feature.Polygon(gEcnu.Edit.selectedPolygon._lineRings,gEcnu.Edit.selectedPolygon._data);catchPolygons.push(opeFea);gEcnu.Edit.selectedPolygon_pre=opeFea;gEcnu.Edit.selectedPolygon=opeFea;catchLayer.removeAllFeatures();catchLayer.addFeatures(catchPolygons);opeFea.onSelect();map.setMode("moveNode_mouseDwon");var callback_marker=gEcnu.EditFeature.setting.events._events.updateCompleted;if(typeof callback_marker!="undefined"){callback_marker(e,opeFea)}}else{}break;case"moveNode_mouseDwon":map.setMode("moveNode");break;case"selectLine":if(gEcnu.Util.ifctrl(e)){var curobj=gEcnu.EditFeature.setting;var catchLayer=curobj._layer;var features=catchLayer.getAllFeatures();var len=features.length;var returnfea=null;var returnString=gEcnu.Graph.catchLine(mxy,features);if(returnString.indexOf("true")>=0){var linefea_index=parseFloat(returnString.split("|")[4].split(",")[2]);linefea_index=parseInt(linefea_index);var linefea=features[linefea_index];linefea.onSelect_ex();returnfea=linefea}var callback_marker=gEcnu.EditFeature.setting.events._events.multiSelected;var returnFeatures=[];if(returnfea!=null){returnFeatures.push(returnfea)}if(typeof callback_marker!="undefined"){callback_marker(e,returnFeatures)}}else{var curobj=gEcnu.EditFeature.setting;var catchLayer=curobj._layer;var features=catchLayer.getAllFeatures();var len=features.length;var returnfea=null;var returnString=gEcnu.Graph.catchLine(mxy,features);if(returnString.indexOf("true")>=0){var linefea_index=parseFloat(returnString.split("|")[4].split(",")[2]);linefea_index=parseInt(linefea_index);var linefea=features[linefea_index];linefea.onSelect();returnfea=linefea;gEcnu.Edit.selectedLine=returnfea;gEcnu.Edit.selectedLine_pre=returnfea}var callback_marker=gEcnu.EditFeature.setting.events._events.selected;var returnFeatures=[];if(returnfea!=null){returnFeatures.push(returnfea)}if(typeof callback_marker!="undefined"){callback_marker(e,returnFeatures)}}break;case"moveNodeLine_mouseDwon":map.setMode("moveNode_Line");break;case"addPoint_line":var returnstring="false";if(gEcnu.Edit.selectedLine==null){return}returnstring=gEcnu.Graph.catchLine(mxy,[gEcnu.Edit.selectedLine]);if(returnstring.indexOf("true")>=0){var pointx_geo=parseFloat(returnstring.split("|")[1].split(",")[2]);var pointy_geo=parseFloat(returnstring.split("|")[1].split(",")[3]);var lineerring_index=parseFloat(returnstring.split("|")[4].split(",")[0]);var linestrPoint_index=parseFloat(returnstring.split("|")[4].split(",")[1]);var opeLinerRing=gEcnu.Edit.selectedLine._lineStrings[lineerring_index];var insertPoint=new gEcnu.Geometry.Point(pointx_geo,pointy_geo);var myindex=parseInt(linestrPoint_index)+1;opeLinerRing.addPoint(insertPoint,myindex);var curobj=gEcnu.EditFeature.setting;var catchLayer=curobj._layer;var allfeatures=catchLayer.getAllFeatures();var catchPolygons=[];for(var m=0;m<allfeatures.length;m++){if(allfeatures[m]!=gEcnu.Edit.selectedLine_pre){catchPolygons.push(allfeatures[m])}}var opeFea=new gEcnu.Feature.Polyline(gEcnu.Edit.selectedLine._lineStrings,gEcnu.Edit.selectedLine._data);catchPolygons.push(opeFea);gEcnu.Edit.selectedLine_pre=opeFea;gEcnu.Edit.selectedLine=opeFea;catchLayer.removeAllFeatures();catchLayer.addFeatures(catchPolygons);opeFea.onSelect();map.setMode("moveNodeLine_mouseDwon");var callback_marker=gEcnu.EditFeature.setting.events._events.updateCompleted;if(typeof callback_marker!="undefined"){callback_marker(e,opeFea)}}else{}break;case"delPoint_line":var returnpoint="false";if(gEcnu.Edit.selectedLine==null){return}returnpoint=gEcnu.Graph.catchPoint(mxy,[gEcnu.Edit.selectedLine]);if(returnpoint.indexOf("true")>=0){var lineRing_index=parseFloat(returnpoint.split("|")[2].split(",")[0]);
var lineRingPoint_index=parseFloat(returnpoint.split("|")[2].split(",")[1]);var opeLinerRing=gEcnu.Edit.selectedLine._lineStrings[lineRing_index];var myindex=parseInt(lineRingPoint_index);opeLinerRing.delPoint(myindex);var curobj=gEcnu.EditFeature.setting;var catchLayer=curobj._layer;var allfeatures=catchLayer.getAllFeatures();var catchPolygons=[];for(var m=0;m<allfeatures.length;m++){if(allfeatures[m]!=gEcnu.Edit.selectedLine_pre){catchPolygons.push(allfeatures[m])}}var opeFea=new gEcnu.Feature.Polyline(gEcnu.Edit.selectedLine._lineStrings,gEcnu.Edit.selectedLine._data);catchPolygons.push(opeFea);gEcnu.Edit.selectedLine_pre=opeFea;gEcnu.Edit.selectedLine=opeFea;catchLayer.removeAllFeatures();catchLayer.addFeatures(catchPolygons);opeFea.onSelect();map.setMode("moveNodeLine_mouseDwon");var callback_marker=gEcnu.EditFeature.setting.events._events.updateCompleted;if(typeof callback_marker!="undefined"){callback_marker(e,opeFea)}}else{}break;case"drawRect":var geometry_pt=new gEcnu.Geometry.Point(wxy.x,wxy.y);gEcnu.Edit.draw_rect_points.push(geometry_pt);break;case"drawCircle":if(gEcnu.Edit.draw_circle_points.length>0){gEcnu.Edit.drawCircleEnd=true}else{gSelf.overLayer.clear();gEcnu.Edit.drawCircleEnd=false}var geometry_pt=new gEcnu.Geometry.Point(wxy.x,wxy.y);gEcnu.Edit.draw_circle_points.push(geometry_pt);break}};gEcnu.Edit.graphMouseMoveEvt=function(e,map){var mode=map.getMode();var mxy=gEcnu.Util.getMouseXY(gSelf._container,e);var ctx=map.overLayer.getCtx();switch(mode){case"drawLine":var ptArr=gEcnu.Edit.draw_line_points;var len=ptArr.length;var curobj=gEcnu.DrawFeature.setting;var catchable=curobj._catchable;var catchLayer=curobj._layer;map.overLayer.clear();if(catchable){var returnpoint="",returnstring="";var features=catchLayer.getAllFeatures();returnpoint=gEcnu.Graph.catchPoint(mxy,features);if(returnpoint.indexOf("true")>=0){map.overLayer.clear();map.mLayer.getLayerContainer().style.cursor="crosshair";var pointx=parseFloat(returnpoint.split("|")[1].split(",")[0]);var pointy=parseFloat(returnpoint.split("|")[1].split(",")[1]);mxy={x:pointx,y:pointy};var line_point_style=new gEcnu.Style({cirRadius:3,opacity:1,fillColor:"red",strokeColor:"red",lineWeight:2});map.overLayer.setStyle(line_point_style);var ctx=map.overLayer._ctx;gEcnu.Util.setStyle(ctx,line_point_style);gEcnu.Graph.drawPoint(ctx,mxy)}else{map.mLayer.getLayerContainer().style.cursor="default";returnstring=gEcnu.Graph.catchLine(mxy,features);if(returnstring.indexOf("true")>=0){var startx=parseFloat(returnstring.split("|")[2].split(",")[0]);var starty=parseFloat(returnstring.split("|")[2].split(",")[1]);var endx=parseFloat(returnstring.split("|")[3].split(",")[0]);var endy=parseFloat(returnstring.split("|")[3].split(",")[1]);var pt1={x:startx,y:starty};var pt2={x:endx,y:endy};var line_point_style=new gEcnu.Style({cirRadius:3,opacity:1,fillColor:"red",strokeColor:"red",lineWeight:2});map.overLayer.setStyle(line_point_style);var ctx=map.overLayer._ctx;gEcnu.Util.setStyle(ctx,line_point_style);gEcnu.Graph.drawLine(ctx,pt1,pt2)}else{}}}if(len>=1){var line_point_style=new gEcnu.Style({opacity:1,fillColor:"#118811",strokeColor:"#118811",lineWeight:1});map.overLayer.setStyle(line_point_style);var ctx=map.overLayer._ctx;gEcnu.Util.setStyle(ctx,line_point_style);var sxy=gEcnu.Util.worldToScreen(ptArr[len-1].x,ptArr[len-1].y);gEcnu.Graph.drawLine(ctx,sxy,mxy);gEcnu.Graph.drawLines_geo(ctx,ptArr)}gEcnu.Graph.drawPoints_geo(ctx,ptArr);break;case"drawPolygon":var ptArr=gEcnu.Edit.draw_polygon_points;var len=ptArr.length;var curobj=gEcnu.DrawFeature.setting;var catchable=curobj._catchable;var catchLayer=curobj._layer;map.overLayer.clear();if(catchable){var returnpoint="",returnstring="";var features=catchLayer.getAllFeatures();returnpoint=gEcnu.Graph.catchPoint(mxy,features);if(returnpoint.indexOf("true")>=0){map.overLayer.clear();map.mLayer.getLayerContainer().style.cursor="crosshair";var pointx=parseFloat(returnpoint.split("|")[1].split(",")[0]);var pointy=parseFloat(returnpoint.split("|")[1].split(",")[1]);mxy={x:pointx,y:pointy};var line_point_style=new gEcnu.Style({cirRadius:3,opacity:1,fillColor:"red",strokeColor:"red",lineWeight:2});map.overLayer.setStyle(line_point_style);var ctx=map.overLayer._ctx;gEcnu.Util.setStyle(ctx,line_point_style);gEcnu.Graph.drawPoint(ctx,mxy)}else{map.mLayer.getLayerContainer().style.cursor="default";returnstring=gEcnu.Graph.catchLine(mxy,features);if(returnstring.indexOf("true")>=0){var startx=parseFloat(returnstring.split("|")[2].split(",")[0]);var starty=parseFloat(returnstring.split("|")[2].split(",")[1]);var endx=parseFloat(returnstring.split("|")[3].split(",")[0]);var endy=parseFloat(returnstring.split("|")[3].split(",")[1]);var pt1={x:startx,y:starty};var pt2={x:endx,y:endy};var line_point_style=new gEcnu.Style({cirRadius:3,opacity:1,fillColor:"red",strokeColor:"red",lineWeight:2});map.overLayer.setStyle(line_point_style);var ctx=map.overLayer._ctx;gEcnu.Util.setStyle(ctx,line_point_style);gEcnu.Graph.drawLine(ctx,pt1,pt2)
}else{}}}if(len>=1){var line_point_style=new gEcnu.Style({opacity:1,fillColor:"#118811",strokeColor:"#118811",lineWeight:1});map.overLayer.setStyle(line_point_style);var ctx=map.overLayer._ctx;gEcnu.Util.setStyle(ctx,line_point_style);var sxy=gEcnu.Util.worldToScreen(ptArr[len-1].x,ptArr[len-1].y);gEcnu.Graph.drawLine(ctx,sxy,mxy);if(len>=2){var sxy_fir=gEcnu.Util.worldToScreen(ptArr[0].x,ptArr[0].y);gEcnu.Graph.drawLine(ctx,sxy_fir,mxy)}gEcnu.Graph.drawLines_geo(ctx,ptArr);if(returnpoint.indexOf("true")>=0){gEcnu.Graph.drawPoint(ctx,mxy)}}gEcnu.Graph.drawPoints_geo(ctx,ptArr);break;case"moveNode_mouseDwon":case"selectPolygon":map.mLayer.getLayerContainer().style.cursor="default";if(gEcnu.Edit.selectedPolygon!=null){map.mLayer.getLayerContainer().style.cursor="default";var thislen=gEcnu.Edit.selectedPolygon._lineRings.length;for(var m=0;m<thislen;m++){var tmppoints=gEcnu.Edit.selectedPolygon._lineRings[m].points;var tmppoints_len=tmppoints.length;for(var j=0;j<tmppoints_len;j++){var thispoint=gEcnu.Util.worldToScreen(tmppoints[j].x,tmppoints[j].y);var dis=Math.sqrt((mxy.x-thispoint.x)*(mxy.x-thispoint.x)+(mxy.y-thispoint.y)*(mxy.y-thispoint.y));if(dis<5){gEcnu.Edit.Poly_selPoint_index=j;gEcnu.Edit.Poly_sellineRing_index=m;map.mLayer.getLayerContainer().style.cursor="move";map.setMode("moveNode_mouseDwon");return}}}}map.setMode("selectPolygon");break;case"moveNode":if(gEcnu.Edit.Poly_selPoint_index!=-1){var opePolygon=gEcnu.Edit.selectedPolygon;var opeVtx=opePolygon._lineRings[gEcnu.Edit.Poly_sellineRing_index].points[gEcnu.Edit.Poly_selPoint_index];var opepoint_len=opePolygon._lineRings[gEcnu.Edit.Poly_sellineRing_index].points.length;var opelastPoint=opePolygon._lineRings[gEcnu.Edit.Poly_sellineRing_index].points[opepoint_len-1];var curobj=gEcnu.EditFeature.setting;var catchable=curobj._catchable;var catchLayer=curobj._layer;map.overLayer.clear();if(catchable){var allfeatures=catchLayer.getAllFeatures();var catchPolygons=new Array();for(var m=0;m<allfeatures.length;m++){if(allfeatures[m]!=opePolygon){catchPolygons.push(allfeatures[m])}}var returnpoint=gEcnu.Graph.catchPoint(mxy,catchPolygons);if(returnpoint.indexOf("true")>=0){map.mLayer.getLayerContainer().style.cursor="crosshair";var pointx=parseFloat(returnpoint.split("|")[1].split(",")[0]);var pointy=parseFloat(returnpoint.split("|")[1].split(",")[1]);mxy={x:pointx,y:pointy};opeVtx.x=parseFloat(returnpoint.split("|")[1].split(",")[2]);opeVtx.y=parseFloat(returnpoint.split("|")[1].split(",")[3]);if(gEcnu.Edit.Poly_selPoint_index==0){opelastPoint.x=opeVtx.x;opelastPoint.y=opeVtx.y}var ctx=map.overLayer._ctx;gEcnu.Graph.drawPoint(ctx,mxy)}else{map.mLayer.getLayerContainer().style.cursor="move";var returnstring=gEcnu.Graph.catchLine(mxy,catchPolygons);if(returnstring.indexOf("true")>=0){map.mLayer.getLayerContainer().style.cursor="default";var startx=parseFloat(returnstring.split("|")[2].split(",")[0]);var starty=parseFloat(returnstring.split("|")[2].split(",")[1]);var endx=parseFloat(returnstring.split("|")[3].split(",")[0]);var endy=parseFloat(returnstring.split("|")[3].split(",")[1]);var pt1={x:startx,y:starty};var pt2={x:endx,y:endy};opeVtx.x=parseFloat(returnstring.split("|")[1].split(",")[2]);opeVtx.y=parseFloat(returnstring.split("|")[1].split(",")[3]);if(gEcnu.Edit.Poly_selPoint_index==0){opelastPoint.x=opeVtx.x;opelastPoint.y=opeVtx.y}var ctx=map.overLayer._ctx;gEcnu.Graph.drawLine(ctx,pt1,pt2)}else{map.mLayer.getLayerContainer().style.cursor="move";var pt2=gEcnu.Util.screenToWorld(mxy.x,mxy.y);opeVtx.x=pt2.x;opeVtx.y=pt2.y;if(gEcnu.Edit.Poly_selPoint_index==0){opelastPoint.x=opeVtx.x;opelastPoint.y=opeVtx.y}}}var ctx=map.overLayer._ctx;gEcnu.Graph.drawPoints_geo(ctx,opePolygon._lineRings[gEcnu.Edit.Poly_sellineRing_index].points);gEcnu.Graph.drawLines_geo(ctx,opePolygon._lineRings[gEcnu.Edit.Poly_sellineRing_index].points)}else{map.mLayer.getLayerContainer().style.cursor="pointer";var pt2=gEcnu.Util.screenToWorld(mxy.x,mxy.y);opeVtx.x=pt2.x;opeVtx.y=pt2.y;if(gEcnu.Edit.Poly_selPoint_index==0){opelastPoint.x=opeVtx.x;opelastPoint.y=opeVtx.y}var ctx=map.overLayer._ctx;gEcnu.Graph.drawPoints_geo(ctx,opePolygon._lineRings[gEcnu.Edit.Poly_sellineRing_index].points);gEcnu.Graph.drawLines_geo(ctx,opePolygon._lineRings[gEcnu.Edit.Poly_sellineRing_index].points)}}break;case"addPoint":var returnstring="false";if(gEcnu.Edit.selectedPolygon==null){return}returnstring=gEcnu.Graph.catchLine(mxy,[gEcnu.Edit.selectedPolygon]);if(returnstring.indexOf("true")>=0){map.mLayer.getLayerContainer().style.cursor="crosshair";var interX_scr=parseFloat(returnstring.split("|")[1].split(",")[0]);var interY_scr=parseFloat(returnstring.split("|")[1].split(",")[1]);var ctx=map.overLayer._ctx;gEcnu.Edit.selectedPolygon.onSelect();var line_point_style=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});map.overLayer.setStyle(line_point_style);gEcnu.Util.setStyle(ctx,line_point_style);gEcnu.Graph.drawPoint(ctx,{x:interX_scr,y:interY_scr});return}else{map.mLayer.getLayerContainer().style.cursor="default";
gEcnu.Edit.selectedPolygon.onSelect()}break;case"delPoint":var returnpoint="false";if(gEcnu.Edit.selectedPolygon==null){return}returnpoint=gEcnu.Graph.catchPoint(mxy,[gEcnu.Edit.selectedPolygon]);if(returnpoint.indexOf("true")>=0){map.mLayer.getLayerContainer().style.cursor="pointer";var pointx=parseFloat(returnpoint.split("|")[1].split(",")[0]);var pointy=parseFloat(returnpoint.split("|")[1].split(",")[1]);var ctx=map.overLayer._ctx;gEcnu.Edit.selectedPolygon.onSelect();var line_point_style=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});map.overLayer.setStyle(line_point_style);gEcnu.Util.setStyle(ctx,line_point_style);gEcnu.Graph.drawPoint(ctx,{x:pointx,y:pointy});return}else{map.mLayer.getLayerContainer().style.cursor="default";gEcnu.Edit.selectedPolygon.onSelect()}break;case"moveNodeLine_mouseDwon":case"selectLine":map.mLayer.getLayerContainer().style.cursor="default";if(gEcnu.Edit.selectedLine!=null){map.mLayer.getLayerContainer().style.cursor="default";var thislen=gEcnu.Edit.selectedLine._lineStrings.length;for(var m=0;m<thislen;m++){var tmppoints=gEcnu.Edit.selectedLine._lineStrings[m].points;var tmppoints_len=tmppoints.length;for(var j=0;j<tmppoints_len;j++){var thispoint=gEcnu.Util.worldToScreen(tmppoints[j].x,tmppoints[j].y);var dis=Math.sqrt((mxy.x-thispoint.x)*(mxy.x-thispoint.x)+(mxy.y-thispoint.y)*(mxy.y-thispoint.y));if(dis<5){gEcnu.Edit.Line_sellineString_index=m;gEcnu.Edit.Line_selPoint_index=j;map.mLayer.getLayerContainer().style.cursor="move";map.setMode("moveNodeLine_mouseDwon");return}}}}map.setMode("selectLine");break;case"moveNode_Line":if(gEcnu.Edit.Line_selPoint_index!=-1){var opeLine=gEcnu.Edit.selectedLine;var opeVtx=opeLine._lineStrings[gEcnu.Edit.Line_sellineString_index].points[gEcnu.Edit.Line_selPoint_index];var curobj=gEcnu.EditFeature.setting;var catchable=curobj._catchable;var catchLayer=curobj._layer;map.overLayer.clear();if(catchable){var allfeatures=catchLayer.getAllFeatures();var catchPolygons=new Array();for(var m=0;m<allfeatures.length;m++){if(allfeatures[m]!=opeLine){catchPolygons.push(allfeatures[m])}}var returnpoint=gEcnu.Graph.catchPoint(mxy,catchPolygons);if(returnpoint.indexOf("true")>=0){map.mLayer.getLayerContainer().style.cursor="crosshair";var pointx=parseFloat(returnpoint.split("|")[1].split(",")[0]);var pointy=parseFloat(returnpoint.split("|")[1].split(",")[1]);mxy={x:pointx,y:pointy};opeVtx.x=parseFloat(returnpoint.split("|")[1].split(",")[2]);opeVtx.y=parseFloat(returnpoint.split("|")[1].split(",")[3]);var ctx=map.overLayer._ctx;gEcnu.Graph.drawPoint(ctx,mxy)}else{map.mLayer.getLayerContainer().style.cursor="move";var returnstring=gEcnu.Graph.catchLine(mxy,catchPolygons);if(returnstring.indexOf("true")>=0){map.mLayer.getLayerContainer().style.cursor="default";var startx=parseFloat(returnstring.split("|")[2].split(",")[0]);var starty=parseFloat(returnstring.split("|")[2].split(",")[1]);var endx=parseFloat(returnstring.split("|")[3].split(",")[0]);var endy=parseFloat(returnstring.split("|")[3].split(",")[1]);var pt1={x:startx,y:starty};var pt2={x:endx,y:endy};opeVtx.x=parseFloat(returnstring.split("|")[1].split(",")[2]);opeVtx.y=parseFloat(returnstring.split("|")[1].split(",")[3]);var ctx=map.overLayer._ctx;gEcnu.Graph.drawLine(ctx,pt1,pt2)}else{map.mLayer.getLayerContainer().style.cursor="move";var pt2=gEcnu.Util.screenToWorld(mxy.x,mxy.y);opeVtx.x=pt2.x;opeVtx.y=pt2.y}}var ctx=map.overLayer._ctx;gEcnu.Graph.drawPoints_geo(ctx,opeLine._lineStrings[gEcnu.Edit.Line_sellineString_index].points);gEcnu.Graph.drawLines_geo(ctx,opeLine._lineStrings[gEcnu.Edit.Line_sellineString_index].points)}else{map.mLayer.getLayerContainer().style.cursor="pointer";var pt2=gEcnu.Util.screenToWorld(mxy.x,mxy.y);opeVtx.x=pt2.x;opeVtx.y=pt2.y;var ctx=map.overLayer._ctx;gEcnu.Graph.drawPoints_geo(ctx,opeLine._lineStrings[gEcnu.Edit.Line_sellineString_index].points);gEcnu.Graph.drawLines_geo(ctx,opeLine._lineStrings[gEcnu.Edit.Line_sellineString_index].points)}}break;case"addPoint_line":var returnstring="false";if(gEcnu.Edit.selectedLine==null){return}returnstring=gEcnu.Graph.catchLine(mxy,[gEcnu.Edit.selectedLine]);if(returnstring.indexOf("true")>=0){map.mLayer.getLayerContainer().style.cursor="crosshair";var interX_scr=parseFloat(returnstring.split("|")[1].split(",")[0]);var interY_scr=parseFloat(returnstring.split("|")[1].split(",")[1]);var ctx=map.overLayer._ctx;gEcnu.Edit.selectedLine.onSelect();var line_point_style=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});map.overLayer.setStyle(line_point_style);gEcnu.Util.setStyle(ctx,line_point_style);gEcnu.Graph.drawPoint(ctx,{x:interX_scr,y:interY_scr});return}else{map.mLayer.getLayerContainer().style.cursor="default";gEcnu.Edit.selectedLine.onSelect()}break;case"delPoint_line":var returnpoint="false";if(gEcnu.Edit.selectedLine==null){return}returnpoint=gEcnu.Graph.catchPoint(mxy,[gEcnu.Edit.selectedLine]);if(returnpoint.indexOf("true")>=0){map.mLayer.getLayerContainer().style.cursor="pointer";
var pointx=parseFloat(returnpoint.split("|")[1].split(",")[0]);var pointy=parseFloat(returnpoint.split("|")[1].split(",")[1]);var ctx=map.overLayer._ctx;gEcnu.Edit.selectedLine.onSelect();var line_point_style=new gEcnu.Style({opacity:1,fillColor:"red",strokeColor:"red",lineWeight:1});map.overLayer.setStyle(line_point_style);gEcnu.Util.setStyle(ctx,line_point_style);gEcnu.Graph.drawPoint(ctx,{x:pointx,y:pointy});return}else{map.mLayer.getLayerContainer().style.cursor="default";gEcnu.Edit.selectedLine.onSelect()}break;case"drawRect":var wxy=gEcnu.Util.screenToWorld(mxy.x,mxy.y);var geometry_pt=new gEcnu.Geometry.Point(wxy.x,wxy.y);if(gEcnu.Edit.draw_rect_points.length>0){gSelf.overLayer.clear();var ctx=gSelf.overLayer.getCtx();ctx.strokeColor="red";var w=mxy.x-gSelf.startX;var h=mxy.y-gSelf.startY;ctx.strokeRect(gSelf.startX,gSelf.startY,w,h)}break;case"drawCircle":var wxy=gEcnu.Util.screenToWorld(mxy.x,mxy.y);var geometry_pt=new gEcnu.Geometry.Point(wxy.x,wxy.y);if(gEcnu.Edit.draw_circle_points.length>0){if(gEcnu.Edit.drawCircleEnd){return}gSelf.overLayer.clear();var ctx=gSelf.overLayer.getCtx();ctx.strokeColor="red";ctx.beginPath();var radius=Math.sqrt((mxy.x-gSelf.startX)*(mxy.x-gSelf.startX)+(mxy.y-gSelf.startY)*(mxy.y-gSelf.startY));ctx.arc(gSelf.startX,gSelf.startY,radius,0,Math.PI*2,true);ctx.stroke()}break}};gEcnu.Edit.graphMouseUpEvt=function(e,map){var mode=map.getMode();var mxy=gEcnu.Util.getMouseXY(gSelf._container,e);var wxy=gEcnu.Util.screenToWorld(mxy.x,mxy.y);gEcnu.Edit.moving=false;switch(mode){case"moveNode":var curobj=gEcnu.EditFeature.setting;var catchLayer=curobj._layer;var allfeatures=catchLayer.getAllFeatures();var catchPolygons=[];for(var m=0;m<allfeatures.length;m++){if(allfeatures[m]!=gEcnu.Edit.selectedPolygon_pre){catchPolygons.push(allfeatures[m])}}var opeFea=new gEcnu.Feature.Polygon(gEcnu.Edit.selectedPolygon._lineRings,gEcnu.Edit.selectedPolygon._data);catchPolygons.push(opeFea);gEcnu.Edit.selectedPolygon_pre=opeFea;gEcnu.Edit.selectedPolygon=opeFea;catchLayer.removeAllFeatures();catchLayer.addFeatures(catchPolygons);opeFea.onSelect();map.setMode("moveNode_mouseDwon");var callback_marker=gEcnu.EditFeature.setting.events._events.updateCompleted;if(typeof callback_marker!="undefined"){callback_marker(e,opeFea)}break;case"moveNode_Line":var curobj=gEcnu.EditFeature.setting;var catchLayer=curobj._layer;var allfeatures=catchLayer.getAllFeatures();var catchPolygons=[];for(var m=0;m<allfeatures.length;m++){if(allfeatures[m]!=gEcnu.Edit.selectedLine_pre){catchPolygons.push(allfeatures[m])}}var opeFea=new gEcnu.Feature.Polyline(gEcnu.Edit.selectedLine._lineStrings,gEcnu.Edit.selectedLine._data);catchPolygons.push(opeFea);gEcnu.Edit.selectedLine_pre=opeFea;gEcnu.Edit.selectedLine=opeFea;catchLayer.removeAllFeatures();catchLayer.addFeatures(catchPolygons);opeFea.onSelect();map.setMode("moveNodeLine_mouseDwon");var callback_marker=gEcnu.EditFeature.setting.events._events.updateCompleted;if(typeof callback_marker!="undefined"){callback_marker(e,opeFea)}break}};gEcnu.Edit.graphMouseDblClickEvt=function(e,map){var mode=map.getMode();switch(mode){case"drawLine":gEcnu.Edit.draw_line_points.pop();var linestring=new gEcnu.Geometry.LineString(gEcnu.Edit.draw_line_points);var callback_marker=gEcnu.DrawFeature.setting.events._events.added;if(typeof callback_marker!="undefined"){callback_marker(e,linestring);gEcnu.Edit.draw_line_points=[]}map.overLayer.clear();break;case"drawPolygon":gEcnu.Edit.draw_polygon_points.pop();var linerRing=new gEcnu.Geometry.LinearRing(gEcnu.Edit.draw_polygon_points);var callback_marker=gEcnu.DrawFeature.setting.events._events.added;if(typeof callback_marker!="undefined"){callback_marker(e,linerRing);gEcnu.Edit.draw_polygon_points=[]}map.overLayer.clear();break;case"drawRect":gEcnu.Edit.draw_rect_points.pop();var pt1x=gEcnu.Edit.draw_rect_points[1].x;var pt1y=gEcnu.Edit.draw_rect_points[0].y;var pt2x=gEcnu.Edit.draw_rect_points[1].x;var pt2y=gEcnu.Edit.draw_rect_points[1].y;var pt3x=gEcnu.Edit.draw_rect_points[0].x;var pt3y=gEcnu.Edit.draw_rect_points[1].y;var geopt1=new gEcnu.Geometry.Point(pt1x,pt1y);var geopt2=new gEcnu.Geometry.Point(pt2x,pt2y);var geopt3=new gEcnu.Geometry.Point(pt3x,pt3y);gEcnu.Edit.draw_rect_points[1]=geopt1;gEcnu.Edit.draw_rect_points.push(geopt2);gEcnu.Edit.draw_rect_points.push(geopt3);var rectRing=new gEcnu.Geometry.RectRing(gEcnu.Edit.draw_rect_points);var callback=gEcnu.DrawFeature.setting.events._events.added;if(typeof callback!="undefined"){callback(e,rectRing);gEcnu.Edit.draw_rect_points=[]}gSelf.overLayer.clear();break;case"drawCircle":gEcnu.Edit.draw_circle_points.pop();var centerpt=gEcnu.Edit.draw_circle_points[0];if(gEcnu.Edit.draw_circle_points.length>=2){var pt1=gEcnu.Edit.draw_circle_points[0];var pt2=gEcnu.Edit.draw_circle_points[1];var radius=Math.sqrt((pt2.x-pt1.x)*(pt2.x-pt1.x)+(pt2.y-pt1.y)*(pt2.y-pt1.y));var RadiusRing=new gEcnu.Geometry.RadiusRing(centerpt,radius);var callback=gEcnu.DrawFeature.setting.events._events.added;if(typeof callback!="undefined"){callback(e,RadiusRing);
gEcnu.Edit.draw_circle_points=[]}}break}};gEcnu.DrawFeature=gClass.extend({init:function(name){this.name=name}});gEcnu.DrawFeature.setting=null;gEcnu.DrawFeature.Marker=gEcnu.DrawFeature.extend({init:function(){this._layer=gSelf.mLayer},activate:function(){this._layer._map.setMode("drawMarker");gEcnu.DrawFeature.setting=this},deactivate:function(){this._layer._map.setMode("map")},events:{_events:{},on:function(eventType,callback){switch(eventType){case"added":this._events.added=callback;break}}}});gEcnu.DrawFeature.Point=gEcnu.DrawFeature.extend({init:function(layer){this._layer=layer},activate:function(){this._layer._map.setMode("drawPoint");gEcnu.DrawFeature.setting=this},deactivate:function(){this._layer._map.setMode("map")},events:{_events:{},on:function(eventType,callback){switch(eventType){case"added":this._events.added=callback;break}}}});gEcnu.DrawFeature.Line=gEcnu.DrawFeature.extend({init:function(layer,catchable){this._layer=layer;this._catchable=true;if(arguments.length>1){this._catchable=catchable}},setCatchable:function(bool_catch){this._catchable=bool_catch},activate:function(){this._layer._map.setMode("drawLine");gEcnu.DrawFeature.setting=this},deactivate:function(){this._layer._map.setMode("map")},events:{_events:{},on:function(eventType,callback){switch(eventType){case"added":this._events.added=callback;break}}}});gEcnu.DrawFeature.Polygon=gEcnu.DrawFeature.extend({init:function(layer,catchable){this._layer=layer;this._catchable=true;if(arguments.length>1){this._catchable=catchable}},setCatchable:function(bool_catch){this._catchable=bool_catch},activate:function(){this._layer._map.setMode("drawPolygon");gEcnu.DrawFeature.setting=this},deactivate:function(){this._layer._map.setMode("map")},events:{_events:{},on:function(eventType,callback){switch(eventType){case"added":this._events.added=callback;break}}}});gEcnu.DrawFeature.Rect=gEcnu.DrawFeature.extend({init:function(layer){this._layer=layer},activate:function(){this._layer._map.setMode("drawRect");gEcnu.DrawFeature.setting=this},deactivate:function(){this._layer._map.setMode("map")},events:{_events:{},on:function(eventType,callback){switch(eventType){case"added":this._events.added=callback;break}}}});gEcnu.DrawFeature.Circle=gEcnu.DrawFeature.extend({init:function(layer){this._layer=layer},activate:function(){this._layer._map.setMode("drawCircle");gEcnu.DrawFeature.setting=this},deactivate:function(){this._layer._map.setMode("map")},events:{_events:{},on:function(eventType,callback){switch(eventType){case"added":this._events.added=callback;break}}}});gEcnu.EditFeature=gClass.extend({init:function(){}});gEcnu.EditFeature.setting=null;gEcnu.EditFeature.Polygon=gEcnu.EditFeature.extend({init:function(layer,catchable){this._layer=layer;this._catchable=true;if(arguments.length>1){this._catchable=catchable}},activate:function(){this._layer._map.setMode("selectPolygon");gEcnu.EditFeature.setting=this},deactivate:function(){this._layer._map.setMode("map");this._layer._map.overLayer.clear();gEcnu.EditFeature.setting=null;gEcnu.Edit.selectedPolygon=null;gEcnu.Edit.selectedPolygon_pre=null;gEcnu.Edit.Poly_sellineRing_index=-1;gEcnu.Edit.Poly_selPoint_index=-1;this._layer._map.mLayer.getLayerContainer().style.cursor="default"},addPoint:function(){if(gEcnu.EditFeature.setting==null||gEcnu.Edit.selectedPolygon==null){return}this._layer._map.setMode("addPoint")},delPoint:function(){if(gEcnu.EditFeature.setting==null||gEcnu.Edit.selectedPolygon==null){return}this._layer._map.setMode("delPoint")},setCatchable:function(bool_catch){this._catchable=bool_catch},events:{_events:{},on:function(eventType,callback){switch(eventType){case"selected":this._events.selected=callback;break;case"multiSelected":this._events.multiSelected=callback;break;case"updateCompleted":this._events.updateCompleted=callback;break}}}});gEcnu.EditFeature.Line=gEcnu.EditFeature.extend({init:function(layer,catchable){this._layer=layer;this._catchable=true;if(arguments.length>1){this._catchable=catchable}},activate:function(){this._layer._map.setMode("selectLine");gEcnu.EditFeature.setting=this},deactivate:function(){this._layer._map.setMode("map");this._layer._map.overLayer.clear();gEcnu.EditFeature.setting=null;gEcnu.Edit.selectedLine=null;gEcnu.Edit.selectedLine_pre=null;gEcnu.Edit.Line_sellineString_index=-1;gEcnu.Edit.Line_selPoint_index=-1;this._layer._map.mLayer.getLayerContainer().style.cursor="default"},addPoint:function(){if(gEcnu.EditFeature.setting==null||gEcnu.Edit.selectedLine==null){return}this._layer._map.setMode("addPoint_line")},delPoint:function(){if(gEcnu.EditFeature.setting==null||gEcnu.Edit.selectedLine==null){return}this._layer._map.setMode("delPoint_line")},setCatchable:function(bool_catch){this._catchable=bool_catch},events:{_events:{},on:function(eventType,callback){switch(eventType){case"selected":this._events.selected=callback;break;case"multiSelected":this._events.multiSelected=callback;break;case"updateCompleted":this._events.updateCompleted=callback;break}}}});
gEcnu.Control=gClass.extend({init:function(id,options){this.id=id;this.options={top:15,left:15,zIndex:500}},setPos:function(){this._container.style.left=this.options.left+"px";this._container.style.top=this.options.top+"px";this._container.style.zIndex=this.options.zIndex},renew:function(){}});gEcnu.Control.Zoom=gEcnu.Control.extend({init:function(id,options){this._super();this.options=gEcnu.Util.setOptions(this,options)},_initContainer:function(){var w=30,h=60;var zoomDiv=gEcnu.Util.createDiv("zoomCtrl",w,h,true);var zoomInDiv=gEcnu.Util.createDiv("zoomInDiv",w,h/2,false);var zoomInImg=new Image();zoomInImg.src=gEcnu.config.imgPath+"zoomin.png";zoomInDiv.appendChild(zoomInImg);var zoomOutDiv=gEcnu.Util.createDiv("zoomInDiv",w,h/2,false);var zoomOutImg=new Image();zoomOutImg.src=gEcnu.config.imgPath+"zoomout.png";zoomInImg.onmouseup=function(e){gEcnu.Util.stopPropagation(e);gSelf.zoomIn()};zoomOutImg.onmouseup=function(e){gEcnu.Util.stopPropagation(e);gSelf.zoomOut()};zoomOutDiv.appendChild(zoomOutImg);zoomDiv.appendChild(zoomInDiv);zoomDiv.appendChild(zoomOutDiv);this._container=zoomDiv},onAdd:function(map){var container=map.getContainer();this._initContainer();this.setPos();container.appendChild(this._container)}});gEcnu.Control.Scale=gEcnu.Control.extend({init:function(id,options){this._super(id,options);this.options={top:0,left:0,zIndex:15,fontColor:"#000"};this.oClass="scaleControl";this.options=gEcnu.Util.setOptions(this,options)},onAdd:function(map){this._initContainer(map);this.setPos();map.getContainer().appendChild(this._container)},_initContainer:function(map){this._map=map;var size=map.getSize();var scaleCanvas=gEcnu.Util.createCanvas("scaleCtrl",size.w,size.h,true);var ctx=scaleCanvas.getContext("2d");this._container=scaleCanvas;this._ctx=ctx;this._showScale(size)},_showScale:function(size){var height=size.h;var ctx=this._ctx;var showscale=this._showScaleText(ctx,height);var width=showscale.allpx;var widthHalf=showscale.halfpx;ctx.beginPath();ctx.strokeStyle=this.options.fontColor;ctx.fillStyle=this.options.fontColor;ctx.linewidth=1;ctx.moveTo(26,height-33);ctx.lineTo(26,height-30);ctx.lineTo(width+26,height-30);ctx.lineTo(width+26,height-33);ctx.closePath();ctx.fill();ctx.beginPath();ctx.moveTo(27,height-30);ctx.lineTo(27,height-24);ctx.closePath();ctx.stroke();ctx.beginPath();ctx.moveTo(width+25,height-30);ctx.lineTo(width+25,height-24);ctx.closePath();ctx.stroke();ctx.beginPath();ctx.moveTo(widthHalf+25,height-30);ctx.lineTo(widthHalf+25,height-24);ctx.closePath();ctx.stroke()},_showScaleText:function(ctx,h){var scale;if(gSelf.coordsFlag=="GEOGRAPHIC"){var actualZoom=gSelf.zoom*111.31955*1000;scale=actualZoom/parseInt(gSelf.w)}else{scale=gSelf.zoom/parseInt(gSelf.w)}var result=this._getScaleWidth(scale);var halfkmscale=result.halfmeter;var kmscale=result.allmeter;var width=result.allpx;var widthHalf=result.halfpx;ctx.clearRect(0,0,200,h);ctx.font="14px serif";ctx.fillStyle=this.options.fontColor;ctx.fillText("0",25,h-10);ctx.fillText(halfkmscale,widthHalf+10,h-10);ctx.fillText(kmscale,width+15,h-10);return result},_getScaleWidth:function(s){var result={};if(s<=16){result.halfpx=50;result.allpx=100;result.halfmeter=Math.round(50*s)+"m";result.allmeter=Math.round(50*s)*2+"m"}else{result.halfpx=50;result.allpx=100;result.halfmeter=Math.round(50*s/1000)+"km";result.allmeter=Math.round(50*s/1000)*2+"km"}return result},clear:function(){var canvas=this._container;this._ctx.clearRect(0,0,canvas.width,canvas.height)},renew:function(){this.clear();this._showScale(this._map)}});